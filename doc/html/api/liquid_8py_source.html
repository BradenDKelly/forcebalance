<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ForceBalance API: liquid.py Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="ForceBalanceLogo_sm.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ForceBalance API
   &#160;<span id="projectnumber">1.1</span>
   </div>
   <div id="projectbrief">Automated optimization of force fields and empirical potentials</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../index.html"><span>Main Page</span></a></li>
      <li ><a href="roadmap.html"><span>Project Roadmap</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">liquid.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="liquid_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespaceforcebalance_1_1liquid.html">00001</a> <span class="stringliteral">&quot;&quot;&quot; @package forcebalance.liquid Matching of liquid bulk properties.  Under development.</span>
<a name="l00002"></a>00002 <span class="stringliteral"></span>
<a name="l00003"></a>00003 <span class="stringliteral">@author Lee-Ping Wang</span>
<a name="l00004"></a>00004 <span class="stringliteral">@date 04/2012</span>
<a name="l00005"></a>00005 <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="keyword">import</span> abc
<a name="l00008"></a>00008 <span class="keyword">import</span> os
<a name="l00009"></a>00009 <span class="keyword">import</span> shutil
<a name="l00010"></a>00010 <span class="keyword">from</span> forcebalance.finite_difference <span class="keyword">import</span> *
<a name="l00011"></a>00011 <span class="keyword">from</span> forcebalance.nifty <span class="keyword">import</span> *
<a name="l00012"></a>00012 <span class="keyword">from</span> forcebalance.nifty <span class="keyword">import</span> _exec
<a name="l00013"></a>00013 <span class="keyword">from</span> forcebalance.target <span class="keyword">import</span> Target
<a name="l00014"></a>00014 <span class="keyword">import</span> numpy <span class="keyword">as</span> np
<a name="l00015"></a>00015 <span class="keyword">from</span> forcebalance.molecule <span class="keyword">import</span> Molecule
<a name="l00016"></a>00016 <span class="keyword">from</span> re <span class="keyword">import</span> match, sub
<a name="l00017"></a>00017 <span class="keyword">import</span> subprocess
<a name="l00018"></a>00018 <span class="keyword">from</span> subprocess <span class="keyword">import</span> PIPE
<a name="l00019"></a>00019 <span class="keywordflow">try</span>:
<a name="l00020"></a>00020     <span class="keyword">from</span> lxml <span class="keyword">import</span> etree
<a name="l00021"></a>00021 <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00022"></a>00022 <span class="keyword">from</span> pymbar <span class="keyword">import</span> pymbar
<a name="l00023"></a>00023 <span class="keyword">import</span> itertools
<a name="l00024"></a>00024 <span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict, namedtuple
<a name="l00025"></a>00025 <span class="keyword">from</span> forcebalance.optimizer <span class="keyword">import</span> Counter, GoodStep
<a name="l00026"></a>00026 <span class="keyword">import</span> csv
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="keyword">from</span> forcebalance.output <span class="keyword">import</span> getLogger
<a name="l00029"></a>00029 logger = getLogger(__name__)
<a name="l00030"></a><a class="code" href="namespaceforcebalance_1_1liquid.html#a82691ecf186d3b94b7c4915ac590d178">00030</a> 
<a name="l00031"></a>00031 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1liquid.html#a6f7d54263236f8788c319aee86b460b6">weight_info</a>(W, PT, N_k, verbose=True):
<a name="l00032"></a><a class="code" href="namespaceforcebalance_1_1liquid.html#a6f7d54263236f8788c319aee86b460b6">00032</a>     C = []
<a name="l00033"></a>00033     N = 0
<a name="l00034"></a>00034     W += 1.0e-300
<a name="l00035"></a>00035     I = np.exp(-1*np.sum((W*np.log(W))))
<a name="l00036"></a>00036     <span class="keywordflow">for</span> ns <span class="keywordflow">in</span> N_k:
<a name="l00037"></a>00037         C.append(sum(W[N:N+ns]))
<a name="l00038"></a>00038         N += ns
<a name="l00039"></a>00039     C = np.array(C)
<a name="l00040"></a>00040     <span class="keywordflow">if</span> verbose:
<a name="l00041"></a>00041         logger.info(<span class="stringliteral">&quot;MBAR Results for Phase Point %s, Box, Contributions:\n&quot;</span> % str(PT))
<a name="l00042"></a>00042         logger.info(str(C) + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00043"></a>00043         logger.info(<span class="stringliteral">&quot;InfoContent: % .2f snapshots (%.2f %%)\n&quot;</span> % (I, 100*I/len(W)))
<a name="l00044"></a>00044     <span class="keywordflow">return</span> C
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="comment"># NPT_Trajectory = namedtuple(&#39;NPT_Trajectory&#39;, [&#39;fnm&#39;, &#39;Rhos&#39;, &#39;pVs&#39;, &#39;Energies&#39;, &#39;Grads&#39;, &#39;mEnergies&#39;, &#39;mGrads&#39;, &#39;Rho_errs&#39;, &#39;Hvap_errs&#39;])</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="keyword">class </span><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html" title="Subclass of Target for liquid property matching.">Liquid</a>(<a class="code" href="classforcebalance_1_1target_1_1Target.html" title="Base class for all fitting targets.">Target</a>):
<a name="l00049"></a>00049     
<a name="l00050"></a>00050     <span class="stringliteral">&quot;&quot;&quot; Subclass of Target for liquid property matching.&quot;&quot;&quot;</span>
<a name="l00051"></a><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html">00051</a>     
<a name="l00052"></a>00052     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a73a35541914580d0d918d34d94065f39" title="Create an instance of the class.">__init__</a>(self,options,tgt_opts,forcefield):
<a name="l00053"></a>00053         <span class="stringliteral">&quot;&quot;&quot; Create an instance of the class. &quot;&quot;&quot;</span>
<a name="l00054"></a>00054         
<a name="l00055"></a>00055         <span class="comment"># Initialize the SuperClass!</span>
<a name="l00056"></a><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#af7ba85e825dfe42a384c2eb2e7cc1f0c">00056</a>         super(Liquid,self).<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a73a35541914580d0d918d34d94065f39" title="Create an instance of the class.">__init__</a>(options,tgt_opts,forcefield)
<a name="l00057"></a>00057         <span class="comment"># Fractional weight of the density</span>
<a name="l00058"></a>00058         self.set_option(tgt_opts,<span class="stringliteral">&#39;w_rho&#39;</span>,forceprint=<span class="keyword">True</span>)
<a name="l00059"></a><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a3d7e00beaf0c7d71751699e05b87c501">00059</a>         <span class="comment"># Fractional weight of the enthalpy of vaporization</span>
<a name="l00060"></a><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a110998789cb046248b78318c97872930">00060</a>         self.set_option(tgt_opts,<span class="stringliteral">&#39;w_hvap&#39;</span>,forceprint=<span class="keyword">True</span>)
<a name="l00061"></a><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#acab3a497d408af6d152a460ecba40583">00061</a>         <span class="comment"># Fractional weight of the thermal expansion coefficient</span>
<a name="l00062"></a><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a13401c3bd91481f840975e95770c107d">00062</a>         self.set_option(tgt_opts,<span class="stringliteral">&#39;w_alpha&#39;</span>,forceprint=<span class="keyword">True</span>)
<a name="l00063"></a>00063         <span class="comment"># Fractional weight of the isothermal compressibility</span>
<a name="l00064"></a>00064         self.set_option(tgt_opts,<span class="stringliteral">&#39;w_kappa&#39;</span>,forceprint=<span class="keyword">True</span>)
<a name="l00065"></a>00065         <span class="comment"># Fractional weight of the isobaric heat capacity</span>
<a name="l00066"></a>00066         self.set_option(tgt_opts,<span class="stringliteral">&#39;w_cp&#39;</span>,forceprint=<span class="keyword">True</span>)
<a name="l00067"></a>00067         <span class="comment"># Fractional weight of the dielectric constant</span>
<a name="l00068"></a>00068         self.set_option(tgt_opts,<span class="stringliteral">&#39;w_eps0&#39;</span>,forceprint=<span class="keyword">True</span>)
<a name="l00069"></a>00069         <span class="comment"># Optionally pause on the zeroth step</span>
<a name="l00070"></a>00070         self.set_option(tgt_opts,<span class="stringliteral">&#39;manual&#39;</span>)
<a name="l00071"></a>00071         <span class="comment"># Don&#39;t target the average enthalpy of vaporization and allow it to freely float (experimental)</span>
<a name="l00072"></a>00072         self.set_option(tgt_opts,<span class="stringliteral">&#39;hvap_subaverage&#39;</span>)
<a name="l00073"></a>00073         <span class="comment"># Number of time steps in the liquid &quot;equilibration&quot; run</span>
<a name="l00074"></a>00074         self.set_option(tgt_opts,<span class="stringliteral">&#39;liquid_equ_steps&#39;</span>,forceprint=<span class="keyword">True</span>)
<a name="l00075"></a>00075         <span class="comment"># Number of time steps in the liquid &quot;production&quot; run</span>
<a name="l00076"></a>00076         self.set_option(tgt_opts,<span class="stringliteral">&#39;liquid_prod_steps&#39;</span>,forceprint=<span class="keyword">True</span>)
<a name="l00077"></a>00077         <span class="comment"># Number of time steps in the gas &quot;equilibration&quot; run</span>
<a name="l00078"></a>00078         self.set_option(tgt_opts,<span class="stringliteral">&#39;gas_equ_steps&#39;</span>,forceprint=<span class="keyword">False</span>)
<a name="l00079"></a>00079         <span class="comment"># Number of time steps in the gas &quot;production&quot; run</span>
<a name="l00080"></a>00080         self.set_option(tgt_opts,<span class="stringliteral">&#39;gas_prod_steps&#39;</span>,forceprint=<span class="keyword">False</span>)
<a name="l00081"></a>00081         <span class="comment"># Time step length (in fs) for the liquid production run</span>
<a name="l00082"></a>00082         self.set_option(tgt_opts,<span class="stringliteral">&#39;liquid_timestep&#39;</span>,forceprint=<span class="keyword">True</span>)
<a name="l00083"></a>00083         <span class="comment"># Time interval (in ps) for writing coordinates</span>
<a name="l00084"></a>00084         self.set_option(tgt_opts,<span class="stringliteral">&#39;liquid_interval&#39;</span>,forceprint=<span class="keyword">True</span>)
<a name="l00085"></a>00085         <span class="comment"># Time step length (in fs) for the gas production run</span>
<a name="l00086"></a>00086         self.set_option(tgt_opts,<span class="stringliteral">&#39;gas_timestep&#39;</span>,forceprint=<span class="keyword">True</span>)
<a name="l00087"></a>00087         <span class="comment"># Time interval (in ps) for writing coordinates</span>
<a name="l00088"></a>00088         self.set_option(tgt_opts,<span class="stringliteral">&#39;gas_interval&#39;</span>,forceprint=<span class="keyword">True</span>)
<a name="l00089"></a>00089         <span class="comment"># Minimize the energy prior to running any dynamics</span>
<a name="l00090"></a>00090         self.set_option(tgt_opts,<span class="stringliteral">&#39;minimize_energy&#39;</span>,forceprint=<span class="keyword">True</span>)
<a name="l00091"></a>00091         <span class="comment"># Isolated dipole (debye) for analytic self-polarization correction.</span>
<a name="l00092"></a>00092         self.set_option(tgt_opts,<span class="stringliteral">&#39;self_pol_mu0&#39;</span>,forceprint=<span class="keyword">True</span>)
<a name="l00093"></a>00093         <span class="comment"># Molecular polarizability (ang**3) for analytic self-polarization correction.</span>
<a name="l00094"></a>00094         self.set_option(tgt_opts,<span class="stringliteral">&#39;self_pol_alpha&#39;</span>,forceprint=<span class="keyword">True</span>)
<a name="l00095"></a>00095         <span class="comment"># Set up the simulation object for self-polarization correction.</span>
<a name="l00096"></a>00096         self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#af7ba85e825dfe42a384c2eb2e7cc1f0c">do_self_pol</a> = (self.self_pol_mu0 &gt; 0.0 <span class="keywordflow">and</span> self.self_pol_alpha &gt; 0.0)
<a name="l00097"></a>00097         <span class="comment"># Enable anisotropic periodic box</span>
<a name="l00098"></a>00098         self.set_option(tgt_opts,<span class="stringliteral">&#39;anisotropic_box&#39;</span>,forceprint=<span class="keyword">True</span>)
<a name="l00099"></a>00099         <span class="comment"># Whether to save trajectories (0 = never, 1 = delete after good step, 2 = keep all)</span>
<a name="l00100"></a>00100         self.set_option(tgt_opts,<span class="stringliteral">&#39;save_traj&#39;</span>)       
<a name="l00101"></a>00101 
<a name="l00102"></a>00102         <span class="comment">#======================================#</span>
<a name="l00103"></a>00103         <span class="comment">#     Variables which are set here     #</span>
<a name="l00104"></a>00104         <span class="comment">#======================================#</span>
<a name="l00105"></a>00105         
<a name="l00106"></a>00106         <span class="comment">## Read the reference data</span>
<a name="l00107"></a>00107         self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a08b698af913d56f780d0587821c922cd">read_data</a>()
<a name="l00108"></a>00108         <span class="comment">## Prepare the temporary directory</span>
<a name="l00109"></a>00109         self.prepare_temp_directory(options,tgt_opts)
<a name="l00110"></a>00110         <span class="comment">## Extra platform-dependent data to send back</span>
<a name="l00111"></a>00111         self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a3d7e00beaf0c7d71751699e05b87c501" title="Read the reference data.">extra_output</a> = []
<a name="l00112"></a>00112         <span class="comment">#======================================#</span>
<a name="l00113"></a>00113         <span class="comment">#          UNDER DEVELOPMENT           #</span>
<a name="l00114"></a>00114         <span class="comment">#======================================#</span>
<a name="l00115"></a>00115         <span class="comment"># Put stuff here that I&#39;m not sure about. :)</span>
<a name="l00116"></a>00116         np.set_printoptions(precision=4, linewidth=100)
<a name="l00117"></a>00117         np.seterr(under=<span class="stringliteral">&#39;ignore&#39;</span>)
<a name="l00118"></a>00118         <span class="comment">## Saved force field mvals for all iterations</span>
<a name="l00119"></a>00119         self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a110998789cb046248b78318c97872930" title="Saved force field mvals for all iterations.">SavedMVal</a> = {}
<a name="l00120"></a>00120         <span class="comment">## Saved trajectories for all iterations and all temperatures :)</span>
<a name="l00121"></a>00121         self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#acab3a497d408af6d152a460ecba40583" title="Saved trajectories for all iterations and all temperatures :)">SavedTraj</a> = defaultdict(dict)
<a name="l00122"></a>00122         <span class="comment">## Evaluated energies for all trajectories (i.e. all iterations and all temperatures), using all mvals</span>
<a name="l00123"></a>00123         self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a92ec9101fdcdadf9c9a3975bac0b409e" title="Evaluated energies for all trajectories (i.e.">MBarEnergy</a> = defaultdict(<span class="keyword">lambda</span>:defaultdict(dict))
<a name="l00124"></a>00124         <span class="comment"># Prefix to command string for launching NPT simulations.</span>
<a name="l00125"></a>00125         self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2e379d0030f788029f9778b33f456cb8">nptpfx</a> = <span class="stringliteral">&quot;&quot;</span>
<a name="l00126"></a>00126         <span class="comment"># List of extra files to upload to Work Queue.</span>
<a name="l00127"></a>00127         self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a748b44c6ea59a4a79bc8413e5d64b88a">nptfiles</a> = []
<a name="l00128"></a>00128         <span class="comment"># Suffix to command string for launching NPT simulations.</span>
<a name="l00129"></a>00129         self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a13401c3bd91481f840975e95770c107d">nptsfx</a> = [(<span class="stringliteral">&quot;--minimize_energy&quot;</span> <span class="keywordflow">if</span> self.minimize_energy <span class="keywordflow">else</span> <span class="keywordtype">None</span>), 
<a name="l00130"></a>00130                        (<span class="stringliteral">&quot;--liquid_equ_steps %i&quot;</span> % self.liquid_equ_steps <span class="keywordflow">if</span> self.liquid_equ_steps &gt; 0 <span class="keywordflow">else</span> <span class="keywordtype">None</span>),
<a name="l00131"></a>00131                        (<span class="stringliteral">&quot;--gas_equ_steps %i&quot;</span> % self.gas_equ_steps <span class="keywordflow">if</span> self.gas_equ_steps &gt; 0 <span class="keywordflow">else</span> <span class="keywordtype">None</span>), 
<a name="l00132"></a>00132                        (<span class="stringliteral">&quot;--gas_prod_steps %i&quot;</span> % self.gas_prod_steps <span class="keywordflow">if</span> self.gas_prod_steps &gt; 0 <span class="keywordflow">else</span> <span class="keywordtype">None</span>), 
<a name="l00133"></a>00133                        (<span class="stringliteral">&quot;--gas_timestep %f&quot;</span> % self.gas_timestep <span class="keywordflow">if</span> self.gas_timestep &gt; 0.0 <span class="keywordflow">else</span> <span class="keywordtype">None</span>), 
<a name="l00134"></a>00134                        (<span class="stringliteral">&quot;--gas_interval %f&quot;</span> % self.gas_interval <span class="keywordflow">if</span> self.gas_interval &gt; 0.0 <span class="keywordflow">else</span> <span class="keywordtype">None</span>)]
<a name="l00135"></a>00135         <span class="comment"># List of trajectory files that may be deleted if self.save_traj == 1.</span>
<a name="l00136"></a>00136         self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#acf4158ed2337a04bdee3ee3f2f16283c">last_traj</a> = []
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a08b698af913d56f780d0587821c922cd">read_data</a>(self):
<a name="l00139"></a>00139         <span class="comment"># Read the &#39;data.csv&#39; file. The file should contain guidelines.</span>
<a name="l00140"></a>00140         with open(os.path.join(self.tgtdir,<span class="stringliteral">&#39;data.csv&#39;</span>),<span class="stringliteral">&#39;rU&#39;</span>) <span class="keyword">as</span> f: R0 = list(csv.reader(f))
<a name="l00141"></a><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">00141</a>         <span class="comment"># All comments are erased.</span>
<a name="l00142"></a>00142         R1 = [[sub(<span class="stringliteral">&#39;#.*$&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,word) <span class="keywordflow">for</span> word <span class="keywordflow">in</span> line] <span class="keywordflow">for</span> line <span class="keywordflow">in</span> R0 <span class="keywordflow">if</span> len(line[0]) &gt; 0 <span class="keywordflow">and</span> line[0][0] != <span class="stringliteral">&quot;#&quot;</span>]
<a name="l00143"></a>00143         <span class="comment"># All empty lines are deleted and words are converted to lowercase.</span>
<a name="l00144"></a>00144         R = [[wrd.lower() <span class="keywordflow">for</span> wrd <span class="keywordflow">in</span> line] <span class="keywordflow">for</span> line <span class="keywordflow">in</span> R1 <span class="keywordflow">if</span> any([len(wrd) <span class="keywordflow">for</span> wrd <span class="keywordflow">in</span> line]) &gt; 0]
<a name="l00145"></a>00145         global_opts = OrderedDict()
<a name="l00146"></a>00146         found_headings = <span class="keyword">False</span>
<a name="l00147"></a>00147         known_vars = [<span class="stringliteral">&#39;mbar&#39;</span>,<span class="stringliteral">&#39;rho&#39;</span>,<span class="stringliteral">&#39;hvap&#39;</span>,<span class="stringliteral">&#39;alpha&#39;</span>,<span class="stringliteral">&#39;kappa&#39;</span>,<span class="stringliteral">&#39;cp&#39;</span>,<span class="stringliteral">&#39;eps0&#39;</span>,<span class="stringliteral">&#39;cvib_intra&#39;</span>,<span class="stringliteral">&#39;cvib_inter&#39;</span>,<span class="stringliteral">&#39;cni&#39;</span>,<span class="stringliteral">&#39;devib_intra&#39;</span>,<span class="stringliteral">&#39;devib_inter&#39;</span>]
<a name="l00148"></a>00148         self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a> = OrderedDict()
<a name="l00149"></a>00149         <span class="keywordflow">for</span> line <span class="keywordflow">in</span> R:
<a name="l00150"></a>00150             <span class="keywordflow">if</span> line[0] == <span class="stringliteral">&quot;global&quot;</span>:
<a name="l00151"></a>00151                 <span class="comment"># Global options are mainly denominators for the different observables.</span>
<a name="l00152"></a>00152                 <span class="keywordflow">if</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(line[2]):
<a name="l00153"></a>00153                     global_opts[line[1]] = float(line[2])
<a name="l00154"></a>00154                 <span class="keywordflow">elif</span> line[2].lower() == <span class="stringliteral">&#39;false&#39;</span>:
<a name="l00155"></a>00155                     global_opts[line[1]] = <span class="keyword">False</span>
<a name="l00156"></a>00156                 <span class="keywordflow">elif</span> line[2].lower() == <span class="stringliteral">&#39;true&#39;</span>:
<a name="l00157"></a>00157                     global_opts[line[1]] = <span class="keyword">True</span>
<a name="l00158"></a>00158             <span class="keywordflow">elif</span> <span class="keywordflow">not</span> found_headings:
<a name="l00159"></a>00159                 found_headings = <span class="keyword">True</span>
<a name="l00160"></a>00160                 headings = line
<a name="l00161"></a>00161                 <span class="keywordflow">if</span> len(set(headings)) != len(headings):
<a name="l00162"></a>00162                     <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Column headings in data.csv must be unique&#39;</span>)
<a name="l00163"></a>00163                 <span class="keywordflow">if</span> <span class="stringliteral">&#39;p&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> headings:
<a name="l00164"></a>00164                     <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;There must be a pressure column heading labeled by &quot;p&quot; in data.csv&#39;</span>)
<a name="l00165"></a>00165                 <span class="keywordflow">if</span> <span class="stringliteral">&#39;t&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> headings:
<a name="l00166"></a>00166                     <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;There must be a temperature column heading labeled by &quot;t&quot; in data.csv&#39;</span>)
<a name="l00167"></a>00167             <span class="keywordflow">elif</span> found_headings:
<a name="l00168"></a>00168                 <span class="keywordflow">try</span>:
<a name="l00169"></a>00169                     <span class="comment"># Temperatures are in kelvin.</span>
<a name="l00170"></a>00170                     t     = [float(val) <span class="keywordflow">for</span> head, val <span class="keywordflow">in</span> zip(headings,line) <span class="keywordflow">if</span> head == <span class="stringliteral">&#39;t&#39;</span>][0]
<a name="l00171"></a>00171                     <span class="comment"># For convenience, users may input the pressure in atmosphere or bar.</span>
<a name="l00172"></a>00172                     pval  = [float(val.split()[0]) <span class="keywordflow">for</span> head, val <span class="keywordflow">in</span> zip(headings,line) <span class="keywordflow">if</span> head == <span class="stringliteral">&#39;p&#39;</span>][0]
<a name="l00173"></a>00173                     punit = [val.split()[1] <span class="keywordflow">if</span> len(val.split()) &gt;= 1 <span class="keywordflow">else</span> <span class="stringliteral">&quot;atm&quot;</span> <span class="keywordflow">for</span> head, val <span class="keywordflow">in</span> zip(headings,line) <span class="keywordflow">if</span> head == <span class="stringliteral">&#39;p&#39;</span>][0]
<a name="l00174"></a>00174                     unrec = set([punit]).difference([<span class="stringliteral">&#39;atm&#39;</span>,<span class="stringliteral">&#39;bar&#39;</span>]) 
<a name="l00175"></a>00175                     <span class="keywordflow">if</span> len(unrec) &gt; 0:
<a name="l00176"></a>00176                         <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;The pressure unit %s is not recognized, please use bar or atm&#39;</span> % unrec[0])
<a name="l00177"></a>00177                     <span class="comment"># This line actually reads the reference data and inserts it into the RefData dictionary of dictionaries.</span>
<a name="l00178"></a>00178                     <span class="keywordflow">for</span> head, val <span class="keywordflow">in</span> zip(headings,line):
<a name="l00179"></a>00179                         <span class="keywordflow">if</span> head == <span class="stringliteral">&#39;t&#39;</span> <span class="keywordflow">or</span> head == <span class="stringliteral">&#39;p&#39;</span> : <span class="keywordflow">continue</span>
<a name="l00180"></a>00180                         <span class="keywordflow">if</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(val):
<a name="l00181"></a>00181                             self.RefData.setdefault(head,OrderedDict([]))[(t,pval,punit)] = float(val)
<a name="l00182"></a>00182                         <span class="keywordflow">elif</span> val.lower() == <span class="stringliteral">&#39;true&#39;</span>:
<a name="l00183"></a>00183                             self.RefData.setdefault(head,OrderedDict([]))[(t,pval,punit)] = <span class="keyword">True</span>
<a name="l00184"></a>00184                         <span class="keywordflow">elif</span> val.lower() == <span class="stringliteral">&#39;false&#39;</span>:
<a name="l00185"></a>00185                             self.RefData.setdefault(head,OrderedDict([]))[(t,pval,punit)] = <span class="keyword">False</span>
<a name="l00186"></a>00186                 <span class="keywordflow">except</span>:
<a name="l00187"></a>00187                     logger.error(line + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00188"></a>00188                     <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Encountered an error reading this line!&#39;</span>)
<a name="l00189"></a>00189             <span class="keywordflow">else</span>:
<a name="l00190"></a>00190                 logger.error(line + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00191"></a>00191                 <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;I did not recognize this line!&#39;</span>)
<a name="l00192"></a>00192         <span class="comment"># Check the reference data table for validity.</span>
<a name="l00193"></a>00193         default_denoms = defaultdict(int)
<a name="l00194"></a>00194         PhasePoints = <span class="keywordtype">None</span>
<a name="l00195"></a>00195         <span class="keywordflow">for</span> head <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>:
<a name="l00196"></a>00196             <span class="keywordflow">if</span> head <span class="keywordflow">not</span> <span class="keywordflow">in</span> known_vars+[i+<span class="stringliteral">&quot;_wt&quot;</span> <span class="keywordflow">for</span> i <span class="keywordflow">in</span> known_vars]:
<a name="l00197"></a>00197                 <span class="comment"># Only hard-coded properties may be recognized.</span>
<a name="l00198"></a>00198                 <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&quot;The column heading %s is not recognized in data.csv&quot;</span> % head)
<a name="l00199"></a>00199             <span class="keywordflow">if</span> head <span class="keywordflow">in</span> known_vars:
<a name="l00200"></a>00200                 <span class="keywordflow">if</span> head+<span class="stringliteral">&quot;_wt&quot;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>:
<a name="l00201"></a>00201                     <span class="comment"># If the phase-point weights are not specified in the reference data file, initialize them all to one.</span>
<a name="l00202"></a>00202                     self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[head+<span class="stringliteral">&quot;_wt&quot;</span>] = OrderedDict([(key, 1.0) <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[head]])
<a name="l00203"></a>00203                 wts = np.array(self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[head+<span class="stringliteral">&quot;_wt&quot;</span>].values())
<a name="l00204"></a>00204                 dat = np.array(self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[head].values())
<a name="l00205"></a>00205                 avg = np.average(dat, weights=wts)
<a name="l00206"></a>00206                 <span class="keywordflow">if</span> len(wts) &gt; 1:
<a name="l00207"></a>00207                     <span class="comment"># If there is more than one data point, then the default denominator is the</span>
<a name="l00208"></a>00208                     <span class="comment"># standard deviation of the experimental values.</span>
<a name="l00209"></a>00209                     default_denoms[head+<span class="stringliteral">&quot;_denom&quot;</span>] = np.sqrt(np.dot(wts, (dat-avg)**2)/wts.sum())
<a name="l00210"></a>00210                 <span class="keywordflow">else</span>:
<a name="l00211"></a>00211                     <span class="comment"># If there is only one data point, then the denominator is just the single</span>
<a name="l00212"></a>00212                     <span class="comment"># data point itself.</span>
<a name="l00213"></a>00213                     default_denoms[head+<span class="stringliteral">&quot;_denom&quot;</span>] = np.sqrt(dat[0])
<a name="l00214"></a>00214             self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2333919b4fc49482ed23b5e66eaa0ea8">PhasePoints</a> = self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[head].keys()
<a name="l00215"></a>00215             <span class="comment"># This prints out all of the reference data.</span>
<a name="l00216"></a>00216             <span class="comment"># printcool_dictionary(self.RefData[head],head)</span>
<a name="l00217"></a>00217         <span class="comment"># Create labels for the directories.</span>
<a name="l00218"></a>00218         self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a16afa7eeca3234f74f60ac085dd8eb5b">Labels</a> = [<span class="stringliteral">&quot;%.2fK-%.1f%s&quot;</span> % i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2333919b4fc49482ed23b5e66eaa0ea8">PhasePoints</a>]
<a name="l00219"></a>00219         logger.debug(<span class="stringliteral">&quot;global_opts:\n%s\n&quot;</span> % str(global_opts))
<a name="l00220"></a>00220         logger.debug(<span class="stringliteral">&quot;default_denoms:\n%s\n&quot;</span> % str(default_denoms))
<a name="l00221"></a>00221         <span class="keywordflow">for</span> opt <span class="keywordflow">in</span> global_opts:
<a name="l00222"></a>00222             <span class="keywordflow">if</span> <span class="stringliteral">&quot;_denom&quot;</span> <span class="keywordflow">in</span> opt:
<a name="l00223"></a>00223                 <span class="comment"># Record entries from the global_opts dictionary so they can be retrieved from other methods.</span>
<a name="l00224"></a>00224                 self.set_option(global_opts,opt,default=default_denoms[opt])
<a name="l00225"></a>00225             <span class="keywordflow">else</span>:
<a name="l00226"></a>00226                 self.set_option(global_opts,opt)
<a name="l00227"></a>00227 
<a name="l00228"></a>00228     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a07a59f9f335693329b789a9c7608fc9f" title="Submit a NPT simulation to the Work Queue.">npt_simulation</a>(self, temperature, pressure, simnum):
<a name="l00229"></a>00229         <span class="stringliteral">&quot;&quot;&quot; Submit a NPT simulation to the Work Queue. &quot;&quot;&quot;</span>
<a name="l00230"></a>00230         wq = <a class="code" href="namespaceforcebalance_1_1nifty.html#ac37d4fe58ef70ed546ebfc45d12f7a5d">getWorkQueue</a>()
<a name="l00231"></a>00231         <span class="keywordflow">if</span> <span class="keywordflow">not</span> (os.path.exists(<span class="stringliteral">&#39;npt_result.p&#39;</span>) <span class="keywordflow">or</span> os.path.exists(<span class="stringliteral">&#39;npt_result.p.bz2&#39;</span>)):
<a name="l00232"></a>00232             <a class="code" href="namespaceforcebalance_1_1nifty.html#a0cf4e58f90acf20e3d6224be2354082c">link_dir_contents</a>(os.path.join(self.root,self.rundir),os.getcwd())
<a name="l00233"></a><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a07a59f9f335693329b789a9c7608fc9f">00233</a>             self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#acf4158ed2337a04bdee3ee3f2f16283c">last_traj</a> += [os.path.join(os.getcwd(), i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a3d7e00beaf0c7d71751699e05b87c501" title="Read the reference data.">extra_output</a>]
<a name="l00234"></a>00234             <span class="keywordflow">if</span> self.liquid_traj != <span class="keywordtype">None</span>:
<a name="l00235"></a>00235                 self.liquid_conf.xyzs[0] = self.liquid_traj.xyzs[simnum%len(self.liquid_traj)]
<a name="l00236"></a>00236                 self.liquid_conf.boxes[0] = self.liquid_traj.boxes[simnum%len(self.liquid_traj)]
<a name="l00237"></a>00237             self.liquid_conf.write(self.liquid_fnm)
<a name="l00238"></a>00238             cmdstr = <span class="stringliteral">&#39;%s python npt.py %s %i %.3f %.3f %.3f %.3f %s&#39;</span> % (self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2e379d0030f788029f9778b33f456cb8">nptpfx</a>, self.engine, self.liquid_prod_steps, self.liquid_timestep,
<a name="l00239"></a>00239                                                                         self.liquid_interval, temperature, pressure, <span class="stringliteral">&#39; &#39;</span>.join([i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a13401c3bd91481f840975e95770c107d">nptsfx</a> <span class="keywordflow">if</span> i != <span class="keywordtype">None</span>]))
<a name="l00240"></a>00240             <span class="keywordflow">if</span> wq == <span class="keywordtype">None</span>:
<a name="l00241"></a>00241                 logger.info(<span class="stringliteral">&quot;Running condensed phase simulation locally.\n&quot;</span>)
<a name="l00242"></a>00242                 logger.info(<span class="stringliteral">&quot;You may tail -f %s/npt.out in another terminal window\n&quot;</span> % os.getcwd())
<a name="l00243"></a>00243                 _exec(cmdstr, outfnm=<span class="stringliteral">&#39;npt.out&#39;</span>)
<a name="l00244"></a>00244             <span class="keywordflow">else</span>:
<a name="l00245"></a>00245                 <a class="code" href="namespaceforcebalance_1_1nifty.html#a673f4a044169f5d8d822823989a836a7" title="Submit a job to the Work Queue.">queue_up</a>(wq, command = cmdstr+<span class="stringliteral">&#39; &amp;&gt; npt.out&#39;</span>,
<a name="l00246"></a>00246                          input_files = self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a748b44c6ea59a4a79bc8413e5d64b88a">nptfiles</a> + [<span class="stringliteral">&#39;npt.py&#39;</span>, self.liquid_fnm, self.gas_fnm, <span class="stringliteral">&#39;forcebalance.p&#39;</span>],
<a name="l00247"></a>00247                          output_files = [<span class="stringliteral">&#39;npt_result.p.bz2&#39;</span>, <span class="stringliteral">&#39;npt.out&#39;</span>] + self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a3d7e00beaf0c7d71751699e05b87c501" title="Read the reference data.">extra_output</a>,
<a name="l00248"></a>00248                          tgt=self)
<a name="l00249"></a>00249 
<a name="l00250"></a>00250     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#ae94ce30dfd0e92fdd6d746e6743be844">indicate</a>(self):
<a name="l00251"></a>00251         <span class="comment"># Somehow the &quot;indicator&quot; functionality made its way into &quot;get&quot;.  No matter.</span>
<a name="l00252"></a>00252         <span class="keywordflow">return</span>
<a name="l00253"></a>00253 
<a name="l00254"></a><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#ae94ce30dfd0e92fdd6d746e6743be844">00254</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a00c23db61bcb86cc19f79dacdb2bc1f3">objective_term</a>(self, points, expname, calc, err, grad, name=&quot;Quantity&quot;, SubAverage=False):
<a name="l00255"></a>00255         <span class="keywordflow">if</span> expname <span class="keywordflow">in</span> self.RefData:
<a name="l00256"></a>00256             exp = self.RefData[expname]
<a name="l00257"></a>00257             Weights = self.RefData[expname+<span class="stringliteral">&quot;_wt&quot;</span>]
<a name="l00258"></a><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a00c23db61bcb86cc19f79dacdb2bc1f3">00258</a>             Denom = getattr(self,expname+<span class="stringliteral">&quot;_denom&quot;</span>)
<a name="l00259"></a>00259         <span class="keywordflow">else</span>:
<a name="l00260"></a>00260             <span class="comment"># If the reference data doesn&#39;t exist then return nothing.</span>
<a name="l00261"></a>00261             <span class="keywordflow">return</span> 0.0, np.zeros(self.FF.np, dtype=float), np.zeros((self.FF.np,self.FF.np),dtype=float), <span class="keywordtype">None</span>
<a name="l00262"></a>00262             
<a name="l00263"></a>00263         Sum = sum(Weights.values())
<a name="l00264"></a>00264         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> Weights:
<a name="l00265"></a>00265             Weights[i] /= Sum
<a name="l00266"></a>00266         logger.info(<span class="stringliteral">&quot;Weights have been renormalized to &quot;</span> + str(sum(Weights.values())) + <span class="stringliteral">&quot;\n&quot;</span>)
<a name="l00267"></a>00267         <span class="comment"># Use least-squares or hyperbolic (experimental) objective.</span>
<a name="l00268"></a>00268         LeastSquares = <span class="keyword">True</span>
<a name="l00269"></a>00269 
<a name="l00270"></a>00270         logger.info(<span class="stringliteral">&quot;Physical quantity %s uses denominator = % .4f\n&quot;</span> % (name, Denom))
<a name="l00271"></a>00271         <span class="keywordflow">if</span> <span class="keywordflow">not</span> LeastSquares:
<a name="l00272"></a>00272             <span class="comment"># If using a hyperbolic functional form</span>
<a name="l00273"></a>00273             <span class="comment"># we still want the contribution to the </span>
<a name="l00274"></a>00274             <span class="comment"># objective function to be the same when</span>
<a name="l00275"></a>00275             <span class="comment"># Delta = Denom.</span>
<a name="l00276"></a>00276             Denom /= 3 ** 0.5
<a name="l00277"></a>00277         
<a name="l00278"></a>00278         Objective = 0.0
<a name="l00279"></a>00279         Gradient = np.zeros(self.FF.np, dtype=float)
<a name="l00280"></a>00280         Hessian = np.zeros((self.FF.np,self.FF.np),dtype=float)
<a name="l00281"></a>00281         Objs = {}
<a name="l00282"></a>00282         GradMap = []
<a name="l00283"></a>00283         avgCalc = 0.0
<a name="l00284"></a>00284         avgExp  = 0.0
<a name="l00285"></a>00285         avgGrad = np.zeros(self.FF.np, dtype=float)
<a name="l00286"></a>00286         <span class="keywordflow">for</span> i, PT <span class="keywordflow">in</span> enumerate(points):
<a name="l00287"></a>00287             avgCalc += Weights[PT]*calc[PT]
<a name="l00288"></a>00288             avgExp  += Weights[PT]*exp[PT]
<a name="l00289"></a>00289             avgGrad += Weights[PT]*grad[PT]
<a name="l00290"></a>00290         <span class="keywordflow">for</span> i, PT <span class="keywordflow">in</span> enumerate(points):
<a name="l00291"></a>00291             <span class="keywordflow">if</span> SubAverage:
<a name="l00292"></a>00292                 G = grad[PT]-avgGrad
<a name="l00293"></a>00293                 Delta = calc[PT] - exp[PT] - avgCalc + avgExp
<a name="l00294"></a>00294             <span class="keywordflow">else</span>:
<a name="l00295"></a>00295                 G = grad[PT]
<a name="l00296"></a>00296                 Delta = calc[PT] - exp[PT]
<a name="l00297"></a>00297             <span class="keywordflow">if</span> LeastSquares:
<a name="l00298"></a>00298                 <span class="comment"># Least-squares objective function.</span>
<a name="l00299"></a>00299                 ThisObj = Weights[PT] * Delta ** 2 / Denom**2
<a name="l00300"></a>00300                 Objs[PT] = ThisObj
<a name="l00301"></a>00301                 ThisGrad = 2.0 * Weights[PT] * Delta * G / Denom**2
<a name="l00302"></a>00302                 GradMap.append(G)
<a name="l00303"></a>00303                 Objective += ThisObj
<a name="l00304"></a>00304                 Gradient += ThisGrad
<a name="l00305"></a>00305                 <span class="comment"># Gauss-Newton approximation to the Hessian.</span>
<a name="l00306"></a>00306                 Hessian += 2.0 * Weights[PT] * (np.outer(G, G)) / Denom**2
<a name="l00307"></a>00307             <span class="keywordflow">else</span>:
<a name="l00308"></a>00308                 <span class="comment"># L1-like objective function.</span>
<a name="l00309"></a>00309                 D = Denom
<a name="l00310"></a>00310                 S = Delta**2 + D**2
<a name="l00311"></a>00311                 ThisObj  = Weights[PT] * (S**0.5-D) / Denom
<a name="l00312"></a>00312                 ThisGrad = Weights[PT] * (Delta/S**0.5) * G / Denom
<a name="l00313"></a>00313                 ThisHess = Weights[PT] * (1/S**0.5-Delta**2/S**1.5) * np.outer(G,G) / Denom
<a name="l00314"></a>00314                 Objs[PT] = ThisObj
<a name="l00315"></a>00315                 GradMap.append(G)
<a name="l00316"></a>00316                 Objective += ThisObj
<a name="l00317"></a>00317                 Gradient += ThisGrad
<a name="l00318"></a>00318                 Hessian += ThisHess
<a name="l00319"></a>00319         GradMapPrint = [[<span class="stringliteral">&quot;#PhasePoint&quot;</span>] + self.FF.plist]
<a name="l00320"></a>00320         <span class="keywordflow">for</span> PT, g <span class="keywordflow">in</span> zip(points,GradMap):
<a name="l00321"></a>00321             GradMapPrint.append([<span class="stringliteral">&#39; %8.2f %8.1f %3s&#39;</span> % PT] + [<span class="stringliteral">&quot;% 9.3e&quot;</span> % i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> g])
<a name="l00322"></a>00322         o = open(<span class="stringliteral">&#39;gradient_%s.dat&#39;</span> % name,<span class="stringliteral">&#39;w&#39;</span>)
<a name="l00323"></a>00323         <span class="keywordflow">for</span> line <span class="keywordflow">in</span> GradMapPrint:
<a name="l00324"></a>00324             <span class="keywordflow">print</span> &gt;&gt; o, <span class="stringliteral">&#39; &#39;</span>.join(line)
<a name="l00325"></a>00325         o.close()
<a name="l00326"></a>00326             
<a name="l00327"></a>00327         Delta = np.array([calc[PT] - exp[PT] <span class="keywordflow">for</span> PT <span class="keywordflow">in</span> points])
<a name="l00328"></a>00328         delt = {PT : r <span class="keywordflow">for</span> PT, r <span class="keywordflow">in</span> zip(points,Delta)}
<a name="l00329"></a>00329         print_out = OrderedDict([(<span class="stringliteral">&#39;    %8.2f %8.1f %3s&#39;</span> % PT,<span class="stringliteral">&quot;%9.3f    %9.3f +- %-7.3f % 7.3f % 9.5f % 9.5f&quot;</span> % (exp[PT],calc[PT],err[PT],delt[PT],Weights[PT],Objs[PT])) <span class="keywordflow">for</span> PT <span class="keywordflow">in</span> calc])
<a name="l00330"></a>00330         <span class="keywordflow">return</span> Objective, Gradient, Hessian, print_out
<a name="l00331"></a>00331 
<a name="l00332"></a>00332     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a716e28bb5572b3273036ac753b7e1e1d">submit_jobs</a>(self, mvals, AGrad=True, AHess=True):
<a name="l00333"></a>00333         <span class="comment"># This routine is called by Objective.stage() will run before &quot;get&quot;.</span>
<a name="l00334"></a>00334         <span class="comment"># It submits the jobs to the Work Queue and the stage() function will wait for jobs to complete.</span>
<a name="l00335"></a>00335         <span class="comment">#</span>
<a name="l00336"></a><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a716e28bb5572b3273036ac753b7e1e1d">00336</a>         <span class="comment"># First dump the force field to a pickle file</span>
<a name="l00337"></a>00337         with open(<span class="stringliteral">&#39;forcebalance.p&#39;</span>,<span class="stringliteral">&#39;w&#39;</span>) <span class="keyword">as</span> f: <a class="code" href="namespaceforcebalance_1_1nifty.html#a2ff762a2f2d2b6bb1c7dd067bd1a1e88" title="Use this instead of pickle.dump for pickling anything that contains _ElementTree types.">lp_dump</a>((self.FF,mvals,self.h,AGrad),f)
<a name="l00338"></a>00338 
<a name="l00339"></a>00339         <span class="comment"># Give the user an opportunity to copy over data from a previous (perhaps failed) run.</span>
<a name="l00340"></a>00340         <span class="keywordflow">if</span> <a class="code" href="namespaceforcebalance_1_1optimizer.html#ae1f6c649703a22b2f767a5f6bf53297b">Counter</a>() == 0 <span class="keywordflow">and</span> self.manual:
<a name="l00341"></a>00341             <a class="code" href="namespaceforcebalance_1_1nifty.html#abb8f59044961a12588e0653c2baa8b01">warn_press_key</a>(<span class="stringliteral">&quot;Now&#39;s our chance to fill the temp directory up with data!&quot;</span>, timeout=120)
<a name="l00342"></a>00342 
<a name="l00343"></a>00343         <span class="comment"># If self.save_traj == 1, delete the trajectory files from a previous good optimization step.</span>
<a name="l00344"></a>00344         <span class="keywordflow">if</span> <a class="code" href="namespaceforcebalance_1_1optimizer.html#ae1f6c649703a22b2f767a5f6bf53297b">Counter</a>() &gt; 0 <span class="keywordflow">and</span> (Counter == 1 <span class="keywordflow">or</span> <a class="code" href="namespaceforcebalance_1_1optimizer.html#ab43948ecf30c90d319e0c0b107fe484a">GoodStep</a>()) <span class="keywordflow">and</span> self.save_traj &lt; 2:
<a name="l00345"></a>00345             <span class="keywordflow">for</span> fn <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#acf4158ed2337a04bdee3ee3f2f16283c">last_traj</a>:
<a name="l00346"></a>00346                 <span class="keywordflow">if</span> os.path.exists(fn):
<a name="l00347"></a>00347                     os.remove(fn)
<a name="l00348"></a>00348         self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#acf4158ed2337a04bdee3ee3f2f16283c">last_traj</a> = []
<a name="l00349"></a>00349 
<a name="l00350"></a>00350         <span class="comment"># Set up and run the NPT simulations.</span>
<a name="l00351"></a>00351         snum = 0
<a name="l00352"></a>00352         <span class="keywordflow">for</span> label, pt <span class="keywordflow">in</span> zip(self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a16afa7eeca3234f74f60ac085dd8eb5b">Labels</a>, self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2333919b4fc49482ed23b5e66eaa0ea8">PhasePoints</a>):
<a name="l00353"></a>00353             T = pt[0]
<a name="l00354"></a>00354             P = pt[1]
<a name="l00355"></a>00355             Punit = pt[2]
<a name="l00356"></a>00356             <span class="keywordflow">if</span> Punit == <span class="stringliteral">&#39;bar&#39;</span>:
<a name="l00357"></a>00357                 P *= 1.0 / 1.01325
<a name="l00358"></a>00358             <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(label):
<a name="l00359"></a>00359                 os.makedirs(label)
<a name="l00360"></a>00360                 os.chdir(label)
<a name="l00361"></a>00361                 self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a07a59f9f335693329b789a9c7608fc9f" title="Submit a NPT simulation to the Work Queue.">npt_simulation</a>(T,P,snum)
<a name="l00362"></a>00362                 os.chdir(<span class="stringliteral">&#39;..&#39;</span>)
<a name="l00363"></a>00363                 snum += 1
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a802c4139e5c002fabdeab5de88093880" title="Fitting of liquid bulk properties.">get</a>(self, mvals, AGrad=True, AHess=True):
<a name="l00366"></a>00366         
<a name="l00367"></a>00367         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00368"></a>00368 <span class="stringliteral">        Fitting of liquid bulk properties.  This is the current major</span>
<a name="l00369"></a>00369 <span class="stringliteral">        direction of development for ForceBalance.  Basically, fitting</span>
<a name="l00370"></a>00370 <span class="stringliteral">        the QM energies / forces alone does not always give us the</span>
<a name="l00371"></a>00371 <span class="stringliteral">        best simulation behavior.  In many cases it makes more sense</span>
<a name="l00372"></a>00372 <span class="stringliteral">        to try and reproduce some experimentally known data as well.</span>
<a name="l00373"></a>00373 <span class="stringliteral"></span>
<a name="l00374"></a>00374 <span class="stringliteral">        In order to reproduce experimentally known data, we need to</span>
<a name="l00375"></a>00375 <span class="stringliteral">        run a simulation and compare the simulation result to</span>
<a name="l00376"></a>00376 <span class="stringliteral">        experiment.  The main challenge here is that the simulations</span>
<a name="l00377"></a>00377 <span class="stringliteral">        are computationally intensive (i.e. they require energy and</span>
<a name="l00378"></a>00378 <span class="stringliteral">        force evaluations), and furthermore the results are noisy.  We</span>
<a name="l00379"></a>00379 <span class="stringliteral">        need to run the simulations automatically and remotely</span>
<a name="l00380"></a>00380 <span class="stringliteral">        (i.e. on clusters) and a good way to calculate the derivatives</span>
<a name="l00381"></a>00381 <span class="stringliteral">        of the simulation results with respect to the parameter values.</span>
<a name="l00382"></a>00382 <span class="stringliteral"></span>
<a name="l00383"></a>00383 <span class="stringliteral">        This function contains some experimentally known values of the</span>
<a name="l00384"></a>00384 <span class="stringliteral">        density and enthalpy of vaporization (Hvap) of liquid water.</span>
<a name="l00385"></a>00385 <span class="stringliteral">        It launches the density and Hvap calculations on the cluster,</span>
<a name="l00386"></a>00386 <span class="stringliteral">        and gathers the results / derivatives.  The actual calculation</span>
<a name="l00387"></a>00387 <span class="stringliteral">        of results / derivatives is done in a separate file.</span>
<a name="l00388"></a>00388 <span class="stringliteral"></span>
<a name="l00389"></a>00389 <span class="stringliteral">        After the results come back, they are gathered together to form</span>
<a name="l00390"></a>00390 <span class="stringliteral">        an objective function.</span>
<a name="l00391"></a>00391 <span class="stringliteral"></span>
<a name="l00392"></a>00392 <span class="stringliteral">        @param[in] mvals Mathematical parameter values</span>
<a name="l00393"></a>00393 <span class="stringliteral">        @param[in] AGrad Switch to turn on analytic gradient</span>
<a name="l00394"></a>00394 <span class="stringliteral">        @param[in] AHess Switch to turn on analytic Hessian</span>
<a name="l00395"></a>00395 <span class="stringliteral">        @return Answer Contribution to the objective function</span>
<a name="l00396"></a>00396 <span class="stringliteral">        </span>
<a name="l00397"></a>00397 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00398"></a>00398 
<a name="l00399"></a>00399         Answer = {}
<a name="l00400"></a>00400 
<a name="l00401"></a><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a802c4139e5c002fabdeab5de88093880">00401</a>         Results = {}
<a name="l00402"></a>00402         Points = []  <span class="comment"># These are the phase points for which data exists.</span>
<a name="l00403"></a>00403         BPoints = [] <span class="comment"># These are the phase points for which we are doing MBAR for the condensed phase.</span>
<a name="l00404"></a>00404         mPoints = [] <span class="comment"># These are the phase points to use for enthalpy of vaporization; if we&#39;re scanning pressure then set hvap_wt for higher pressures to zero.</span>
<a name="l00405"></a>00405         tt = 0
<a name="l00406"></a>00406         <span class="keywordflow">for</span> label, PT <span class="keywordflow">in</span> zip(self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a16afa7eeca3234f74f60ac085dd8eb5b">Labels</a>, self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2333919b4fc49482ed23b5e66eaa0ea8">PhasePoints</a>):
<a name="l00407"></a>00407             <span class="keywordflow">if</span> os.path.exists(<span class="stringliteral">&#39;./%s/npt_result.p.bz2&#39;</span> % label):
<a name="l00408"></a><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a677f8c01349a91716e10353633a4c5c1">00408</a>                 os.system(<span class="stringliteral">&#39;bunzip2 ./%s/npt_result.p.bz2&#39;</span> % label)
<a name="l00409"></a>00409             <span class="keywordflow">if</span> os.path.exists(<span class="stringliteral">&#39;./%s/npt_result.p&#39;</span> % label):
<a name="l00410"></a>00410                 Points.append(PT)
<a name="l00411"></a>00411                 Results[tt] = <a class="code" href="namespaceforcebalance_1_1nifty.html#a577abfd36638c5f4dfdade136abaef12" title="Use this instead of pickle.load for unpickling anything that contains _ElementTree types...">lp_load</a>(open(<span class="stringliteral">&#39;./%s/npt_result.p&#39;</span> % label))
<a name="l00412"></a>00412                 <span class="keywordflow">if</span> <span class="stringliteral">&#39;hvap&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a> <span class="keywordflow">and</span> PT[0] <span class="keywordflow">not</span> <span class="keywordflow">in</span> [i[0] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> mPoints]:
<a name="l00413"></a>00413                     mPoints.append(PT)
<a name="l00414"></a>00414                 <span class="keywordflow">if</span> <span class="stringliteral">&#39;mbar&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a> <span class="keywordflow">and</span> PT <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[<span class="stringliteral">&#39;mbar&#39;</span>] <span class="keywordflow">and</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[<span class="stringliteral">&#39;mbar&#39;</span>][PT]:
<a name="l00415"></a>00415                     BPoints.append(PT)
<a name="l00416"></a>00416                 tt += 1
<a name="l00417"></a>00417             <span class="keywordflow">else</span>:
<a name="l00418"></a>00418                 <span class="keywordflow">pass</span>
<a name="l00419"></a>00419                 <span class="comment"># for obs in self.RefData:</span>
<a name="l00420"></a>00420                 <span class="comment">#     del self.RefData[obs][PT]</span>
<a name="l00421"></a>00421         <span class="keywordflow">if</span> len(Points) == 0:
<a name="l00422"></a>00422             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;The liquid simulations have terminated with \x1b[1;91mno readable data\x1b[0m - this is a problem!&#39;</span>)
<a name="l00423"></a>00423 
<a name="l00424"></a>00424         <span class="comment"># Assign variable names to all the stuff in npt_result.p</span>
<a name="l00425"></a>00425         Rhos, Vols, Potentials, Energies, Dips, Grads, GDips, mPotentials, mEnergies, mGrads, \
<a name="l00426"></a>00426             Rho_errs, Hvap_errs, Alpha_errs, Kappa_errs, Cp_errs, Eps0_errs, NMols = ([Results[t][i] <span class="keywordflow">for</span> t <span class="keywordflow">in</span> range(len(Points))] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(17))
<a name="l00427"></a>00427         <span class="comment"># Determine the number of molecules</span>
<a name="l00428"></a>00428         <span class="keywordflow">if</span> len(set(NMols)) != 1:
<a name="l00429"></a>00429             logger.error(str(NMols))
<a name="l00430"></a>00430             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;The above list should only contain one number - the number of molecules&#39;</span>)
<a name="l00431"></a>00431         <span class="keywordflow">else</span>:
<a name="l00432"></a>00432             NMol = list(set(NMols))[0]
<a name="l00433"></a>00433     
<a name="l00434"></a>00434         R  = np.array(list(itertools.chain(*list(Rhos))))
<a name="l00435"></a>00435         V  = np.array(list(itertools.chain(*list(Vols))))
<a name="l00436"></a>00436         E  = np.array(list(itertools.chain(*list(Energies))))
<a name="l00437"></a>00437         Dx = np.array(list(itertools.chain(*list(d[:,0] <span class="keywordflow">for</span> d <span class="keywordflow">in</span> Dips))))
<a name="l00438"></a>00438         Dy = np.array(list(itertools.chain(*list(d[:,1] <span class="keywordflow">for</span> d <span class="keywordflow">in</span> Dips))))
<a name="l00439"></a>00439         Dz = np.array(list(itertools.chain(*list(d[:,2] <span class="keywordflow">for</span> d <span class="keywordflow">in</span> Dips))))
<a name="l00440"></a>00440         G  = np.hstack(tuple(Grads))
<a name="l00441"></a>00441         GDx = np.hstack(tuple(gd[0] <span class="keywordflow">for</span> gd <span class="keywordflow">in</span> GDips))
<a name="l00442"></a>00442         GDy = np.hstack(tuple(gd[1] <span class="keywordflow">for</span> gd <span class="keywordflow">in</span> GDips))
<a name="l00443"></a>00443         GDz = np.hstack(tuple(gd[2] <span class="keywordflow">for</span> gd <span class="keywordflow">in</span> GDips))
<a name="l00444"></a>00444         <span class="keywordflow">if</span> len(mPoints) &gt; 0:
<a name="l00445"></a>00445             mE = np.array(list(itertools.chain(*list([i <span class="keywordflow">for</span> pt, i <span class="keywordflow">in</span> zip(Points,mEnergies) <span class="keywordflow">if</span> pt <span class="keywordflow">in</span> mPoints]))))
<a name="l00446"></a>00446             mG = np.hstack(tuple([i <span class="keywordflow">for</span> pt, i <span class="keywordflow">in</span> zip(Points,mGrads) <span class="keywordflow">if</span> pt <span class="keywordflow">in</span> mPoints]))
<a name="l00447"></a>00447 
<a name="l00448"></a>00448         Rho_calc = OrderedDict([])
<a name="l00449"></a>00449         Rho_grad = OrderedDict([])
<a name="l00450"></a>00450         Rho_std  = OrderedDict([])
<a name="l00451"></a>00451         Hvap_calc = OrderedDict([])
<a name="l00452"></a>00452         Hvap_grad = OrderedDict([])
<a name="l00453"></a>00453         Hvap_std  = OrderedDict([])
<a name="l00454"></a>00454         Alpha_calc = OrderedDict([])
<a name="l00455"></a>00455         Alpha_grad = OrderedDict([])
<a name="l00456"></a>00456         Alpha_std  = OrderedDict([])
<a name="l00457"></a>00457         Kappa_calc = OrderedDict([])
<a name="l00458"></a>00458         Kappa_grad = OrderedDict([])
<a name="l00459"></a>00459         Kappa_std  = OrderedDict([])
<a name="l00460"></a>00460         Cp_calc = OrderedDict([])
<a name="l00461"></a>00461         Cp_grad = OrderedDict([])
<a name="l00462"></a>00462         Cp_std  = OrderedDict([])
<a name="l00463"></a>00463         Eps0_calc = OrderedDict([])
<a name="l00464"></a>00464         Eps0_grad = OrderedDict([])
<a name="l00465"></a>00465         Eps0_std  = OrderedDict([])
<a name="l00466"></a>00466 
<a name="l00467"></a>00467         <span class="comment"># The unit that converts atmospheres * nm**3 into kj/mol :)</span>
<a name="l00468"></a>00468         pvkj=0.061019351687175
<a name="l00469"></a>00469 
<a name="l00470"></a>00470         <span class="comment"># Run MBAR using the total energies. Required for estimates that use the kinetic energy.</span>
<a name="l00471"></a>00471         BSims = len(BPoints)
<a name="l00472"></a>00472         Shots = len(Energies[0])
<a name="l00473"></a>00473         N_k = np.ones(BSims)*Shots
<a name="l00474"></a>00474         <span class="comment"># Use the value of the energy for snapshot t from simulation k at potential m</span>
<a name="l00475"></a>00475         U_kln = np.zeros([BSims,BSims,Shots], dtype = np.float64)
<a name="l00476"></a>00476         <span class="keywordflow">for</span> m, PT <span class="keywordflow">in</span> enumerate(BPoints):
<a name="l00477"></a>00477             T = PT[0]
<a name="l00478"></a>00478             P = PT[1] / 1.01325 <span class="keywordflow">if</span> PT[2] == <span class="stringliteral">&#39;bar&#39;</span> <span class="keywordflow">else</span> PT[1]
<a name="l00479"></a>00479             beta = 1. / (kb * T)
<a name="l00480"></a>00480             <span class="keywordflow">for</span> k <span class="keywordflow">in</span> range(BSims):
<a name="l00481"></a>00481                 <span class="comment"># The correct Boltzmann factors include PV.</span>
<a name="l00482"></a>00482                 <span class="comment"># Note that because the Boltzmann factors are computed from the conditions at simulation &quot;m&quot;,</span>
<a name="l00483"></a>00483                 <span class="comment"># the pV terms must be rescaled to the pressure at simulation &quot;m&quot;.</span>
<a name="l00484"></a>00484                 kk = Points.index(BPoints[k])
<a name="l00485"></a>00485                 U_kln[k, m, :]   = Energies[kk] + P*Vols[kk]*pvkj
<a name="l00486"></a>00486                 U_kln[k, m, :]  *= beta
<a name="l00487"></a>00487         <span class="keywordflow">if</span> len(BPoints) &gt; 1:
<a name="l00488"></a>00488             logger.info(<span class="stringliteral">&quot;Running MBAR analysis on %i states...\n&quot;</span> % len(BPoints))
<a name="l00489"></a>00489             mbar = pymbar.MBAR(U_kln, N_k, verbose=<span class="keyword">True</span>, relative_tolerance=5.0e-8)
<a name="l00490"></a>00490             W1 = mbar.getWeights()
<a name="l00491"></a>00491             logger.info(<span class="stringliteral">&quot;Done\n&quot;</span>)
<a name="l00492"></a>00492         <span class="keywordflow">elif</span> len(BPoints) == 1:
<a name="l00493"></a>00493             W1 = np.ones((BPoints*Shots,BPoints),dtype=float)
<a name="l00494"></a>00494             W1 /= BPoints*Shots
<a name="l00495"></a>00495         
<a name="l00496"></a>00496         W2 = np.zeros([len(Points)*Shots,len(Points)],dtype=np.float64)
<a name="l00497"></a>00497         <span class="keywordflow">for</span> m, PT <span class="keywordflow">in</span> enumerate(Points):
<a name="l00498"></a>00498             <span class="keywordflow">if</span> PT <span class="keywordflow">in</span> BPoints:
<a name="l00499"></a>00499                 mm = BPoints.index(PT)
<a name="l00500"></a>00500                 <span class="keywordflow">for</span> kk, PT1 <span class="keywordflow">in</span> enumerate(BPoints):
<a name="l00501"></a>00501                     k = Points.index(PT1)
<a name="l00502"></a>00502                     logger.debug(<span class="stringliteral">&quot;Will fill W2[%i:%i,%i] with W1[%i:%i,%i]\n&quot;</span> % (k*Shots,k*Shots+Shots,m,kk*Shots,kk*Shots+Shots,mm))
<a name="l00503"></a>00503                     W2[k*Shots:k*Shots+Shots,m] = W1[kk*Shots:kk*Shots+Shots,mm]
<a name="l00504"></a>00504             <span class="keywordflow">else</span>:
<a name="l00505"></a>00505                 logger.debug(<span class="stringliteral">&quot;Will fill W2[%i:%i,%i] with equal weights\n&quot;</span> % (m*Shots,m*Shots+Shots,m))
<a name="l00506"></a>00506                 W2[m*Shots:m*Shots+Shots,m] = 1.0/Shots
<a name="l00507"></a>00507 
<a name="l00508"></a>00508         <span class="comment"># Run MBAR on the monomers.  This is barely necessary.</span>
<a name="l00509"></a>00509         <span class="keywordflow">if</span> len(mPoints) &gt; 0:
<a name="l00510"></a>00510             mSims = len(mPoints)
<a name="l00511"></a>00511             mShots = len(mEnergies[0])
<a name="l00512"></a>00512             mN_k = np.ones(mSims)*mShots
<a name="l00513"></a>00513             mU_kln = np.zeros([mSims,mSims,mShots], dtype = np.float64)
<a name="l00514"></a>00514             <span class="keywordflow">for</span> m, PT <span class="keywordflow">in</span> enumerate(mPoints):
<a name="l00515"></a>00515                 T = PT[0]
<a name="l00516"></a>00516                 beta = 1. / (kb * T)
<a name="l00517"></a>00517                 <span class="keywordflow">for</span> k <span class="keywordflow">in</span> range(mSims):
<a name="l00518"></a>00518                     mU_kln[k, m, :]  = mEnergies[k]
<a name="l00519"></a>00519                     mU_kln[k, m, :] *= beta
<a name="l00520"></a>00520             <span class="keywordflow">if</span> np.abs(np.std(mEnergies)) &gt; 1e-6 <span class="keywordflow">and</span> mSims &gt; 1:
<a name="l00521"></a>00521                 mmbar = pymbar.MBAR(mU_kln, mN_k, verbose=<span class="keyword">False</span>, relative_tolerance=5.0e-8, method=<span class="stringliteral">&#39;self-consistent-iteration&#39;</span>)
<a name="l00522"></a>00522                 mW1 = mmbar.getWeights()
<a name="l00523"></a>00523             <span class="keywordflow">else</span>:
<a name="l00524"></a>00524                 mW1 = np.ones((mSims*mShots,mSims),dtype=float)
<a name="l00525"></a>00525                 mW1 /= mSims*mShots
<a name="l00526"></a>00526 
<a name="l00527"></a>00527         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#af7ba85e825dfe42a384c2eb2e7cc1f0c">do_self_pol</a>:
<a name="l00528"></a>00528             EPol = self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a51ea9d9fb4418ec2497fe8e2d8033d41" title="Return the self-polarization correction as described in Berendsen et al., JPC 1987.">polarization_correction</a>(mvals)
<a name="l00529"></a>00529             GEPol = np.array([<a class="code" href="namespaceforcebalance_1_1finite__difference.html#aa69a8819e4680091f400303c1d6ddeb7" title="A three-point finite difference stencil.">f12d3p</a>(<a class="code" href="namespaceforcebalance_1_1finite__difference.html#ae484c591ae8c4e5bae73a0ef2660c339" title="A function wrapper for finite difference designed for differentiating &#39;get&#39;-type functions.">fdwrap</a>(self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a51ea9d9fb4418ec2497fe8e2d8033d41" title="Return the self-polarization correction as described in Berendsen et al., JPC 1987.">polarization_correction</a>, mvals, p), h = self.h, f0 = EPol)[0] <span class="keywordflow">for</span> p <span class="keywordflow">in</span> range(self.FF.np)])
<a name="l00530"></a>00530             bar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Self-polarization correction to \nenthalpy of vaporization is % .3f kJ/mol%s&quot;</span> % (EPol, <span class="stringliteral">&quot;, Derivative:&quot;</span> <span class="keywordflow">if</span> AGrad <span class="keywordflow">else</span> <span class="stringliteral">&quot;&quot;</span>))
<a name="l00531"></a>00531             <span class="keywordflow">if</span> AGrad:
<a name="l00532"></a>00532                 self.FF.print_map(vals=GEPol)
<a name="l00533"></a>00533                 logger.info(bar)
<a name="l00534"></a>00534             
<a name="l00535"></a>00535         <span class="keywordflow">for</span> i, PT <span class="keywordflow">in</span> enumerate(Points):
<a name="l00536"></a>00536             T = PT[0]
<a name="l00537"></a>00537             P = PT[1] / 1.01325 <span class="keywordflow">if</span> PT[2] == <span class="stringliteral">&#39;bar&#39;</span> <span class="keywordflow">else</span> PT[1]
<a name="l00538"></a>00538             PV = P*V*pvkj
<a name="l00539"></a>00539             H = E + PV
<a name="l00540"></a>00540             <span class="comment"># The weights that we want are the last ones.</span>
<a name="l00541"></a>00541             W = <a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(W2[:,i])
<a name="l00542"></a>00542             C = <a class="code" href="namespaceforcebalance_1_1liquid.html#a6f7d54263236f8788c319aee86b460b6">weight_info</a>(W, PT, np.ones(len(Points), dtype=np.float64)*Shots, verbose=<span class="keyword">True</span>)
<a name="l00543"></a>00543             Gbar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(np.mat(G)*<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(W))
<a name="l00544"></a>00544             mBeta = -1/kb/T
<a name="l00545"></a>00545             Beta  = 1/kb/T
<a name="l00546"></a>00546             kT    = kb*T
<a name="l00547"></a>00547             <span class="comment"># Define some things to make the analytic derivatives easier.</span>
<a name="l00548"></a>00548             <span class="keyword">def </span>avg(vec):
<a name="l00549"></a>00549                 <span class="keywordflow">return</span> np.dot(W,vec)
<a name="l00550"></a>00550             <span class="keyword">def </span>covde(vec):
<a name="l00551"></a>00551                 <span class="keywordflow">return</span> <a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(np.mat(G)*<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(W*vec)) - avg(vec)*Gbar
<a name="l00552"></a>00552             <span class="keyword">def </span>deprod(vec):
<a name="l00553"></a>00553                 <span class="keywordflow">return</span> <a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(np.mat(G)*<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(W*vec))
<a name="l00554"></a>00554             <span class="comment">## Density.</span>
<a name="l00555"></a>00555             Rho_calc[PT]   = np.dot(W,R)
<a name="l00556"></a>00556             Rho_grad[PT]   = mBeta*(<a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(np.mat(G)*<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(W*R)) - np.dot(W,R)*Gbar)
<a name="l00557"></a>00557             <span class="comment">## Enthalpy of vaporization.</span>
<a name="l00558"></a>00558             <span class="keywordflow">if</span> PT <span class="keywordflow">in</span> mPoints:
<a name="l00559"></a>00559                 ii = mPoints.index(PT)
<a name="l00560"></a>00560                 mW = <a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(mW1[:,ii])
<a name="l00561"></a>00561                 mGbar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(np.mat(mG)*<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(mW))
<a name="l00562"></a>00562                 Hvap_calc[PT]  = np.dot(mW,mE) - np.dot(W,E)/NMol + kb*T - np.dot(W, PV)/NMol
<a name="l00563"></a>00563                 Hvap_grad[PT]  = mGbar + mBeta*(<a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(np.mat(mG)*<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(mW*mE)) - np.dot(mW,mE)*mGbar)
<a name="l00564"></a>00564                 Hvap_grad[PT] -= (Gbar + mBeta*(<a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(np.mat(G)*<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(W*E)) - np.dot(W,E)*Gbar)) / NMol
<a name="l00565"></a>00565                 Hvap_grad[PT] -= (mBeta*(<a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(np.mat(G)*<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(W*PV)) - np.dot(W,PV)*Gbar)) / NMol
<a name="l00566"></a>00566                 <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#af7ba85e825dfe42a384c2eb2e7cc1f0c">do_self_pol</a>:
<a name="l00567"></a>00567                     Hvap_calc[PT] -= EPol
<a name="l00568"></a>00568                     Hvap_grad[PT] -= GEPol
<a name="l00569"></a>00569                 <span class="keywordflow">if</span> hasattr(self,<span class="stringliteral">&#39;use_cni&#39;</span>) <span class="keywordflow">and</span> self.use_cni:
<a name="l00570"></a>00570                     <span class="keywordflow">if</span> <span class="keywordflow">not</span> (<span class="stringliteral">&#39;cni&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a> <span class="keywordflow">and</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[<span class="stringliteral">&#39;cni&#39;</span>][PT]):
<a name="l00571"></a>00571                         <span class="keywordflow">raise</span> RuntimeError(<span class="stringliteral">&#39;Asked for a nonideality correction but not provided in reference data (data.csv).  Either disable the option in data.csv or add data.&#39;</span>)
<a name="l00572"></a>00572                     logger.info(<span class="stringliteral">&quot;Adding % .3f to enthalpy of vaporization at &quot;</span> % self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[<span class="stringliteral">&#39;cni&#39;</span>][PT] + str(PT) + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00573"></a>00573                     Hvap_calc[PT] += self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[<span class="stringliteral">&#39;cni&#39;</span>][PT]
<a name="l00574"></a>00574                 <span class="keywordflow">if</span> hasattr(self,<span class="stringliteral">&#39;use_cvib_intra&#39;</span>) <span class="keywordflow">and</span> self.use_cvib_intra:
<a name="l00575"></a>00575                     <span class="keywordflow">if</span> <span class="keywordflow">not</span> (<span class="stringliteral">&#39;cvib_intra&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a> <span class="keywordflow">and</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[<span class="stringliteral">&#39;cvib_intra&#39;</span>][PT]):
<a name="l00576"></a>00576                         <span class="keywordflow">raise</span> RuntimeError(<span class="stringliteral">&#39;Asked for a quantum intramolecular vibrational correction but not provided in reference data (data.csv).  Either disable the option in data.csv or add data.&#39;</span>)
<a name="l00577"></a>00577                     logger.info(<span class="stringliteral">&quot;Adding % .3f to enthalpy of vaporization at &quot;</span> % self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[<span class="stringliteral">&#39;cvib_intra&#39;</span>][PT] + str(PT) + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00578"></a>00578                     Hvap_calc[PT] += self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[<span class="stringliteral">&#39;cvib_intra&#39;</span>][PT]
<a name="l00579"></a>00579                 <span class="keywordflow">if</span> hasattr(self,<span class="stringliteral">&#39;use_cvib_inter&#39;</span>) <span class="keywordflow">and</span> self.use_cvib_inter:
<a name="l00580"></a>00580                     <span class="keywordflow">if</span> <span class="keywordflow">not</span> (<span class="stringliteral">&#39;cvib_inter&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a> <span class="keywordflow">and</span> self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[<span class="stringliteral">&#39;cvib_inter&#39;</span>][PT]):
<a name="l00581"></a>00581                         <span class="keywordflow">raise</span> RuntimeError(<span class="stringliteral">&#39;Asked for a quantum intermolecular vibrational correction but not provided in reference data (data.csv).  Either disable the option in data.csv or add data.&#39;</span>)
<a name="l00582"></a>00582                     logger.info(<span class="stringliteral">&quot;Adding % .3f to enthalpy of vaporization at &quot;</span> % self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[<span class="stringliteral">&#39;cvib_inter&#39;</span>][PT] + str(PT) + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00583"></a>00583                     Hvap_calc[PT] += self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[<span class="stringliteral">&#39;cvib_inter&#39;</span>][PT]
<a name="l00584"></a>00584             <span class="keywordflow">else</span>:
<a name="l00585"></a>00585                 Hvap_calc[PT]  = 0.0
<a name="l00586"></a>00586                 Hvap_grad[PT]  = np.zeros(self.FF.np,dtype=float)
<a name="l00587"></a>00587             <span class="comment">## Thermal expansion coefficient.</span>
<a name="l00588"></a>00588             Alpha_calc[PT] = 1e4 * (avg(H*V)-avg(H)*avg(V))/avg(V)/(kT*T)
<a name="l00589"></a>00589             GAlpha1 = -1 * Beta * deprod(H*V) * avg(V) / avg(V)**2
<a name="l00590"></a>00590             GAlpha2 = +1 * Beta * avg(H*V) * deprod(V) / avg(V)**2
<a name="l00591"></a>00591             GAlpha3 = deprod(V)/avg(V) - Gbar
<a name="l00592"></a>00592             GAlpha4 = Beta * covde(H)
<a name="l00593"></a>00593             Alpha_grad[PT] = 1e4 * (GAlpha1 + GAlpha2 + GAlpha3 + GAlpha4)/(kT*T)
<a name="l00594"></a>00594             <span class="comment">## Isothermal compressibility.</span>
<a name="l00595"></a>00595             bar_unit = 0.06022141793 * 1e6
<a name="l00596"></a>00596             Kappa_calc[PT] = bar_unit / kT * (avg(V**2)-avg(V)**2)/avg(V)
<a name="l00597"></a>00597             GKappa1 = +1 * Beta**2 * avg(V**2) * deprod(V) / avg(V)**2
<a name="l00598"></a>00598             GKappa2 = -1 * Beta**2 * avg(V) * deprod(V**2) / avg(V)**2
<a name="l00599"></a>00599             GKappa3 = +1 * Beta**2 * covde(V)
<a name="l00600"></a>00600             Kappa_grad[PT] = bar_unit*(GKappa1 + GKappa2 + GKappa3)
<a name="l00601"></a>00601             <span class="comment">## Isobaric heat capacity.</span>
<a name="l00602"></a>00602             Cp_calc[PT] = 1000/(4.184*NMol*kT*T) * (avg(H**2) - avg(H)**2)
<a name="l00603"></a>00603             <span class="keywordflow">if</span> hasattr(self,<span class="stringliteral">&#39;use_cvib_intra&#39;</span>) <span class="keywordflow">and</span> self.use_cvib_intra:
<a name="l00604"></a>00604                 logger.info(<span class="stringliteral">&quot;Adding &quot;</span> + str(self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[<span class="stringliteral">&#39;devib_intra&#39;</span>][PT]) + <span class="stringliteral">&quot; to the heat capacity\n&quot;</span>)
<a name="l00605"></a>00605                 Cp_calc[PT] += self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[<span class="stringliteral">&#39;devib_intra&#39;</span>][PT]
<a name="l00606"></a>00606             <span class="keywordflow">if</span> hasattr(self,<span class="stringliteral">&#39;use_cvib_inter&#39;</span>) <span class="keywordflow">and</span> self.use_cvib_inter:
<a name="l00607"></a>00607                 logger.info(<span class="stringliteral">&quot;Adding &quot;</span> + str(self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[<span class="stringliteral">&#39;devib_inter&#39;</span>][PT]) + <span class="stringliteral">&quot; to the heat capacity\n&quot;</span>)
<a name="l00608"></a>00608                 Cp_calc[PT] += self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a2567b4431d446cbe76e491c00ac9b6c1">RefData</a>[<span class="stringliteral">&#39;devib_inter&#39;</span>][PT]
<a name="l00609"></a>00609             GCp1 = 2*covde(H) * 1000 / 4.184 / (NMol*kT*T)
<a name="l00610"></a>00610             GCp2 = mBeta*covde(H**2) * 1000 / 4.184 / (NMol*kT*T)
<a name="l00611"></a>00611             GCp3 = 2*Beta*avg(H)*covde(H) * 1000 / 4.184 / (NMol*kT*T)
<a name="l00612"></a>00612             Cp_grad[PT] = GCp1 + GCp2 + GCp3
<a name="l00613"></a>00613             <span class="comment">## Static dielectric constant.</span>
<a name="l00614"></a>00614             prefactor = 30.348705333964077
<a name="l00615"></a>00615             D2 = avg(Dx**2)+avg(Dy**2)+avg(Dz**2)-avg(Dx)**2-avg(Dy)**2-avg(Dz)**2
<a name="l00616"></a>00616             Eps0_calc[PT] = 1.0 + prefactor*(D2/avg(V))/T
<a name="l00617"></a>00617             GD2  = 2*(<a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(np.mat(GDx)*<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(W*Dx)) - avg(Dx)*<a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(np.mat(GDx)*<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(W))) - Beta*(covde(Dx**2) - 2*avg(Dx)*covde(Dx))
<a name="l00618"></a>00618             GD2 += 2*(<a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(np.mat(GDy)*<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(W*Dy)) - avg(Dy)*<a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(np.mat(GDy)*<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(W))) - Beta*(covde(Dy**2) - 2*avg(Dy)*covde(Dy))
<a name="l00619"></a>00619             GD2 += 2*(<a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(np.mat(GDz)*<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(W*Dz)) - avg(Dz)*<a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(np.mat(GDz)*<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(W))) - Beta*(covde(Dz**2) - 2*avg(Dz)*covde(Dz))
<a name="l00620"></a>00620             Eps0_grad[PT] = prefactor*(GD2/avg(V) - mBeta*covde(V)*D2/avg(V)**2)/T
<a name="l00621"></a>00621             <span class="comment">## Estimation of errors.</span>
<a name="l00622"></a>00622             Rho_std[PT]    = np.sqrt(sum(C**2 * np.array(Rho_errs)**2))
<a name="l00623"></a>00623             <span class="keywordflow">if</span> PT <span class="keywordflow">in</span> mPoints:
<a name="l00624"></a>00624                 Hvap_std[PT]   = np.sqrt(sum(C**2 * np.array(Hvap_errs)**2))
<a name="l00625"></a>00625             <span class="keywordflow">else</span>:
<a name="l00626"></a>00626                 Hvap_std[PT]   = 0.0
<a name="l00627"></a>00627             Alpha_std[PT]   = np.sqrt(sum(C**2 * np.array(Alpha_errs)**2)) * 1e4
<a name="l00628"></a>00628             Kappa_std[PT]   = np.sqrt(sum(C**2 * np.array(Kappa_errs)**2)) * 1e6
<a name="l00629"></a>00629             Cp_std[PT]   = np.sqrt(sum(C**2 * np.array(Cp_errs)**2))
<a name="l00630"></a>00630             Eps0_std[PT]   = np.sqrt(sum(C**2 * np.array(Eps0_errs)**2))
<a name="l00631"></a>00631 
<a name="l00632"></a>00632         <span class="comment"># Get contributions to the objective function</span>
<a name="l00633"></a>00633         X_Rho, G_Rho, H_Rho, RhoPrint = self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a00c23db61bcb86cc19f79dacdb2bc1f3">objective_term</a>(Points, <span class="stringliteral">&#39;rho&#39;</span>, Rho_calc, Rho_std, Rho_grad, name=<span class="stringliteral">&quot;Density&quot;</span>)
<a name="l00634"></a>00634         X_Hvap, G_Hvap, H_Hvap, HvapPrint = self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a00c23db61bcb86cc19f79dacdb2bc1f3">objective_term</a>(Points, <span class="stringliteral">&#39;hvap&#39;</span>, Hvap_calc, Hvap_std, Hvap_grad, name=<span class="stringliteral">&quot;H_vap&quot;</span>, SubAverage=self.hvap_subaverage)
<a name="l00635"></a>00635         X_Alpha, G_Alpha, H_Alpha, AlphaPrint = self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a00c23db61bcb86cc19f79dacdb2bc1f3">objective_term</a>(Points, <span class="stringliteral">&#39;alpha&#39;</span>, Alpha_calc, Alpha_std, Alpha_grad, name=<span class="stringliteral">&quot;Thermal Expansion&quot;</span>)
<a name="l00636"></a>00636         X_Kappa, G_Kappa, H_Kappa, KappaPrint = self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a00c23db61bcb86cc19f79dacdb2bc1f3">objective_term</a>(Points, <span class="stringliteral">&#39;kappa&#39;</span>, Kappa_calc, Kappa_std, Kappa_grad, name=<span class="stringliteral">&quot;Compressibility&quot;</span>)
<a name="l00637"></a>00637         X_Cp, G_Cp, H_Cp, CpPrint = self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a00c23db61bcb86cc19f79dacdb2bc1f3">objective_term</a>(Points, <span class="stringliteral">&#39;cp&#39;</span>, Cp_calc, Cp_std, Cp_grad, name=<span class="stringliteral">&quot;Heat Capacity&quot;</span>)
<a name="l00638"></a>00638         X_Eps0, G_Eps0, H_Eps0, Eps0Print = self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a00c23db61bcb86cc19f79dacdb2bc1f3">objective_term</a>(Points, <span class="stringliteral">&#39;eps0&#39;</span>, Eps0_calc, Eps0_std, Eps0_grad, name=<span class="stringliteral">&quot;Dielectric Constant&quot;</span>)
<a name="l00639"></a>00639 
<a name="l00640"></a>00640         Gradient = np.zeros(self.FF.np, dtype=float)
<a name="l00641"></a>00641         Hessian = np.zeros((self.FF.np,self.FF.np),dtype=float)
<a name="l00642"></a>00642 
<a name="l00643"></a>00643         <span class="keywordflow">if</span> X_Rho == 0: self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a677f8c01349a91716e10353633a4c5c1" title="Density.">w_rho</a> = 0.0
<a name="l00644"></a>00644         <span class="keywordflow">if</span> X_Hvap == 0: self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a7f43411fa6a9c39b63f1e82fe78ea597">w_hvap</a> = 0.0
<a name="l00645"></a>00645         <span class="keywordflow">if</span> X_Alpha == 0: self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a6ada133a0ceeb17e032f1337242afcf0">w_alpha</a> = 0.0
<a name="l00646"></a>00646         <span class="keywordflow">if</span> X_Kappa == 0: self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a19f8897aad045e3bf51eedba4606ac87">w_kappa</a> = 0.0
<a name="l00647"></a>00647         <span class="keywordflow">if</span> X_Cp == 0: self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a614365b5ac24f312c564e4f8d2b7b4cf">w_cp</a> = 0.0
<a name="l00648"></a>00648         <span class="keywordflow">if</span> X_Eps0 == 0: self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#af99c11c0ba5bbfcbc53bc8d7d6125465">w_eps0</a> = 0.0
<a name="l00649"></a>00649 
<a name="l00650"></a>00650         w_tot = self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a677f8c01349a91716e10353633a4c5c1" title="Density.">w_rho</a> + self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a7f43411fa6a9c39b63f1e82fe78ea597">w_hvap</a> + self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a6ada133a0ceeb17e032f1337242afcf0">w_alpha</a> + self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a19f8897aad045e3bf51eedba4606ac87">w_kappa</a> + self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a614365b5ac24f312c564e4f8d2b7b4cf">w_cp</a> + self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#af99c11c0ba5bbfcbc53bc8d7d6125465">w_eps0</a>
<a name="l00651"></a>00651         w_1 = self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a677f8c01349a91716e10353633a4c5c1" title="Density.">w_rho</a> / w_tot
<a name="l00652"></a>00652         w_2 = self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a7f43411fa6a9c39b63f1e82fe78ea597">w_hvap</a> / w_tot
<a name="l00653"></a>00653         w_3 = self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a6ada133a0ceeb17e032f1337242afcf0">w_alpha</a> / w_tot
<a name="l00654"></a>00654         w_4 = self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a19f8897aad045e3bf51eedba4606ac87">w_kappa</a> / w_tot
<a name="l00655"></a>00655         w_5 = self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a614365b5ac24f312c564e4f8d2b7b4cf">w_cp</a> / w_tot
<a name="l00656"></a>00656         w_6 = self.<a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#af99c11c0ba5bbfcbc53bc8d7d6125465">w_eps0</a> / w_tot
<a name="l00657"></a>00657 
<a name="l00658"></a>00658         Objective    = w_1 * X_Rho + w_2 * X_Hvap + w_3 * X_Alpha + w_4 * X_Kappa + w_5 * X_Cp + w_6 * X_Eps0
<a name="l00659"></a>00659         <span class="keywordflow">if</span> AGrad:
<a name="l00660"></a>00660             Gradient = w_1 * G_Rho + w_2 * G_Hvap + w_3 * G_Alpha + w_4 * G_Kappa + w_5 * G_Cp + w_6 * G_Eps0
<a name="l00661"></a>00661         <span class="keywordflow">if</span> AHess:
<a name="l00662"></a>00662             Hessian  = w_1 * H_Rho + w_2 * H_Hvap + w_3 * H_Alpha + w_4 * H_Kappa + w_5 * H_Cp + w_6 * H_Eps0
<a name="l00663"></a>00663 
<a name="l00664"></a>00664         PrintDict = OrderedDict()
<a name="l00665"></a>00665         <span class="keywordflow">if</span> X_Rho &gt; 0:
<a name="l00666"></a>00666             <a class="code" href="namespaceforcebalance_1_1nifty.html#a51180e960742cc7547749fdfb3513ec4" title="See documentation for printcool; this is a nice way to print out keys/values in a dictionary...">printcool_dictionary</a>(RhoPrint, title=<span class="stringliteral">&#39;%s Density (kg m^-3) \nTemperature  Pressure  Reference  Calculated +- Stdev     Delta    Weight    Term   &#39;</span> % self.name,bold=<span class="keyword">True</span>,color=4,keywidth=15)
<a name="l00667"></a>00667             bar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Density objective function: % .3f%s&quot;</span> % (X_Rho, <span class="stringliteral">&quot;, Derivative:&quot;</span> <span class="keywordflow">if</span> AGrad <span class="keywordflow">else</span> <span class="stringliteral">&quot;&quot;</span>))
<a name="l00668"></a>00668             <span class="keywordflow">if</span> AGrad:
<a name="l00669"></a>00669                 self.FF.print_map(vals=G_Rho)
<a name="l00670"></a>00670                 logger.info(bar)
<a name="l00671"></a>00671             PrintDict[<span class="stringliteral">&#39;Density&#39;</span>] = <span class="stringliteral">&quot;% 10.5f % 8.3f % 14.5e&quot;</span> % (X_Rho, w_1, X_Rho*w_1)
<a name="l00672"></a>00672 
<a name="l00673"></a>00673         <span class="keywordflow">if</span> X_Hvap &gt; 0:
<a name="l00674"></a>00674             <a class="code" href="namespaceforcebalance_1_1nifty.html#a51180e960742cc7547749fdfb3513ec4" title="See documentation for printcool; this is a nice way to print out keys/values in a dictionary...">printcool_dictionary</a>(HvapPrint, title=<span class="stringliteral">&#39;%s Enthalpy of Vaporization (kJ mol^-1) \nTemperature  Pressure  Reference  Calculated +- Stdev     Delta    Weight    Term   &#39;</span> % self.name,bold=<span class="keyword">True</span>,color=4,keywidth=15)
<a name="l00675"></a>00675             bar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;H_vap objective function: % .3f%s&quot;</span> % (X_Hvap, <span class="stringliteral">&quot;, Derivative:&quot;</span> <span class="keywordflow">if</span> AGrad <span class="keywordflow">else</span> <span class="stringliteral">&quot;&quot;</span>))
<a name="l00676"></a>00676             <span class="keywordflow">if</span> AGrad:
<a name="l00677"></a>00677                 self.FF.print_map(vals=G_Hvap)
<a name="l00678"></a>00678                 logger.info(bar)
<a name="l00679"></a>00679                 
<a name="l00680"></a>00680             PrintDict[<span class="stringliteral">&#39;Enthalpy of Vaporization&#39;</span>] = <span class="stringliteral">&quot;% 10.5f % 8.3f % 14.5e&quot;</span> % (X_Hvap, w_2, X_Hvap*w_2)
<a name="l00681"></a>00681 
<a name="l00682"></a>00682         <span class="keywordflow">if</span> X_Alpha &gt; 0:
<a name="l00683"></a>00683             <a class="code" href="namespaceforcebalance_1_1nifty.html#a51180e960742cc7547749fdfb3513ec4" title="See documentation for printcool; this is a nice way to print out keys/values in a dictionary...">printcool_dictionary</a>(AlphaPrint,title=<span class="stringliteral">&#39;%s Thermal Expansion Coefficient (10^-4 K^-1) \nTemperature  Pressure  Reference  Calculated +- Stdev     Delta    Weight    Term   &#39;</span> % self.name,bold=<span class="keyword">True</span>,color=4,keywidth=15)
<a name="l00684"></a>00684             bar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Thermal Expansion objective function: % .3f%s&quot;</span> % (X_Alpha, <span class="stringliteral">&quot;, Derivative:&quot;</span> <span class="keywordflow">if</span> AGrad <span class="keywordflow">else</span> <span class="stringliteral">&quot;&quot;</span>))
<a name="l00685"></a>00685             <span class="keywordflow">if</span> AGrad:
<a name="l00686"></a>00686                 self.FF.print_map(vals=G_Alpha)
<a name="l00687"></a>00687                 logger.info(bar)
<a name="l00688"></a>00688 
<a name="l00689"></a>00689             PrintDict[<span class="stringliteral">&#39;Thermal Expansion Coefficient&#39;</span>] = <span class="stringliteral">&quot;% 10.5f % 8.3f % 14.5e&quot;</span> % (X_Alpha, w_3, X_Alpha*w_3)
<a name="l00690"></a>00690 
<a name="l00691"></a>00691         <span class="keywordflow">if</span> X_Kappa &gt; 0:
<a name="l00692"></a>00692             <a class="code" href="namespaceforcebalance_1_1nifty.html#a51180e960742cc7547749fdfb3513ec4" title="See documentation for printcool; this is a nice way to print out keys/values in a dictionary...">printcool_dictionary</a>(KappaPrint,title=<span class="stringliteral">&#39;%s Isothermal Compressibility (10^-6 bar^-1) \nTemperature  Pressure  Reference  Calculated +- Stdev     Delta    Weight    Term   &#39;</span> % self.name,bold=<span class="keyword">True</span>,color=4,keywidth=15)
<a name="l00693"></a>00693             bar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Compressibility objective function: % .3f%s&quot;</span> % (X_Kappa, <span class="stringliteral">&quot;, Derivative:&quot;</span> <span class="keywordflow">if</span> AGrad <span class="keywordflow">else</span> <span class="stringliteral">&quot;&quot;</span>))
<a name="l00694"></a>00694             <span class="keywordflow">if</span> AGrad:
<a name="l00695"></a>00695                 self.FF.print_map(vals=G_Kappa)
<a name="l00696"></a>00696                 logger.info(bar)
<a name="l00697"></a>00697                 
<a name="l00698"></a>00698             PrintDict[<span class="stringliteral">&#39;Isothermal Compressibility&#39;</span>] = <span class="stringliteral">&quot;% 10.5f % 8.3f % 14.5e&quot;</span> % (X_Kappa, w_4, X_Kappa*w_4)
<a name="l00699"></a>00699 
<a name="l00700"></a>00700         <span class="keywordflow">if</span> X_Cp &gt; 0:
<a name="l00701"></a>00701             <a class="code" href="namespaceforcebalance_1_1nifty.html#a51180e960742cc7547749fdfb3513ec4" title="See documentation for printcool; this is a nice way to print out keys/values in a dictionary...">printcool_dictionary</a>(CpPrint,   title=<span class="stringliteral">&#39;%s Isobaric Heat Capacity (cal mol^-1 K^-1) \nTemperature  Pressure  Reference  Calculated +- Stdev     Delta    Weight    Term   &#39;</span> % self.name,bold=<span class="keyword">True</span>,color=4,keywidth=15)
<a name="l00702"></a>00702             bar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Heat Capacity objective function: % .3f%s&quot;</span> % (X_Cp, <span class="stringliteral">&quot;, Derivative:&quot;</span> <span class="keywordflow">if</span> AGrad <span class="keywordflow">else</span> <span class="stringliteral">&quot;&quot;</span>))
<a name="l00703"></a>00703             <span class="keywordflow">if</span> AGrad:
<a name="l00704"></a>00704                 self.FF.print_map(vals=G_Cp)
<a name="l00705"></a>00705                 logger.info(bar)
<a name="l00706"></a>00706 
<a name="l00707"></a>00707             PrintDict[<span class="stringliteral">&#39;Isobaric Heat Capacity&#39;</span>] = <span class="stringliteral">&quot;% 10.5f % 8.3f % 14.5e&quot;</span> % (X_Cp, w_5, X_Cp*w_5)
<a name="l00708"></a>00708 
<a name="l00709"></a>00709         <span class="keywordflow">if</span> X_Eps0 &gt; 0:
<a name="l00710"></a>00710             <a class="code" href="namespaceforcebalance_1_1nifty.html#a51180e960742cc7547749fdfb3513ec4" title="See documentation for printcool; this is a nice way to print out keys/values in a dictionary...">printcool_dictionary</a>(Eps0Print,   title=<span class="stringliteral">&#39;%s Dielectric Constant\nTemperature  Pressure  Reference  Calculated +- Stdev     Delta    Weight    Term   &#39;</span> % self.name,bold=<span class="keyword">True</span>,color=4,keywidth=15)
<a name="l00711"></a>00711             bar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Dielectric Constant objective function: % .3f%s&quot;</span> % (X_Eps0, <span class="stringliteral">&quot;, Derivative:&quot;</span> <span class="keywordflow">if</span> AGrad <span class="keywordflow">else</span> <span class="stringliteral">&quot;&quot;</span>))
<a name="l00712"></a>00712             <span class="keywordflow">if</span> AGrad:
<a name="l00713"></a>00713                 self.FF.print_map(vals=G_Eps0)
<a name="l00714"></a>00714                 logger.info(bar)
<a name="l00715"></a>00715 
<a name="l00716"></a>00716             PrintDict[<span class="stringliteral">&#39;Dielectric Constant&#39;</span>] = <span class="stringliteral">&quot;% 10.5f % 8.3f % 14.5e&quot;</span> % (X_Eps0, w_6, X_Eps0*w_6)
<a name="l00717"></a>00717 
<a name="l00718"></a>00718         PrintDict[<span class="stringliteral">&#39;Total&#39;</span>] = <span class="stringliteral">&quot;% 10s % 8s % 14.5e&quot;</span> % (<span class="stringliteral">&quot;&quot;</span>,<span class="stringliteral">&quot;&quot;</span>,Objective)
<a name="l00719"></a>00719 
<a name="l00720"></a>00720         Title = <span class="stringliteral">&quot;%s Condensed Phase Properties:\n %-20s %40s&quot;</span> % (self.name, <span class="stringliteral">&quot;Property Name&quot;</span>, <span class="stringliteral">&quot;Residual x Weight = Contribution&quot;</span>)
<a name="l00721"></a>00721         <a class="code" href="namespaceforcebalance_1_1nifty.html#a51180e960742cc7547749fdfb3513ec4" title="See documentation for printcool; this is a nice way to print out keys/values in a dictionary...">printcool_dictionary</a>(PrintDict,color=4,title=Title,keywidth=31)
<a name="l00722"></a>00722 
<a name="l00723"></a>00723         Answer = {<span class="stringliteral">&#39;X&#39;</span>:Objective, <span class="stringliteral">&#39;G&#39;</span>:Gradient, <span class="stringliteral">&#39;H&#39;</span>:Hessian}
<a name="l00724"></a>00724         <span class="keywordflow">return</span> Answer
<a name="l00725"></a>00725 
<a name="l00726"></a>00726     @abc.abstractmethod
<a name="l00727"></a>00727     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1liquid_1_1Liquid.html#a51ea9d9fb4418ec2497fe8e2d8033d41" title="Return the self-polarization correction as described in Berendsen et al., JPC 1987.">polarization_correction</a>(self,mvals):
<a name="l00728"></a>00728 
<a name="l00729"></a>00729         <span class="stringliteral">&quot;&quot;&quot; </span>
<a name="l00730"></a>00730 <span class="stringliteral">        </span>
<a name="l00731"></a>00731 <span class="stringliteral">        Return the self-polarization correction as described in Berendsen et al., JPC 1987.</span>
<a name="l00732"></a>00732 <span class="stringliteral"></span>
<a name="l00733"></a>00733 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00734"></a>00734         
<a name="l00735"></a>00735         <span class="keywordflow">raise</span> NotImplementedError(<span class="stringliteral">&#39;This method is not implemented in the base class&#39;</span>)
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Sun Aug 25 2013 11:24:14 for ForceBalance API by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
