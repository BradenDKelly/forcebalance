<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ForceBalance API: molecule.py Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="ForceBalanceLogo_sm.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ForceBalance API
   &#160;<span id="projectnumber">1.1</span>
   </div>
   <div id="projectbrief">Automated optimization of force fields and empirical potentials</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../index.html"><span>Main Page</span></a></li>
      <li ><a href="roadmap.html"><span>Project Roadmap</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">molecule.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="molecule_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespaceforcebalance_1_1molecule.html">00001</a> <span class="comment">#======================================================================#</span>
<a name="l00002"></a>00002 <span class="comment">#|                                                                    |#</span>
<a name="l00003"></a>00003 <span class="comment">#|              Chemical file format conversion module                |#</span>
<a name="l00004"></a>00004 <span class="comment">#|                                                                    |#</span>
<a name="l00005"></a>00005 <span class="comment">#|                Lee-Ping Wang (leeping@stanford.edu)                |#</span>
<a name="l00006"></a>00006 <span class="comment">#|                   Last updated July 30, 2013                       |#</span>
<a name="l00007"></a>00007 <span class="comment">#|                                                                    |#</span>
<a name="l00008"></a>00008 <span class="comment">#|               [ IN PROGRESS, USE AT YOUR OWN RISK ]                |#</span>
<a name="l00009"></a>00009 <span class="comment">#|                                                                    |#</span>
<a name="l00010"></a>00010 <span class="comment">#|   This is free software released under version 2 of the GNU GPL,   |#</span>
<a name="l00011"></a>00011 <span class="comment">#|   please use or redistribute as you see fit under the terms of     |#</span>
<a name="l00012"></a>00012 <span class="comment">#|   this license. (http://www.gnu.org/licenses/gpl-2.0.html)         |#</span>
<a name="l00013"></a>00013 <span class="comment">#|                                                                    |#</span>
<a name="l00014"></a>00014 <span class="comment">#|   This program is distributed in the hope that it will be useful,  |#</span>
<a name="l00015"></a>00015 <span class="comment">#|   but without any warranty; without even the implied warranty of   |#</span>
<a name="l00016"></a>00016 <span class="comment">#|   merchantability or fitness for a particular purpose.  See the    |#</span>
<a name="l00017"></a>00017 <span class="comment">#|   GNU General Public License for more details.                     |#</span>
<a name="l00018"></a>00018 <span class="comment">#|                                                                    |#</span>
<a name="l00019"></a>00019 <span class="comment">#|   Feedback and suggestions are encouraged.                         |#</span>
<a name="l00020"></a>00020 <span class="comment">#|                                                                    |#</span>
<a name="l00021"></a>00021 <span class="comment">#|   What this is for:                                                |#</span>
<a name="l00022"></a>00022 <span class="comment">#|   Converting a molecule between file formats                       |#</span>
<a name="l00023"></a>00023 <span class="comment">#|   Loading and processing of trajectories                           |#</span>
<a name="l00024"></a>00024 <span class="comment">#|   (list of geometries for the same set of atoms)                   |#</span>
<a name="l00025"></a>00025 <span class="comment">#|   Concatenating or slicing trajectories                            |#</span>
<a name="l00026"></a>00026 <span class="comment">#|   Combining molecule metadata (charge, Q-Chem rem variables)       |#</span>
<a name="l00027"></a>00027 <span class="comment">#|                                                                    |#</span>
<a name="l00028"></a>00028 <span class="comment">#|   Supported file formats:                                          |#</span>
<a name="l00029"></a>00029 <span class="comment">#|   See the __init__ method in the Molecule class.                   |#</span>
<a name="l00030"></a>00030 <span class="comment">#|                                                                    |#</span>
<a name="l00031"></a>00031 <span class="comment">#|   Note to self / developers:                                       |#</span>
<a name="l00032"></a>00032 <span class="comment">#|   Please make this file as standalone as possible                  |#</span>
<a name="l00033"></a>00033 <span class="comment">#|   (i.e. don&#39;t introduce dependencies).  If we load an external     |#</span>
<a name="l00034"></a>00034 <span class="comment">#|   library to parse a file, do so with &#39;try / except&#39; so that       |#</span>
<a name="l00035"></a>00035 <span class="comment">#|   the module is still usable even if certain parts are missing.    |#</span>
<a name="l00036"></a>00036 <span class="comment">#|   It&#39;s better to be like a Millennium Falcon. :P                   |#</span>
<a name="l00037"></a>00037 <span class="comment">#|                                                                    |#</span>
<a name="l00038"></a>00038 <span class="comment">#|   Please make sure this file is up-to-date in                      |#</span>
<a name="l00039"></a>00039 <span class="comment">#|   both the &#39;leeping&#39; and &#39;forcebalance&#39; modules                    |#</span>
<a name="l00040"></a>00040 <span class="comment">#|                                                                    |#</span>
<a name="l00041"></a>00041 <span class="comment">#|   At present, when I perform operations like adding two objects,   |#</span>
<a name="l00042"></a>00042 <span class="comment">#|   the sum is created from deep copies of data members in the       |#</span>
<a name="l00043"></a>00043 <span class="comment">#|   originals. This is because copying by reference is confusing;    |#</span>
<a name="l00044"></a>00044 <span class="comment">#|   suppose if I do B += A and modify something in B; it should not  |#</span>
<a name="l00045"></a>00045 <span class="comment">#|   change in A.                                                     |#</span>
<a name="l00046"></a>00046 <span class="comment">#|                                                                    |#</span>
<a name="l00047"></a>00047 <span class="comment">#|   A consequence of this is that data members should not be too     |#</span>
<a name="l00048"></a>00048 <span class="comment">#|   complicated; they should be things like lists or dicts, and NOT  |#</span>
<a name="l00049"></a>00049 <span class="comment">#|   contain references to themselves.                                |#</span>
<a name="l00050"></a>00050 <span class="comment">#|                                                                    |#</span>
<a name="l00051"></a>00051 <span class="comment">#|   To-do list: Handling of comments is still not very good.         |#</span>
<a name="l00052"></a>00052 <span class="comment">#|   Comments from previous files should be &#39;passed on&#39; better.       |#</span>
<a name="l00053"></a>00053 <span class="comment">#|                                                                    |#</span>
<a name="l00054"></a>00054 <span class="comment">#|              Contents of this file:                                |#</span>
<a name="l00055"></a>00055 <span class="comment">#|              0) Names of data variables                            |#</span>
<a name="l00056"></a>00056 <span class="comment">#|              1) Imports                                            |#</span>
<a name="l00057"></a>00057 <span class="comment">#|              2) Subroutines                                        |#</span>
<a name="l00058"></a>00058 <span class="comment">#|              3) Molecule class                                     |#</span>
<a name="l00059"></a>00059 <span class="comment">#|                a) Class customizations (add, getitem)              |#</span>
<a name="l00060"></a>00060 <span class="comment">#|                b) Instantiation                                    |#</span>
<a name="l00061"></a>00061 <span class="comment">#|                c) Core functionality (read, write)                 |#</span>
<a name="l00062"></a>00062 <span class="comment">#|                d) Reading functions                                |#</span>
<a name="l00063"></a>00063 <span class="comment">#|                e) Writing functions                                |#</span>
<a name="l00064"></a>00064 <span class="comment">#|                f) Extra stuff                                      |#</span>
<a name="l00065"></a>00065 <span class="comment">#|              4) &quot;main&quot; function (if executed)                      |#</span>
<a name="l00066"></a>00066 <span class="comment">#|                                                                    |#</span>
<a name="l00067"></a>00067 <span class="comment">#|                   Required: Python 2.7, Numpy 1.6                  |#</span>
<a name="l00068"></a>00068 <span class="comment">#|                   Optional: Mol2, PDB, DCD readers                 |#</span>
<a name="l00069"></a>00069 <span class="comment">#|                    (can be found in ForceBalance)                  |#</span>
<a name="l00070"></a>00070 <span class="comment">#|                    NetworkX package (for topologies)               |#</span>
<a name="l00071"></a>00071 <span class="comment">#|                                                                    |#</span>
<a name="l00072"></a>00072 <span class="comment">#|             Thanks: Todd Dolinsky, Yong Huang,                     |#</span>
<a name="l00073"></a>00073 <span class="comment">#|                     Kyle Beauchamp (PDB)                           |#</span>
<a name="l00074"></a>00074 <span class="comment">#|                     John Stone (DCD Plugin)                        |#</span>
<a name="l00075"></a>00075 <span class="comment">#|                     Pierre Tuffery (Mol2 Plugin)                   |#</span>
<a name="l00076"></a>00076 <span class="comment">#|                     #python IRC chat on FreeNode                   |#</span>
<a name="l00077"></a>00077 <span class="comment">#|                                                                    |#</span>
<a name="l00078"></a>00078 <span class="comment">#|             Instructions:                                          |#</span>
<a name="l00079"></a>00079 <span class="comment">#|                                                                    |#</span>
<a name="l00080"></a>00080 <span class="comment">#|               To import:                                           |#</span>
<a name="l00081"></a>00081 <span class="comment">#|                 from molecule import Molecule                      |#</span>
<a name="l00082"></a>00082 <span class="comment">#|               To create a Molecule object:                         |#</span>
<a name="l00083"></a>00083 <span class="comment">#|                 MyMol = Molecule(fnm)                              |#</span>
<a name="l00084"></a>00084 <span class="comment">#|               To convert to a new file format:                     |#</span>
<a name="l00085"></a>00085 <span class="comment">#|                 MyMol.write(&#39;newfnm.format&#39;)                       |#</span>
<a name="l00086"></a>00086 <span class="comment">#|               To concatenate geometries:                           |#</span>
<a name="l00087"></a>00087 <span class="comment">#|                 MyMol += MyMolB                                    |#</span>
<a name="l00088"></a>00088 <span class="comment">#|                                                                    |#</span>
<a name="l00089"></a>00089 <span class="comment">#======================================================================#</span>
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 <span class="comment">#=========================================#</span>
<a name="l00092"></a>00092 <span class="comment">#|     DECLARE VARIABLE NAMES HERE       |#</span>
<a name="l00093"></a>00093 <span class="comment">#|                                       |#</span>
<a name="l00094"></a>00094 <span class="comment">#|  Any member variable in the Molecule  |#</span>
<a name="l00095"></a>00095 <span class="comment">#| class must be declared here otherwise |#</span>
<a name="l00096"></a>00096 <span class="comment">#| the Molecule class won&#39;t recognize it |#</span>
<a name="l00097"></a>00097 <span class="comment">#=========================================#</span>
<a name="l00098"></a>00098 <span class="comment">#| Data attributes in FrameVariableNames |#</span>
<a name="l00099"></a>00099 <span class="comment">#| must be a list along the frame axis,  |#</span>
<a name="l00100"></a>00100 <span class="comment">#| and they must have the same length.   |#</span>
<a name="l00101"></a>00101 <span class="comment">#=========================================#</span>
<a name="l00102"></a>00102 <span class="comment"># xyzs       = List of numpy arrays of atomic xyz coordinates</span>
<a name="l00103"></a>00103 <span class="comment"># comms      = List of comment strings</span>
<a name="l00104"></a>00104 <span class="comment"># boxes      = List of 3-element or 9-element arrays for periodic boxes</span>
<a name="l00105"></a>00105 <span class="comment"># qm_forces  = List of numpy arrays of atomistic forces from QM calculations</span>
<a name="l00106"></a>00106 <span class="comment"># qm_espxyzs = List of numpy arrays of xyz coordinates for ESP evaluation</span>
<a name="l00107"></a>00107 <span class="comment"># qm_espvals = List of numpy arrays of ESP values</span>
<a name="l00108"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a03da3fd451a69301311b20f00e409f3a">00108</a> FrameVariableNames = set([<span class="stringliteral">&#39;xyzs&#39;</span>, <span class="stringliteral">&#39;comms&#39;</span>, <span class="stringliteral">&#39;boxes&#39;</span>, <span class="stringliteral">&#39;qm_forces&#39;</span>, <span class="stringliteral">&#39;qm_energies&#39;</span>, <span class="stringliteral">&#39;qm_interaction&#39;</span>, 
<a name="l00109"></a>00109                           <span class="stringliteral">&#39;qm_espxyzs&#39;</span>, <span class="stringliteral">&#39;qm_espvals&#39;</span>, <span class="stringliteral">&#39;qm_extchgs&#39;</span>, <span class="stringliteral">&#39;qm_mulliken_charges&#39;</span>, <span class="stringliteral">&#39;qm_mulliken_spins&#39;</span>])
<a name="l00110"></a>00110 <span class="comment">#=========================================#</span>
<a name="l00111"></a>00111 <span class="comment">#| Data attributes in AtomVariableNames  |#</span>
<a name="l00112"></a>00112 <span class="comment">#| must be a list along the atom axis,   |#</span>
<a name="l00113"></a>00113 <span class="comment">#| and they must have the same length.   |#</span>
<a name="l00114"></a>00114 <span class="comment">#=========================================#</span>
<a name="l00115"></a>00115 <span class="comment"># elem       = List of elements</span>
<a name="l00116"></a>00116 <span class="comment"># partial_charge = List of atomic partial charges </span>
<a name="l00117"></a>00117 <span class="comment"># atomname   = List of atom names (can come from MM coordinate file)</span>
<a name="l00118"></a>00118 <span class="comment"># atomtype   = List of atom types (can come from MM force field)</span>
<a name="l00119"></a>00119 <span class="comment"># tinkersuf  = String that comes after the XYZ coordinates in TINKER .xyz or .arc files</span>
<a name="l00120"></a>00120 <span class="comment"># resid      = Residue IDs (can come from MM coordinate file)</span>
<a name="l00121"></a>00121 <span class="comment"># resname    = Residue names</span>
<a name="l00122"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#aa5faa35f222a5e9f4dae2648f0e41b73">00122</a> AtomVariableNames = set([<span class="stringliteral">&#39;elem&#39;</span>, <span class="stringliteral">&#39;partial_charge&#39;</span>, <span class="stringliteral">&#39;atomname&#39;</span>, <span class="stringliteral">&#39;atomtype&#39;</span>, <span class="stringliteral">&#39;tinkersuf&#39;</span>, <span class="stringliteral">&#39;resid&#39;</span>, <span class="stringliteral">&#39;resname&#39;</span>, <span class="stringliteral">&#39;qcsuf&#39;</span>, <span class="stringliteral">&#39;qm_ghost&#39;</span>, <span class="stringliteral">&#39;chain&#39;</span>, <span class="stringliteral">&#39;altloc&#39;</span>, <span class="stringliteral">&#39;icode&#39;</span>])
<a name="l00123"></a>00123 <span class="comment">#=========================================#</span>
<a name="l00124"></a>00124 <span class="comment">#| This can be any data attribute we     |#</span>
<a name="l00125"></a>00125 <span class="comment">#| want but it&#39;s usually some property   |#</span>
<a name="l00126"></a>00126 <span class="comment">#| of the molecule not along the frame   |#</span>
<a name="l00127"></a>00127 <span class="comment">#| atom axis.                            |#</span>
<a name="l00128"></a>00128 <span class="comment">#=========================================#</span>
<a name="l00129"></a>00129 <span class="comment"># bonds      = A list of 2-tuples representing bonds.  Carefully pruned when atom subselection is done.</span>
<a name="l00130"></a>00130 <span class="comment"># fnm        = The file name that the class was built from</span>
<a name="l00131"></a>00131 <span class="comment"># qcrems     = The Q-Chem &#39;rem&#39; variables stored as a list of OrderedDicts</span>
<a name="l00132"></a>00132 <span class="comment"># qctemplate = The Q-Chem template file, not including the coordinates or rem variables</span>
<a name="l00133"></a>00133 <span class="comment"># charge     = The net charge of the molecule</span>
<a name="l00134"></a>00134 <span class="comment"># mult       = The spin multiplicity of the molecule</span>
<a name="l00135"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a576677e3e9a7d9d1aac5523aaf9098c1">00135</a> MetaVariableNames = set([<span class="stringliteral">&#39;fnm&#39;</span>, <span class="stringliteral">&#39;ftype&#39;</span>, <span class="stringliteral">&#39;qcrems&#39;</span>, <span class="stringliteral">&#39;qctemplate&#39;</span>, <span class="stringliteral">&#39;charge&#39;</span>, <span class="stringliteral">&#39;mult&#39;</span>, <span class="stringliteral">&#39;bonds&#39;</span>])
<a name="l00136"></a>00136 <span class="comment"># Variable names relevant to quantum calculations explicitly</span>
<a name="l00137"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a483603baba28d76694b2d5f1e7b37813">00137</a> QuantumVariableNames = set([<span class="stringliteral">&#39;qcrems&#39;</span>, <span class="stringliteral">&#39;qctemplate&#39;</span>, <span class="stringliteral">&#39;charge&#39;</span>, <span class="stringliteral">&#39;mult&#39;</span>, <span class="stringliteral">&#39;qcsuf&#39;</span>, <span class="stringliteral">&#39;qm_ghost&#39;</span>])
<a name="l00138"></a>00138 <span class="comment"># Superset of all variable names.</span>
<a name="l00139"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#ab103b4aacb65cce6b558135c39a6e9a4">00139</a> AllVariableNames = QuantumVariableNames | AtomVariableNames | MetaVariableNames | FrameVariableNames
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 <span class="comment"># OrderedDict requires Python 2.7 or higher</span>
<a name="l00142"></a>00142 <span class="keyword">import</span> os, sys, re, copy
<a name="l00143"></a>00143 <span class="keyword">import</span> numpy <span class="keyword">as</span> np
<a name="l00144"></a>00144 <span class="keyword">from</span> numpy <span class="keyword">import</span> sin, cos, arcsin, arccos
<a name="l00145"></a>00145 <span class="keyword">import</span> imp
<a name="l00146"></a>00146 <span class="keyword">import</span> itertools
<a name="l00147"></a>00147 <span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict, namedtuple
<a name="l00148"></a>00148 <span class="keyword">from</span> ctypes <span class="keyword">import</span> *
<a name="l00149"></a>00149 <span class="keyword">from</span> warnings <span class="keyword">import</span> warn
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 <span class="comment"># Covalent radii from Cordero et al. &#39;Covalent radii revisited&#39; Dalton Transactions 2008, 2832-2838.</span>
<a name="l00152"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#ae100906fa209012ddf9d4b19ee69b0b7">00152</a> Radii = [0.31, 0.28, <span class="comment"># H and He</span>
<a name="l00153"></a>00153          1.28, 0.96, 0.84, 0.76, 0.71, 0.66, 0.57, 0.58, <span class="comment"># First row elements</span>
<a name="l00154"></a>00154          1.66, 1.41, 1.21, 1.11, 1.07, 1.05, 1.02, 1.06, <span class="comment"># Second row elements</span>
<a name="l00155"></a>00155          2.03, 1.76, 1.70, 1.60, 1.53, 1.39, 1.61, 1.52, 1.50, 
<a name="l00156"></a>00156          1.24, 1.32, 1.22, 1.22, 1.20, 1.19, 1.20, 1.20, 1.16, <span class="comment"># Third row elements, K through Kr</span>
<a name="l00157"></a>00157          2.20, 1.95, 1.90, 1.75, 1.64, 1.54, 1.47, 1.46, 1.42, 
<a name="l00158"></a>00158          1.39, 1.45, 1.44, 1.42, 1.39, 1.39, 1.38, 1.39, 1.40, <span class="comment"># Fourth row elements, Rb through Xe</span>
<a name="l00159"></a>00159          2.44, 2.15, 2.07, 2.04, 2.03, 2.01, 1.99, 1.98, 
<a name="l00160"></a>00160          1.98, 1.96, 1.94, 1.92, 1.92, 1.89, 1.90, 1.87, <span class="comment"># Fifth row elements, s and f blocks</span>
<a name="l00161"></a>00161          1.87, 1.75, 1.70, 1.62, 1.51, 1.44, 1.41, 1.36, 
<a name="l00162"></a>00162          1.36, 1.32, 1.45, 1.46, 1.48, 1.40, 1.50, 1.50, <span class="comment"># Fifth row elements, d and p blocks</span>
<a name="l00163"></a>00163          2.60, 2.21, 2.15, 2.06, 2.00, 1.96, 1.90, 1.87, 1.80, 1.69] <span class="comment"># Sixth row elements</span>
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 <span class="comment"># A list that gives you the element if you give it the atomic number, hence the &#39;none&#39; at the front.</span>
<a name="l00166"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#af1987e9e7f33b828c15f1e4f7dcded2c">00166</a> Elements = [<span class="stringliteral">&quot;None&quot;</span>,<span class="stringliteral">&#39;H&#39;</span>,<span class="stringliteral">&#39;He&#39;</span>,
<a name="l00167"></a>00167             <span class="stringliteral">&#39;Li&#39;</span>,<span class="stringliteral">&#39;Be&#39;</span>,<span class="stringliteral">&#39;B&#39;</span>,<span class="stringliteral">&#39;C&#39;</span>,<span class="stringliteral">&#39;N&#39;</span>,<span class="stringliteral">&#39;O&#39;</span>,<span class="stringliteral">&#39;F&#39;</span>,<span class="stringliteral">&#39;Ne&#39;</span>,
<a name="l00168"></a>00168             <span class="stringliteral">&#39;Na&#39;</span>,<span class="stringliteral">&#39;Mg&#39;</span>,<span class="stringliteral">&#39;Al&#39;</span>,<span class="stringliteral">&#39;Si&#39;</span>,<span class="stringliteral">&#39;P&#39;</span>,<span class="stringliteral">&#39;S&#39;</span>,<span class="stringliteral">&#39;Cl&#39;</span>,<span class="stringliteral">&#39;Ar&#39;</span>,
<a name="l00169"></a>00169             <span class="stringliteral">&#39;K&#39;</span>,<span class="stringliteral">&#39;Ca&#39;</span>,<span class="stringliteral">&#39;Sc&#39;</span>,<span class="stringliteral">&#39;Ti&#39;</span>,<span class="stringliteral">&#39;V&#39;</span>,<span class="stringliteral">&#39;Cr&#39;</span>,<span class="stringliteral">&#39;Mn&#39;</span>,<span class="stringliteral">&#39;Fe&#39;</span>,<span class="stringliteral">&#39;Co&#39;</span>,<span class="stringliteral">&#39;Ni&#39;</span>,<span class="stringliteral">&#39;Cu&#39;</span>,<span class="stringliteral">&#39;Zn&#39;</span>,<span class="stringliteral">&#39;Ga&#39;</span>,<span class="stringliteral">&#39;Ge&#39;</span>,<span class="stringliteral">&#39;As&#39;</span>,<span class="stringliteral">&#39;Se&#39;</span>,<span class="stringliteral">&#39;Br&#39;</span>,<span class="stringliteral">&#39;Kr&#39;</span>,
<a name="l00170"></a>00170             <span class="stringliteral">&#39;Rb&#39;</span>,<span class="stringliteral">&#39;Sr&#39;</span>,<span class="stringliteral">&#39;Y&#39;</span>,<span class="stringliteral">&#39;Zr&#39;</span>,<span class="stringliteral">&#39;Nb&#39;</span>,<span class="stringliteral">&#39;Mo&#39;</span>,<span class="stringliteral">&#39;Tc&#39;</span>,<span class="stringliteral">&#39;Ru&#39;</span>,<span class="stringliteral">&#39;Rh&#39;</span>,<span class="stringliteral">&#39;Pd&#39;</span>,<span class="stringliteral">&#39;Ag&#39;</span>,<span class="stringliteral">&#39;Cd&#39;</span>,<span class="stringliteral">&#39;In&#39;</span>,<span class="stringliteral">&#39;Sn&#39;</span>,<span class="stringliteral">&#39;Sb&#39;</span>,<span class="stringliteral">&#39;Te&#39;</span>,<span class="stringliteral">&#39;I&#39;</span>,<span class="stringliteral">&#39;Xe&#39;</span>,
<a name="l00171"></a>00171             <span class="stringliteral">&#39;Cs&#39;</span>,<span class="stringliteral">&#39;Ba&#39;</span>,<span class="stringliteral">&#39;La&#39;</span>,<span class="stringliteral">&#39;Ce&#39;</span>,<span class="stringliteral">&#39;Pr&#39;</span>,<span class="stringliteral">&#39;Nd&#39;</span>,<span class="stringliteral">&#39;Pm&#39;</span>,<span class="stringliteral">&#39;Sm&#39;</span>,<span class="stringliteral">&#39;Eu&#39;</span>,<span class="stringliteral">&#39;Gd&#39;</span>,<span class="stringliteral">&#39;Tb&#39;</span>,<span class="stringliteral">&#39;Dy&#39;</span>,<span class="stringliteral">&#39;Ho&#39;</span>,<span class="stringliteral">&#39;Er&#39;</span>,<span class="stringliteral">&#39;Tm&#39;</span>,<span class="stringliteral">&#39;Yb&#39;</span>,
<a name="l00172"></a>00172             <span class="stringliteral">&#39;Lu&#39;</span>,<span class="stringliteral">&#39;Hf&#39;</span>,<span class="stringliteral">&#39;Ta&#39;</span>,<span class="stringliteral">&#39;W&#39;</span>,<span class="stringliteral">&#39;Re&#39;</span>,<span class="stringliteral">&#39;Os&#39;</span>,<span class="stringliteral">&#39;Ir&#39;</span>,<span class="stringliteral">&#39;Pt&#39;</span>,<span class="stringliteral">&#39;Au&#39;</span>,<span class="stringliteral">&#39;Hg&#39;</span>,<span class="stringliteral">&#39;Tl&#39;</span>,<span class="stringliteral">&#39;Pb&#39;</span>,<span class="stringliteral">&#39;Bi&#39;</span>,<span class="stringliteral">&#39;Po&#39;</span>,<span class="stringliteral">&#39;At&#39;</span>,<span class="stringliteral">&#39;Rn&#39;</span>,
<a name="l00173"></a>00173             <span class="stringliteral">&#39;Fr&#39;</span>,<span class="stringliteral">&#39;Ra&#39;</span>,<span class="stringliteral">&#39;Ac&#39;</span>,<span class="stringliteral">&#39;Th&#39;</span>,<span class="stringliteral">&#39;Pa&#39;</span>,<span class="stringliteral">&#39;</span><span class="stringliteral">U&#39;,&#39;</span>Np&#39;,&#39;Pu&#39;,&#39;Am&#39;,&#39;Cm&#39;,&#39;Bk&#39;,&#39;Cf&#39;,&#39;Es&#39;,&#39;Fm&#39;,&#39;Md&#39;,&#39;No&#39;,&#39;Lr&#39;,&#39;Rf&#39;,&#39;Db&#39;,&#39;Sg&#39;,&#39;Bh&#39;,&#39;Hs&#39;,&#39;Mt&#39;]
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="comment"># Dictionary of atomic masses ; also serves as the list of elements (periodic table)</span>
<a name="l00176"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a00baf2798fd1a1e41c0364e94eafd133">00176</a> PeriodicTable = OrderedDict([(<span class="stringliteral">&#39;H&#39;</span> , 1.0079), (<span class="stringliteral">&#39;He&#39;</span> , 4.0026), 
<a name="l00177"></a>00177                              (<span class="stringliteral">&#39;Li&#39;</span> , 6.941), (<span class="stringliteral">&#39;Be&#39;</span> , 9.0122), (<span class="stringliteral">&#39;B&#39;</span> , 10.811), (<span class="stringliteral">&#39;C&#39;</span> , 12.0107), (<span class="stringliteral">&#39;N&#39;</span> , 14.0067), (<span class="stringliteral">&#39;O&#39;</span> , 15.9994), (<span class="stringliteral">&#39;F&#39;</span> , 18.9984), (<span class="stringliteral">&#39;Ne&#39;</span> , 20.1797),
<a name="l00178"></a>00178                              (<span class="stringliteral">&#39;Na&#39;</span> , 22.9897), (<span class="stringliteral">&#39;Mg&#39;</span> , 24.305), (<span class="stringliteral">&#39;Al&#39;</span> , 26.9815), (<span class="stringliteral">&#39;Si&#39;</span> , 28.0855), (<span class="stringliteral">&#39;P&#39;</span> , 30.9738), (<span class="stringliteral">&#39;S&#39;</span> , 32.065), (<span class="stringliteral">&#39;Cl&#39;</span> , 35.453), (<span class="stringliteral">&#39;Ar&#39;</span> , 39.948), 
<a name="l00179"></a>00179                              (<span class="stringliteral">&#39;K&#39;</span> , 39.0983), (<span class="stringliteral">&#39;Ca&#39;</span> , 40.078), (<span class="stringliteral">&#39;Sc&#39;</span> , 44.9559), (<span class="stringliteral">&#39;Ti&#39;</span> , 47.867), (<span class="stringliteral">&#39;V&#39;</span> , 50.9415), (<span class="stringliteral">&#39;Cr&#39;</span> , 51.9961), (<span class="stringliteral">&#39;Mn&#39;</span> , 54.938), (<span class="stringliteral">&#39;Fe&#39;</span> , 55.845), (<span class="stringliteral">&#39;Co&#39;</span> , 58.9332), 
<a name="l00180"></a>00180                              (<span class="stringliteral">&#39;Ni&#39;</span> , 58.6934), (<span class="stringliteral">&#39;Cu&#39;</span> , 63.546), (<span class="stringliteral">&#39;Zn&#39;</span> , 65.39), (<span class="stringliteral">&#39;Ga&#39;</span> , 69.723), (<span class="stringliteral">&#39;Ge&#39;</span> , 72.64), (<span class="stringliteral">&#39;As&#39;</span> , 74.9216), (<span class="stringliteral">&#39;Se&#39;</span> , 78.96), (<span class="stringliteral">&#39;Br&#39;</span> , 79.904), (<span class="stringliteral">&#39;Kr&#39;</span> , 83.8), 
<a name="l00181"></a>00181                              (<span class="stringliteral">&#39;Rb&#39;</span> , 85.4678), (<span class="stringliteral">&#39;Sr&#39;</span> , 87.62), (<span class="stringliteral">&#39;Y&#39;</span> , 88.9059), (<span class="stringliteral">&#39;Zr&#39;</span> , 91.224), (<span class="stringliteral">&#39;Nb&#39;</span> , 92.9064), (<span class="stringliteral">&#39;Mo&#39;</span> , 95.94), (<span class="stringliteral">&#39;Tc&#39;</span> , 98), (<span class="stringliteral">&#39;Ru&#39;</span> , 101.07), (<span class="stringliteral">&#39;Rh&#39;</span> , 102.9055), 
<a name="l00182"></a>00182                              (<span class="stringliteral">&#39;Pd&#39;</span> , 106.42), (<span class="stringliteral">&#39;Ag&#39;</span> , 107.8682), (<span class="stringliteral">&#39;Cd&#39;</span> , 112.411), (<span class="stringliteral">&#39;In&#39;</span> , 114.818), (<span class="stringliteral">&#39;Sn&#39;</span> , 118.71), (<span class="stringliteral">&#39;Sb&#39;</span> , 121.76), (<span class="stringliteral">&#39;Te&#39;</span> , 127.6), (<span class="stringliteral">&#39;I&#39;</span> , 126.9045), (<span class="stringliteral">&#39;Xe&#39;</span> , 131.293), 
<a name="l00183"></a>00183                              (<span class="stringliteral">&#39;Cs&#39;</span> , 132.9055), (<span class="stringliteral">&#39;Ba&#39;</span> , 137.327), (<span class="stringliteral">&#39;La&#39;</span> , 138.9055), (<span class="stringliteral">&#39;Ce&#39;</span> , 140.116), (<span class="stringliteral">&#39;Pr&#39;</span> , 140.9077), (<span class="stringliteral">&#39;Nd&#39;</span> , 144.24), (<span class="stringliteral">&#39;Pm&#39;</span> , 145), (<span class="stringliteral">&#39;Sm&#39;</span> , 150.36), 
<a name="l00184"></a>00184                              (<span class="stringliteral">&#39;Eu&#39;</span> , 151.964), (<span class="stringliteral">&#39;Gd&#39;</span> , 157.25), (<span class="stringliteral">&#39;Tb&#39;</span> , 158.9253), (<span class="stringliteral">&#39;Dy&#39;</span> , 162.5), (<span class="stringliteral">&#39;Ho&#39;</span> , 164.9303), (<span class="stringliteral">&#39;Er&#39;</span> , 167.259), (<span class="stringliteral">&#39;Tm&#39;</span> , 168.9342), (<span class="stringliteral">&#39;Yb&#39;</span> , 173.04), 
<a name="l00185"></a>00185                              (<span class="stringliteral">&#39;Lu&#39;</span> , 174.967), (<span class="stringliteral">&#39;Hf&#39;</span> , 178.49), (<span class="stringliteral">&#39;Ta&#39;</span> , 180.9479), (<span class="stringliteral">&#39;W&#39;</span> , 183.84), (<span class="stringliteral">&#39;Re&#39;</span> , 186.207), (<span class="stringliteral">&#39;Os&#39;</span> , 190.23), (<span class="stringliteral">&#39;Ir&#39;</span> , 192.217), (<span class="stringliteral">&#39;Pt&#39;</span> , 195.078), 
<a name="l00186"></a>00186                              (<span class="stringliteral">&#39;Au&#39;</span> , 196.9665), (<span class="stringliteral">&#39;Hg&#39;</span> , 200.59), (<span class="stringliteral">&#39;Tl&#39;</span> , 204.3833), (<span class="stringliteral">&#39;Pb&#39;</span> , 207.2), (<span class="stringliteral">&#39;Bi&#39;</span> , 208.9804), (<span class="stringliteral">&#39;Po&#39;</span> , 209), (<span class="stringliteral">&#39;At&#39;</span> , 210), (<span class="stringliteral">&#39;Rn&#39;</span> , 222), 
<a name="l00187"></a>00187                              (<span class="stringliteral">&#39;Fr&#39;</span> , 223), (<span class="stringliteral">&#39;Ra&#39;</span> , 226), (<span class="stringliteral">&#39;Ac&#39;</span> , 227), (<span class="stringliteral">&#39;Th&#39;</span> , 232.0381), (<span class="stringliteral">&#39;Pa&#39;</span> , 231.0359), (<span class="stringliteral">&#39;</span><span class="stringliteral">U&#39; , 238.0289), (&#39;</span>Np&#39; , 237), (&#39;Pu&#39; , 244), 
<a name="l00188"></a>00188                              (<span class="stringliteral">&#39;Am&#39;</span> , 243), (<span class="stringliteral">&#39;Cm&#39;</span> , 247), (<span class="stringliteral">&#39;Bk&#39;</span> , 247), (<span class="stringliteral">&#39;Cf&#39;</span> , 251), (<span class="stringliteral">&#39;Es&#39;</span> , 252), (<span class="stringliteral">&#39;Fm&#39;</span> , 257), (<span class="stringliteral">&#39;Md&#39;</span> , 258), (<span class="stringliteral">&#39;No&#39;</span> , 259), 
<a name="l00189"></a>00189                              (<span class="stringliteral">&#39;Lr&#39;</span> , 262), (<span class="stringliteral">&#39;Rf&#39;</span> , 261), (<span class="stringliteral">&#39;Db&#39;</span> , 262), (<span class="stringliteral">&#39;Sg&#39;</span> , 266), (<span class="stringliteral">&#39;Bh&#39;</span> , 264), (<span class="stringliteral">&#39;Hs&#39;</span> , 277), (<span class="stringliteral">&#39;Mt&#39;</span> , 268)])
<a name="l00190"></a>00190 
<a name="l00191"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#af28de4693e5b8e82df900d0ac3c6c370">00191</a> <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#af28de4693e5b8e82df900d0ac3c6c370">getElement</a>(mass):
<a name="l00192"></a>00192     <span class="keywordflow">return</span> PeriodicTable.keys()[np.argmin([np.abs(m-mass) <span class="keywordflow">for</span> m <span class="keywordflow">in</span> PeriodicTable.values()])]
<a name="l00193"></a>00193 
<a name="l00194"></a>00194 <span class="comment">#============================#</span>
<a name="l00195"></a>00195 <span class="comment">#| DCD read/write functions |#</span>
<a name="l00196"></a>00196 <span class="comment">#============================#</span>
<a name="l00197"></a>00197 <span class="comment"># Try to load _dcdlib.so either from a directory in the LD_LIBRARY_PATH</span>
<a name="l00198"></a>00198 <span class="comment"># or from the same directory as this module.</span>
<a name="l00199"></a>00199 <span class="keywordflow">try</span>: _dcdlib = CDLL(<span class="stringliteral">&quot;_dcdlib.so&quot;</span>)
<a name="l00200"></a>00200 <span class="keywordflow">except</span>:
<a name="l00201"></a>00201     <span class="keywordflow">try</span>: _dcdlib = CDLL(os.path.join(imp.find_module(__name__.split(<span class="stringliteral">&#39;.&#39;</span>)[0])[1],<span class="stringliteral">&quot;_dcdlib.so&quot;</span>))
<a name="l00202"></a>00202     <span class="keywordflow">except</span>: 
<a name="l00203"></a>00203         <span class="keywordflow">if</span> <span class="stringliteral">&quot;nanoreactor&quot;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> __name__: warn(<span class="stringliteral">&#39;The dcdlib module cannot be imported (Cannot read/write DCD files)&#39;</span>)
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 <span class="comment">#============================#</span>
<a name="l00206"></a>00206 <span class="comment">#| PDB read/write functions |#</span>
<a name="l00207"></a>00207 <span class="comment">#============================#</span>
<a name="l00208"></a>00208 <span class="keywordflow">try</span>: <span class="keyword">from</span> PDB <span class="keyword">import</span> *
<a name="l00209"></a>00209 <span class="keywordflow">except</span>: 
<a name="l00210"></a>00210     <span class="keywordflow">if</span> <span class="stringliteral">&quot;nanoreactor&quot;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> __name__: warn(<span class="stringliteral">&#39;The pdb module cannot be miported (Cannot read/write PDB files)&#39;</span>)
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 <span class="comment">#=============================#</span>
<a name="l00213"></a>00213 <span class="comment">#| Mol2 read/write functions |#</span>
<a name="l00214"></a>00214 <span class="comment">#=============================#</span>
<a name="l00215"></a>00215 <span class="keywordflow">try</span>: <span class="keyword">import</span> Mol2
<a name="l00216"></a>00216 <span class="keywordflow">except</span>: 
<a name="l00217"></a>00217     <span class="keywordflow">if</span> <span class="stringliteral">&quot;nanoreactor&quot;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> __name__: warn(<span class="stringliteral">&#39;The Mol2 module cannot be imported (Cannot read/write Mol2 files)&#39;</span>)
<a name="l00218"></a>00218 
<a name="l00219"></a>00219 <span class="comment">#==============================#</span>
<a name="l00220"></a>00220 <span class="comment">#| OpenMM interface functions |#</span>
<a name="l00221"></a>00221 <span class="comment">#==============================#</span>
<a name="l00222"></a>00222 <span class="keywordflow">try</span>: 
<a name="l00223"></a>00223     <span class="keyword">from</span> simtk.unit <span class="keyword">import</span> *
<a name="l00224"></a>00224     <span class="keyword">from</span> simtk.openmm <span class="keyword">import</span> *
<a name="l00225"></a>00225     <span class="keyword">from</span> simtk.openmm.app <span class="keyword">import</span> *
<a name="l00226"></a>00226 <span class="keywordflow">except</span>: 
<a name="l00227"></a>00227     <span class="keywordflow">if</span> <span class="stringliteral">&quot;nanoreactor&quot;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> __name__: warn(<span class="stringliteral">&#39;The OpenMM modules cannot be imported (Cannot interface with OpenMM)&#39;</span>)
<a name="l00228"></a>00228     
<a name="l00229"></a>00229 <span class="comment">#===========================#</span>
<a name="l00230"></a>00230 <span class="comment">#| Convenience subroutines |#</span>
<a name="l00231"></a>00231 <span class="comment">#===========================#</span>
<a name="l00232"></a>00232 
<a name="l00233"></a>00233 <span class="comment">## One bohr equals this many angstroms</span>
<a name="l00234"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#af69f9f12bed5faede1948498e9f0d2e5">00234</a> bohrang = 0.529177249
<a name="l00235"></a>00235 
<a name="l00236"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#ab8464fea13fad2a506792c2f1d7c93f3">00236</a> <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#ab8464fea13fad2a506792c2f1d7c93f3">nodematch</a>(node1,node2):
<a name="l00237"></a>00237     <span class="comment"># Matching two nodes of a graph.  Nodes are equivalent if the elements are the same</span>
<a name="l00238"></a>00238     <span class="keywordflow">return</span> node1[<span class="stringliteral">&#39;e&#39;</span>] == node2[<span class="stringliteral">&#39;e&#39;</span>]
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a0dd31eff88d2bed0884ab21a13261d42" title="ONLY matches integers! If you have a decimal point? None shall pass!">isint</a>(word):
<a name="l00241"></a>00241     <span class="stringliteral">&quot;&quot;&quot;ONLY matches integers! If you have a decimal point? None shall pass!&quot;&quot;&quot;</span>
<a name="l00242"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a0dd31eff88d2bed0884ab21a13261d42">00242</a>     <span class="keywordflow">return</span> re.match(<span class="stringliteral">&#39;^[-+]?[0-9]+$&#39;</span>,word)
<a name="l00243"></a>00243 
<a name="l00244"></a>00244 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(word):
<a name="l00245"></a>00245     <span class="stringliteral">&quot;&quot;&quot;Matches ANY number; it can be a decimal, scientific notation, integer, or what have you&quot;&quot;&quot;</span>
<a name="l00246"></a>00246     <span class="keywordflow">return</span> re.match(<span class="stringliteral">&#39;^[-+]?[0-9]*\.?[0-9]*([eEdD][-+]?[0-9]+)?$&#39;</span>,word)
<a name="l00247"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70">00247</a> 
<a name="l00248"></a>00248 <span class="comment"># Used to get the white spaces in a split line.</span>
<a name="l00249"></a>00249 splitter = re.compile(<span class="stringliteral">r&#39;(\s+|\S+)&#39;</span>)
<a name="l00250"></a>00250 
<a name="l00251"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a41b84501c57b5adca693580d4c27d099">00251</a> <span class="comment"># Container for Bravais lattice vector.  Three cell lengths, three angles, three vectors, volume, and TINKER trig functions.</span>
<a name="l00252"></a>00252 Box = namedtuple(<span class="stringliteral">&#39;Box&#39;</span>,[<span class="stringliteral">&#39;a&#39;</span>,<span class="stringliteral">&#39;b&#39;</span>,<span class="stringliteral">&#39;c&#39;</span>,<span class="stringliteral">&#39;alpha&#39;</span>,<span class="stringliteral">&#39;beta&#39;</span>,<span class="stringliteral">&#39;gamma&#39;</span>,<span class="stringliteral">&#39;A&#39;</span>,<span class="stringliteral">&#39;B&#39;</span>,<span class="stringliteral">&#39;C&#39;</span>,<span class="stringliteral">&#39;V&#39;</span>])
<a name="l00253"></a>00253 radian = 180. / np.pi
<a name="l00254"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#aa9de7b4fcb815b9f7ad490d461131e72">00254</a> <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a0a6e3e79b04534bf2e83d09def189444" title="This function takes in three lattice lengths and three lattice angles, and tries to return a complete...">BuildLatticeFromLengthsAngles</a>(a, b, c, alpha, beta, gamma):
<a name="l00255"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a922ed32eb838098c0b77423c624a4487">00255</a>     <span class="stringliteral">&quot;&quot;&quot; This function takes in three lattice lengths and three lattice angles, and tries to return a complete box specification. &quot;&quot;&quot;</span>
<a name="l00256"></a>00256     alph = alpha*np.pi/180
<a name="l00257"></a>00257     bet  = beta*np.pi/180
<a name="l00258"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a0a6e3e79b04534bf2e83d09def189444">00258</a>     gamm = gamma*np.pi/180
<a name="l00259"></a>00259     v = np.sqrt(1 - cos(alph)**2 - cos(bet)**2 - cos(gamm)**2 + 2*cos(alph)*cos(bet)*cos(gamm))
<a name="l00260"></a>00260     Mat = np.mat([[a, b*cos(gamm), c*cos(bet)],
<a name="l00261"></a>00261                   [0, b*sin(gamm), c*((cos(alph)-cos(bet)*cos(gamm))/sin(gamm))],
<a name="l00262"></a>00262                   [0, 0, c*v/sin(gamm)]])
<a name="l00263"></a>00263     L1 = Mat*np.mat([[1],[0],[0]])
<a name="l00264"></a>00264     L2 = Mat*np.mat([[0],[1],[0]])
<a name="l00265"></a>00265     L3 = Mat*np.mat([[0],[0],[1]])
<a name="l00266"></a>00266     <span class="keywordflow">return</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#aa9de7b4fcb815b9f7ad490d461131e72">Box</a>(a,b,c,alpha,beta,gamma,np.array(L1).flatten(),np.array(L2).flatten(),np.array(L3).flatten(),v*a*b*c)
<a name="l00267"></a>00267 
<a name="l00268"></a>00268 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a29fb1ac9324f4280f07c65baea339989" title="This function takes in three lattice vectors and tries to return a complete box specification.">BuildLatticeFromVectors</a>(v1, v2, v3):
<a name="l00269"></a>00269     <span class="stringliteral">&quot;&quot;&quot; This function takes in three lattice vectors and tries to return a complete box specification. &quot;&quot;&quot;</span>
<a name="l00270"></a>00270     a = np.linalg.norm(v1)
<a name="l00271"></a>00271     b = np.linalg.norm(v2)
<a name="l00272"></a>00272     c = np.linalg.norm(v3)
<a name="l00273"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a29fb1ac9324f4280f07c65baea339989">00273</a>     alpha = arccos(np.linalg.dot(v2, v3) / np.linalg.norm(v2) / np.linalg.norm(v3)) * radian
<a name="l00274"></a>00274     beta  = arccos(np.linalg.dot(v1, v3) / np.linalg.norm(v1) / np.linalg.norm(v3)) * radian
<a name="l00275"></a>00275     gamma = arccos(np.linalg.dot(v1, v2) / np.linalg.norm(v1) / np.linalg.norm(v2)) * radian
<a name="l00276"></a>00276     alph = alpha*np.pi/180
<a name="l00277"></a>00277     bet  = beta*np.pi/180
<a name="l00278"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a247e1def6c85f832dd332dea40da62d3">00278</a>     gamm = gamma*np.pi/180
<a name="l00279"></a>00279     v = np.sqrt(1 - cos(alph)**2 - cos(bet)**2 - cos(gamm)**2 + 2*cos(alph)*cos(bet)*cos(gamm))
<a name="l00280"></a>00280     Mat = np.mat([[a, b*cos(gamm), c*cos(bet)],
<a name="l00281"></a>00281                   [0, b*sin(gamm), c*((cos(alph)-cos(bet)*cos(gamm))/sin(gamm))],
<a name="l00282"></a>00282                   [0, 0, c*v/sin(gamm)]])
<a name="l00283"></a>00283     L1 = Mat*np.mat([[1],[0],[0]])
<a name="l00284"></a>00284     L2 = Mat*np.mat([[0],[1],[0]])
<a name="l00285"></a>00285     L3 = Mat*np.mat([[0],[0],[1]])
<a name="l00286"></a>00286     <span class="keywordflow">return</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#aa9de7b4fcb815b9f7ad490d461131e72">Box</a>(a,b,c,alpha,beta,gamma,np.array(L1).flatten(),np.array(L2).flatten(),np.array(L3).flatten(),v*a*b*c)
<a name="l00287"></a>00287 
<a name="l00288"></a>00288 <span class="comment">#===========================#</span>
<a name="l00289"></a>00289 <span class="comment">#|   Connectivity graph    |#</span>
<a name="l00290"></a>00290 <span class="comment">#|  Good for doing simple  |#</span>
<a name="l00291"></a>00291 <span class="comment">#|     topology tricks     |#</span>
<a name="l00292"></a>00292 <span class="comment">#===========================#</span>
<a name="l00293"></a>00293 <span class="keywordflow">try</span>:
<a name="l00294"></a>00294     <span class="keyword">import</span> networkx <span class="keyword">as</span> nx
<a name="l00295"></a>00295     <span class="keyword">class </span>MyG(nx.Graph):
<a name="l00296"></a>00296         <span class="keyword">def </span>__init__(self):
<a name="l00297"></a>00297             super(MyG,self).__init__()
<a name="l00298"></a>00298             self.Alive = <span class="keyword">True</span>
<a name="l00299"></a>00299         <span class="keyword">def </span>__eq__(self, other):
<a name="l00300"></a>00300             <span class="comment"># This defines whether two MyG objects are &quot;equal&quot; to one another.</span>
<a name="l00301"></a>00301             <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.Alive:
<a name="l00302"></a>00302                 <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l00303"></a>00303             <span class="keywordflow">if</span> <span class="keywordflow">not</span> other.Alive:
<a name="l00304"></a>00304                 <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l00305"></a>00305             <span class="keywordflow">return</span> nx.is_isomorphic(self,other,node_match=nodematch)
<a name="l00306"></a>00306         <span class="keyword">def </span>__hash__(self):
<a name="l00307"></a>00307             <span class="stringliteral">&#39;&#39;&#39; The hash function is something we can use to discard two things that are obviously not equal.  Here we neglect the hash. &#39;&#39;&#39;</span>
<a name="l00308"></a>00308             <span class="keywordflow">return</span> 1
<a name="l00309"></a>00309         <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1chemistry.html#ace6400fcf0f12a9d9f70aa7496984379">L</a>(self):
<a name="l00310"></a>00310             <span class="stringliteral">&#39;&#39;&#39; Return a list of the sorted atom numbers in this graph. &#39;&#39;&#39;</span>
<a name="l00311"></a>00311             <span class="keywordflow">return</span> sorted(self.nodes())
<a name="l00312"></a>00312         <span class="keyword">def </span>AStr(self):
<a name="l00313"></a>00313             <span class="stringliteral">&#39;&#39;&#39; Return a string of atoms, which serves as a rudimentary &#39;fingerprint&#39; : &#39;99,100,103,151&#39; . &#39;&#39;&#39;</span>
<a name="l00314"></a>00314             <span class="keywordflow">return</span> <span class="stringliteral">&#39;,&#39;</span>.join([<span class="stringliteral">&#39;%i&#39;</span> % i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.L()])
<a name="l00315"></a>00315         <span class="keyword">def </span>e(self):
<a name="l00316"></a>00316             <span class="stringliteral">&#39;&#39;&#39; Return an array of the elements.  For instance [&#39;H&#39; &#39;C&#39; &#39;C&#39; &#39;H&#39;]. &#39;&#39;&#39;</span>
<a name="l00317"></a>00317             elems = nx.get_node_attributes(self,<span class="stringliteral">&#39;e&#39;</span>)
<a name="l00318"></a>00318             <span class="keywordflow">return</span> [elems[i] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.L()]
<a name="l00319"></a>00319         <span class="keyword">def </span>ef(self):
<a name="l00320"></a>00320             <span class="stringliteral">&#39;&#39;&#39; Create an Empirical Formula &#39;&#39;&#39;</span>
<a name="l00321"></a>00321             Formula = list(self.e())
<a name="l00322"></a>00322             <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>.join([(<span class="stringliteral">&#39;%s%i&#39;</span> % (k, Formula.count(k)) <span class="keywordflow">if</span> Formula.count(k) &gt; 1 <span class="keywordflow">else</span> <span class="stringliteral">&#39;%s&#39;</span> % k) <span class="keywordflow">for</span> k <span class="keywordflow">in</span> sorted(set(Formula))])
<a name="l00323"></a>00323         <span class="keyword">def </span>x(self):
<a name="l00324"></a>00324             <span class="stringliteral">&#39;&#39;&#39; Get a list of the coordinates. &#39;&#39;&#39;</span>
<a name="l00325"></a>00325             coors = nx.get_node_attributes(self,<span class="stringliteral">&#39;x&#39;</span>)
<a name="l00326"></a>00326             <span class="keywordflow">return</span> np.array([coors[i] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.L()])
<a name="l00327"></a>00327     <span class="keywordflow">try</span>:
<a name="l00328"></a>00328         <span class="keyword">import</span> contact
<a name="l00329"></a>00329     <span class="keywordflow">except</span>:
<a name="l00330"></a>00330         warn(<span class="stringliteral">&quot;&#39;contact&#39; cannot be imported (topology tools will be slow.)&quot;</span>)
<a name="l00331"></a>00331 <span class="keywordflow">except</span>:
<a name="l00332"></a>00332     warn(<span class="stringliteral">&quot;NetworkX cannot be imported (topology tools won&#39;t work).  Most functionality should still work though.&quot;</span>)
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 
<a name="l00335"></a>00335 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a2eba3cad44138b3b10ea883240888412" title="Print a line consisting of (element, x, y, z) in accordance with .xyz file format.">format_xyz_coord</a>(element,xyz,tinker=False):
<a name="l00336"></a>00336     <span class="stringliteral">&quot;&quot;&quot; Print a line consisting of (element, x, y, z) in accordance with .xyz file format</span>
<a name="l00337"></a>00337 <span class="stringliteral"></span>
<a name="l00338"></a>00338 <span class="stringliteral">    @param[in] element A chemical element of a single atom</span>
<a name="l00339"></a>00339 <span class="stringliteral">    @param[in] xyz A 3-element array containing x, y, z coordinates of that atom</span>
<a name="l00340"></a>00340 <span class="stringliteral"></span>
<a name="l00341"></a>00341 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00342"></a>00342     <span class="keywordflow">if</span> tinker:
<a name="l00343"></a>00343         <span class="keywordflow">return</span> <span class="stringliteral">&quot;%-3s % 11.6f % 11.6f % 11.6f&quot;</span> % (element,xyz[0],xyz[1],xyz[2])
<a name="l00344"></a>00344     <span class="keywordflow">else</span>:
<a name="l00345"></a>00345         <span class="keywordflow">return</span> <span class="stringliteral">&quot;%-5s % 15.10f % 15.10f % 15.10f&quot;</span> % (element,xyz[0],xyz[1],xyz[2])
<a name="l00346"></a>00346 
<a name="l00347"></a>00347 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a41c13064e4285973aa6c49369d3d3390" title="Print a line in accordance with .gro file format, with six decimal points of precision.">format_gro_coord</a>(resid, resname, aname, seqno, xyz):
<a name="l00348"></a>00348     <span class="stringliteral">&quot;&quot;&quot; Print a line in accordance with .gro file format, with six decimal points of precision</span>
<a name="l00349"></a>00349 <span class="stringliteral"></span>
<a name="l00350"></a>00350 <span class="stringliteral">    @param[in] resid The number of the residue that the atom belongs to</span>
<a name="l00351"></a>00351 <span class="stringliteral">    @param[in] resname The name of the residue that the atom belongs to</span>
<a name="l00352"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a2eba3cad44138b3b10ea883240888412">00352</a> <span class="stringliteral">    @param[in] aname The name of the atom</span>
<a name="l00353"></a>00353 <span class="stringliteral">    @param[in] seqno The sequential number of the atom</span>
<a name="l00354"></a>00354 <span class="stringliteral">    @param[in] xyz A 3-element array containing x, y, z coordinates of that atom</span>
<a name="l00355"></a>00355 <span class="stringliteral">    </span>
<a name="l00356"></a>00356 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00357"></a>00357     <span class="keywordflow">return</span> <span class="stringliteral">&quot;%5i%-5s%5s%5i % 10.6f % 10.6f % 10.6f&quot;</span> % (resid,resname,aname,seqno,xyz[0],xyz[1],xyz[2])
<a name="l00358"></a>00358 
<a name="l00359"></a>00359 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a4948e4662b8d2c8d515427d1bbb3d01e" title="Print a line consisting of (element, p, q, r, s, t, ...) where (p, q, r) are arbitrary atom-wise data...">format_xyzgen_coord</a>(element,xyzgen):
<a name="l00360"></a>00360     <span class="stringliteral">&quot;&quot;&quot; Print a line consisting of (element, p, q, r, s, t, ...) where</span>
<a name="l00361"></a>00361 <span class="stringliteral">    (p, q, r) are arbitrary atom-wise data (this might happen, for</span>
<a name="l00362"></a>00362 <span class="stringliteral">    instance, with atomic charges)</span>
<a name="l00363"></a>00363 <span class="stringliteral"></span>
<a name="l00364"></a>00364 <span class="stringliteral">    @param[in] element A chemical element of a single atom</span>
<a name="l00365"></a>00365 <span class="stringliteral">    @param[in] xyzgen A N-element array containing data for that atom</span>
<a name="l00366"></a>00366 <span class="stringliteral"></span>
<a name="l00367"></a>00367 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00368"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a41c13064e4285973aa6c49369d3d3390">00368</a>     <span class="keywordflow">return</span> <span class="stringliteral">&quot;%-5s&quot;</span> + <span class="stringliteral">&#39; &#39;</span>.join([<span class="stringliteral">&quot;% 15.10f&quot;</span> % i] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> xyzgen)
<a name="l00369"></a>00369 
<a name="l00370"></a>00370 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#ae25aa5331b3a2dd0e9d1e184380357db" title="Print a line corresponding to the box vector in accordance with .gro file format.">format_gro_box</a>(box):
<a name="l00371"></a>00371     <span class="stringliteral">&quot;&quot;&quot; Print a line corresponding to the box vector in accordance with .gro file format</span>
<a name="l00372"></a>00372 <span class="stringliteral"></span>
<a name="l00373"></a>00373 <span class="stringliteral">    @param[in] box Box NamedTuple</span>
<a name="l00374"></a>00374 <span class="stringliteral">    </span>
<a name="l00375"></a>00375 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00376"></a>00376     <span class="keywordflow">if</span> box.alpha == 90.0 <span class="keywordflow">and</span> box.beta == 90.0 <span class="keywordflow">and</span> box.gamma == 90.0:
<a name="l00377"></a>00377         <span class="keywordflow">return</span> <span class="stringliteral">&#39; &#39;</span>.join([<span class="stringliteral">&quot;% 10.6f&quot;</span> % (i/10) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> [box.a, box.b, box.c]])
<a name="l00378"></a>00378     <span class="keywordflow">else</span>:
<a name="l00379"></a>00379         <span class="keywordflow">return</span> <span class="stringliteral">&#39; &#39;</span>.join([<span class="stringliteral">&quot;% 10.6f&quot;</span> % (i/10) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> [box.A[0], box.B[1], box.C[2], box.A[1], box.A[2], box.B[0], box.B[2], box.C[0], box.C[1]]])
<a name="l00380"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a4948e4662b8d2c8d515427d1bbb3d01e">00380</a> 
<a name="l00381"></a>00381 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a12b7bb398c2fa49a223f258ec7737483" title="Determines whether a line contains GROMACS data or not.">is_gro_coord</a>(line):
<a name="l00382"></a>00382     <span class="stringliteral">&quot;&quot;&quot; Determines whether a line contains GROMACS data or not</span>
<a name="l00383"></a>00383 <span class="stringliteral"></span>
<a name="l00384"></a>00384 <span class="stringliteral">    @param[in] line The line to be tested</span>
<a name="l00385"></a>00385 <span class="stringliteral">    </span>
<a name="l00386"></a>00386 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00387"></a>00387     sline = line.split()
<a name="l00388"></a>00388     <span class="keywordflow">if</span> len(sline) == 6:
<a name="l00389"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#ae25aa5331b3a2dd0e9d1e184380357db">00389</a>         <span class="keywordflow">return</span> all([<a class="code" href="namespaceforcebalance_1_1molecule.html#a0dd31eff88d2bed0884ab21a13261d42" title="ONLY matches integers! If you have a decimal point? None shall pass!">isint</a>(sline[2]),<a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(sline[3]),<a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(sline[4]),<a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(sline[5])])
<a name="l00390"></a>00390     <span class="keywordflow">elif</span> len(sline) == 5:
<a name="l00391"></a>00391         <span class="keywordflow">return</span> all([<a class="code" href="namespaceforcebalance_1_1molecule.html#a0dd31eff88d2bed0884ab21a13261d42" title="ONLY matches integers! If you have a decimal point? None shall pass!">isint</a>(line[15:20]),<a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(sline[2]),<a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(sline[3]),<a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(sline[4])])
<a name="l00392"></a>00392     <span class="keywordflow">else</span>:
<a name="l00393"></a>00393         <span class="keywordflow">return</span> 0
<a name="l00394"></a>00394 
<a name="l00395"></a>00395 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a838d85848bd817e801d0f5f6502217ef" title="Determines whether a line contains CHARMM data or not.">is_charmm_coord</a>(line):
<a name="l00396"></a>00396     <span class="stringliteral">&quot;&quot;&quot; Determines whether a line contains CHARMM data or not</span>
<a name="l00397"></a>00397 <span class="stringliteral"></span>
<a name="l00398"></a>00398 <span class="stringliteral">    @param[in] line The line to be tested</span>
<a name="l00399"></a>00399 <span class="stringliteral">    </span>
<a name="l00400"></a>00400 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00401"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a12b7bb398c2fa49a223f258ec7737483">00401</a>     sline = line.split()
<a name="l00402"></a>00402     <span class="keywordflow">if</span> len(sline) &gt;= 7:
<a name="l00403"></a>00403         <span class="keywordflow">return</span> all([<a class="code" href="namespaceforcebalance_1_1molecule.html#a0dd31eff88d2bed0884ab21a13261d42" title="ONLY matches integers! If you have a decimal point? None shall pass!">isint</a>(sline[0]), <a class="code" href="namespaceforcebalance_1_1molecule.html#a0dd31eff88d2bed0884ab21a13261d42" title="ONLY matches integers! If you have a decimal point? None shall pass!">isint</a>(sline[1]), <a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(sline[4]), <a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(sline[5]), <a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(sline[6])])
<a name="l00404"></a>00404     <span class="keywordflow">else</span>:
<a name="l00405"></a>00405         <span class="keywordflow">return</span> 0
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#aafc8c924eed4480fed8ddc9c474d3bc1" title="Determines whether a line contains a GROMACS box vector or not.">is_gro_box</a>(line):
<a name="l00408"></a>00408     <span class="stringliteral">&quot;&quot;&quot; Determines whether a line contains a GROMACS box vector or not</span>
<a name="l00409"></a>00409 <span class="stringliteral"></span>
<a name="l00410"></a>00410 <span class="stringliteral">    @param[in] line The line to be tested</span>
<a name="l00411"></a>00411 <span class="stringliteral">    </span>
<a name="l00412"></a>00412 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00413"></a>00413     sline = line.split()
<a name="l00414"></a>00414     <span class="keywordflow">if</span> len(sline) == 9 <span class="keywordflow">and</span> all([<a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline]):
<a name="l00415"></a>00415         <span class="keywordflow">return</span> 1
<a name="l00416"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a838d85848bd817e801d0f5f6502217ef">00416</a>     <span class="keywordflow">elif</span> len(sline) == 3 <span class="keywordflow">and</span> all([<a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline]):
<a name="l00417"></a>00417         <span class="keywordflow">return</span> 1
<a name="l00418"></a>00418     <span class="keywordflow">else</span>:
<a name="l00419"></a>00419         <span class="keywordflow">return</span> 0
<a name="l00420"></a>00420 
<a name="l00421"></a>00421 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a4cdb2086978b281ed84cd66179c3f5b2">add_strip_to_mat</a>(mat,strip):
<a name="l00422"></a>00422     out = list(mat)
<a name="l00423"></a>00423     <span class="keywordflow">if</span> out == [] <span class="keywordflow">and</span> strip != []: 
<a name="l00424"></a>00424         out = list(strip)
<a name="l00425"></a>00425     <span class="keywordflow">elif</span> out != [] <span class="keywordflow">and</span> strip != []:
<a name="l00426"></a>00426         <span class="keywordflow">for</span> (i,j) <span class="keywordflow">in</span> zip(out,strip):
<a name="l00427"></a>00427             i += list(j)
<a name="l00428"></a>00428     <span class="keywordflow">return</span> out
<a name="l00429"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#aafc8c924eed4480fed8ddc9c474d3bc1">00429</a> 
<a name="l00430"></a>00430 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a58c3f09152db4d1c6e1db9df29c60c43">pvec</a>(vec):
<a name="l00431"></a>00431     <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>.join([<span class="stringliteral">&#39; % .10e&#39;</span> % i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> list(vec.flatten())])
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a7fe52c2928c7b0329882541bef2e34cd" title="Groups a big long iterable into groups of ten or what have you.">grouper</a>(n, iterable):
<a name="l00434"></a>00434     <span class="stringliteral">&quot;&quot;&quot; Groups a big long iterable into groups of ten or what have you. &quot;&quot;&quot;</span>
<a name="l00435"></a>00435     args = [iter(iterable)] * n
<a name="l00436"></a>00436     <span class="keywordflow">return</span> list([e <span class="keywordflow">for</span> e <span class="keywordflow">in</span> t <span class="keywordflow">if</span> e != <span class="keywordtype">None</span>] <span class="keywordflow">for</span> t <span class="keywordflow">in</span> itertools.izip_longest(*args))
<a name="l00437"></a>00437 
<a name="l00438"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a4cdb2086978b281ed84cd66179c3f5b2">00438</a> <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a5f529179461765fadbd0a742cdc2c677" title="Creates a list of number sequences divided as evenly as possible.">even_list</a>(totlen, splitsize):
<a name="l00439"></a>00439     <span class="stringliteral">&quot;&quot;&quot; Creates a list of number sequences divided as evenly as possible.  &quot;&quot;&quot;</span>
<a name="l00440"></a>00440     joblens = np.zeros(splitsize,dtype=int)
<a name="l00441"></a>00441     subsets = []
<a name="l00442"></a>00442     <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(totlen):
<a name="l00443"></a>00443         joblens[i%splitsize] += 1
<a name="l00444"></a>00444     jobnow = 0
<a name="l00445"></a>00445     <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(splitsize):
<a name="l00446"></a>00446         subsets.append(range(jobnow, jobnow + joblens[i]))
<a name="l00447"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a58c3f09152db4d1c6e1db9df29c60c43">00447</a>         jobnow += joblens[i]
<a name="l00448"></a>00448     <span class="keywordflow">return</span> subsets
<a name="l00449"></a>00449 
<a name="l00450"></a>00450 <span class="keyword">class </span><a class="code" href="classforcebalance_1_1molecule_1_1MolfileTimestep.html" title="Wrapper for the timestep C structure used in molfile plugins.">MolfileTimestep</a>(Structure):
<a name="l00451"></a>00451     <span class="stringliteral">&quot;&quot;&quot; Wrapper for the timestep C structure used in molfile plugins. &quot;&quot;&quot;</span>
<a name="l00452"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a7fe52c2928c7b0329882541bef2e34cd">00452</a>     _fields_ = [(<span class="stringliteral">&quot;coords&quot;</span>,POINTER(c_float)), (<span class="stringliteral">&quot;velocities&quot;</span>,POINTER(c_float)),
<a name="l00453"></a>00453                 (<span class="stringliteral">&quot;A&quot;</span>,c_float), (<span class="stringliteral">&quot;B&quot;</span>,c_float), (<span class="stringliteral">&quot;C&quot;</span>,c_float), (<span class="stringliteral">&quot;alpha&quot;</span>,c_float), 
<a name="l00454"></a>00454                 (<span class="stringliteral">&quot;beta&quot;</span>,c_float), (<span class="stringliteral">&quot;gamma&quot;</span>,c_float), (<span class="stringliteral">&quot;physical_time&quot;</span>,c_double)]
<a name="l00455"></a>00455     
<a name="l00456"></a>00456 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a5b50df23cc4d0e617fdc56538f0bea63">both</a>(A, B, key):
<a name="l00457"></a>00457     <span class="keywordflow">return</span> key <span class="keywordflow">in</span> A.Data <span class="keywordflow">and</span> key <span class="keywordflow">in</span> B.Data
<a name="l00458"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a5f529179461765fadbd0a742cdc2c677">00458</a> 
<a name="l00459"></a>00459 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a6f7c6217b1c64da309a8abd21dfdcf08">diff</a>(A, B, key):
<a name="l00460"></a>00460     <span class="keywordflow">if</span> <span class="keywordflow">not</span> (key <span class="keywordflow">in</span> A.Data <span class="keywordflow">and</span> key <span class="keywordflow">in</span> B.Data) : <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l00461"></a>00461     <span class="keywordflow">else</span>:
<a name="l00462"></a>00462         <span class="keywordflow">if</span> type(A.Data[key]) <span class="keywordflow">is</span> np.ndarray:
<a name="l00463"></a>00463             <span class="keywordflow">return</span> (A.Data[key] != B.Data[key]).any()
<a name="l00464"></a>00464         <span class="keywordflow">else</span>:
<a name="l00465"></a>00465             <span class="keywordflow">return</span> A.Data[key] != B.Data[key]
<a name="l00466"></a>00466 
<a name="l00467"></a>00467 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a75775be6563ad7f10695a9a45ff49ba9">either</a>(A, B, key):
<a name="l00468"></a>00468     <span class="keywordflow">return</span> key <span class="keywordflow">in</span> A.Data <span class="keywordflow">or</span> key <span class="keywordflow">in</span> B.Data
<a name="l00469"></a>00469 
<a name="l00470"></a>00470 <span class="comment">#===========================#</span>
<a name="l00471"></a><a class="code" href="classforcebalance_1_1molecule_1_1MolfileTimestep.html">00471</a> <span class="comment">#|  Alignment subroutines  |#</span>
<a name="l00472"></a>00472 <span class="comment">#| Moments added 08/03/12  |#</span>
<a name="l00473"></a>00473 <span class="comment">#===========================#</span>
<a name="l00474"></a>00474 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#af02bf73765f34bbef81c4a5b000b86ce" title="Constructs an Euler matrix from three Euler angles.">EulerMatrix</a>(T1,T2,T3):
<a name="l00475"></a>00475     <span class="stringliteral">&quot;&quot;&quot; Constructs an Euler matrix from three Euler angles. &quot;&quot;&quot;</span>
<a name="l00476"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a5b50df23cc4d0e617fdc56538f0bea63">00476</a>     DMat = np.mat(np.zeros((3,3),dtype = float))
<a name="l00477"></a>00477     DMat[0,0] = np.cos(T1)
<a name="l00478"></a>00478     DMat[0,1] = np.sin(T1)
<a name="l00479"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a6f7c6217b1c64da309a8abd21dfdcf08">00479</a>     DMat[1,0] = -np.sin(T1)
<a name="l00480"></a>00480     DMat[1,1] = np.cos(T1)
<a name="l00481"></a>00481     DMat[2,2] = 1
<a name="l00482"></a>00482     CMat = np.mat(np.zeros((3,3),dtype = float))
<a name="l00483"></a>00483     CMat[0,0] = 1
<a name="l00484"></a>00484     CMat[1,1] = np.cos(T2)
<a name="l00485"></a>00485     CMat[1,2] = np.sin(T2)
<a name="l00486"></a>00486     CMat[2,1] = -np.sin(T2)
<a name="l00487"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a75775be6563ad7f10695a9a45ff49ba9">00487</a>     CMat[2,2] = np.cos(T2)
<a name="l00488"></a>00488     BMat = np.mat(np.zeros((3,3),dtype = float))
<a name="l00489"></a>00489     BMat[0,0] = np.cos(T3)
<a name="l00490"></a>00490     BMat[0,1] = np.sin(T3)
<a name="l00491"></a>00491     BMat[1,0] = -np.sin(T3)
<a name="l00492"></a>00492     BMat[1,1] = np.cos(T3)
<a name="l00493"></a>00493     BMat[2,2] = 1
<a name="l00494"></a>00494     EMat = BMat*CMat*DMat
<a name="l00495"></a>00495     <span class="keywordflow">return</span> np.mat(EMat)
<a name="l00496"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#af02bf73765f34bbef81c4a5b000b86ce">00496</a> 
<a name="l00497"></a>00497 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a8fcbb4a2b3470a85d25699b6f28a54fc" title="Computes an &#39;overlap&#39; between two molecules based on some fictitious density.">ComputeOverlap</a>(theta,elem,xyz1,xyz2):
<a name="l00498"></a>00498     <span class="stringliteral">&quot;&quot;&quot; </span>
<a name="l00499"></a>00499 <span class="stringliteral">    Computes an &#39;overlap&#39; between two molecules based on some</span>
<a name="l00500"></a>00500 <span class="stringliteral">    fictitious density.  Good for fine-tuning alignment but gets stuck</span>
<a name="l00501"></a>00501 <span class="stringliteral">    in local minima.</span>
<a name="l00502"></a>00502 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00503"></a>00503     xyz2R = np.array(<a class="code" href="namespaceforcebalance_1_1molecule.html#af02bf73765f34bbef81c4a5b000b86ce" title="Constructs an Euler matrix from three Euler angles.">EulerMatrix</a>(theta[0],theta[1],theta[2])*np.mat(xyz2.T)).T
<a name="l00504"></a>00504     Obj = 0.0
<a name="l00505"></a>00505     elem = np.array(elem)
<a name="l00506"></a>00506     <span class="keywordflow">for</span> i <span class="keywordflow">in</span> set(elem):
<a name="l00507"></a>00507         <span class="keywordflow">for</span> j <span class="keywordflow">in</span> np.where(elem==i)[0]:
<a name="l00508"></a>00508             <span class="keywordflow">for</span> k <span class="keywordflow">in</span> np.where(elem==i)[0]:
<a name="l00509"></a>00509                 dx = xyz1[j] - xyz2R[k]
<a name="l00510"></a>00510                 dx2 = np.dot(dx,dx)
<a name="l00511"></a>00511                 Obj -= np.exp(-0.5*dx2)
<a name="l00512"></a>00512     <span class="keywordflow">return</span> Obj
<a name="l00513"></a>00513 
<a name="l00514"></a>00514 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a9a58eb1746e51420f50da3f3a6d51485" title="Computes a &quot;overlap density&quot; from two frames.">AlignToDensity</a>(elem,xyz1,xyz2,binary=False):
<a name="l00515"></a>00515     <span class="stringliteral">&quot;&quot;&quot; </span>
<a name="l00516"></a>00516 <span class="stringliteral">    Computes a &quot;overlap density&quot; from two frames.</span>
<a name="l00517"></a>00517 <span class="stringliteral">    This function can be called by AlignToMoments to get rid of inversion problems</span>
<a name="l00518"></a>00518 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00519"></a>00519     grid = np.pi*np.array(list(itertools.product([0,1],[0,1],[0,1])))
<a name="l00520"></a>00520     ovlp = np.array([<a class="code" href="namespaceforcebalance_1_1molecule.html#a8fcbb4a2b3470a85d25699b6f28a54fc" title="Computes an &#39;overlap&#39; between two molecules based on some fictitious density.">ComputeOverlap</a>(e, elem, xyz1, xyz2) <span class="keywordflow">for</span> e <span class="keywordflow">in</span> grid]) <span class="comment"># Mao</span>
<a name="l00521"></a>00521     t1 = grid[np.argmin(ovlp)]
<a name="l00522"></a>00522     xyz2R = (np.array(<a class="code" href="namespaceforcebalance_1_1molecule.html#af02bf73765f34bbef81c4a5b000b86ce" title="Constructs an Euler matrix from three Euler angles.">EulerMatrix</a>(t1[0],t1[1],t1[2])*np.mat(xyz2.T)).T).copy()
<a name="l00523"></a>00523     <span class="keywordflow">return</span> xyz2R
<a name="l00524"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a8fcbb4a2b3470a85d25699b6f28a54fc">00524</a> 
<a name="l00525"></a>00525 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#aa9ad9b92efa7bd3c1d589d62bbb8108e" title="Pre-aligns molecules to &#39;moment of inertia&#39;.">AlignToMoments</a>(elem,xyz1,xyz2=None):
<a name="l00526"></a>00526     <span class="stringliteral">&quot;&quot;&quot;Pre-aligns molecules to &#39;moment of inertia&#39;.</span>
<a name="l00527"></a>00527 <span class="stringliteral">    If xyz2 is passed in, it will assume that xyz1 is already</span>
<a name="l00528"></a>00528 <span class="stringliteral">    aligned to the moment of inertia, and it simply does 180-degree</span>
<a name="l00529"></a>00529 <span class="stringliteral">    rotations to make sure nothing is inverted.&quot;&quot;&quot;</span>
<a name="l00530"></a>00530     xyz = xyz1 <span class="keywordflow">if</span> xyz2 == <span class="keywordtype">None</span> <span class="keywordflow">else</span> xyz2
<a name="l00531"></a>00531     I = np.zeros((3,3))
<a name="l00532"></a>00532     <span class="keywordflow">for</span> i, xi <span class="keywordflow">in</span> enumerate(xyz):
<a name="l00533"></a>00533         I += (np.dot(xi,xi)*np.eye(3) - np.outer(xi,xi))
<a name="l00534"></a>00534         <span class="comment"># This is the original line from MSMBuilder, but we&#39;re choosing not to use masses</span>
<a name="l00535"></a>00535         <span class="comment"># I += PeriodicTable[elem[i]]*(np.dot(xi,xi)*np.eye(3) - np.outer(xi,xi))</span>
<a name="l00536"></a>00536     A, B = np.linalg.eig(I)
<a name="l00537"></a>00537     <span class="comment"># Sort eigenvectors by eigenvalue</span>
<a name="l00538"></a>00538     BB   = B[:, np.argsort(A)]
<a name="l00539"></a>00539     determ = np.linalg.det(BB)
<a name="l00540"></a>00540     Thresh = 1e-3
<a name="l00541"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a9a58eb1746e51420f50da3f3a6d51485">00541</a>     <span class="keywordflow">if</span> np.abs(determ - 1.0) &gt; Thresh:
<a name="l00542"></a>00542         <span class="keywordflow">if</span> np.abs(determ + 1.0) &gt; Thresh:
<a name="l00543"></a>00543             <span class="keywordflow">print</span> <span class="stringliteral">&quot;in AlignToMoments, determinant is % .3f&quot;</span> % determ
<a name="l00544"></a>00544         BB[:,2] *= -1
<a name="l00545"></a>00545     xyzr = np.array(np.mat(BB).T * np.mat(xyz).T).T.copy()
<a name="l00546"></a>00546     <span class="keywordflow">if</span> xyz2 != <span class="keywordtype">None</span>:
<a name="l00547"></a>00547         xyzrr = <a class="code" href="namespaceforcebalance_1_1molecule.html#a9a58eb1746e51420f50da3f3a6d51485" title="Computes a &quot;overlap density&quot; from two frames.">AlignToDensity</a>(elem,xyz1,xyzr,binary=<span class="keyword">True</span>)
<a name="l00548"></a>00548         <span class="keywordflow">return</span> xyzrr
<a name="l00549"></a>00549     <span class="keywordflow">else</span>:
<a name="l00550"></a>00550         <span class="keywordflow">return</span> xyzr
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#a08840b73e95bf34bf9ca7ea36ad0492d">get_rotate_translate</a>(matrix1,matrix2):
<a name="l00553"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#aa9ad9b92efa7bd3c1d589d62bbb8108e">00553</a>     <span class="keyword">assert</span> np.shape(matrix1) == np.shape(matrix2), <span class="stringliteral">&#39;Matrices not of same dimensions&#39;</span>
<a name="l00554"></a>00554     
<a name="l00555"></a>00555     <span class="comment"># Store number of rows</span>
<a name="l00556"></a>00556     nrows = np.shape(matrix1)[0]
<a name="l00557"></a>00557     
<a name="l00558"></a>00558     <span class="comment"># Getting centroid position for each selection</span>
<a name="l00559"></a>00559     avg_pos1 = matrix1.sum(axis=0)/nrows
<a name="l00560"></a>00560     avg_pos2 = matrix2.sum(axis=0)/nrows
<a name="l00561"></a>00561 
<a name="l00562"></a>00562     <span class="comment"># Translation of matrices</span>
<a name="l00563"></a>00563     avg_matrix1 = matrix1-avg_pos1
<a name="l00564"></a>00564     avg_matrix2 = matrix2-avg_pos2
<a name="l00565"></a>00565 
<a name="l00566"></a>00566     <span class="comment"># Covariance matrix</span>
<a name="l00567"></a>00567     covar = np.dot(avg_matrix1.T,avg_matrix2)
<a name="l00568"></a>00568     
<a name="l00569"></a>00569     <span class="comment"># Do the SVD in order to get rotation matrix</span>
<a name="l00570"></a>00570     u,s,wt = np.linalg.svd(covar)
<a name="l00571"></a>00571     
<a name="l00572"></a>00572     <span class="comment"># Rotation matrix</span>
<a name="l00573"></a>00573     <span class="comment"># Transposition of u,wt</span>
<a name="l00574"></a>00574     rot_matrix = wt.T*u.T
<a name="l00575"></a>00575     
<a name="l00576"></a><a class="code" href="namespaceforcebalance_1_1molecule.html#a08840b73e95bf34bf9ca7ea36ad0492d">00576</a>     <span class="comment"># Insure a right-handed coordinate system</span>
<a name="l00577"></a>00577     <span class="comment"># need to fix this!!</span>
<a name="l00578"></a>00578     <span class="comment">#if np.linalg.det(rot_matrix) &gt; 0:</span>
<a name="l00579"></a>00579     <span class="comment">#    wt[2] = -wt[2]</span>
<a name="l00580"></a>00580     rot_matrix = np.transpose(np.dot(np.transpose(wt),np.transpose(u)))
<a name="l00581"></a>00581 
<a name="l00582"></a>00582     trans_matrix = avg_pos2-np.dot(avg_pos1,rot_matrix)
<a name="l00583"></a>00583     <span class="keywordflow">return</span> trans_matrix, rot_matrix
<a name="l00584"></a>00584 
<a name="l00585"></a>00585 <span class="keyword">class </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html" title="Lee-Ping&#39;s general file format conversion class.">Molecule</a>(object):
<a name="l00586"></a>00586     <span class="stringliteral">&quot;&quot;&quot; Lee-Ping&#39;s general file format conversion class.</span>
<a name="l00587"></a>00587 <span class="stringliteral"></span>
<a name="l00588"></a>00588 <span class="stringliteral">    The purpose of this class is to read and write chemical file formats in a</span>
<a name="l00589"></a>00589 <span class="stringliteral">    way that is convenient for research.  There are highly general file format</span>
<a name="l00590"></a>00590 <span class="stringliteral">    converters out there (e.g. catdcd, openbabel) but I find that writing </span>
<a name="l00591"></a>00591 <span class="stringliteral">    my own class can be very helpful for specific purposes.  Here are some things</span>
<a name="l00592"></a>00592 <span class="stringliteral">    this class can do:</span>
<a name="l00593"></a>00593 <span class="stringliteral">    </span>
<a name="l00594"></a>00594 <span class="stringliteral">    - Convert a .gro file to a .xyz file, or a .pdb file to a .dcd file.</span>
<a name="l00595"></a>00595 <span class="stringliteral">    Data is stored internally, so any readable file can be converted into</span>
<a name="l00596"></a>00596 <span class="stringliteral">    any writable file as long as there is sufficient information to write </span>
<a name="l00597"></a>00597 <span class="stringliteral">    that file.</span>
<a name="l00598"></a>00598 <span class="stringliteral">    </span>
<a name="l00599"></a>00599 <span class="stringliteral">    - Accumulate information from different files.  For example, we may read</span>
<a name="l00600"></a>00600 <span class="stringliteral">    A.gro to get a list of coordinates, add quantum settings from a B.in file,</span>
<a name="l00601"></a>00601 <span class="stringliteral">    and write A.in (this gives us a file that we can use to run QM calculations)</span>
<a name="l00602"></a>00602 <span class="stringliteral"></span>
<a name="l00603"></a>00603 <span class="stringliteral">    - Concatenate two trajectories together as long as they&#39;re compatible.  This</span>
<a name="l00604"></a>00604 <span class="stringliteral">    is done by creating two Molecule objects and then simply adding them.  Addition</span>
<a name="l00605"></a>00605 <span class="stringliteral">    means two things:  (1) Information fields missing from each class, but present </span>
<a name="l00606"></a>00606 <span class="stringliteral">    in the other, are added to the sum, and (2) Appendable or per-frame fields</span>
<a name="l00607"></a>00607 <span class="stringliteral">    (i.e. coordinates) are concatenated together.</span>
<a name="l00608"></a>00608 <span class="stringliteral"></span>
<a name="l00609"></a>00609 <span class="stringliteral">    - Slice trajectories using reasonable Python language.  That is to say,</span>
<a name="l00610"></a>00610 <span class="stringliteral">    MyMolecule[1:10] returns a new Molecule object that contains frames 2 through 10.</span>
<a name="l00611"></a>00611 <span class="stringliteral">    </span>
<a name="l00612"></a>00612 <span class="stringliteral">    Next step: Read in Q-Chem output data using this too!</span>
<a name="l00613"></a>00613 <span class="stringliteral"></span>
<a name="l00614"></a>00614 <span class="stringliteral">    Special variables:  These variables cannot be set manually because</span>
<a name="l00615"></a>00615 <span class="stringliteral">    there is a special method associated with getting them.</span>
<a name="l00616"></a>00616 <span class="stringliteral"></span>
<a name="l00617"></a>00617 <span class="stringliteral">    na = The number of atoms.  You&#39;ll get this if you use MyMol.na or MyMol[&#39;na&#39;].</span>
<a name="l00618"></a>00618 <span class="stringliteral">    na = The number of snapshots.  You&#39;ll get this if you use MyMol.ns or MyMol[&#39;ns&#39;].</span>
<a name="l00619"></a>00619 <span class="stringliteral"></span>
<a name="l00620"></a>00620 <span class="stringliteral">    Unit system:  Angstroms.</span>
<a name="l00621"></a>00621 <span class="stringliteral"></span>
<a name="l00622"></a>00622 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     <span class="keyword">def </span>__len__(self):
<a name="l00625"></a>00625         <span class="stringliteral">&quot;&quot;&quot; Return the number of frames in the trajectory. &quot;&quot;&quot;</span>
<a name="l00626"></a>00626         L = -1
<a name="l00627"></a>00627         klast = <span class="keywordtype">None</span>
<a name="l00628"></a>00628         Defined = <span class="keyword">False</span>
<a name="l00629"></a>00629         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.FrameKeys:
<a name="l00630"></a>00630             Defined = <span class="keyword">True</span>
<a name="l00631"></a>00631             <span class="keywordflow">if</span> L != -1 <span class="keywordflow">and</span> len(self.Data[key]) != L:
<a name="l00632"></a>00632                 <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;The keys %s and %s have different lengths - this isn\&#39;t supposed to happen for two FrameKeys member variables.&#39;</span> % (key, klast))
<a name="l00633"></a>00633             L = len(self.Data[key])
<a name="l00634"></a>00634             klast = key
<a name="l00635"></a>00635         <span class="keywordflow">if</span> <span class="keywordflow">not</span> Defined:
<a name="l00636"></a>00636             <span class="keywordflow">return</span> 0
<a name="l00637"></a>00637         <span class="keywordflow">return</span> L
<a name="l00638"></a>00638 
<a name="l00639"></a>00639     <span class="keyword">def </span>__getattr__(self, key):
<a name="l00640"></a>00640         <span class="stringliteral">&quot;&quot;&quot; Whenever we try to get a class attribute, it first tries to get the attribute from the Data dictionary. &quot;&quot;&quot;</span>
<a name="l00641"></a>00641         <span class="keywordflow">if</span> key == <span class="stringliteral">&#39;ns&#39;</span>:
<a name="l00642"></a>00642             <span class="keywordflow">return</span> len(self)
<a name="l00643"></a>00643         <span class="keywordflow">elif</span> key == <span class="stringliteral">&#39;na&#39;</span>: <span class="comment"># The &#39;na&#39; attribute is the number of atoms.</span>
<a name="l00644"></a>00644             L = -1
<a name="l00645"></a>00645             klast = <span class="keywordtype">None</span>
<a name="l00646"></a>00646             Defined = <span class="keyword">False</span>
<a name="l00647"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html">00647</a>             <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.AtomKeys:
<a name="l00648"></a>00648                 Defined = <span class="keyword">True</span>
<a name="l00649"></a>00649                 <span class="keywordflow">if</span> L != -1 <span class="keywordflow">and</span> len(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key]) != L:
<a name="l00650"></a>00650                     <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;The keys %s and %s have different lengths (%i %i) - this isn\&#39;t supposed to happen for two AtomKeys member variables.&#39;</span> % (key, klast, len(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key]), len(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[klast])))
<a name="l00651"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a619d265b8c438f9ad87ac536e66ea9a0">00651</a>                 L = len(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key])
<a name="l00652"></a>00652                 klast = key
<a name="l00653"></a>00653             <span class="keywordflow">if</span> Defined:
<a name="l00654"></a>00654                 <span class="keywordflow">return</span> L
<a name="l00655"></a>00655             <span class="keywordflow">elif</span> <span class="stringliteral">&#39;xyzs&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l00656"></a>00656                 <span class="keywordflow">return</span> len(self.xyzs[0])
<a name="l00657"></a>00657             <span class="keywordflow">else</span>:
<a name="l00658"></a>00658                 <span class="keywordflow">return</span> 0
<a name="l00659"></a>00659             <span class="comment">#raise Exception(&#39;na is ill-defined if the molecule has no AtomKeys member variables.&#39;)</span>
<a name="l00660"></a>00660         <span class="comment">## These attributes return a list of attribute names defined in this class that belong in the chosen category.</span>
<a name="l00661"></a>00661         <span class="comment">## For example: self.FrameKeys should return set([&#39;xyzs&#39;,&#39;boxes&#39;]) if xyzs and boxes exist in self.Data</span>
<a name="l00662"></a>00662         <span class="keywordflow">elif</span> key == <span class="stringliteral">&#39;FrameKeys&#39;</span>:
<a name="l00663"></a>00663             <span class="keywordflow">return</span> set(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>) &amp; FrameVariableNames
<a name="l00664"></a>00664         <span class="keywordflow">elif</span> key == <span class="stringliteral">&#39;AtomKeys&#39;</span>:
<a name="l00665"></a>00665             <span class="keywordflow">return</span> set(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>) &amp; AtomVariableNames
<a name="l00666"></a>00666         <span class="keywordflow">elif</span> key == <span class="stringliteral">&#39;MetaKeys&#39;</span>:
<a name="l00667"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a0c40cab05311928494dae9278e806240">00667</a>             <span class="keywordflow">return</span> set(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>) &amp; MetaVariableNames
<a name="l00668"></a>00668         <span class="keywordflow">elif</span> key == <span class="stringliteral">&#39;QuantumKeys&#39;</span>:
<a name="l00669"></a>00669             <span class="keywordflow">return</span> set(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>) &amp; QuantumVariableNames
<a name="l00670"></a>00670         <span class="keywordflow">elif</span> key <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l00671"></a>00671             <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key]
<a name="l00672"></a>00672         <span class="keywordflow">return</span> getattr(super(Molecule, self), key)
<a name="l00673"></a>00673 
<a name="l00674"></a>00674     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a3e716bb5d0b0450d5774cfc42a44c789" title="Whenever we try to get a class attribute, it first tries to get the attribute from the Data dictionar...">__setattr__</a>(self, key, value):
<a name="l00675"></a>00675         <span class="stringliteral">&quot;&quot;&quot; Whenever we try to get a class attribute, it first tries to get the attribute from the Data dictionary. &quot;&quot;&quot;</span>
<a name="l00676"></a>00676         <span class="comment">## These attributes return a list of attribute names defined in this class, that belong in the chosen category.</span>
<a name="l00677"></a>00677         <span class="comment">## For example: self.FrameKeys should return set([&#39;xyzs&#39;,&#39;boxes&#39;]) if xyzs and boxes exist in self.Data</span>
<a name="l00678"></a>00678         <span class="keywordflow">if</span> key <span class="keywordflow">in</span> AllVariableNames:
<a name="l00679"></a>00679             self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key] = value
<a name="l00680"></a>00680         <span class="keywordflow">return</span> super(Molecule,self).<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a3e716bb5d0b0450d5774cfc42a44c789" title="Whenever we try to get a class attribute, it first tries to get the attribute from the Data dictionar...">__setattr__</a>(key, value)
<a name="l00681"></a>00681 
<a name="l00682"></a>00682     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a0da69575f235955e5562e46d311a5536" title="The Molecule class has list-like behavior, so we can get slices of it.">__getitem__</a>(self, key):
<a name="l00683"></a>00683         <span class="stringliteral">&quot;&quot;&quot; </span>
<a name="l00684"></a>00684 <span class="stringliteral">        The Molecule class has list-like behavior, so we can get slices of it.</span>
<a name="l00685"></a>00685 <span class="stringliteral">        If we say MyMolecule[0:10], then we&#39;ll return a copy of MyMolecule with frames 0 through 9.</span>
<a name="l00686"></a>00686 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00687"></a>00687         <span class="keywordflow">if</span> isinstance(key, int) <span class="keywordflow">or</span> isinstance(key, slice) <span class="keywordflow">or</span> isinstance(key,np.ndarray):
<a name="l00688"></a>00688             <span class="keywordflow">if</span> isinstance(key, int):
<a name="l00689"></a>00689                 key = [key]
<a name="l00690"></a>00690             New = <a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html" title="Lee-Ping&#39;s general file format conversion class.">Molecule</a>()
<a name="l00691"></a>00691             <span class="keywordflow">for</span> k <span class="keywordflow">in</span> self.FrameKeys:
<a name="l00692"></a>00692                 <span class="keywordflow">if</span> k == <span class="stringliteral">&#39;boxes&#39;</span>:
<a name="l00693"></a>00693                     New.Data[k] = [j <span class="keywordflow">for</span> i, j <span class="keywordflow">in</span> enumerate(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[k]) <span class="keywordflow">if</span> i <span class="keywordflow">in</span> np.arange(len(self))[key]]
<a name="l00694"></a>00694                 <span class="keywordflow">else</span>:
<a name="l00695"></a>00695                     New.Data[k] = list(np.array(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[k])[key])
<a name="l00696"></a>00696             <span class="keywordflow">for</span> k <span class="keywordflow">in</span> self.AtomKeys | self.MetaKeys:
<a name="l00697"></a>00697                 New.Data[k] = copy.deepcopy(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[k])
<a name="l00698"></a>00698             <span class="keywordflow">return</span> New
<a name="l00699"></a>00699         <span class="keywordflow">else</span>:
<a name="l00700"></a>00700             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;getitem is not implemented for keys of type %s&#39;</span> % str(key))
<a name="l00701"></a>00701 
<a name="l00702"></a>00702     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ab4a7a79d738889528f3823b46244ea7d" title="Similarly, in order to delete a frame, we simply perform item deletion on framewise variables...">__delitem__</a>(self, key):
<a name="l00703"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a3e716bb5d0b0450d5774cfc42a44c789">00703</a>         <span class="stringliteral">&quot;&quot;&quot; </span>
<a name="l00704"></a>00704 <span class="stringliteral">        Similarly, in order to delete a frame, we simply perform item deletion on</span>
<a name="l00705"></a>00705 <span class="stringliteral">        framewise variables.</span>
<a name="l00706"></a>00706 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00707"></a>00707         <span class="keywordflow">for</span> k <span class="keywordflow">in</span> self.FrameKeys:
<a name="l00708"></a>00708             del self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[k][key]
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a40360a68b3f2f14406d3524e62f0c0a1" title="List-like behavior for looping over trajectories.">__iter__</a>(self):
<a name="l00711"></a>00711         <span class="stringliteral">&quot;&quot;&quot; List-like behavior for looping over trajectories. Note that these values are returned by reference. </span>
<a name="l00712"></a>00712 <span class="stringliteral">        Note that this is intended to be more efficient than __getitem__, so when we loop over a trajectory,</span>
<a name="l00713"></a>00713 <span class="stringliteral">        it&#39;s best to go &quot;for m in M&quot; instead of &quot;for i in range(len(M)): m = M[i]&quot;</span>
<a name="l00714"></a>00714 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00715"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a0da69575f235955e5562e46d311a5536">00715</a>         <span class="keywordflow">for</span> frame <span class="keywordflow">in</span> range(self.ns):
<a name="l00716"></a>00716             New = <a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html" title="Lee-Ping&#39;s general file format conversion class.">Molecule</a>()
<a name="l00717"></a>00717             <span class="keywordflow">for</span> k <span class="keywordflow">in</span> self.FrameKeys:
<a name="l00718"></a>00718                 New.Data[k] = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[k][frame]
<a name="l00719"></a>00719             <span class="keywordflow">for</span> k <span class="keywordflow">in</span> self.AtomKeys | self.MetaKeys:
<a name="l00720"></a>00720                 New.Data[k] = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[k]
<a name="l00721"></a>00721             <span class="keywordflow">yield</span> New
<a name="l00722"></a>00722 
<a name="l00723"></a>00723     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a3e82ae8215555b543f1e5800b718c409" title="Add method for Molecule objects.">__add__</a>(self,other):
<a name="l00724"></a>00724         <span class="stringliteral">&quot;&quot;&quot; Add method for Molecule objects. &quot;&quot;&quot;</span>
<a name="l00725"></a>00725         <span class="comment"># Check type of other</span>
<a name="l00726"></a>00726         <span class="keywordflow">if</span> <span class="keywordflow">not</span> isinstance(other,Molecule):
<a name="l00727"></a>00727             <span class="keywordflow">raise</span> TypeError(<span class="stringliteral">&#39;A Molecule instance can only be added to another Molecule instance&#39;</span>)
<a name="l00728"></a>00728         <span class="comment"># Create the sum of the two classes by copying the first class.</span>
<a name="l00729"></a>00729         Sum = <a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html" title="Lee-Ping&#39;s general file format conversion class.">Molecule</a>()
<a name="l00730"></a>00730         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> AtomVariableNames | MetaVariableNames:
<a name="l00731"></a>00731             <span class="comment"># Because a molecule object can only have one &#39;file name&#39; or &#39;file type&#39; attribute,</span>
<a name="l00732"></a>00732             <span class="comment"># we only keep the original one.  This isn&#39;t perfect, but that&#39;s okay.</span>
<a name="l00733"></a>00733             <span class="keywordflow">if</span> key == <span class="stringliteral">&#39;fnm&#39;</span> <span class="keywordflow">or</span> key == <span class="stringliteral">&#39;ftype&#39;</span> <span class="keywordflow">and</span> key <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l00734"></a>00734                 Sum.Data[key] = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key]
<a name="l00735"></a>00735             <span class="keywordflow">elif</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#a6f7c6217b1c64da309a8abd21dfdcf08">diff</a>(self, other, key):
<a name="l00736"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ab4a7a79d738889528f3823b46244ea7d">00736</a>                 <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;The data member called %s is not the same for these two objects&#39;</span> % key)
<a name="l00737"></a>00737             <span class="keywordflow">elif</span> key <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l00738"></a>00738                 Sum.Data[key] = copy.deepcopy(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key])
<a name="l00739"></a>00739             <span class="keywordflow">elif</span> key <span class="keywordflow">in</span> other.Data:
<a name="l00740"></a>00740                 Sum.Data[key] = copy.deepcopy(other.Data[key])
<a name="l00741"></a>00741         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> FrameVariableNames:
<a name="l00742"></a>00742             <span class="keywordflow">if</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#a5b50df23cc4d0e617fdc56538f0bea63">both</a>(self, other, key):
<a name="l00743"></a>00743                 <span class="keywordflow">if</span> type(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key]) <span class="keywordflow">is</span> <span class="keywordflow">not</span> list:
<a name="l00744"></a>00744                     <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Key %s in self is a FrameKey, it must be a list&#39;</span> % key)
<a name="l00745"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a40360a68b3f2f14406d3524e62f0c0a1">00745</a>                 <span class="keywordflow">if</span> type(other.Data[key]) <span class="keywordflow">is</span> <span class="keywordflow">not</span> list:
<a name="l00746"></a>00746                     <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Key %s in other is a FrameKey, it must be a list&#39;</span> % key)
<a name="l00747"></a>00747                 Sum.Data[key] = list(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key] + other.Data[key])
<a name="l00748"></a>00748             <span class="keywordflow">elif</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#a75775be6563ad7f10695a9a45ff49ba9">either</a>(self, other, key):
<a name="l00749"></a>00749                 <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Key %s is a FrameKey, must exist in both self and other for them to be added (for now).&#39;</span>)
<a name="l00750"></a>00750         <span class="keywordflow">return</span> Sum
<a name="l00751"></a>00751  
<a name="l00752"></a>00752     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ae1bcdf1cc78a6cc165de80bacc7b69c5" title="Add method for Molecule objects.">__iadd__</a>(self,other):
<a name="l00753"></a>00753         <span class="stringliteral">&quot;&quot;&quot; Add method for Molecule objects. &quot;&quot;&quot;</span>
<a name="l00754"></a>00754         <span class="comment"># Check type of other</span>
<a name="l00755"></a>00755         <span class="keywordflow">if</span> <span class="keywordflow">not</span> isinstance(other,Molecule):
<a name="l00756"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a3e82ae8215555b543f1e5800b718c409">00756</a>             <span class="keywordflow">raise</span> TypeError(<span class="stringliteral">&#39;A Molecule instance can only be added to another Molecule instance&#39;</span>)
<a name="l00757"></a>00757         <span class="comment"># Create the sum of the two classes by copying the first class.</span>
<a name="l00758"></a>00758         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> AtomVariableNames | MetaVariableNames:
<a name="l00759"></a>00759             <span class="keywordflow">if</span> key == <span class="stringliteral">&#39;fnm&#39;</span> <span class="keywordflow">or</span> key == <span class="stringliteral">&#39;ftype&#39;</span>: <span class="keywordflow">pass</span>
<a name="l00760"></a>00760             <span class="keywordflow">elif</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#a6f7c6217b1c64da309a8abd21dfdcf08">diff</a>(self, other, key):
<a name="l00761"></a>00761                 <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;The data member called %s is not the same for these two objects&#39;</span> % key)
<a name="l00762"></a>00762             <span class="comment"># Information from the other class is added to this class (if said info doesn&#39;t exist.)</span>
<a name="l00763"></a>00763             <span class="keywordflow">elif</span> key <span class="keywordflow">in</span> other.Data:
<a name="l00764"></a>00764                 self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key] = copy.deepcopy(other.Data[key])
<a name="l00765"></a>00765         <span class="comment"># FrameKeys must be a list.</span>
<a name="l00766"></a>00766         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> FrameVariableNames:
<a name="l00767"></a>00767             <span class="keywordflow">if</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#a5b50df23cc4d0e617fdc56538f0bea63">both</a>(self, other, key):
<a name="l00768"></a>00768                 <span class="keywordflow">if</span> type(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key]) <span class="keywordflow">is</span> <span class="keywordflow">not</span> list:
<a name="l00769"></a>00769                     <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Key %s in self is a FrameKey, it must be a list&#39;</span> % key)
<a name="l00770"></a>00770                 <span class="keywordflow">if</span> type(other.Data[key]) <span class="keywordflow">is</span> <span class="keywordflow">not</span> list:
<a name="l00771"></a>00771                     <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Key %s in other is a FrameKey, it must be a list&#39;</span> % key)
<a name="l00772"></a>00772                 self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key] += other.Data[key]
<a name="l00773"></a>00773             <span class="keywordflow">elif</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#a75775be6563ad7f10695a9a45ff49ba9">either</a>(self, other, key):
<a name="l00774"></a>00774                 <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Key %s is a FrameKey, must exist in both self and other for them to be added (for now).&#39;</span> % key)
<a name="l00775"></a>00775         <span class="keywordflow">return</span> self
<a name="l00776"></a>00776 
<a name="l00777"></a>00777     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a77417ff99b19f6d0b7c6f527e83fa7f1">append</a>(self,other):
<a name="l00778"></a>00778         self += other
<a name="l00779"></a>00779 
<a name="l00780"></a>00780     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a3f8233f4e9911d7af0f17ca66c16ff92" title="To create the Molecule object, we simply define the table of file reading/writing functions and read ...">__init__</a>(self, fnm = None, ftype = None, positive_resid=True, build_topology = True):
<a name="l00781"></a>00781         <span class="stringliteral">&quot;&quot;&quot; To create the Molecule object, we simply define the table of</span>
<a name="l00782"></a>00782 <span class="stringliteral">        file reading/writing functions and read in a file if it is</span>
<a name="l00783"></a>00783 <span class="stringliteral">        provided.&quot;&quot;&quot;</span>
<a name="l00784"></a>00784         <span class="comment">#=========================================#</span>
<a name="l00785"></a>00785         <span class="comment">#|           File type tables            |#</span>
<a name="l00786"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ae1bcdf1cc78a6cc165de80bacc7b69c5">00786</a>         <span class="comment">#|    Feel free to edit these as more    |#</span>
<a name="l00787"></a>00787         <span class="comment">#|      readers / writers are added      |#</span>
<a name="l00788"></a>00788         <span class="comment">#=========================================#</span>
<a name="l00789"></a>00789         <span class="comment">## The table of file readers</span>
<a name="l00790"></a>00790         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ab812bbb4ae25ee4f6b69a7926a2ef3e8" title="The table of file readers.">Read_Tab</a> = {<span class="stringliteral">&#39;gaussian&#39;</span> : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a861feda06e1f60ab25c45eaaaf228cfc" title="Parse a Gaussian .com file and return a SINGLE-ELEMENT list of xyz coordinates (no multiple file supp...">read_com</a>,
<a name="l00791"></a>00791                          <span class="stringliteral">&#39;gromacs&#39;</span>  : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a963a4382dc59ebd8dd9ee2064843e355" title="Read a GROMACS .gro file.">read_gro</a>,
<a name="l00792"></a>00792                          <span class="stringliteral">&#39;charmm&#39;</span>   : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8b8d3444945cab760288f28996787855" title="Read a CHARMM .cor (or .crd) file.">read_charmm</a>,
<a name="l00793"></a>00793                          <span class="stringliteral">&#39;dcd&#39;</span>      : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ad8fa6cc7424aae00ee3f5bb87d28e037">read_dcd</a>,
<a name="l00794"></a>00794                          <span class="stringliteral">&#39;mdcrd&#39;</span>    : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ab1b56d66b7673b2631e2cee013a80b93" title="Parse an AMBER .mdcrd file.">read_mdcrd</a>,
<a name="l00795"></a>00795                          <span class="stringliteral">&#39;pdb&#39;</span>      : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#afadc87c0cc32dc73558cd901a4c64dd4" title="Loads a PDB and returns a dictionary containing its data.">read_pdb</a>,
<a name="l00796"></a>00796                          <span class="stringliteral">&#39;xyz&#39;</span>      : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a15a7a0e0377e6dfd52e60c77fbc583c1" title="Parse a .xyz file which contains several xyz coordinates, and return their elements.">read_xyz</a>,
<a name="l00797"></a>00797                          <span class="stringliteral">&#39;mol2&#39;</span>     : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a14b1fbc70a083d21fd016b5dd854fd56">read_mol2</a>,
<a name="l00798"></a>00798                          <span class="stringliteral">&#39;qcin&#39;</span>     : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a003b182b54de4473c4691ae1474b1ada" title="Read a Q-Chem input file.">read_qcin</a>,
<a name="l00799"></a>00799                          <span class="stringliteral">&#39;qcout&#39;</span>    : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8c9e71843e7123c57c43c24af2d84f25" title="Q-Chem output file reader, adapted for our parser.">read_qcout</a>,
<a name="l00800"></a>00800                          <span class="stringliteral">&#39;qcesp&#39;</span>    : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a27fb6201b435a3b205ae62f605256f3d">read_qcesp</a>,
<a name="l00801"></a>00801                          <span class="stringliteral">&#39;qdata&#39;</span>    : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a1d34af6a7d22dd34850d58efe8595b20">read_qdata</a>,
<a name="l00802"></a>00802                          <span class="stringliteral">&#39;tinker&#39;</span>   : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#aeb5983ae61079198f077f55e448e2c32" title="Read a TINKER .arc file.">read_arc</a>}
<a name="l00803"></a>00803         <span class="comment">## The table of file writers</span>
<a name="l00804"></a>00804         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a950a2ec0b5697bf88f192dec676825fc" title="The table of file writers.">Write_Tab</a> = {<span class="stringliteral">&#39;gromacs&#39;</span> : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a503eae2cee228e4cc5fc736504714925">write_gro</a>,
<a name="l00805"></a>00805                           <span class="stringliteral">&#39;xyz&#39;</span>     : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#adc6620e8287edabe161442de12295f75">write_xyz</a>,
<a name="l00806"></a>00806                           <span class="stringliteral">&#39;molproq&#39;</span> : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#aba14226f272f91c91ecf7060ff136a2b">write_molproq</a>,
<a name="l00807"></a>00807                           <span class="stringliteral">&#39;dcd&#39;</span>     : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a0dee435704418bf51199d6bab6d92249">write_dcd</a>,
<a name="l00808"></a>00808                           <span class="stringliteral">&#39;mdcrd&#39;</span>   : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#aab5ea35ab9d68559fd6ea7b747c2bddb">write_mdcrd</a>,
<a name="l00809"></a>00809                           <span class="stringliteral">&#39;pdb&#39;</span>     : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a47082443566cd50add3f2ec20af9cc10" title="Save to a PDB.">write_pdb</a>,
<a name="l00810"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a77417ff99b19f6d0b7c6f527e83fa7f1">00810</a>                           <span class="stringliteral">&#39;qcin&#39;</span>    : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#af46b2ba6ef777cf8301bc16e157c724d">write_qcin</a>,
<a name="l00811"></a>00811                           <span class="stringliteral">&#39;qdata&#39;</span>   : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a1ef6aefd3218f8ab3f9dc2b37e602fbf" title="Text quantum data format.">write_qdata</a>,
<a name="l00812"></a>00812                           <span class="stringliteral">&#39;tinker&#39;</span>  : self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a95782abfb36e7080a1b98bfad2ced4f3">write_arc</a>}
<a name="l00813"></a>00813         <span class="comment">## A funnel dictionary that takes redundant file types</span>
<a name="l00814"></a>00814         <span class="comment">## and maps them down to a few.</span>
<a name="l00815"></a>00815         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8ee3f691f4ff9c4236afa756ed5482e3" title="A funnel dictionary that takes redundant file types and maps them down to a few.">Funnel</a>    = {<span class="stringliteral">&#39;gromos&#39;</span>  : <span class="stringliteral">&#39;gromacs&#39;</span>,
<a name="l00816"></a>00816                           <span class="stringliteral">&#39;gro&#39;</span>     : <span class="stringliteral">&#39;gromacs&#39;</span>,
<a name="l00817"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a3f8233f4e9911d7af0f17ca66c16ff92">00817</a>                           <span class="stringliteral">&#39;g96&#39;</span>     : <span class="stringliteral">&#39;gromacs&#39;</span>,
<a name="l00818"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ab812bbb4ae25ee4f6b69a7926a2ef3e8">00818</a>                           <span class="stringliteral">&#39;gmx&#39;</span>     : <span class="stringliteral">&#39;gromacs&#39;</span>,
<a name="l00819"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a950a2ec0b5697bf88f192dec676825fc">00819</a>                           <span class="stringliteral">&#39;in&#39;</span>      : <span class="stringliteral">&#39;qcin&#39;</span>,
<a name="l00820"></a>00820                           <span class="stringliteral">&#39;com&#39;</span>     : <span class="stringliteral">&#39;gaussian&#39;</span>,
<a name="l00821"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8ee3f691f4ff9c4236afa756ed5482e3">00821</a>                           <span class="stringliteral">&#39;out&#39;</span>     : <span class="stringliteral">&#39;qcout&#39;</span>,
<a name="l00822"></a>00822                           <span class="stringliteral">&#39;esp&#39;</span>     : <span class="stringliteral">&#39;qcesp&#39;</span>,
<a name="l00823"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a5ba227fb037995246be7bca5cf633b8b">00823</a>                           <span class="stringliteral">&#39;txt&#39;</span>     : <span class="stringliteral">&#39;qdata&#39;</span>,
<a name="l00824"></a>00824                           <span class="stringliteral">&#39;crd&#39;</span>     : <span class="stringliteral">&#39;charmm&#39;</span>,
<a name="l00825"></a>00825                           <span class="stringliteral">&#39;cor&#39;</span>     : <span class="stringliteral">&#39;charmm&#39;</span>,
<a name="l00826"></a>00826                           <span class="stringliteral">&#39;arc&#39;</span>     : <span class="stringliteral">&#39;tinker&#39;</span>}
<a name="l00827"></a>00827         <span class="comment">## Creates entries like &#39;gromacs&#39; : &#39;gromacs&#39; and &#39;xyz&#39; : &#39;xyz&#39;</span>
<a name="l00828"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a5e092c726455a18c9300f5c5362121d8">00828</a>         <span class="comment">## in the Funnel</span>
<a name="l00829"></a>00829         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a5ba227fb037995246be7bca5cf633b8b" title="Creates entries like &#39;gromacs&#39; : &#39;gromacs&#39; and &#39;xyz&#39; : &#39;xyz&#39; in the Funnel.">positive_resid</a> = positive_resid
<a name="l00830"></a>00830         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> set(self.Read_Tab.keys() + self.Write_Tab.keys()):
<a name="l00831"></a>00831             self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8ee3f691f4ff9c4236afa756ed5482e3" title="A funnel dictionary that takes redundant file types and maps them down to a few.">Funnel</a>[i] = i
<a name="l00832"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#accabf9159aa7f3c6e514ec048d88eeaa">00832</a>         <span class="comment"># Data container.  All of the data is stored in here.</span>
<a name="l00833"></a>00833         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a> = {}
<a name="l00834"></a>00834         <span class="comment">## Read in stuff if we passed in a file name, otherwise return an empty instance.</span>
<a name="l00835"></a>00835         <span class="keywordflow">if</span> fnm != <span class="keywordtype">None</span>:
<a name="l00836"></a>00836             self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[<span class="stringliteral">&#39;fnm&#39;</span>] = fnm
<a name="l00837"></a>00837             <span class="keywordflow">if</span> ftype == <span class="keywordtype">None</span>:
<a name="l00838"></a>00838                 <span class="comment">## Try to determine from the file name using the extension.</span>
<a name="l00839"></a>00839                 ftype = os.path.splitext(fnm)[1][1:]
<a name="l00840"></a>00840             <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(fnm):
<a name="l00841"></a>00841                 <span class="keywordflow">raise</span> IOError(<span class="stringliteral">&#39;Tried to create Molecule object from a file that does not exist&#39;</span>)
<a name="l00842"></a>00842             self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[<span class="stringliteral">&#39;ftype&#39;</span>] = ftype
<a name="l00843"></a>00843             <span class="comment">## Actually read the file.</span>
<a name="l00844"></a>00844             Parsed = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ab812bbb4ae25ee4f6b69a7926a2ef3e8" title="The table of file readers.">Read_Tab</a>[self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8ee3f691f4ff9c4236afa756ed5482e3" title="A funnel dictionary that takes redundant file types and maps them down to a few.">Funnel</a>[ftype.lower()]](fnm)
<a name="l00845"></a>00845             <span class="comment">## Set member variables.</span>
<a name="l00846"></a>00846             <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> Parsed.items():
<a name="l00847"></a>00847                 self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key] = val
<a name="l00848"></a>00848             <span class="comment">## Create a list of comment lines if we don&#39;t already have them from reading the file.</span>
<a name="l00849"></a>00849             <span class="keywordflow">if</span> <span class="stringliteral">&#39;comms&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l00850"></a>00850                 self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a5e092c726455a18c9300f5c5362121d8" title="Read in stuff if we passed in a file name, otherwise return an empty instance.">comms</a> = [<span class="stringliteral">&#39;Generated by ForceBalance from %s: Frame %i of %i&#39;</span> % (fnm, i+1, self.ns) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.ns)]
<a name="l00851"></a>00851             <span class="keywordflow">else</span>:
<a name="l00852"></a>00852                 self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a5e092c726455a18c9300f5c5362121d8" title="Read in stuff if we passed in a file name, otherwise return an empty instance.">comms</a> = [i.expandtabs() <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a5e092c726455a18c9300f5c5362121d8" title="Read in stuff if we passed in a file name, otherwise return an empty instance.">comms</a>]
<a name="l00853"></a>00853             <span class="comment">## Make sure the comment line isn&#39;t too long</span>
<a name="l00854"></a>00854             <span class="comment"># for i in range(len(self.comms)):</span>
<a name="l00855"></a>00855             <span class="comment">#     self.comms[i] = self.comms[i][:100] if len(self.comms[i]) &gt; 100 else self.comms[i]</span>
<a name="l00856"></a>00856             <span class="comment"># Attempt to build the topology for small systems. :)</span>
<a name="l00857"></a>00857             <span class="keywordflow">if</span> <span class="stringliteral">&#39;networkx&#39;</span> <span class="keywordflow">in</span> sys.modules <span class="keywordflow">and</span> build_topology <span class="keywordflow">and</span> self.na &gt; 0:
<a name="l00858"></a>00858                 <span class="keywordflow">if</span> self.na &gt; 10000:
<a name="l00859"></a>00859                     <span class="keywordflow">print</span> <span class="stringliteral">&quot;Warning: Large number of atoms (%i), topology building may take a long time&quot;</span> % self.na
<a name="l00860"></a>00860                 self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#accabf9159aa7f3c6e514ec048d88eeaa" title="Make sure the comment line isn&#39;t too long for i in range(len(self.comms)): self.comms[i] = self...">topology</a> = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a071f18dacd881f761462f772bb0cf632" title="A bare-bones implementation of the bond graph capability in the nanoreactor code.">build_topology</a>()
<a name="l00861"></a>00861                 self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac0a283e8dd0d63a852311ccdc904e31f">molecules</a> = nx.connected_component_subgraphs(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#accabf9159aa7f3c6e514ec048d88eeaa" title="Make sure the comment line isn&#39;t too long for i in range(len(self.comms)): self.comms[i] = self...">topology</a>)
<a name="l00862"></a>00862                 <span class="keywordflow">if</span> <span class="stringliteral">&#39;bonds&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l00863"></a>00863                     self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[<span class="stringliteral">&#39;bonds&#39;</span>] = self.topology.edges()
<a name="l00864"></a>00864 
<a name="l00865"></a>00865     <span class="comment">#=====================================#</span>
<a name="l00866"></a>00866     <span class="comment">#|     Core read/write functions     |#</span>
<a name="l00867"></a>00867     <span class="comment">#| Hopefully we won&#39;t have to change |#</span>
<a name="l00868"></a>00868     <span class="comment">#|         these very often!         |#</span>
<a name="l00869"></a>00869     <span class="comment">#=====================================#</span>
<a name="l00870"></a>00870 
<a name="l00871"></a>00871     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a80851250d8e749bea882d5aa4bcfcdd1">require</a>(self, *args):
<a name="l00872"></a>00872         <span class="keywordflow">for</span> arg <span class="keywordflow">in</span> args:
<a name="l00873"></a>00873             <span class="keywordflow">if</span> arg <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l00874"></a>00874                 <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&quot;%s is a required attribute for writing this type of file but it&#39;s not present&quot;</span> % arg)
<a name="l00875"></a>00875 
<a name="l00876"></a>00876     <span class="comment"># def read(self, fnm, ftype = None):</span>
<a name="l00877"></a>00877     <span class="comment">#     &quot;&quot;&quot; Read in a file. &quot;&quot;&quot;</span>
<a name="l00878"></a>00878     <span class="comment">#     if ftype == None:</span>
<a name="l00879"></a>00879     <span class="comment">#         ## Try to determine from the file name using the extension.</span>
<a name="l00880"></a>00880     <span class="comment">#         ftype = os.path.splitext(fnm)[1][1:]</span>
<a name="l00881"></a>00881     <span class="comment">#     ## This calls the table of reader functions and prints out an error message if it fails.</span>
<a name="l00882"></a>00882     <span class="comment">#     ## &#39;Answer&#39; is a dictionary of data that is returned from the reader function.</span>
<a name="l00883"></a>00883     <span class="comment">#     Answer = self.Read_Tab[self.Funnel[ftype.lower()]](fnm)</span>
<a name="l00884"></a>00884     <span class="comment">#     return Answer</span>
<a name="l00885"></a>00885 
<a name="l00886"></a>00886     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a4ecfdf28aacff9c081dd50cd4ac84f89">write</a>(self,fnm=None,ftype=None,append=False,select=None):
<a name="l00887"></a>00887         <span class="keywordflow">if</span> fnm == <span class="keywordtype">None</span> <span class="keywordflow">and</span> ftype == <span class="keywordtype">None</span>:
<a name="l00888"></a>00888             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&quot;Output file name and file type are not specified.&quot;</span>)
<a name="l00889"></a>00889         <span class="keywordflow">elif</span> ftype == <span class="keywordtype">None</span>:
<a name="l00890"></a>00890             ftype = os.path.splitext(fnm)[1][1:]
<a name="l00891"></a>00891         <span class="comment">## Fill in comments.</span>
<a name="l00892"></a>00892         <span class="keywordflow">if</span> len(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a5e092c726455a18c9300f5c5362121d8" title="Read in stuff if we passed in a file name, otherwise return an empty instance.">comms</a>) &lt; len(self.xyzs):
<a name="l00893"></a>00893             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a5e092c726455a18c9300f5c5362121d8" title="Read in stuff if we passed in a file name, otherwise return an empty instance.">comms</a>), len(self.xyzs)):
<a name="l00894"></a>00894                 self.comms.append(<span class="stringliteral">&quot;Frame %i: generated by ForceBalance&quot;</span> % i)
<a name="l00895"></a>00895         <span class="comment">## I needed to add in this line because the DCD writer requires the file name,</span>
<a name="l00896"></a>00896         <span class="comment">## but the other methods don&#39;t.</span>
<a name="l00897"></a>00897         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a7887451529cc2b396240b6e4ebfcc2de" title="Fill in comments.">fout</a> = fnm
<a name="l00898"></a>00898         <span class="keywordflow">if</span> type(select) <span class="keywordflow">in</span> [int, np.int64, np.int32]:
<a name="l00899"></a>00899             select = [select]
<a name="l00900"></a>00900         <span class="keywordflow">if</span> select == <span class="keywordtype">None</span>:
<a name="l00901"></a>00901             select = range(len(self))
<a name="l00902"></a>00902         Answer = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a950a2ec0b5697bf88f192dec676825fc" title="The table of file writers.">Write_Tab</a>[self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8ee3f691f4ff9c4236afa756ed5482e3" title="A funnel dictionary that takes redundant file types and maps them down to a few.">Funnel</a>[ftype.lower()]](select)
<a name="l00903"></a>00903         <span class="comment">## Any method that returns text will give us a list of lines, which we then write to the file.</span>
<a name="l00904"></a>00904         <span class="keywordflow">if</span> Answer != <span class="keywordtype">None</span>:
<a name="l00905"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a80851250d8e749bea882d5aa4bcfcdd1">00905</a>             <span class="keywordflow">if</span> fnm == <span class="keywordtype">None</span> <span class="keywordflow">or</span> fnm == sys.stdout:
<a name="l00906"></a>00906                 outfile = sys.stdout
<a name="l00907"></a>00907             <span class="keywordflow">elif</span> append:
<a name="l00908"></a>00908                 outfile = open(fnm,<span class="stringliteral">&#39;a&#39;</span>)
<a name="l00909"></a>00909             <span class="keywordflow">else</span>:
<a name="l00910"></a>00910                 outfile = open(fnm,<span class="stringliteral">&#39;w&#39;</span>)
<a name="l00911"></a>00911             <span class="keywordflow">for</span> line <span class="keywordflow">in</span> Answer:
<a name="l00912"></a>00912                 <span class="keywordflow">print</span> &gt;&gt; outfile,line
<a name="l00913"></a>00913             outfile.close()
<a name="l00914"></a>00914 
<a name="l00915"></a>00915     <span class="comment">#=====================================#</span>
<a name="l00916"></a>00916     <span class="comment">#|         Useful functions          |#</span>
<a name="l00917"></a>00917     <span class="comment">#|     For doing useful things       |#</span>
<a name="l00918"></a>00918     <span class="comment">#=====================================#</span>
<a name="l00919"></a>00919 
<a name="l00920"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a4ecfdf28aacff9c081dd50cd4ac84f89">00920</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a6aa22586a5590f63ea20e269e3f195a5">center_of_mass</a>(self):
<a name="l00921"></a>00921         M = sum([PeriodicTable[self.elem[i]] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)])
<a name="l00922"></a>00922         <span class="keywordflow">return</span> np.array([np.sum([xyz[i,:] * PeriodicTable[self.elem[i]] / M <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(xyz.shape[0])],axis=0) <span class="keywordflow">for</span> xyz <span class="keywordflow">in</span> self.xyzs])
<a name="l00923"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a7887451529cc2b396240b6e4ebfcc2de">00923</a> 
<a name="l00924"></a>00924     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a02ff6f6642ed47c3b1fa3bb00191c32a">radius_of_gyration</a>(self):
<a name="l00925"></a>00925         M = sum([PeriodicTable[self.elem[i]] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)])
<a name="l00926"></a>00926         coms = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a6aa22586a5590f63ea20e269e3f195a5">center_of_mass</a>()
<a name="l00927"></a>00927         rgs = []
<a name="l00928"></a>00928         <span class="keywordflow">for</span> i, xyz <span class="keywordflow">in</span> enumerate(self.xyzs):
<a name="l00929"></a>00929             xyz1 = xyz.copy()
<a name="l00930"></a>00930             xyz1 -= coms[i]
<a name="l00931"></a>00931             rgs.append(np.sum([PeriodicTable[self.elem[i]]*np.dot(x,x) <span class="keywordflow">for</span> i, x <span class="keywordflow">in</span> enumerate(xyz1)])/M)
<a name="l00932"></a>00932         <span class="keywordflow">return</span> np.array(rgs)
<a name="l00933"></a>00933             
<a name="l00934"></a>00934 <span class="comment">#        if center:</span>
<a name="l00935"></a>00935 <span class="comment">#            xyz1 -= xyz1.mean(0)</span>
<a name="l00936"></a>00936 <span class="comment">#        for index2, xyz2 in enumerate(self.xyzs):</span>
<a name="l00937"></a>00937 <span class="comment">#            if index2 == 0: continue</span>
<a name="l00938"></a>00938 <span class="comment">#            xyz2 -= xyz2.mean(0)</span>
<a name="l00939"></a>00939 <span class="comment">#            if smooth:</span>
<a name="l00940"></a>00940 <span class="comment">#                ref = index2-1</span>
<a name="l00941"></a>00941 <span class="comment">#            else:</span>
<a name="l00942"></a>00942 <span class="comment">#                ref = 0</span>
<a name="l00943"></a>00943 <span class="comment">#            tr, rt = get_rotate_translate(xyz2,self.xyzs[ref])</span>
<a name="l00944"></a>00944 <span class="comment">#            xyz2 = np.dot(xyz2, rt) + tr</span>
<a name="l00945"></a>00945 <span class="comment">#            self.xyzs[index2] = xyz2</span>
<a name="l00946"></a>00946 
<a name="l00947"></a>00947     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a68e276a95910d534fa2e937abbc60e1c">load_frames</a>(self, fnm):
<a name="l00948"></a>00948         NewMol = <a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html" title="Lee-Ping&#39;s general file format conversion class.">Molecule</a>(fnm)
<a name="l00949"></a>00949         <span class="keywordflow">if</span> NewMol.na != self.na:
<a name="l00950"></a>00950             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;When loading frames, don\&#39;t change the number of atoms.&#39;</span>)
<a name="l00951"></a>00951         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> NewMol.FrameKeys:
<a name="l00952"></a>00952             self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key] = NewMol.Data[key]
<a name="l00953"></a>00953 
<a name="l00954"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a6aa22586a5590f63ea20e269e3f195a5">00954</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a441d8367806c9a802bd0693fea16c62a">edit_qcrems</a>(self, in_dict, subcalc = None):
<a name="l00955"></a>00955         <span class="keywordflow">if</span> subcalc == <span class="keywordtype">None</span>:
<a name="l00956"></a>00956             <span class="keywordflow">for</span> qcrem <span class="keywordflow">in</span> self.qcrems:
<a name="l00957"></a>00957                 <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> in_dict.items():
<a name="l00958"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a02ff6f6642ed47c3b1fa3bb00191c32a">00958</a>                     qcrem[key] = val
<a name="l00959"></a>00959         <span class="keywordflow">else</span>:
<a name="l00960"></a>00960             <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> in_dict.items():
<a name="l00961"></a>00961                 self.qcrems[subcalc][key] = val
<a name="l00962"></a>00962 
<a name="l00963"></a>00963     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a33020ff5e5cec23a3d9d1fe7adfa8583">add_quantum</a>(self, other):
<a name="l00964"></a>00964         <span class="keywordflow">if</span> type(other) <span class="keywordflow">is</span> Molecule:
<a name="l00965"></a>00965             OtherMol = other
<a name="l00966"></a>00966         <span class="keywordflow">elif</span> type(other) <span class="keywordflow">is</span> str:
<a name="l00967"></a>00967             OtherMol = <a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html" title="Lee-Ping&#39;s general file format conversion class.">Molecule</a>(other)
<a name="l00968"></a>00968         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> OtherMol.QuantumKeys:
<a name="l00969"></a>00969             <span class="keywordflow">if</span> key <span class="keywordflow">in</span> AtomVariableNames <span class="keywordflow">and</span> len(OtherMol.Data[key]) != self.na:
<a name="l00970"></a>00970                 <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;The quantum-key %s is AtomData, but it doesn\&#39;t have the same number of atoms as the Molecule object we\&#39;re adding it to.&#39;</span>)
<a name="l00971"></a>00971             self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key] = copy.deepcopy(OtherMol.Data[key])
<a name="l00972"></a>00972 
<a name="l00973"></a>00973     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a13d86eb62139bdc2a835756cacb3be66" title="Add a virtual site to the system.">add_virtual_site</a>(self, idx, **kwargs):
<a name="l00974"></a>00974         <span class="stringliteral">&quot;&quot;&quot; Add a virtual site to the system.  This does NOT set the position of the virtual site; it sits at the origin. &quot;&quot;&quot;</span>
<a name="l00975"></a>00975         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.AtomKeys:
<a name="l00976"></a>00976             <span class="keywordflow">if</span> key <span class="keywordflow">in</span> kwargs:
<a name="l00977"></a>00977                 self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key].insert(idx,kwargs[key])
<a name="l00978"></a>00978             <span class="keywordflow">else</span>:
<a name="l00979"></a>00979                 <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;You need to specify %s when adding a virtual site to this molecule.&#39;</span> % key)
<a name="l00980"></a>00980         <span class="keywordflow">if</span> <span class="stringliteral">&#39;xyzs&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l00981"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a68e276a95910d534fa2e937abbc60e1c">00981</a>             <span class="keywordflow">for</span> i, xyz <span class="keywordflow">in</span> enumerate(self.xyzs):
<a name="l00982"></a>00982                 <span class="keywordflow">if</span> <span class="stringliteral">&#39;pos&#39;</span> <span class="keywordflow">in</span> kwargs:
<a name="l00983"></a>00983                     self.xyzs[i] = np.insert(xyz, idx, xyz[kwargs[<span class="stringliteral">&#39;pos&#39;</span>]], axis=0)
<a name="l00984"></a>00984                 <span class="keywordflow">else</span>:
<a name="l00985"></a>00985                     self.xyzs[i] = np.insert(xyz, idx, 0.0, axis=0)
<a name="l00986"></a>00986         <span class="keywordflow">else</span>:
<a name="l00987"></a>00987             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;You need to have xyzs in this molecule to add a virtual site.&#39;</span>)
<a name="l00988"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a441d8367806c9a802bd0693fea16c62a">00988</a> 
<a name="l00989"></a>00989     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ad825186bec1659fdad2521a1b377323b" title="Replace all of the data for a certain attribute in the system from orig to want.">replace_peratom</a>(self, key, orig, want):
<a name="l00990"></a>00990         <span class="stringliteral">&quot;&quot;&quot; Replace all of the data for a certain attribute in the system from orig to want. &quot;&quot;&quot;</span>
<a name="l00991"></a>00991         <span class="keywordflow">if</span> key <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l00992"></a>00992             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):
<a name="l00993"></a>00993                 <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key][i] == orig:
<a name="l00994"></a>00994                     self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key][i] = want
<a name="l00995"></a>00995         <span class="keywordflow">else</span>:
<a name="l00996"></a>00996             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;The key that we want to replace (%s) doesn\&#39;t exist.&#39;</span> % key)
<a name="l00997"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a33020ff5e5cec23a3d9d1fe7adfa8583">00997</a> 
<a name="l00998"></a>00998     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ae565eb57c2ee21f2be19b9761754aba5" title="Replace all of the data for a attribute key2 from orig to want, contingent on key1 being equal to con...">replace_peratom_conditional</a>(self, key1, cond, key2, orig, want):
<a name="l00999"></a>00999         <span class="stringliteral">&quot;&quot;&quot; Replace all of the data for a attribute key2 from orig to want, contingent on key1 being equal to cond. </span>
<a name="l01000"></a>01000 <span class="stringliteral">        For instance: replace H1 with H2 if resname is SOL.&quot;&quot;&quot;</span>
<a name="l01001"></a>01001         <span class="keywordflow">if</span> key2 <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a> <span class="keywordflow">and</span> key1 <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l01002"></a>01002             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):
<a name="l01003"></a>01003                 <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key2][i] == orig <span class="keywordflow">and</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key1][i] == cond:
<a name="l01004"></a>01004                     self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key2][i] = want
<a name="l01005"></a>01005         <span class="keywordflow">else</span>:
<a name="l01006"></a>01006             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Either the comparison or replacement key (%s, %s) doesn\&#39;t exist.&#39;</span> % (key1, key2))
<a name="l01007"></a>01007 
<a name="l01008"></a>01008     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a432affdec68562b5b19fd249124480c3" title="Return a copy of the object with certain atoms selected.">atom_select</a>(self,atomslice):
<a name="l01009"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a13d86eb62139bdc2a835756cacb3be66">01009</a>         <span class="stringliteral">&quot;&quot;&quot; Return a copy of the object with certain atoms selected.  Takes an integer, list or array as argument. &quot;&quot;&quot;</span>
<a name="l01010"></a>01010         <span class="keywordflow">if</span> isinstance(atomslice, int):
<a name="l01011"></a>01011             atomslice = [atomslice]
<a name="l01012"></a>01012         <span class="keywordflow">if</span> isinstance(atomslice, list):
<a name="l01013"></a>01013             atomslice = np.array(atomslice)
<a name="l01014"></a>01014         New = <a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html" title="Lee-Ping&#39;s general file format conversion class.">Molecule</a>()
<a name="l01015"></a>01015         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.FrameKeys | self.MetaKeys:
<a name="l01016"></a>01016             New.Data[key] = copy.deepcopy(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key])
<a name="l01017"></a>01017         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.AtomKeys:
<a name="l01018"></a>01018             <span class="keywordflow">if</span> key == <span class="stringliteral">&#39;tinkersuf&#39;</span>: <span class="comment"># Tinker suffix is a bit tricky</span>
<a name="l01019"></a>01019                 Map = dict([(a+1, i+1) <span class="keywordflow">for</span> i, a <span class="keywordflow">in</span> enumerate(atomslice)])
<a name="l01020"></a>01020                 CopySuf = list(np.array(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key])[atomslice])
<a name="l01021"></a>01021                 NewSuf = []
<a name="l01022"></a>01022                 <span class="keywordflow">for</span> line <span class="keywordflow">in</span> CopySuf:
<a name="l01023"></a>01023                     whites      = re.split(<span class="stringliteral">&#39;[^ ]+&#39;</span>,line)
<a name="l01024"></a>01024                     s           = line.split()
<a name="l01025"></a>01025                     <span class="keywordflow">if</span> len(s) &gt; 1:
<a name="l01026"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ad825186bec1659fdad2521a1b377323b">01026</a>                         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(1,len(s)):
<a name="l01027"></a>01027                             s[i] = str(Map[int(s[i])])
<a name="l01028"></a>01028                     NewSuf.append(<span class="stringliteral">&#39;&#39;</span>.join([whites[j]+s[j] <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(len(s))]))
<a name="l01029"></a>01029                 New.Data[<span class="stringliteral">&#39;tinkersuf&#39;</span>] = NewSuf[:]
<a name="l01030"></a>01030             <span class="keywordflow">else</span>:
<a name="l01031"></a>01031                 New.Data[key] = list(np.array(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key])[atomslice])
<a name="l01032"></a>01032         <span class="keywordflow">if</span> <span class="stringliteral">&#39;xyzs&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l01033"></a>01033             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.ns):
<a name="l01034"></a>01034                 New.xyzs[i] = self.xyzs[i][atomslice]
<a name="l01035"></a>01035         <span class="keywordflow">if</span> <span class="stringliteral">&#39;bonds&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l01036"></a>01036             <span class="comment"># print self.bonds</span>
<a name="l01037"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ae565eb57c2ee21f2be19b9761754aba5">01037</a>             <span class="comment"># print atomslice</span>
<a name="l01038"></a>01038             <span class="comment"># print [(b[0] in atomslice and b[1] in atomslice) for b in self.bonds]</span>
<a name="l01039"></a>01039             New.Data[<span class="stringliteral">&#39;bonds&#39;</span>] = [(list(atomslice).index(b[0]), list(atomslice).index(b[1])) <span class="keywordflow">for</span> b <span class="keywordflow">in</span> self.bonds <span class="keywordflow">if</span> (b[0] <span class="keywordflow">in</span> atomslice <span class="keywordflow">and</span> b[1] <span class="keywordflow">in</span> atomslice)]
<a name="l01040"></a>01040         <span class="keywordflow">return</span> New
<a name="l01041"></a>01041 
<a name="l01042"></a>01042     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a63dd7bc0347cc3dec5e8fa0ebfd567ec" title="Return a copy of the object with another molecule object appended.">atom_stack</a>(self, other):
<a name="l01043"></a>01043         <span class="stringliteral">&quot;&quot;&quot; Return a copy of the object with another molecule object appended.  WARNING: This function may invalidate stuff like QM energies. &quot;&quot;&quot;</span>
<a name="l01044"></a>01044         <span class="keywordflow">if</span> len(other) != len(self):
<a name="l01045"></a>01045             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;The number of frames of the Molecule objects being stacked are not equal.&#39;</span>)
<a name="l01046"></a>01046 
<a name="l01047"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a432affdec68562b5b19fd249124480c3">01047</a>         New = <a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html" title="Lee-Ping&#39;s general file format conversion class.">Molecule</a>()
<a name="l01048"></a>01048         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.FrameKeys | self.MetaKeys:
<a name="l01049"></a>01049             New.Data[key] = copy.deepcopy(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key])
<a name="l01050"></a>01050             
<a name="l01051"></a>01051         <span class="comment"># This is how we&#39;re going to stack things like Cartesian coordinates and QM forces.</span>
<a name="l01052"></a>01052         <span class="keyword">def </span>FrameStack(k):
<a name="l01053"></a>01053             <span class="keywordflow">if</span> k <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a> <span class="keywordflow">and</span> k <span class="keywordflow">in</span> other.Data:
<a name="l01054"></a>01054                 New.Data[k] = [np.vstack((s, o)) <span class="keywordflow">for</span> s, o <span class="keywordflow">in</span> zip(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[k], other.Data[k])]
<a name="l01055"></a>01055         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> [<span class="stringliteral">&#39;xyzs&#39;</span>, <span class="stringliteral">&#39;qm_forces&#39;</span>, <span class="stringliteral">&#39;qm_espxyzs&#39;</span>, <span class="stringliteral">&#39;qm_espvals&#39;</span>, <span class="stringliteral">&#39;qm_extchgs&#39;</span>, <span class="stringliteral">&#39;qm_mulliken_charges&#39;</span>, <span class="stringliteral">&#39;qm_mulliken_spins&#39;</span>]:
<a name="l01056"></a>01056             FrameStack(i)
<a name="l01057"></a>01057 
<a name="l01058"></a>01058         <span class="comment"># Now build the new atom keys.</span>
<a name="l01059"></a>01059         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> self.AtomKeys:
<a name="l01060"></a>01060             <span class="keywordflow">if</span> key <span class="keywordflow">not</span> <span class="keywordflow">in</span> other.Data:
<a name="l01061"></a>01061                 <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Trying to stack two Molecule objects - the first object contains %s and the other does not&#39;</span> % (key))
<a name="l01062"></a>01062             <span class="keywordflow">if</span> key == <span class="stringliteral">&#39;tinkersuf&#39;</span>: <span class="comment"># Tinker suffix is a bit tricky</span>
<a name="l01063"></a>01063                 NewSuf = []
<a name="l01064"></a>01064                 <span class="keywordflow">for</span> line <span class="keywordflow">in</span> other.Data[key]:
<a name="l01065"></a>01065                     whites      = re.split(<span class="stringliteral">&#39;[^ ]+&#39;</span>,line)
<a name="l01066"></a>01066                     s           = line.split()
<a name="l01067"></a>01067                     <span class="keywordflow">if</span> len(s) &gt; 1:
<a name="l01068"></a>01068                         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(1,len(s)):
<a name="l01069"></a>01069                             s[i] = str(int(s[i]) + self.na)
<a name="l01070"></a>01070                     NewSuf.append(<span class="stringliteral">&#39;&#39;</span>.join([whites[j]+s[j] <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(len(s))]))
<a name="l01071"></a>01071                 New.Data[key] = deepcopy(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key]) + NewSuf
<a name="l01072"></a>01072             <span class="keywordflow">else</span>:
<a name="l01073"></a>01073                 <span class="keywordflow">if</span> type(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key]) <span class="keywordflow">is</span> np.ndarray:
<a name="l01074"></a>01074                     New.Data[key] = np.concatenate((self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key], other.Data[key]))
<a name="l01075"></a>01075                 <span class="keywordflow">elif</span> type(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key]) <span class="keywordflow">is</span> list:
<a name="l01076"></a>01076                     New.Data[key] = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[key] + other.Data[key]
<a name="l01077"></a>01077                 <span class="keywordflow">else</span>:
<a name="l01078"></a>01078                     <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Cannot stack %s because it is of type %s&#39;</span> % (key, str(type(New.Data[key]))))
<a name="l01079"></a>01079         <span class="keywordflow">if</span> <span class="stringliteral">&#39;bonds&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a> <span class="keywordflow">and</span> <span class="stringliteral">&#39;bonds&#39;</span> <span class="keywordflow">in</span> other.Data:
<a name="l01080"></a>01080             New.Data[<span class="stringliteral">&#39;bonds&#39;</span>] = self.bonds + [(b[0]+self.na, b[1]+self.na) <span class="keywordflow">for</span> b <span class="keywordflow">in</span> other.bonds]
<a name="l01081"></a>01081         <span class="keywordflow">return</span> New
<a name="l01082"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a63dd7bc0347cc3dec5e8fa0ebfd567ec">01082</a> 
<a name="l01083"></a>01083     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a685c8092020a46cd7cf5b52ab45ca6e4" title="Align molecules using the &quot;moment of inertia.&quot; Note that we&#39;re following the MSMBuilder convention ...">align_by_moments</a>(self):
<a name="l01084"></a>01084         <span class="stringliteral">&quot;&quot;&quot; Align molecules using the &quot;moment of inertia.&quot;</span>
<a name="l01085"></a>01085 <span class="stringliteral">        Note that we&#39;re following the MSMBuilder convention </span>
<a name="l01086"></a>01086 <span class="stringliteral">        of using all ones for the masses. &quot;&quot;&quot;</span>
<a name="l01087"></a>01087         xyz1  = self.xyzs[0]
<a name="l01088"></a>01088         xyz1 -= xyz1.mean(0)
<a name="l01089"></a>01089         xyz1  = <a class="code" href="namespaceforcebalance_1_1molecule.html#aa9ad9b92efa7bd3c1d589d62bbb8108e" title="Pre-aligns molecules to &#39;moment of inertia&#39;.">AlignToMoments</a>(self.elem,xyz1)
<a name="l01090"></a>01090         <span class="keywordflow">for</span> index2, xyz2 <span class="keywordflow">in</span> enumerate(self.xyzs):
<a name="l01091"></a>01091             xyz2 -= xyz2.mean(0)
<a name="l01092"></a>01092             xyz2 = <a class="code" href="namespaceforcebalance_1_1molecule.html#aa9ad9b92efa7bd3c1d589d62bbb8108e" title="Pre-aligns molecules to &#39;moment of inertia&#39;.">AlignToMoments</a>(self.elem,xyz1,xyz2)
<a name="l01093"></a>01093             self.xyzs[index2] = xyz2
<a name="l01094"></a>01094 
<a name="l01095"></a>01095     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a87e66db685214a9cdd4feff49d4ea5dc" title="Align molecules.">align</a>(self, smooth = True, center = True):
<a name="l01096"></a>01096         <span class="stringliteral">&quot;&quot;&quot; Align molecules. </span>
<a name="l01097"></a>01097 <span class="stringliteral">        </span>
<a name="l01098"></a>01098 <span class="stringliteral">        Has the option to create smooth trajectories </span>
<a name="l01099"></a>01099 <span class="stringliteral">        (align each frame to the previous one)</span>
<a name="l01100"></a>01100 <span class="stringliteral">        or to align each frame to the first one.</span>
<a name="l01101"></a>01101 <span class="stringliteral"></span>
<a name="l01102"></a>01102 <span class="stringliteral">        Also has the option to remove the center of mass.</span>
<a name="l01103"></a>01103 <span class="stringliteral"></span>
<a name="l01104"></a>01104 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01105"></a>01105         xyz1 = self.xyzs[0]
<a name="l01106"></a>01106         <span class="keywordflow">if</span> center:
<a name="l01107"></a>01107             xyz1 -= xyz1.mean(0)
<a name="l01108"></a>01108         <span class="keywordflow">for</span> index2, xyz2 <span class="keywordflow">in</span> enumerate(self.xyzs):
<a name="l01109"></a>01109             <span class="keywordflow">if</span> index2 == 0: <span class="keywordflow">continue</span>
<a name="l01110"></a>01110             xyz2 -= xyz2.mean(0)
<a name="l01111"></a>01111             <span class="keywordflow">if</span> smooth:
<a name="l01112"></a>01112                 ref = index2-1
<a name="l01113"></a>01113             <span class="keywordflow">else</span>:
<a name="l01114"></a>01114                 ref = 0
<a name="l01115"></a>01115             tr, rt = <a class="code" href="namespaceforcebalance_1_1molecule.html#a08840b73e95bf34bf9ca7ea36ad0492d">get_rotate_translate</a>(xyz2,self.xyzs[ref])
<a name="l01116"></a>01116             xyz2 = np.dot(xyz2, rt) + tr
<a name="l01117"></a>01117             self.xyzs[index2] = xyz2
<a name="l01118"></a>01118 
<a name="l01119"></a>01119     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a071f18dacd881f761462f772bb0cf632" title="A bare-bones implementation of the bond graph capability in the nanoreactor code.">build_topology</a>(self, sn=None, Fac=1.2):
<a name="l01120"></a>01120         <span class="stringliteral">&#39;&#39;&#39; A bare-bones implementation of the bond graph capability in the nanoreactor code.  </span>
<a name="l01121"></a>01121 <span class="stringliteral">        Returns a NetworkX graph that depicts the molecular topology, which might be useful for stuff. </span>
<a name="l01122"></a>01122 <span class="stringliteral">        Provide, optionally, the frame number used to compute the topology. &#39;&#39;&#39;</span>
<a name="l01123"></a>01123         <span class="keywordflow">if</span> sn == <span class="keywordtype">None</span>:
<a name="l01124"></a>01124             sn = 0
<a name="l01125"></a>01125         mindist = 1.0 <span class="comment"># Any two atoms that are closer than this distance are bonded.</span>
<a name="l01126"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a685c8092020a46cd7cf5b52ab45ca6e4">01126</a>         <span class="comment">#Fac = 1.2     # Increase the threshold for determining whether atoms are bonded. 1.2 is conservative, 1.5 is crazy.</span>
<a name="l01127"></a>01127         <span class="comment"># Create an atom-wise list of covalent radii.</span>
<a name="l01128"></a>01128         R = np.array([(Radii[Elements.index(i)-1] <span class="keywordflow">if</span> i <span class="keywordflow">in</span> Elements <span class="keywordflow">else</span> 0.0) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.elem])
<a name="l01129"></a>01129         <span class="comment"># Create a list of 2-tuples corresponding to combinations of atomic indices.</span>
<a name="l01130"></a>01130         <span class="comment"># This is optimized and much faster than using itertools.combinations.</span>
<a name="l01131"></a>01131         AtomIterator = np.vstack((np.fromiter(itertools.chain(*[[i]*(self.na-i-1) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]),dtype=int), np.fromiter(itertools.chain(*[range(i+1,self.na) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]),dtype=int))).T
<a name="l01132"></a>01132         <span class="comment"># Create a list of thresholds for determining whether a certain interatomic distance is considered to be a bond.</span>
<a name="l01133"></a>01133         <span class="comment"># BondThresh = np.fromiter([max(mindist,(R[i[0]] + R[i[1]])*Fac) for i in AtomIterator], dtype=float)</span>
<a name="l01134"></a>01134         BT0 = R[AtomIterator[:,0]]
<a name="l01135"></a>01135         BT1 = R[AtomIterator[:,1]]
<a name="l01136"></a>01136         BondThresh = (BT0+BT1) * Fac
<a name="l01137"></a>01137         BondThresh = (BondThresh &gt; mindist) * BondThresh + (BondThresh &lt; mindist) * mindist
<a name="l01138"></a>01138         <span class="keywordflow">try</span>:
<a name="l01139"></a>01139             dxij = contact.atom_distances(np.array([self.xyzs[sn]]),AtomIterator)
<a name="l01140"></a>01140         <span class="keywordflow">except</span>:
<a name="l01141"></a>01141             <span class="comment"># Extremely inefficient implementation if importing contact doesn&#39;t work.</span>
<a name="l01142"></a>01142             dxij = [np.array(list(itertools.chain(*[[np.linalg.norm(self.xyzs[sn][i]-self.xyzs[sn][j]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(j+1,self.na)] <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(self.na)])))]
<a name="l01143"></a>01143         G = MyG()
<a name="l01144"></a>01144         bonds = [[] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]
<a name="l01145"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a87e66db685214a9cdd4feff49d4ea5dc">01145</a>         lengths = []
<a name="l01146"></a>01146         <span class="keywordflow">for</span> i, a <span class="keywordflow">in</span> enumerate(self.elem):
<a name="l01147"></a>01147             G.add_node(i)
<a name="l01148"></a>01148             <span class="keywordflow">if</span> <span class="stringliteral">&#39;atomname&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l01149"></a>01149                 nx.set_node_attributes(G,<span class="stringliteral">&#39;n&#39;</span>,{i:self.atomname[i]})
<a name="l01150"></a>01150             nx.set_node_attributes(G,<span class="stringliteral">&#39;e&#39;</span>,{i:a})
<a name="l01151"></a>01151             nx.set_node_attributes(G,<span class="stringliteral">&#39;x&#39;</span>,{i:self.xyzs[sn][i]})
<a name="l01152"></a>01152         bond_bool = dxij[0] &lt; BondThresh
<a name="l01153"></a>01153         <span class="keywordflow">for</span> i, a <span class="keywordflow">in</span> enumerate(bond_bool):
<a name="l01154"></a>01154             <span class="keywordflow">if</span> <span class="keywordflow">not</span> a: <span class="keywordflow">continue</span>
<a name="l01155"></a>01155             (ii, jj) = AtomIterator[i]
<a name="l01156"></a>01156             bonds[ii].<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a77417ff99b19f6d0b7c6f527e83fa7f1">append</a>(jj)
<a name="l01157"></a>01157             bonds[jj].<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a77417ff99b19f6d0b7c6f527e83fa7f1">append</a>(ii)
<a name="l01158"></a>01158             G.add_edge(ii, jj)
<a name="l01159"></a>01159             lengths.append(dxij[0][i])
<a name="l01160"></a>01160         <span class="keywordflow">return</span> G
<a name="l01161"></a>01161 
<a name="l01162"></a>01162     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#aa6b0a08a6579f697667c83e04927298c" title="Return a series of dihedral angles, given four atom indices numbered from zero.">measure_dihedrals</a>(self, i, j, k, l):
<a name="l01163"></a>01163         <span class="stringliteral">&quot;&quot;&quot; Return a series of dihedral angles, given four atom indices numbered from zero. &quot;&quot;&quot;</span>
<a name="l01164"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a071f18dacd881f761462f772bb0cf632">01164</a>         phis = []
<a name="l01165"></a>01165         <span class="keywordflow">if</span> <span class="stringliteral">&#39;bonds&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l01166"></a>01166             <span class="keywordflow">if</span> any(p <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.bonds <span class="keywordflow">for</span> p <span class="keywordflow">in</span> [(min(i,j),max(i,j)),(min(j,k),max(j,k)),(min(k,l),max(k,l))]):
<a name="l01167"></a>01167                 <span class="keywordflow">print</span> [(min(i,j),max(i,j)),(min(j,k),max(j,k)),(min(k,l),max(k,l))]
<a name="l01168"></a>01168                 warn(<span class="stringliteral">&quot;Measuring dihedral angle for four atoms that aren&#39;t bonded.  Hope you know what you&#39;re doing!&quot;</span>)
<a name="l01169"></a>01169         <span class="keywordflow">else</span>:
<a name="l01170"></a>01170             warn(<span class="stringliteral">&quot;This molecule object doesn&#39;t have bonds defined, sanity-checking is off.&quot;</span>)
<a name="l01171"></a>01171         <span class="keywordflow">for</span> s <span class="keywordflow">in</span> range(self.ns):
<a name="l01172"></a>01172             x4 = self.xyzs[s][l]
<a name="l01173"></a>01173             x3 = self.xyzs[s][k]
<a name="l01174"></a>01174             x2 = self.xyzs[s][j]
<a name="l01175"></a>01175             x1 = self.xyzs[s][i]
<a name="l01176"></a>01176             v1 = x2-x1
<a name="l01177"></a>01177             v2 = x3-x2
<a name="l01178"></a>01178             v3 = x4-x3
<a name="l01179"></a>01179             t1 = np.linalg.norm(v2)*np.dot(v1,np.cross(v2,v3))
<a name="l01180"></a>01180             t2 = np.dot(np.cross(v1,v2),np.cross(v2,v3))
<a name="l01181"></a>01181             phi = np.arctan2(t1,t2)
<a name="l01182"></a>01182             phis.append(phi * 180 / np.pi)
<a name="l01183"></a>01183             <span class="comment">#phimod = phi*180/pi % 360</span>
<a name="l01184"></a>01184             <span class="comment">#phis.append(phimod)</span>
<a name="l01185"></a>01185             <span class="comment">#print phimod</span>
<a name="l01186"></a>01186         <span class="keywordflow">return</span> phis
<a name="l01187"></a>01187 
<a name="l01188"></a>01188     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#af412b655371674434ec63b4bfea6d8c0" title="Find pairwise RMSD (super slow, not like the one in MSMBuilder.)">all_pairwise_rmsd</a>(self):
<a name="l01189"></a>01189         <span class="stringliteral">&quot;&quot;&quot; Find pairwise RMSD (super slow, not like the one in MSMBuilder.) &quot;&quot;&quot;</span>
<a name="l01190"></a>01190         N = len(self)
<a name="l01191"></a>01191         Mat = np.zeros((N,N),dtype=float)
<a name="l01192"></a>01192         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(N):
<a name="l01193"></a>01193             xyzi = self.xyzs[i].copy()
<a name="l01194"></a>01194             xyzi -= xyzi.mean(0)
<a name="l01195"></a>01195             <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(i):
<a name="l01196"></a>01196                 xyzj = self.xyzs[j].copy()
<a name="l01197"></a>01197                 xyzj -= xyzj.mean(0)
<a name="l01198"></a>01198                 tr, rt = <a class="code" href="namespaceforcebalance_1_1molecule.html#a08840b73e95bf34bf9ca7ea36ad0492d">get_rotate_translate</a>(xyzj, xyzi)
<a name="l01199"></a>01199                 xyzj = np.dot(xyzj, rt) + tr
<a name="l01200"></a>01200                 rmsd = np.sqrt(np.mean((xyzj - xyzi) ** 2))
<a name="l01201"></a>01201                 Mat[i,j] = rmsd
<a name="l01202"></a>01202                 Mat[j,i] = rmsd
<a name="l01203"></a>01203         <span class="keywordflow">return</span> Mat
<a name="l01204"></a>01204 
<a name="l01205"></a>01205     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#aff7a0e2413297088a5bc3e91e5951f3f">align_center</a>(self):
<a name="l01206"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#aa6b0a08a6579f697667c83e04927298c">01206</a>         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a87e66db685214a9cdd4feff49d4ea5dc" title="Align molecules.">align</a>()
<a name="l01207"></a>01207 
<a name="l01208"></a>01208     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a57edc8d72f7e4c1a1452de7b438f3c55" title="Returns the Cartesian coordinates in the Molecule object in a list of OpenMM-compatible positions...">openmm_positions</a>(self):
<a name="l01209"></a>01209         <span class="stringliteral">&quot;&quot;&quot; Returns the Cartesian coordinates in the Molecule object in</span>
<a name="l01210"></a>01210 <span class="stringliteral">        a list of OpenMM-compatible positions, so it is possible to type</span>
<a name="l01211"></a>01211 <span class="stringliteral">        simulation.context.setPositions(Mol.openmm_positions()[0])</span>
<a name="l01212"></a>01212 <span class="stringliteral">        or something like that.</span>
<a name="l01213"></a>01213 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01214"></a>01214 
<a name="l01215"></a>01215         Positions = []
<a name="l01216"></a>01216         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a80851250d8e749bea882d5aa4bcfcdd1">require</a>(<span class="stringliteral">&#39;xyzs&#39;</span>)
<a name="l01217"></a>01217         <span class="keywordflow">for</span> xyz <span class="keywordflow">in</span> self.xyzs:
<a name="l01218"></a>01218             Pos = []
<a name="l01219"></a>01219             <span class="keywordflow">for</span> xyzi <span class="keywordflow">in</span> xyz:
<a name="l01220"></a>01220                 Pos.append(Vec3(xyzi[0]/10,xyzi[1]/10,xyzi[2]/10))
<a name="l01221"></a>01221             Positions.append(Pos*nanometer)
<a name="l01222"></a>01222         <span class="keywordflow">return</span> Positions
<a name="l01223"></a>01223 
<a name="l01224"></a>01224     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#aa20a420f4b450bfa9e632fae037ecb01" title="Returns the periodic box vectors in the Molecule object in a list of OpenMM-compatible boxes...">openmm_boxes</a>(self):
<a name="l01225"></a>01225         <span class="stringliteral">&quot;&quot;&quot; Returns the periodic box vectors in the Molecule object in</span>
<a name="l01226"></a>01226 <span class="stringliteral">        a list of OpenMM-compatible boxes, so it is possible to type</span>
<a name="l01227"></a>01227 <span class="stringliteral">        simulation.context.setPeriodicBoxVectors(Mol.openmm_boxes()[0])</span>
<a name="l01228"></a>01228 <span class="stringliteral">        or something like that.</span>
<a name="l01229"></a>01229 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01230"></a>01230         
<a name="l01231"></a>01231         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a80851250d8e749bea882d5aa4bcfcdd1">require</a>(<span class="stringliteral">&#39;boxes&#39;</span>)
<a name="l01232"></a>01232         <span class="keywordflow">return</span> [(Vec3(box.A)/10.0, Vec3(box.B)/10.0, Vec3(box.C)/10.0) * nanometer <span class="keywordflow">for</span> box <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac84c67d37f00c0f65e6fb6126e19f9bb">boxes</a>]
<a name="l01233"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#af412b655371674434ec63b4bfea6d8c0">01233</a> 
<a name="l01234"></a>01234     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a71da1c1e530afd8b9b5f08d9bd27259f" title="Split the molecule object into a number of separate files (chunks), either by specifying the number o...">split</a>(self, fnm=None, ftype=None, method=&quot;chunks&quot;, num=None):
<a name="l01235"></a>01235 
<a name="l01236"></a>01236         <span class="stringliteral">&quot;&quot;&quot; Split the molecule object into a number of separate files</span>
<a name="l01237"></a>01237 <span class="stringliteral">        (chunks), either by specifying the number of frames per chunk</span>
<a name="l01238"></a>01238 <span class="stringliteral">        or the number of chunks.  Only relevant for &quot;trajectories&quot;.</span>
<a name="l01239"></a>01239 <span class="stringliteral">        The type of file may be specified; if they aren&#39;t specified</span>
<a name="l01240"></a>01240 <span class="stringliteral">        then the original file type is used.</span>
<a name="l01241"></a>01241 <span class="stringliteral"></span>
<a name="l01242"></a>01242 <span class="stringliteral">        The output file names are [name].[numbers].[extension] where</span>
<a name="l01243"></a>01243 <span class="stringliteral">        [name] can be specified by passing &#39;fnm&#39; or taken from the</span>
<a name="l01244"></a>01244 <span class="stringliteral">        object&#39;s &#39;fnm&#39; attribute by default.  [numbers] are integers</span>
<a name="l01245"></a>01245 <span class="stringliteral">        ranging from the lowest to the highest chunk number, prepended</span>
<a name="l01246"></a>01246 <span class="stringliteral">        by zeros.</span>
<a name="l01247"></a>01247 <span class="stringliteral"></span>
<a name="l01248"></a>01248 <span class="stringliteral">        If the number of chunks / frames is not specified, then one file</span>
<a name="l01249"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#aff7a0e2413297088a5bc3e91e5951f3f">01249</a> <span class="stringliteral">        is written for each frame.</span>
<a name="l01250"></a>01250 <span class="stringliteral">        </span>
<a name="l01251"></a>01251 <span class="stringliteral">        @return fnms A list of the file names that were written.</span>
<a name="l01252"></a>01252 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01253"></a>01253         
<a name="l01254"></a>01254         
<a name="l01255"></a>01255 
<a name="l01256"></a>01256     <span class="comment">#=====================================#</span>
<a name="l01257"></a>01257     <span class="comment">#|         Reading functions         |#</span>
<a name="l01258"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a57edc8d72f7e4c1a1452de7b438f3c55">01258</a>     <span class="comment">#=====================================#</span>
<a name="l01259"></a>01259 
<a name="l01260"></a>01260     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a15a7a0e0377e6dfd52e60c77fbc583c1" title="Parse a .xyz file which contains several xyz coordinates, and return their elements.">read_xyz</a>(self, fnm):
<a name="l01261"></a>01261         <span class="stringliteral">&quot;&quot;&quot; Parse a .xyz file which contains several xyz coordinates, and return their elements.</span>
<a name="l01262"></a>01262 <span class="stringliteral"></span>
<a name="l01263"></a>01263 <span class="stringliteral">        @param[in] fnm The input file name</span>
<a name="l01264"></a>01264 <span class="stringliteral">        @return elem  A list of chemical elements in the XYZ file</span>
<a name="l01265"></a>01265 <span class="stringliteral">        @return comms A list of comments.</span>
<a name="l01266"></a>01266 <span class="stringliteral">        @return xyzs  A list of XYZ coordinates (number of snapshots times number of atoms)</span>
<a name="l01267"></a>01267 <span class="stringliteral"></span>
<a name="l01268"></a>01268 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01269"></a>01269         xyz   = []
<a name="l01270"></a>01270         xyzs  = []
<a name="l01271"></a>01271         comms = []
<a name="l01272"></a>01272         elem  = []
<a name="l01273"></a>01273         an    = 0
<a name="l01274"></a>01274         na    = 0
<a name="l01275"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#aa20a420f4b450bfa9e632fae037ecb01">01275</a>         ln    = 0
<a name="l01276"></a>01276         absln = 0
<a name="l01277"></a>01277         <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm):
<a name="l01278"></a>01278             <span class="keywordflow">if</span> ln == 0:
<a name="l01279"></a>01279                 <span class="comment"># Skip blank lines.</span>
<a name="l01280"></a>01280                 <span class="keywordflow">if</span> len(line.strip()) &gt; 0:
<a name="l01281"></a>01281                     na = int(line.strip())
<a name="l01282"></a>01282             <span class="keywordflow">elif</span> ln == 1:
<a name="l01283"></a>01283                 comms.append(line.strip())
<a name="l01284"></a>01284             <span class="keywordflow">else</span>:
<a name="l01285"></a>01285                 sline = line.split()
<a name="l01286"></a>01286                 xyz.append([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline[1:]])
<a name="l01287"></a>01287                 <span class="keywordflow">if</span> len(elem) &lt; na:
<a name="l01288"></a>01288                     elem.append(sline[0])
<a name="l01289"></a>01289                 an += 1
<a name="l01290"></a>01290                 <span class="keywordflow">if</span> an == na:
<a name="l01291"></a>01291                     xyzs.append(np.array(xyz))
<a name="l01292"></a>01292                     xyz = []
<a name="l01293"></a>01293                     an  = 0
<a name="l01294"></a>01294             <span class="keywordflow">if</span> ln == na+1:
<a name="l01295"></a>01295                 <span class="comment"># Reset the line number counter when we hit the last line in a block.</span>
<a name="l01296"></a>01296                 ln = -1
<a name="l01297"></a>01297             ln += 1
<a name="l01298"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a71da1c1e530afd8b9b5f08d9bd27259f">01298</a>             absln += 1
<a name="l01299"></a>01299         Answer = {<span class="stringliteral">&#39;elem&#39;</span> : elem,
<a name="l01300"></a>01300                   <span class="stringliteral">&#39;xyzs&#39;</span> : xyzs,
<a name="l01301"></a>01301                   <span class="stringliteral">&#39;comms&#39;</span>: comms}
<a name="l01302"></a>01302         <span class="keywordflow">return</span> Answer
<a name="l01303"></a>01303 
<a name="l01304"></a>01304     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ab1b56d66b7673b2631e2cee013a80b93" title="Parse an AMBER .mdcrd file.">read_mdcrd</a>(self, fnm):
<a name="l01305"></a>01305         <span class="stringliteral">&quot;&quot;&quot; Parse an AMBER .mdcrd file.  This requires at least the number of atoms.</span>
<a name="l01306"></a>01306 <span class="stringliteral">        This will FAIL for monatomic trajectories (but who the heck makes those?)</span>
<a name="l01307"></a>01307 <span class="stringliteral"></span>
<a name="l01308"></a>01308 <span class="stringliteral">        @param[in] fnm The input file name</span>
<a name="l01309"></a>01309 <span class="stringliteral">        @return xyzs  A list of XYZ coordinates (number of snapshots times number of atoms)</span>
<a name="l01310"></a>01310 <span class="stringliteral">        @return boxes Boxes (if present.)</span>
<a name="l01311"></a>01311 <span class="stringliteral"></span>
<a name="l01312"></a>01312 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01313"></a>01313         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a80851250d8e749bea882d5aa4bcfcdd1">require</a>(<span class="stringliteral">&#39;na&#39;</span>)
<a name="l01314"></a>01314         xyz    = []
<a name="l01315"></a>01315         xyzs   = []
<a name="l01316"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a15a7a0e0377e6dfd52e60c77fbc583c1">01316</a>         boxes  = []
<a name="l01317"></a>01317         ln     = 0
<a name="l01318"></a>01318         <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm):
<a name="l01319"></a>01319             sline = line.split()
<a name="l01320"></a>01320             <span class="keywordflow">if</span> ln == 0:
<a name="l01321"></a>01321                 <span class="keywordflow">pass</span>
<a name="l01322"></a>01322             <span class="keywordflow">else</span>:
<a name="l01323"></a>01323                 <span class="keywordflow">if</span> xyz == [] <span class="keywordflow">and</span> len(sline) == 3:
<a name="l01324"></a>01324                     a, b, c = (float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> line.split())
<a name="l01325"></a>01325                     boxes.append(<a class="code" href="namespaceforcebalance_1_1molecule.html#a0a6e3e79b04534bf2e83d09def189444" title="This function takes in three lattice lengths and three lattice angles, and tries to return a complete...">BuildLatticeFromLengthsAngles</a>(a, b, c, 90.0, 90.0, 90.0))
<a name="l01326"></a>01326                 <span class="keywordflow">else</span>:
<a name="l01327"></a>01327                     xyz += [float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> line.split()]
<a name="l01328"></a>01328                     <span class="keywordflow">if</span> len(xyz) == self.na * 3:
<a name="l01329"></a>01329                         xyzs.append(np.array(xyz).reshape(-1,3))
<a name="l01330"></a>01330                         xyz = []
<a name="l01331"></a>01331             ln += 1
<a name="l01332"></a>01332         Answer = {<span class="stringliteral">&#39;xyzs&#39;</span> : xyzs}
<a name="l01333"></a>01333         <span class="keywordflow">if</span> len(boxes) &gt; 0:
<a name="l01334"></a>01334             Answer[<span class="stringliteral">&#39;boxes&#39;</span>] = boxes
<a name="l01335"></a>01335         <span class="keywordflow">return</span> Answer
<a name="l01336"></a>01336 
<a name="l01337"></a>01337     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a1d34af6a7d22dd34850d58efe8595b20">read_qdata</a>(self, fnm):
<a name="l01338"></a>01338         xyzs     = []
<a name="l01339"></a>01339         energies = []
<a name="l01340"></a>01340         forces   = []
<a name="l01341"></a>01341         espxyzs  = []
<a name="l01342"></a>01342         espvals  = []
<a name="l01343"></a>01343         interaction = []
<a name="l01344"></a>01344         <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm):
<a name="l01345"></a>01345             <span class="keywordflow">if</span> <span class="stringliteral">&#39;COORDS&#39;</span> <span class="keywordflow">in</span> line:
<a name="l01346"></a>01346                 xyzs.append(np.array([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> line.split()[1:]]).reshape(-1,3))
<a name="l01347"></a>01347             <span class="keywordflow">elif</span> <span class="stringliteral">&#39;FORCES&#39;</span> <span class="keywordflow">in</span> line:
<a name="l01348"></a>01348                 forces.append(np.array([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> line.split()[1:]]).reshape(-1,3))
<a name="l01349"></a>01349             <span class="keywordflow">elif</span> <span class="stringliteral">&#39;ESPXYZ&#39;</span> <span class="keywordflow">in</span> line:
<a name="l01350"></a>01350                 espxyzs.append(np.array([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> line.split()[1:]]).reshape(-1,3))
<a name="l01351"></a>01351             <span class="keywordflow">elif</span> <span class="stringliteral">&#39;ESPVAL&#39;</span> <span class="keywordflow">in</span> line:
<a name="l01352"></a>01352                 espvals.append(np.array([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> line.split()[1:]]))
<a name="l01353"></a>01353             <span class="keywordflow">elif</span> <span class="stringliteral">&#39;ENERGY&#39;</span> <span class="keywordflow">in</span> line:
<a name="l01354"></a>01354                 energies.append(float(line.split()[1]))
<a name="l01355"></a>01355             <span class="keywordflow">elif</span> <span class="stringliteral">&#39;INTERACTION&#39;</span> <span class="keywordflow">in</span> line:
<a name="l01356"></a>01356                 interaction.append(float(line.split()[1]))
<a name="l01357"></a>01357         Answer = {}
<a name="l01358"></a>01358         <span class="keywordflow">if</span> len(xyzs) &gt; 0:
<a name="l01359"></a>01359             Answer[<span class="stringliteral">&#39;xyzs&#39;</span>] = xyzs
<a name="l01360"></a>01360         <span class="keywordflow">if</span> len(energies) &gt; 0:
<a name="l01361"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ab1b56d66b7673b2631e2cee013a80b93">01361</a>             Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>] = energies
<a name="l01362"></a>01362         <span class="keywordflow">if</span> len(interaction) &gt; 0:
<a name="l01363"></a>01363             Answer[<span class="stringliteral">&#39;qm_interaction&#39;</span>] = interaction
<a name="l01364"></a>01364         <span class="keywordflow">if</span> len(forces) &gt; 0:
<a name="l01365"></a>01365             Answer[<span class="stringliteral">&#39;qm_forces&#39;</span>] = forces
<a name="l01366"></a>01366         <span class="keywordflow">if</span> len(espxyzs) &gt; 0:
<a name="l01367"></a>01367             Answer[<span class="stringliteral">&#39;qm_espxyzs&#39;</span>] = espxyzs
<a name="l01368"></a>01368         <span class="keywordflow">if</span> len(espvals) &gt; 0:
<a name="l01369"></a>01369             Answer[<span class="stringliteral">&#39;qm_espvals&#39;</span>] = espvals
<a name="l01370"></a>01370         <span class="keywordflow">return</span> Answer
<a name="l01371"></a>01371 
<a name="l01372"></a>01372     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a14b1fbc70a083d21fd016b5dd854fd56">read_mol2</a>(self, fnm):
<a name="l01373"></a>01373         xyz      = []
<a name="l01374"></a>01374         charge   = []
<a name="l01375"></a>01375         atomname = []
<a name="l01376"></a>01376         atomtype = []
<a name="l01377"></a>01377         elem     = []
<a name="l01378"></a>01378         data = Mol2.mol2_set(fnm)
<a name="l01379"></a>01379         <span class="keywordflow">if</span> len(data.compounds) &gt; 1:
<a name="l01380"></a>01380             sys.stderr.write(<span class="stringliteral">&quot;Not sure what to do if the MOL2 file contains multiple compounds\n&quot;</span>)
<a name="l01381"></a>01381         <span class="keywordflow">for</span> i, atom <span class="keywordflow">in</span> enumerate(data.compounds.items()[0][1].atoms):
<a name="l01382"></a>01382             xyz.append([atom.x, atom.y, atom.z])
<a name="l01383"></a>01383             charge.append(atom.charge)
<a name="l01384"></a>01384             atomname.append(atom.atom_name)
<a name="l01385"></a>01385             atomtype.append(atom.atom_type)
<a name="l01386"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a1d34af6a7d22dd34850d58efe8595b20">01386</a>             thiselem = atom.atom_name
<a name="l01387"></a>01387             <span class="keywordflow">if</span> len(thiselem) &gt; 1:
<a name="l01388"></a>01388                 thiselem = thiselem[0] + re.sub(<span class="stringliteral">&#39;[A-Z0-9]&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,thiselem[1:])
<a name="l01389"></a>01389             elem.append(thiselem)
<a name="l01390"></a>01390 
<a name="l01391"></a>01391         resname = [data.compounds.items()[0][0] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(elem))]
<a name="l01392"></a>01392         resid = [1 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(elem))]
<a name="l01393"></a>01393         
<a name="l01394"></a>01394         <span class="comment"># Deprecated &#39;abonds&#39; format.</span>
<a name="l01395"></a>01395         <span class="comment"># bonds    = [[] for i in range(len(elem))]</span>
<a name="l01396"></a>01396         <span class="comment"># for bond in data.compounds.items()[0][1].bonds:</span>
<a name="l01397"></a>01397         <span class="comment">#     a1 = bond.origin_atom_id - 1</span>
<a name="l01398"></a>01398         <span class="comment">#     a2 = bond.target_atom_id - 1</span>
<a name="l01399"></a>01399         <span class="comment">#     aL, aH = (a1, a2) if a1 &lt; a2 else (a2, a1)</span>
<a name="l01400"></a>01400         <span class="comment">#     bonds[aL].append(aH)</span>
<a name="l01401"></a>01401 
<a name="l01402"></a>01402         bonds = []
<a name="l01403"></a>01403         <span class="keywordflow">for</span> bond <span class="keywordflow">in</span> data.compounds.items()[0][1].bonds:
<a name="l01404"></a>01404             a1 = bond.origin_atom_id - 1
<a name="l01405"></a>01405             a2 = bond.target_atom_id - 1
<a name="l01406"></a>01406             aL, aH = (a1, a2) <span class="keywordflow">if</span> a1 &lt; a2 <span class="keywordflow">else</span> (a2, a1)
<a name="l01407"></a>01407             bonds.append((aL,aH))
<a name="l01408"></a>01408 
<a name="l01409"></a>01409         Answer = {<span class="stringliteral">&#39;xyzs&#39;</span> : [np.array(xyz)],
<a name="l01410"></a>01410                   <span class="stringliteral">&#39;partial_charge&#39;</span> : charge,
<a name="l01411"></a>01411                   <span class="stringliteral">&#39;atomname&#39;</span> : atomname,
<a name="l01412"></a>01412                   <span class="stringliteral">&#39;atomtype&#39;</span> : atomtype,
<a name="l01413"></a>01413                   <span class="stringliteral">&#39;elem&#39;</span>     : elem,
<a name="l01414"></a>01414                   <span class="stringliteral">&#39;resname&#39;</span>  : resname,
<a name="l01415"></a>01415                   <span class="stringliteral">&#39;resid&#39;</span>    : resid,
<a name="l01416"></a>01416                   <span class="stringliteral">&#39;bonds&#39;</span>    : bonds
<a name="l01417"></a>01417                   }
<a name="l01418"></a>01418 
<a name="l01419"></a>01419         <span class="keywordflow">return</span> Answer
<a name="l01420"></a>01420 
<a name="l01421"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a14b1fbc70a083d21fd016b5dd854fd56">01421</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ad8fa6cc7424aae00ee3f5bb87d28e037">read_dcd</a>(self, fnm):
<a name="l01422"></a>01422         xyzs = []
<a name="l01423"></a>01423         boxes = []
<a name="l01424"></a>01424         <span class="keywordflow">if</span> _dcdlib.vmdplugin_init() != 0:
<a name="l01425"></a>01425             <span class="keywordflow">raise</span> IOError(<span class="stringliteral">&quot;Unable to init DCD plugin&quot;</span>)
<a name="l01426"></a>01426         natoms = c_int(-1)
<a name="l01427"></a>01427         frame  = 0
<a name="l01428"></a>01428         dcd       = _dcdlib.open_dcd_read(fnm, <span class="stringliteral">&quot;dcd&quot;</span>, byref(natoms))
<a name="l01429"></a>01429         ts        = <a class="code" href="classforcebalance_1_1molecule_1_1MolfileTimestep.html" title="Wrapper for the timestep C structure used in molfile plugins.">MolfileTimestep</a>()
<a name="l01430"></a>01430         _xyz      = c_float * (natoms.value * 3)
<a name="l01431"></a>01431         xyzvec    = _xyz()
<a name="l01432"></a>01432         ts.coords = xyzvec
<a name="l01433"></a>01433         <span class="keywordflow">while</span> <span class="keyword">True</span>:
<a name="l01434"></a>01434             result = _dcdlib.read_next_timestep(dcd, natoms, byref(ts))
<a name="l01435"></a>01435             <span class="keywordflow">if</span> result == 0:
<a name="l01436"></a>01436                 frame += 1
<a name="l01437"></a>01437             <span class="keywordflow">elif</span> result == -1:
<a name="l01438"></a>01438                 <span class="keywordflow">break</span>
<a name="l01439"></a>01439             npa    = np.array(xyzvec)
<a name="l01440"></a>01440             xyz    = np.asfarray(npa)
<a name="l01441"></a>01441             xyzs.append(xyz.reshape(-1, 3))
<a name="l01442"></a>01442             boxes.append(<a class="code" href="namespaceforcebalance_1_1molecule.html#a0a6e3e79b04534bf2e83d09def189444" title="This function takes in three lattice lengths and three lattice angles, and tries to return a complete...">BuildLatticeFromLengthsAngles</a>(ts.A, ts.B, ts.C, 90.0, 90.0, 90.0))
<a name="l01443"></a>01443         _dcdlib.close_file_read(dcd)
<a name="l01444"></a>01444         dcd = <span class="keywordtype">None</span>
<a name="l01445"></a>01445         Answer = {<span class="stringliteral">&#39;xyzs&#39;</span> : xyzs,
<a name="l01446"></a>01446                   <span class="stringliteral">&#39;boxes&#39;</span> : boxes}
<a name="l01447"></a>01447         <span class="keywordflow">return</span> Answer
<a name="l01448"></a>01448 
<a name="l01449"></a>01449     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a861feda06e1f60ab25c45eaaaf228cfc" title="Parse a Gaussian .com file and return a SINGLE-ELEMENT list of xyz coordinates (no multiple file supp...">read_com</a>(self, fnm):
<a name="l01450"></a>01450         <span class="stringliteral">&quot;&quot;&quot; Parse a Gaussian .com file and return a SINGLE-ELEMENT list of xyz coordinates (no multiple file support)</span>
<a name="l01451"></a>01451 <span class="stringliteral"></span>
<a name="l01452"></a>01452 <span class="stringliteral">        @param[in] fnm The input file name</span>
<a name="l01453"></a>01453 <span class="stringliteral">        @return elem   A list of chemical elements in the XYZ file</span>
<a name="l01454"></a>01454 <span class="stringliteral">        @return comms  A single-element list for the comment.</span>
<a name="l01455"></a>01455 <span class="stringliteral">        @return xyzs   A single-element list for the  XYZ coordinates.</span>
<a name="l01456"></a>01456 <span class="stringliteral">        @return charge The total charge of the system.</span>
<a name="l01457"></a>01457 <span class="stringliteral">        @return mult   The spin multiplicity of the system.</span>
<a name="l01458"></a>01458 <span class="stringliteral"></span>
<a name="l01459"></a>01459 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01460"></a>01460         elem    = []
<a name="l01461"></a>01461         xyz     = []
<a name="l01462"></a>01462         ln      = 0
<a name="l01463"></a>01463         absln   = 0
<a name="l01464"></a>01464         comfile = open(fnm).readlines()
<a name="l01465"></a>01465         inxyz = 0
<a name="l01466"></a>01466         <span class="keywordflow">for</span> line <span class="keywordflow">in</span> comfile:
<a name="l01467"></a>01467             <span class="comment"># Everything after exclamation point is a comment</span>
<a name="l01468"></a>01468             sline = line.split(<span class="stringliteral">&#39;!&#39;</span>)[0].<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a71da1c1e530afd8b9b5f08d9bd27259f" title="Split the molecule object into a number of separate files (chunks), either by specifying the number o...">split</a>()
<a name="l01469"></a>01469             <span class="keywordflow">if</span> len(sline) == 2:
<a name="l01470"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ad8fa6cc7424aae00ee3f5bb87d28e037">01470</a>                 <span class="keywordflow">if</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#a0dd31eff88d2bed0884ab21a13261d42" title="ONLY matches integers! If you have a decimal point? None shall pass!">isint</a>(sline[0]) <span class="keywordflow">and</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#a0dd31eff88d2bed0884ab21a13261d42" title="ONLY matches integers! If you have a decimal point? None shall pass!">isint</a>(sline[1]):
<a name="l01471"></a>01471                     charge = int(sline[0])
<a name="l01472"></a>01472                     mult = int(sline[1])
<a name="l01473"></a>01473                     title_ln = ln - 2
<a name="l01474"></a>01474             <span class="keywordflow">elif</span> len(sline) == 4:
<a name="l01475"></a>01475                 inxyz = 1
<a name="l01476"></a>01476                 <span class="keywordflow">if</span> sline[0].capitalize() <span class="keywordflow">in</span> PeriodicTable <span class="keywordflow">and</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(sline[1]) <span class="keywordflow">and</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(sline[2]) <span class="keywordflow">and</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(sline[3]):
<a name="l01477"></a>01477                     elem.append(sline[0])
<a name="l01478"></a>01478                     xyz.append(np.array([float(sline[1]),float(sline[2]),float(sline[3])]))
<a name="l01479"></a>01479             <span class="keywordflow">elif</span> inxyz:
<a name="l01480"></a>01480                 <span class="keywordflow">break</span>
<a name="l01481"></a>01481             ln += 1
<a name="l01482"></a>01482             absln += 1
<a name="l01483"></a>01483 
<a name="l01484"></a>01484         Answer = {<span class="stringliteral">&#39;xyzs&#39;</span>   : [np.array(xyz)],
<a name="l01485"></a>01485                   <span class="stringliteral">&#39;elem&#39;</span>   : elem,
<a name="l01486"></a>01486                   <span class="stringliteral">&#39;comms&#39;</span>  : [comfile[title_ln].strip()],
<a name="l01487"></a>01487                   <span class="stringliteral">&#39;charge&#39;</span> : charge,
<a name="l01488"></a>01488                   <span class="stringliteral">&#39;mult&#39;</span>   : mult}
<a name="l01489"></a>01489         <span class="keywordflow">return</span> Answer
<a name="l01490"></a>01490 
<a name="l01491"></a>01491     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#aeb5983ae61079198f077f55e448e2c32" title="Read a TINKER .arc file.">read_arc</a>(self, fnm):
<a name="l01492"></a>01492         <span class="stringliteral">&quot;&quot;&quot; Read a TINKER .arc file.</span>
<a name="l01493"></a>01493 <span class="stringliteral"></span>
<a name="l01494"></a>01494 <span class="stringliteral">        @param[in] fnm  The input file name</span>
<a name="l01495"></a>01495 <span class="stringliteral">        @return xyzs    A list for the  XYZ coordinates.</span>
<a name="l01496"></a>01496 <span class="stringliteral">        @return resid   The residue ID numbers.  These are not easy to get!</span>
<a name="l01497"></a>01497 <span class="stringliteral">        @return elem    A list of chemical elements in the XYZ file</span>
<a name="l01498"></a>01498 <span class="stringliteral">        @return comms   A single-element list for the comment.</span>
<a name="l01499"></a>01499 <span class="stringliteral">        @return tinkersuf  The suffix that comes after lines in the XYZ coordinates; this is usually topology info</span>
<a name="l01500"></a>01500 <span class="stringliteral"></span>
<a name="l01501"></a>01501 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01502"></a>01502         tinkersuf   = []
<a name="l01503"></a>01503         xyzs  = []
<a name="l01504"></a>01504         xyz   = []
<a name="l01505"></a>01505         resid = []
<a name="l01506"></a>01506         elem  = []
<a name="l01507"></a>01507         comms = []
<a name="l01508"></a>01508         thisres = set([])
<a name="l01509"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a861feda06e1f60ab25c45eaaaf228cfc">01509</a>         forwardres = set([])
<a name="l01510"></a>01510         title = <span class="keyword">True</span>
<a name="l01511"></a>01511         nframes = 0
<a name="l01512"></a>01512         thisresid   = 1
<a name="l01513"></a>01513         ln = 0
<a name="l01514"></a>01514         thisatom = 0
<a name="l01515"></a>01515         <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm):
<a name="l01516"></a>01516             sline = line.split()
<a name="l01517"></a>01517             <span class="keywordflow">if</span> len(sline) == 0: <span class="keywordflow">continue</span>
<a name="l01518"></a>01518             <span class="comment"># The first line always contains the number of atoms</span>
<a name="l01519"></a>01519             <span class="comment"># The words after the first line are comments</span>
<a name="l01520"></a>01520             <span class="keywordflow">if</span> title:
<a name="l01521"></a>01521                 na = int(sline[0])
<a name="l01522"></a>01522                 comms.append(<span class="stringliteral">&#39; &#39;</span>.join(sline[1:]))
<a name="l01523"></a>01523                 title = <span class="keyword">False</span>
<a name="l01524"></a>01524             <span class="keywordflow">elif</span> len(sline) &gt;= 5:
<a name="l01525"></a>01525                 <span class="keywordflow">if</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#a0dd31eff88d2bed0884ab21a13261d42" title="ONLY matches integers! If you have a decimal point? None shall pass!">isint</a>(sline[0]) <span class="keywordflow">and</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(sline[2]) <span class="keywordflow">and</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(sline[3]) <span class="keywordflow">and</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(sline[4]): <span class="comment"># A line of data better look like this</span>
<a name="l01526"></a>01526                     <span class="keywordflow">if</span> nframes == 0:
<a name="l01527"></a>01527                         elem.append(sline[1])
<a name="l01528"></a>01528                         resid.append(thisresid)
<a name="l01529"></a>01529                         whites      = re.split(<span class="stringliteral">&#39;[^ ]+&#39;</span>,line)
<a name="l01530"></a>01530                         <span class="keywordflow">if</span> len(sline) &gt; 5:
<a name="l01531"></a>01531                             tinkersuf.append(<span class="stringliteral">&#39;&#39;</span>.join([whites[j]+sline[j] <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(5,len(sline))]))
<a name="l01532"></a>01532                         <span class="keywordflow">else</span>:
<a name="l01533"></a>01533                             tinkersuf.append(<span class="stringliteral">&#39;&#39;</span>)
<a name="l01534"></a>01534                     <span class="comment"># LPW Make sure ..</span>
<a name="l01535"></a>01535                     thisatom += 1
<a name="l01536"></a>01536                     <span class="comment">#thisatom = int(sline[0])</span>
<a name="l01537"></a>01537                     thisres.add(thisatom)
<a name="l01538"></a>01538                     forwardres.add(thisatom)
<a name="l01539"></a>01539                     <span class="keywordflow">if</span> len(sline) &gt;= 6:
<a name="l01540"></a>01540                         forwardres.update([int(j) <span class="keywordflow">for</span> j <span class="keywordflow">in</span> sline[6:]])
<a name="l01541"></a>01541                     <span class="keywordflow">if</span> thisres == forwardres:
<a name="l01542"></a>01542                         thisres = set([])
<a name="l01543"></a>01543                         forwardres = set([])
<a name="l01544"></a>01544                         thisresid += 1
<a name="l01545"></a>01545                     xyz.append([float(sline[2]),float(sline[3]),float(sline[4])])
<a name="l01546"></a>01546                     <span class="keywordflow">if</span> thisatom == na:
<a name="l01547"></a>01547                         thisatom = 0
<a name="l01548"></a>01548                         nframes += 1
<a name="l01549"></a>01549                         title = <span class="keyword">True</span>
<a name="l01550"></a>01550                         xyzs.append(np.array(xyz))
<a name="l01551"></a>01551                         xyz = []
<a name="l01552"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#aeb5983ae61079198f077f55e448e2c32">01552</a>             ln += 1
<a name="l01553"></a>01553         Answer = {<span class="stringliteral">&#39;xyzs&#39;</span>   : xyzs,
<a name="l01554"></a>01554                   <span class="stringliteral">&#39;resid&#39;</span>  : resid,
<a name="l01555"></a>01555                   <span class="stringliteral">&#39;elem&#39;</span>   : elem,
<a name="l01556"></a>01556                   <span class="stringliteral">&#39;comms&#39;</span>  : comms,
<a name="l01557"></a>01557                   <span class="stringliteral">&#39;tinkersuf&#39;</span> : tinkersuf}
<a name="l01558"></a>01558         <span class="keywordflow">return</span> Answer
<a name="l01559"></a>01559 
<a name="l01560"></a>01560     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a963a4382dc59ebd8dd9ee2064843e355" title="Read a GROMACS .gro file.">read_gro</a>(self, fnm):
<a name="l01561"></a>01561         <span class="stringliteral">&quot;&quot;&quot; Read a GROMACS .gro file.</span>
<a name="l01562"></a>01562 <span class="stringliteral"></span>
<a name="l01563"></a>01563 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01564"></a>01564         xyzs     = []
<a name="l01565"></a>01565         elem     = [] <span class="comment"># The element, most useful for quantum chemistry calculations</span>
<a name="l01566"></a>01566         atomname = [] <span class="comment"># The atom name, for instance &#39;HW1&#39;</span>
<a name="l01567"></a>01567         comms    = []
<a name="l01568"></a>01568         resid    = []
<a name="l01569"></a>01569         resname  = []
<a name="l01570"></a>01570         boxes    = []
<a name="l01571"></a>01571         xyz      = []
<a name="l01572"></a>01572         ln       = 0
<a name="l01573"></a>01573         frame    = 0
<a name="l01574"></a>01574         absln    = 0
<a name="l01575"></a>01575         <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm):
<a name="l01576"></a>01576             sline = line.split()
<a name="l01577"></a>01577             <span class="keywordflow">if</span> ln == 0:
<a name="l01578"></a>01578                 comms.append(line.strip())
<a name="l01579"></a>01579             <span class="keywordflow">elif</span> ln == 1:
<a name="l01580"></a>01580                 na = int(line.strip())
<a name="l01581"></a>01581             <span class="keywordflow">elif</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#a12b7bb398c2fa49a223f258ec7737483" title="Determines whether a line contains GROMACS data or not.">is_gro_coord</a>(line):
<a name="l01582"></a>01582                 <span class="keywordflow">if</span> frame == 0: <span class="comment"># Create the list of residues, atom names etc. only if it&#39;s the first frame.</span>
<a name="l01583"></a>01583                     <span class="comment"># Name of the residue, for instance &#39;153SOL1 -&gt; SOL1&#39; ; strips leading numbers</span>
<a name="l01584"></a>01584                     thisresname = re.sub(<span class="stringliteral">&#39;^[0-9]*&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,sline[0])
<a name="l01585"></a>01585                     resname.append(thisresname)
<a name="l01586"></a>01586                     resid.append(int(sline[0].replace(thisresname,<span class="stringliteral">&#39;&#39;</span>)))
<a name="l01587"></a>01587                     atomname.append(sline[1])
<a name="l01588"></a>01588                     thiselem = sline[1]
<a name="l01589"></a>01589                     <span class="keywordflow">if</span> len(thiselem) &gt; 1:
<a name="l01590"></a>01590                         thiselem = thiselem[0] + re.sub(<span class="stringliteral">&#39;[A-Z0-9]&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,thiselem[1:])
<a name="l01591"></a>01591                     elem.append(thiselem)
<a name="l01592"></a>01592                 xyz.append([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline[-3:]])
<a name="l01593"></a>01593             <span class="keywordflow">elif</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#aafc8c924eed4480fed8ddc9c474d3bc1" title="Determines whether a line contains a GROMACS box vector or not.">is_gro_box</a>(line) <span class="keywordflow">and</span> ln == na + 2:
<a name="l01594"></a>01594                 box = [float(i)*10 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline]
<a name="l01595"></a>01595                 <span class="keywordflow">if</span> len(box) == 3:
<a name="l01596"></a>01596                     a = box[0]
<a name="l01597"></a>01597                     b = box[1]
<a name="l01598"></a>01598                     c = box[2]
<a name="l01599"></a>01599                     alpha = 90.0
<a name="l01600"></a>01600                     beta = 90.0
<a name="l01601"></a>01601                     gamma = 90.0
<a name="l01602"></a>01602                     boxes.append(<a class="code" href="namespaceforcebalance_1_1molecule.html#a0a6e3e79b04534bf2e83d09def189444" title="This function takes in three lattice lengths and three lattice angles, and tries to return a complete...">BuildLatticeFromLengthsAngles</a>(a, b, c, alpha, beta, gamma))
<a name="l01603"></a>01603                 <span class="keywordflow">elif</span> len(box) == 9:
<a name="l01604"></a>01604                     v1 = np.array([box[0], box[3], box[4]])
<a name="l01605"></a>01605                     v2 = np.array([box[5], box[1], box[6]])
<a name="l01606"></a>01606                     v3 = np.array([box[7], box[8], box[2]])
<a name="l01607"></a>01607                     boxes.append(<a class="code" href="namespaceforcebalance_1_1molecule.html#a29fb1ac9324f4280f07c65baea339989" title="This function takes in three lattice vectors and tries to return a complete box specification.">BuildLatticeFromVectors</a>(v1, v2, v3))
<a name="l01608"></a>01608                 xyzs.append(np.array(xyz)*10)
<a name="l01609"></a>01609                 xyz = []
<a name="l01610"></a>01610                 ln = -1
<a name="l01611"></a>01611                 frame += 1
<a name="l01612"></a>01612             ln += 1
<a name="l01613"></a>01613             absln += 1
<a name="l01614"></a>01614         Answer = {<span class="stringliteral">&#39;xyzs&#39;</span>     : xyzs,
<a name="l01615"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a963a4382dc59ebd8dd9ee2064843e355">01615</a>                   <span class="stringliteral">&#39;elem&#39;</span>     : elem,
<a name="l01616"></a>01616                   <span class="stringliteral">&#39;atomname&#39;</span> : atomname,
<a name="l01617"></a>01617                   <span class="stringliteral">&#39;resid&#39;</span>    : resid,
<a name="l01618"></a>01618                   <span class="stringliteral">&#39;resname&#39;</span>  : resname,
<a name="l01619"></a>01619                   <span class="stringliteral">&#39;boxes&#39;</span>    : boxes,
<a name="l01620"></a>01620                   <span class="stringliteral">&#39;comms&#39;</span>    : comms}
<a name="l01621"></a>01621         <span class="keywordflow">return</span> Answer
<a name="l01622"></a>01622 
<a name="l01623"></a>01623     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8b8d3444945cab760288f28996787855" title="Read a CHARMM .cor (or .crd) file.">read_charmm</a>(self, fnm):
<a name="l01624"></a>01624         <span class="stringliteral">&quot;&quot;&quot; Read a CHARMM .cor (or .crd) file.</span>
<a name="l01625"></a>01625 <span class="stringliteral"></span>
<a name="l01626"></a>01626 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01627"></a>01627         xyzs     = []
<a name="l01628"></a>01628         elem     = [] <span class="comment"># The element, most useful for quantum chemistry calculations</span>
<a name="l01629"></a>01629         atomname = [] <span class="comment"># The atom name, for instance &#39;HW1&#39;</span>
<a name="l01630"></a>01630         comms    = []
<a name="l01631"></a>01631         resid    = []
<a name="l01632"></a>01632         resname  = []
<a name="l01633"></a>01633         xyz      = []
<a name="l01634"></a>01634         thiscomm = []
<a name="l01635"></a>01635         ln       = 0
<a name="l01636"></a>01636         frame    = 0
<a name="l01637"></a>01637         an       = 0
<a name="l01638"></a>01638         <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm):
<a name="l01639"></a>01639             sline = line.split()
<a name="l01640"></a>01640             <span class="keywordflow">if</span> re.match(<span class="stringliteral">&#39;^\*&#39;</span>,line):
<a name="l01641"></a>01641                 <span class="keywordflow">if</span> len(sline) == 1:
<a name="l01642"></a>01642                     comms.append(<span class="stringliteral">&#39;;&#39;</span>.join(list(thiscomm)))
<a name="l01643"></a>01643                     thiscomm = []
<a name="l01644"></a>01644                 <span class="keywordflow">else</span>:
<a name="l01645"></a>01645                     thiscomm.append(<span class="stringliteral">&#39; &#39;</span>.join(sline[1:]))
<a name="l01646"></a>01646             <span class="keywordflow">elif</span> re.match(<span class="stringliteral">&#39;^ *[0-9]+ +(EXT)?$&#39;</span>,line):
<a name="l01647"></a>01647                 na = int(sline[0])
<a name="l01648"></a>01648             <span class="keywordflow">elif</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#a838d85848bd817e801d0f5f6502217ef" title="Determines whether a line contains CHARMM data or not.">is_charmm_coord</a>(line):
<a name="l01649"></a>01649                 <span class="keywordflow">if</span> frame == 0: <span class="comment"># Create the list of residues, atom names etc. only if it&#39;s the first frame.</span>
<a name="l01650"></a>01650                     resid.append(sline[1])
<a name="l01651"></a>01651                     resname.append(sline[2])
<a name="l01652"></a>01652                     atomname.append(sline[3])
<a name="l01653"></a>01653                     thiselem = sline[3]
<a name="l01654"></a>01654                     <span class="keywordflow">if</span> len(thiselem) &gt; 1:
<a name="l01655"></a>01655                         thiselem = thiselem[0] + re.sub(<span class="stringliteral">&#39;[A-Z0-9]&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,thiselem[1:])
<a name="l01656"></a>01656                     elem.append(thiselem)
<a name="l01657"></a>01657                 xyz.append([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline[4:7]])
<a name="l01658"></a>01658                 an += 1
<a name="l01659"></a>01659                 <span class="keywordflow">if</span> an == na:
<a name="l01660"></a>01660                     xyzs.append(np.array(xyz))
<a name="l01661"></a>01661                     xyz = []
<a name="l01662"></a>01662                     an = 0
<a name="l01663"></a>01663                     frame += 1
<a name="l01664"></a>01664             ln += 1
<a name="l01665"></a>01665         Answer = {<span class="stringliteral">&#39;xyzs&#39;</span>     : xyzs,
<a name="l01666"></a>01666                   <span class="stringliteral">&#39;elem&#39;</span>     : elem,
<a name="l01667"></a>01667                   <span class="stringliteral">&#39;atomname&#39;</span> : atomname,
<a name="l01668"></a>01668                   <span class="stringliteral">&#39;resid&#39;</span>    : resid,
<a name="l01669"></a>01669                   <span class="stringliteral">&#39;resname&#39;</span>  : resname,
<a name="l01670"></a>01670                   <span class="stringliteral">&#39;comms&#39;</span>    : comms}
<a name="l01671"></a>01671         <span class="keywordflow">return</span> Answer
<a name="l01672"></a>01672 
<a name="l01673"></a>01673     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a003b182b54de4473c4691ae1474b1ada" title="Read a Q-Chem input file.">read_qcin</a>(self, fnm):
<a name="l01674"></a>01674         <span class="stringliteral">&quot;&quot;&quot; Read a Q-Chem input file.</span>
<a name="l01675"></a>01675 <span class="stringliteral"></span>
<a name="l01676"></a>01676 <span class="stringliteral">        These files can be very complicated, and I can&#39;t write a completely</span>
<a name="l01677"></a>01677 <span class="stringliteral">        general parser for them.  It is important to keep our goal in</span>
<a name="l01678"></a>01678 <span class="stringliteral">        mind:</span>
<a name="l01679"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8b8d3444945cab760288f28996787855">01679</a> <span class="stringliteral"></span>
<a name="l01680"></a>01680 <span class="stringliteral">        1) The main goal is to convert a trajectory to Q-Chem input</span>
<a name="l01681"></a>01681 <span class="stringliteral">        files with identical calculation settings.</span>
<a name="l01682"></a>01682 <span class="stringliteral"></span>
<a name="l01683"></a>01683 <span class="stringliteral">        2) When we print the Q-Chem file, we should preserve the line</span>
<a name="l01684"></a>01684 <span class="stringliteral">        ordering of the &#39;rem&#39; section, but also be able to add &#39;rem&#39;</span>
<a name="l01685"></a>01685 <span class="stringliteral">        options at the end.</span>
<a name="l01686"></a>01686 <span class="stringliteral"></span>
<a name="l01687"></a>01687 <span class="stringliteral">        3) We should accommodate the use case that the Q-Chem file may have</span>
<a name="l01688"></a>01688 <span class="stringliteral">        follow-up calculations delimited by &#39;@@@@&#39;.</span>
<a name="l01689"></a>01689 <span class="stringliteral"></span>
<a name="l01690"></a>01690 <span class="stringliteral">        4) We can read in all of the xyz&#39;s as a trajectory, but only the</span>
<a name="l01691"></a>01691 <span class="stringliteral">        Q-Chem settings belonging to the first xyz will be saved.</span>
<a name="l01692"></a>01692 <span class="stringliteral"></span>
<a name="l01693"></a>01693 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01694"></a>01694 
<a name="l01695"></a>01695         qcrem                = OrderedDict()
<a name="l01696"></a>01696         qcrems               = []
<a name="l01697"></a>01697         xyz                  = []
<a name="l01698"></a>01698         xyzs                 = []
<a name="l01699"></a>01699         elem                 = []
<a name="l01700"></a>01700         section              = <span class="keywordtype">None</span>
<a name="l01701"></a>01701         <span class="comment"># The Z-matrix printing in new versions throws me off.</span>
<a name="l01702"></a>01702         zmatrix              = <span class="keyword">False</span>
<a name="l01703"></a>01703         template             = []
<a name="l01704"></a>01704         fff = <span class="keyword">False</span>
<a name="l01705"></a>01705         inside_section       = <span class="keyword">False</span>
<a name="l01706"></a>01706         reading_template     = <span class="keyword">True</span>
<a name="l01707"></a>01707         charge               = 0
<a name="l01708"></a>01708         mult                 = 0
<a name="l01709"></a>01709         Answer               = {}
<a name="l01710"></a>01710         SectionData          = []
<a name="l01711"></a>01711         template_cut         = 0
<a name="l01712"></a>01712         readsuf              = <span class="keyword">True</span>
<a name="l01713"></a>01713         suffix               = [] <span class="comment"># The suffix, which comes after every atom line in the $molecule section, is for determining the MM atom type and topology.</span>
<a name="l01714"></a>01714         ghost                = [] <span class="comment"># If the element in the $molecule section is preceded by an &#39;@&#39; sign, it&#39;s a ghost atom for counterpoise calculations.</span>
<a name="l01715"></a>01715 
<a name="l01716"></a>01716         <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm).readlines():
<a name="l01717"></a>01717             line = line.strip().expandtabs()
<a name="l01718"></a>01718             sline = line.split()
<a name="l01719"></a>01719             dline = line.split(<span class="stringliteral">&#39;!&#39;</span>)[0].<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a71da1c1e530afd8b9b5f08d9bd27259f" title="Split the molecule object into a number of separate files (chunks), either by specifying the number o...">split</a>()
<a name="l01720"></a>01720             <span class="keywordflow">if</span> <span class="stringliteral">&quot;Z-matrix Print&quot;</span> <span class="keywordflow">in</span> line:
<a name="l01721"></a>01721                 zmatrix = <span class="keyword">True</span>
<a name="l01722"></a>01722             <span class="keywordflow">if</span> re.match(<span class="stringliteral">&#39;^\$&#39;</span>,line):
<a name="l01723"></a>01723                 wrd = re.sub(<span class="stringliteral">&#39;\$&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,line)
<a name="l01724"></a>01724                 <span class="keywordflow">if</span> wrd == <span class="stringliteral">&#39;end&#39;</span>:
<a name="l01725"></a>01725                     zmatrix = <span class="keyword">False</span>
<a name="l01726"></a>01726                     inside_section = <span class="keyword">False</span>
<a name="l01727"></a>01727                     <span class="keywordflow">if</span> section == <span class="stringliteral">&#39;molecule&#39;</span>:
<a name="l01728"></a>01728                         <span class="keywordflow">if</span> len(xyz) &gt; 0:
<a name="l01729"></a>01729                             xyzs.append(np.array(xyz))
<a name="l01730"></a>01730                         xyz = []
<a name="l01731"></a>01731                         fff = <span class="keyword">True</span>
<a name="l01732"></a>01732                         <span class="keywordflow">if</span> suffix != []:
<a name="l01733"></a>01733                             readsuf = <span class="keyword">False</span>
<a name="l01734"></a>01734                     <span class="keywordflow">elif</span> section == <span class="stringliteral">&#39;rem&#39;</span>:
<a name="l01735"></a>01735                         <span class="keywordflow">if</span> reading_template:
<a name="l01736"></a>01736                             qcrems.append(qcrem)
<a name="l01737"></a>01737                             qcrem = OrderedDict()
<a name="l01738"></a>01738                     <span class="keywordflow">if</span> reading_template:
<a name="l01739"></a>01739                         <span class="keywordflow">if</span> section != <span class="stringliteral">&#39;external_charges&#39;</span>: <span class="comment"># Ignore the external charges section because it varies from frame to frame.</span>
<a name="l01740"></a>01740                             template.append((section,SectionData))
<a name="l01741"></a>01741                     SectionData = []
<a name="l01742"></a>01742                 <span class="keywordflow">else</span>:
<a name="l01743"></a>01743                     section = wrd
<a name="l01744"></a>01744                     inside_section = <span class="keyword">True</span>
<a name="l01745"></a>01745             <span class="keywordflow">elif</span> inside_section:
<a name="l01746"></a>01746                 <span class="keywordflow">if</span> section == <span class="stringliteral">&#39;molecule&#39;</span> <span class="keywordflow">and</span> <span class="keywordflow">not</span> zmatrix:
<a name="l01747"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a003b182b54de4473c4691ae1474b1ada">01747</a>                     <span class="keywordflow">if</span> len(dline) &gt;= 4 <span class="keywordflow">and</span> all([<a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(dline[i]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(1,4)]):
<a name="l01748"></a>01748                         <span class="keywordflow">if</span> fff:
<a name="l01749"></a>01749                             reading_template = <span class="keyword">False</span>
<a name="l01750"></a>01750                             template_cut = list(i <span class="keywordflow">for</span> i, dat <span class="keywordflow">in</span> enumerate(template) <span class="keywordflow">if</span> dat[0] == <span class="stringliteral">&#39;@@@@&#39;</span>)[-1]
<a name="l01751"></a>01751                         <span class="keywordflow">else</span>:
<a name="l01752"></a>01752                             <span class="keywordflow">if</span> re.match(<span class="stringliteral">&#39;^@&#39;</span>, sline[0]): <span class="comment"># This is a ghost atom</span>
<a name="l01753"></a>01753                                 ghost.append(<span class="keyword">True</span>)
<a name="l01754"></a>01754                             <span class="keywordflow">else</span>:
<a name="l01755"></a>01755                                 ghost.append(<span class="keyword">False</span>)
<a name="l01756"></a>01756                             elem.append(re.sub(<span class="stringliteral">&#39;@&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,sline[0]))
<a name="l01757"></a>01757                         xyz.append([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline[1:4]])
<a name="l01758"></a>01758                         <span class="keywordflow">if</span> readsuf <span class="keywordflow">and</span> len(sline) &gt; 4:
<a name="l01759"></a>01759                             whites      = re.split(<span class="stringliteral">&#39;[^ ]+&#39;</span>,line)
<a name="l01760"></a>01760                             suffix.append(<span class="stringliteral">&#39;&#39;</span>.join([whites[j]+sline[j] <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(4,len(sline))]))
<a name="l01761"></a>01761                     <span class="keywordflow">elif</span> re.match(<span class="stringliteral">&quot;[+-]?[0-9]+ +[0-9]+$&quot;</span>,line.split(<span class="stringliteral">&#39;!&#39;</span>)[0].strip()):
<a name="l01762"></a>01762                         <span class="keywordflow">if</span> <span class="keywordflow">not</span> fff:
<a name="l01763"></a>01763                             charge = int(sline[0])
<a name="l01764"></a>01764                             mult = int(sline[1])
<a name="l01765"></a>01765                     <span class="keywordflow">else</span>:
<a name="l01766"></a>01766                         SectionData.append(line)
<a name="l01767"></a>01767                 <span class="keywordflow">elif</span> reading_template <span class="keywordflow">and</span> <span class="keywordflow">not</span> zmatrix:
<a name="l01768"></a>01768                     <span class="keywordflow">if</span> section == <span class="stringliteral">&#39;basis&#39;</span>:
<a name="l01769"></a>01769                         SectionData.append(line.split(<span class="stringliteral">&#39;!&#39;</span>)[0])
<a name="l01770"></a>01770                     <span class="keywordflow">elif</span> section == <span class="stringliteral">&#39;rem&#39;</span>:
<a name="l01771"></a>01771                         S = splitter.findall(line)
<a name="l01772"></a>01772                         <span class="keywordflow">if</span> S[0] == <span class="stringliteral">&#39;!&#39;</span>:
<a name="l01773"></a>01773                             qcrem[<span class="stringliteral">&#39;&#39;</span>.join(S[0:3]).lower()] = <span class="stringliteral">&#39;&#39;</span>.join(S[4:])
<a name="l01774"></a>01774                         <span class="keywordflow">else</span>:
<a name="l01775"></a>01775                             qcrem[S[0].lower()] = <span class="stringliteral">&#39;&#39;</span>.join(S[2:])
<a name="l01776"></a>01776                     <span class="keywordflow">else</span>:
<a name="l01777"></a>01777                         SectionData.append(line)
<a name="l01778"></a>01778             <span class="keywordflow">elif</span> re.match(<span class="stringliteral">&#39;^@+$&#39;</span>, line) <span class="keywordflow">and</span> reading_template:
<a name="l01779"></a>01779                 template.append((<span class="stringliteral">&#39;@@@@&#39;</span>, []))
<a name="l01780"></a>01780             <span class="keywordflow">elif</span> re.match(<span class="stringliteral">&#39;Welcome to Q-Chem&#39;</span>, line) <span class="keywordflow">and</span> reading_template <span class="keywordflow">and</span> fff:
<a name="l01781"></a>01781                 template.append((<span class="stringliteral">&#39;@@@@&#39;</span>, []))
<a name="l01782"></a>01782 
<a name="l01783"></a>01783         <span class="keywordflow">if</span> template_cut != 0:
<a name="l01784"></a>01784             template = template[:template_cut]
<a name="l01785"></a>01785 
<a name="l01786"></a>01786         Answer = {<span class="stringliteral">&#39;qctemplate&#39;</span>  : template,
<a name="l01787"></a>01787                   <span class="stringliteral">&#39;qcrems&#39;</span>      : qcrems,
<a name="l01788"></a>01788                   <span class="stringliteral">&#39;charge&#39;</span>      : charge,
<a name="l01789"></a>01789                   <span class="stringliteral">&#39;mult&#39;</span>        : mult,
<a name="l01790"></a>01790                   }
<a name="l01791"></a>01791         <span class="keywordflow">if</span> suffix != []:
<a name="l01792"></a>01792             Answer[<span class="stringliteral">&#39;qcsuf&#39;</span>] = suffix
<a name="l01793"></a>01793 
<a name="l01794"></a>01794         <span class="keywordflow">if</span> len(xyzs) &gt; 0:
<a name="l01795"></a>01795             Answer[<span class="stringliteral">&#39;xyzs&#39;</span>] = xyzs
<a name="l01796"></a>01796         <span class="keywordflow">if</span> len(elem) &gt; 0:
<a name="l01797"></a>01797             Answer[<span class="stringliteral">&#39;elem&#39;</span>] = elem
<a name="l01798"></a>01798         <span class="keywordflow">if</span> len(ghost) &gt; 0:
<a name="l01799"></a>01799             Answer[<span class="stringliteral">&#39;qm_ghost&#39;</span>] = ghost
<a name="l01800"></a>01800         <span class="keywordflow">return</span> Answer
<a name="l01801"></a>01801 
<a name="l01802"></a>01802 
<a name="l01803"></a>01803     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#afadc87c0cc32dc73558cd901a4c64dd4" title="Loads a PDB and returns a dictionary containing its data.">read_pdb</a>(self, fnm):
<a name="l01804"></a>01804         <span class="stringliteral">&quot;&quot;&quot; Loads a PDB and returns a dictionary containing its data. &quot;&quot;&quot;</span>
<a name="l01805"></a>01805 
<a name="l01806"></a>01806         F1=file(fnm,<span class="stringliteral">&#39;</span><span class="stringliteral">r&#39;)</span>
<a name="l01807"></a>01807 <span class="stringliteral">        ParsedPDB=readPDB(F1)</span>
<a name="l01808"></a>01808 <span class="stringliteral"></span>
<a name="l01809"></a>01809 <span class="stringliteral">        Box = </span><span class="keywordtype">None</span>
<a name="l01810"></a>01810         <span class="comment">#Separate into distinct lists for each model.</span>
<a name="l01811"></a>01811         PDBLines=[[]]
<a name="l01812"></a>01812         <span class="keywordflow">for</span> x <span class="keywordflow">in</span> ParsedPDB[0]:
<a name="l01813"></a>01813             <span class="keywordflow">if</span> x.__class__ <span class="keywordflow">in</span> [END, ENDMDL]:
<a name="l01814"></a>01814                 PDBLines.append([])
<a name="l01815"></a>01815             <span class="keywordflow">if</span> x.__class__ <span class="keywordflow">in</span> [ATOM, HETATM]:
<a name="l01816"></a>01816                 PDBLines[-1].<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a77417ff99b19f6d0b7c6f527e83fa7f1">append</a>(x)
<a name="l01817"></a>01817             <span class="keywordflow">if</span> x.__class__==CRYST1:
<a name="l01818"></a>01818                 Box = <a class="code" href="namespaceforcebalance_1_1molecule.html#a0a6e3e79b04534bf2e83d09def189444" title="This function takes in three lattice lengths and three lattice angles, and tries to return a complete...">BuildLatticeFromLengthsAngles</a>(x.a, x.b, x.c, x.alpha, x.beta, x.gamma)
<a name="l01819"></a>01819 
<a name="l01820"></a>01820         X=PDBLines[0]
<a name="l01821"></a>01821 
<a name="l01822"></a>01822         XYZ=np.array([[x.x,x.y,x.z] <span class="keywordflow">for</span> x <span class="keywordflow">in</span> X])/10.0<span class="comment">#Convert to nanometers</span>
<a name="l01823"></a>01823         AltLoc=np.array([x.altLoc <span class="keywordflow">for</span> x <span class="keywordflow">in</span> X],<span class="stringliteral">&#39;str&#39;</span>) <span class="comment"># Alternate location</span>
<a name="l01824"></a>01824         ICode=np.array([x.iCode <span class="keywordflow">for</span> x <span class="keywordflow">in</span> X],<span class="stringliteral">&#39;str&#39;</span>) <span class="comment"># Insertion code</span>
<a name="l01825"></a>01825         ChainID=np.array([x.chainID <span class="keywordflow">for</span> x <span class="keywordflow">in</span> X],<span class="stringliteral">&#39;str&#39;</span>)
<a name="l01826"></a>01826         AtomNames=np.array([x.name <span class="keywordflow">for</span> x <span class="keywordflow">in</span> X],<span class="stringliteral">&#39;str&#39;</span>)
<a name="l01827"></a>01827         ResidueNames=np.array([x.resName <span class="keywordflow">for</span> x <span class="keywordflow">in</span> X],<span class="stringliteral">&#39;str&#39;</span>)
<a name="l01828"></a>01828         ResidueID=np.array([x.resSeq <span class="keywordflow">for</span> x <span class="keywordflow">in</span> X],<span class="stringliteral">&#39;int&#39;</span>)
<a name="l01829"></a>01829         <span class="comment"># Try not to number Residue IDs starting from 1...</span>
<a name="l01830"></a>01830         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a5ba227fb037995246be7bca5cf633b8b" title="Creates entries like &#39;gromacs&#39; : &#39;gromacs&#39; and &#39;xyz&#39; : &#39;xyz&#39; in the Funnel.">positive_resid</a>:
<a name="l01831"></a>01831             ResidueID=ResidueID-ResidueID[0]+1
<a name="l01832"></a>01832 
<a name="l01833"></a>01833         XYZList=[]
<a name="l01834"></a>01834         <span class="keywordflow">for</span> Model <span class="keywordflow">in</span> PDBLines:
<a name="l01835"></a>01835             <span class="comment"># Skip over subsequent models with the wrong number of atoms.</span>
<a name="l01836"></a>01836             NewXYZ = []
<a name="l01837"></a>01837             <span class="keywordflow">for</span> x <span class="keywordflow">in</span> Model:
<a name="l01838"></a>01838                 NewXYZ.append([x.x,x.y,x.z])
<a name="l01839"></a>01839             <span class="keywordflow">if</span> len(XYZList) == 0:
<a name="l01840"></a>01840                 XYZList.append(NewXYZ)
<a name="l01841"></a>01841             <span class="keywordflow">elif</span> len(XYZList) &gt;= 1 <span class="keywordflow">and</span> (np.array(NewXYZ).shape == np.array(XYZList[-1]).shape):
<a name="l01842"></a>01842                 XYZList.append(NewXYZ)
<a name="l01843"></a>01843 
<a name="l01844"></a>01844         <span class="keywordflow">if</span> len(XYZList[-1])==0:<span class="comment">#If PDB contains trailing END / ENDMDL, remove empty list</span>
<a name="l01845"></a>01845             XYZList.pop()
<a name="l01846"></a>01846 
<a name="l01847"></a>01847         <span class="comment"># Build a list of chemical elements</span>
<a name="l01848"></a>01848         elem = []
<a name="l01849"></a>01849         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> AtomNames:
<a name="l01850"></a>01850             thiselem = i
<a name="l01851"></a>01851             <span class="keywordflow">if</span> len(thiselem) &gt; 1:
<a name="l01852"></a>01852                 thiselem = re.sub(<span class="stringliteral">&#39;^[0-9]&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,thiselem)
<a name="l01853"></a>01853                 thiselem = thiselem[0] + re.sub(<span class="stringliteral">&#39;[A-Z0-9]&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,thiselem[1:])
<a name="l01854"></a>01854             elem.append(thiselem)
<a name="l01855"></a>01855 
<a name="l01856"></a>01856         XYZList=list(np.array(XYZList).reshape((-1,len(ChainID),3)))
<a name="l01857"></a>01857 
<a name="l01858"></a>01858         bonds = []
<a name="l01859"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#afadc87c0cc32dc73558cd901a4c64dd4">01859</a>         <span class="comment"># Read in CONECT records.</span>
<a name="l01860"></a>01860         F2=open(fnm,<span class="stringliteral">&#39;</span><span class="stringliteral">r&#39;)</span>
<a name="l01861"></a>01861 <span class="stringliteral">        </span><span class="keywordflow">for</span> line <span class="keywordflow">in</span> F2:
<a name="l01862"></a>01862             s = line.split()
<a name="l01863"></a>01863             <span class="keywordflow">if</span> s[0].upper() == <span class="stringliteral">&quot;CONECT&quot;</span>:
<a name="l01864"></a>01864                 <span class="keywordflow">if</span> len(s) &gt; 2:
<a name="l01865"></a>01865                     <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(2, len(s)):
<a name="l01866"></a>01866                         bonds.append((int(s[1])-1, int(s[i])-1))
<a name="l01867"></a>01867 
<a name="l01868"></a>01868         Answer={<span class="stringliteral">&quot;xyzs&quot;</span>:XYZList, <span class="stringliteral">&quot;chain&quot;</span>:ChainID, <span class="stringliteral">&quot;altloc&quot;</span>:AltLoc, <span class="stringliteral">&quot;icode&quot;</span>:ICode, <span class="stringliteral">&quot;atomname&quot;</span>:AtomNames,
<a name="l01869"></a>01869                 <span class="stringliteral">&quot;resid&quot;</span>:ResidueID, <span class="stringliteral">&quot;resname&quot;</span>:ResidueNames, <span class="stringliteral">&quot;elem&quot;</span>:elem,
<a name="l01870"></a>01870                 <span class="stringliteral">&quot;comms&quot;</span>:[<span class="stringliteral">&#39;&#39;</span> <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(XYZList))]}
<a name="l01871"></a>01871 
<a name="l01872"></a>01872         <span class="keywordflow">if</span> len(bonds) &gt; 0:
<a name="l01873"></a>01873             Answer[<span class="stringliteral">&quot;bonds&quot;</span>] = bonds
<a name="l01874"></a>01874         <span class="keywordflow">if</span> Box != <span class="keywordtype">None</span>:
<a name="l01875"></a>01875             Answer[<span class="stringliteral">&quot;boxes&quot;</span>] = [Box <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(XYZList))]
<a name="l01876"></a>01876 
<a name="l01877"></a>01877         <span class="keywordflow">return</span> Answer
<a name="l01878"></a>01878 
<a name="l01879"></a>01879     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a27fb6201b435a3b205ae62f605256f3d">read_qcesp</a>(self, fnm):
<a name="l01880"></a>01880         espxyz = []
<a name="l01881"></a>01881         espval = []
<a name="l01882"></a>01882         <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm):
<a name="l01883"></a>01883             sline = line.split()
<a name="l01884"></a>01884             <span class="keywordflow">if</span> len(sline) == 4 <span class="keywordflow">and</span> all([<a class="code" href="namespaceforcebalance_1_1molecule.html#afe989ffd119568047fc8265b1d329a70" title="Matches ANY number; it can be a decimal, scientific notation, integer, or what have you...">isfloat</a>(sline[i]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(4)]):
<a name="l01885"></a>01885                 espxyz.append([float(sline[i]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(3)])
<a name="l01886"></a>01886                 espval.append(float(sline[3]))
<a name="l01887"></a>01887         Answer = {<span class="stringliteral">&#39;qm_espxyzs&#39;</span> : [np.array(espxyz) * bohrang],
<a name="l01888"></a>01888                   <span class="stringliteral">&#39;qm_espvals&#39;</span>  : [np.array(espval)]
<a name="l01889"></a>01889                   }
<a name="l01890"></a>01890         <span class="keywordflow">return</span> Answer
<a name="l01891"></a>01891     
<a name="l01892"></a>01892     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8c9e71843e7123c57c43c24af2d84f25" title="Q-Chem output file reader, adapted for our parser.">read_qcout</a>(self, fnm):
<a name="l01893"></a>01893         <span class="stringliteral">&quot;&quot;&quot; Q-Chem output file reader, adapted for our parser. </span>
<a name="l01894"></a>01894 <span class="stringliteral">    </span>
<a name="l01895"></a>01895 <span class="stringliteral">        Q-Chem output files are very flexible and there&#39;s no way I can account for all of them.  Here&#39;s what</span>
<a name="l01896"></a>01896 <span class="stringliteral">        I am able to account for:</span>
<a name="l01897"></a>01897 <span class="stringliteral">        </span>
<a name="l01898"></a>01898 <span class="stringliteral">        A list of:</span>
<a name="l01899"></a>01899 <span class="stringliteral">        - Coordinates</span>
<a name="l01900"></a>01900 <span class="stringliteral">        - Energies</span>
<a name="l01901"></a>01901 <span class="stringliteral">        - Forces</span>
<a name="l01902"></a>01902 <span class="stringliteral">        </span>
<a name="l01903"></a>01903 <span class="stringliteral">        Note that each step in a geometry optimization counts as a frame.</span>
<a name="l01904"></a>01904 <span class="stringliteral">    </span>
<a name="l01905"></a>01905 <span class="stringliteral">        As with all Q-Chem output files, note that successive calculations can have different numbers of atoms.</span>
<a name="l01906"></a>01906 <span class="stringliteral">    </span>
<a name="l01907"></a>01907 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l01908"></a>01908     
<a name="l01909"></a>01909         xyzs     = []
<a name="l01910"></a>01910         xyz      = []
<a name="l01911"></a>01911         elem     = []
<a name="l01912"></a>01912         elemThis = []
<a name="l01913"></a>01913         mkchg    = []
<a name="l01914"></a>01914         mkspn    = []
<a name="l01915"></a>01915         mkchgThis= []
<a name="l01916"></a>01916         mkspnThis= []
<a name="l01917"></a>01917         XMode    = 0
<a name="l01918"></a>01918         MMode    = 0
<a name="l01919"></a>01919         conv     = []
<a name="l01920"></a>01920         convThis = 0
<a name="l01921"></a>01921         readChargeMult = 0
<a name="l01922"></a>01922         energy_scf = []
<a name="l01923"></a>01923         float_match  = {<span class="stringliteral">&#39;energy_scfThis&#39;</span>   : (<span class="stringliteral">&quot;^[1-9][0-9]* +[-+]?([0-9]*\.)?[0-9]+ +[-+]?([0-9]*\.)?[0-9]+([eE][-+]?[0-9]+)[A-Za-z0 ]*$&quot;</span>, 1),
<a name="l01924"></a>01924                         <span class="stringliteral">&#39;energy_opt&#39;</span>       : (<span class="stringliteral">&quot;^Final energy is +[-+]?([0-9]*\.)?[0-9]+$&quot;</span>, -1),
<a name="l01925"></a>01925                         <span class="stringliteral">&#39;charge&#39;</span>           : (<span class="stringliteral">&quot;Sum of atomic charges&quot;</span>, -1),
<a name="l01926"></a>01926                         <span class="stringliteral">&#39;mult&#39;</span>             : (<span class="stringliteral">&quot;Sum of spin +charges&quot;</span>, -1),
<a name="l01927"></a>01927                         <span class="stringliteral">&#39;energy_mp2&#39;</span>       : (<span class="stringliteral">&quot;^(ri)*(-)*mp2 +total energy += +[-+]?([0-9]*\.)?[0-9]+ +au$&quot;</span>,-2),
<a name="l01928"></a>01928                         <span class="stringliteral">&#39;energy_ccsd&#39;</span>      : (<span class="stringliteral">&quot;^CCSD Total Energy += +[-+]?([0-9]*\.)?[0-9]+$&quot;</span>,-1),
<a name="l01929"></a>01929                         <span class="stringliteral">&#39;energy_ccsdt&#39;</span>     : (<span class="stringliteral">&quot;^CCSD\(T\) Total Energy += +[-+]?([0-9]*\.)?[0-9]+$&quot;</span>,-1)
<a name="l01930"></a>01930                         }
<a name="l01931"></a>01931         matrix_match = {<span class="stringliteral">&#39;analytical_grad&#39;</span>  :<span class="stringliteral">&#39;Full Analytical Gradient&#39;</span>,
<a name="l01932"></a>01932                         <span class="stringliteral">&#39;gradient_scf&#39;</span>     :<span class="stringliteral">&#39;Gradient of SCF Energy&#39;</span>,
<a name="l01933"></a>01933                         <span class="stringliteral">&#39;gradient_mp2&#39;</span>     :<span class="stringliteral">&#39;Gradient of MP2 Energy&#39;</span>,
<a name="l01934"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a27fb6201b435a3b205ae62f605256f3d">01934</a>                         <span class="stringliteral">&#39;gradient_dualbas&#39;</span> :<span class="stringliteral">&#39;Gradient of the Dual-Basis Energy&#39;</span>
<a name="l01935"></a>01935                         }
<a name="l01936"></a>01936         qcrem    = OrderedDict()
<a name="l01937"></a>01937 
<a name="l01938"></a>01938         matblank   = {<span class="stringliteral">&#39;match&#39;</span> : <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;All&#39;</span> : [], <span class="stringliteral">&#39;This&#39;</span> : [], <span class="stringliteral">&#39;Strip&#39;</span> : [], <span class="stringliteral">&#39;Mode&#39;</span> : 0}
<a name="l01939"></a>01939         Mats      = {}
<a name="l01940"></a>01940         Floats    = {}
<a name="l01941"></a>01941         <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> matrix_match.items():
<a name="l01942"></a>01942             Mats[key] = matblank.copy()
<a name="l01943"></a>01943         <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> float_match.items():
<a name="l01944"></a>01944             Floats[key] = []
<a name="l01945"></a>01945     
<a name="l01946"></a>01946         <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(fnm):
<a name="l01947"></a>01947             line = line.strip().expandtabs()
<a name="l01948"></a>01948             <span class="keywordflow">if</span> <span class="stringliteral">&#39;fatal error&#39;</span> <span class="keywordflow">in</span> line:
<a name="l01949"></a>01949                 <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Calculation encountered a fatal error!&#39;</span>)
<a name="l01950"></a>01950             <span class="keywordflow">if</span> XMode &gt;= 1:
<a name="l01951"></a>01951                 <span class="comment"># Perfectionist here; matches integer, element, and three floating points</span>
<a name="l01952"></a>01952                 <span class="keywordflow">if</span> re.match(<span class="stringliteral">&quot;^[0-9]+ +[A-Z][A-Za-z]?( +[-+]?([0-9]*\.)?[0-9]+){3}$&quot;</span>, line):
<a name="l01953"></a>01953                     XMode = 2
<a name="l01954"></a>01954                     sline = line.split()
<a name="l01955"></a>01955                     elemThis.append(sline[1])
<a name="l01956"></a>01956                     xyz.append([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline[2:]])
<a name="l01957"></a>01957                 <span class="keywordflow">elif</span> XMode == 2: <span class="comment"># Break out of the loop if we encounter anything other than atomic data</span>
<a name="l01958"></a>01958                     <span class="keywordflow">if</span> elem == []:
<a name="l01959"></a>01959                         elem = elemThis
<a name="l01960"></a>01960                     <span class="keywordflow">elif</span> elem != elemThis:
<a name="l01961"></a>01961                         <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Q-Chem output parser will not work if successive calculations have different numbers of atoms!&#39;</span>)
<a name="l01962"></a>01962                     elemThis = []
<a name="l01963"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8c9e71843e7123c57c43c24af2d84f25">01963</a>                     xyzs.append(np.array(xyz))
<a name="l01964"></a>01964                     xyz  = []
<a name="l01965"></a>01965                     XMode = 0
<a name="l01966"></a>01966             <span class="keywordflow">if</span> MMode &gt;= 1:
<a name="l01967"></a>01967                 <span class="comment"># Perfectionist here; matches integer, element, and two floating points</span>
<a name="l01968"></a>01968                 <span class="keywordflow">if</span> re.match(<span class="stringliteral">&quot;^[0-9]+ +[A-Z][a-z]?( +[-+]?([0-9]*\.)?[0-9]+){2}$&quot;</span>, line):
<a name="l01969"></a>01969                     MMode = 2
<a name="l01970"></a>01970                     sline = line.split()
<a name="l01971"></a>01971                     mkchgThis.append(float(sline[2]))
<a name="l01972"></a>01972                     mkspnThis.append(float(sline[3]))
<a name="l01973"></a>01973                 <span class="keywordflow">elif</span> MMode == 2: <span class="comment"># Break out of the loop if we encounter anything other than Mulliken charges</span>
<a name="l01974"></a>01974                     mkchg.append(mkchgThis[:])
<a name="l01975"></a>01975                     mkspn.append(mkspnThis[:])
<a name="l01976"></a>01976                     mkchgThis = []
<a name="l01977"></a>01977                     mkspnThis = []
<a name="l01978"></a>01978                     MMode = 0
<a name="l01979"></a>01979             <span class="keywordflow">elif</span> re.match(<span class="stringliteral">&quot;Standard Nuclear Orientation&quot;</span>.lower(), line.lower()):
<a name="l01980"></a>01980                 XMode = 1
<a name="l01981"></a>01981             <span class="keywordflow">elif</span> re.match(<span class="stringliteral">&quot;Ground-State Mulliken Net Atomic Charges&quot;</span>.lower(), line.lower()):
<a name="l01982"></a>01982                 MMode = 1
<a name="l01983"></a>01983             <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> float_match.items():
<a name="l01984"></a>01984                 <span class="keywordflow">if</span> re.match(val[0].lower(), line.lower()):
<a name="l01985"></a>01985                     Floats[key].<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a77417ff99b19f6d0b7c6f527e83fa7f1">append</a>(float(line.split()[val[1]]))
<a name="l01986"></a>01986             <span class="keywordflow">if</span> re.match(<span class="stringliteral">&quot;.*Convergence criterion met$&quot;</span>.lower(), line.lower()):
<a name="l01987"></a>01987                 conv.append(1)
<a name="l01988"></a>01988                 energy_scf.append(Floats[<span class="stringliteral">&#39;energy_scfThis&#39;</span>][-1])
<a name="l01989"></a>01989                 Floats[<span class="stringliteral">&#39;energy_scfThis&#39;</span>] = []
<a name="l01990"></a>01990             <span class="keywordflow">elif</span> re.match(<span class="stringliteral">&quot;.*Including correction$&quot;</span>.lower(), line.lower()):
<a name="l01991"></a>01991                 energy_scf[-1] = Floats[<span class="stringliteral">&#39;energy_scfThis&#39;</span>][-1]
<a name="l01992"></a>01992                 Floats[<span class="stringliteral">&#39;energy_scfThis&#39;</span>] = []
<a name="l01993"></a>01993             <span class="keywordflow">elif</span> re.match(<span class="stringliteral">&quot;.*Convergence failure$&quot;</span>.lower(), line.lower()):
<a name="l01994"></a>01994                 conv.append(0)
<a name="l01995"></a>01995                 Floats[<span class="stringliteral">&#39;energy_scfThis&#39;</span>] = []
<a name="l01996"></a>01996             <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> matrix_match.items():
<a name="l01997"></a>01997                 <span class="keywordflow">if</span> Mats[key][<span class="stringliteral">&quot;Mode&quot;</span>] &gt;= 1:
<a name="l01998"></a>01998                     <span class="keywordflow">if</span> re.match(<span class="stringliteral">&quot;^[0-9]+( +[0-9]+)+$&quot;</span>,line):
<a name="l01999"></a>01999                         Mats[key][<span class="stringliteral">&quot;This&quot;</span>] = <a class="code" href="namespaceforcebalance_1_1molecule.html#a4cdb2086978b281ed84cd66179c3f5b2">add_strip_to_mat</a>(Mats[key][<span class="stringliteral">&quot;This&quot;</span>],Mats[key][<span class="stringliteral">&quot;Strip&quot;</span>])
<a name="l02000"></a>02000                         Mats[key][<span class="stringliteral">&quot;Strip&quot;</span>] = []
<a name="l02001"></a>02001                     <span class="keywordflow">elif</span> re.match(<span class="stringliteral">&quot;^[0-9]+( +[-+]?([0-9]*\.)?[0-9]+)+$&quot;</span>,line):
<a name="l02002"></a>02002                         Mats[key][<span class="stringliteral">&quot;Strip&quot;</span>].<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a77417ff99b19f6d0b7c6f527e83fa7f1">append</a>([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> line.split()[1:]])
<a name="l02003"></a>02003                     <span class="keywordflow">else</span>:
<a name="l02004"></a>02004                         Mats[key][<span class="stringliteral">&quot;This&quot;</span>] = <a class="code" href="namespaceforcebalance_1_1molecule.html#a4cdb2086978b281ed84cd66179c3f5b2">add_strip_to_mat</a>(Mats[key][<span class="stringliteral">&quot;This&quot;</span>],Mats[key][<span class="stringliteral">&quot;Strip&quot;</span>])
<a name="l02005"></a>02005                         Mats[key][<span class="stringliteral">&quot;Strip&quot;</span>] = []
<a name="l02006"></a>02006                         Mats[key][<span class="stringliteral">&quot;All&quot;</span>].<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a77417ff99b19f6d0b7c6f527e83fa7f1">append</a>(np.array(Mats[key][<span class="stringliteral">&quot;This&quot;</span>]))
<a name="l02007"></a>02007                         Mats[key][<span class="stringliteral">&quot;This&quot;</span>] = []
<a name="l02008"></a>02008                         Mats[key][<span class="stringliteral">&quot;Mode&quot;</span>] = 0
<a name="l02009"></a>02009                 <span class="keywordflow">elif</span> re.match(val.lower(), line.lower()):
<a name="l02010"></a>02010                     Mats[key][<span class="stringliteral">&quot;Mode&quot;</span>] = 1
<a name="l02011"></a>02011 
<a name="l02012"></a>02012         <span class="keywordflow">if</span> len(Floats[<span class="stringliteral">&#39;mult&#39;</span>]) == 0:
<a name="l02013"></a>02013             Floats[<span class="stringliteral">&#39;mult&#39;</span>] = [0]
<a name="l02014"></a>02014 
<a name="l02015"></a>02015         <span class="comment"># Copy out the coordinate lists; Q-Chem output cannot be trusted to get the chemical elements</span>
<a name="l02016"></a>02016         Answer = {<span class="stringliteral">&#39;xyzs&#39;</span>:xyzs}
<a name="l02017"></a>02017         <span class="comment"># Read the output file as an input file to get a Q-Chem template.</span>
<a name="l02018"></a>02018         Aux = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a003b182b54de4473c4691ae1474b1ada" title="Read a Q-Chem input file.">read_qcin</a>(fnm)
<a name="l02019"></a>02019         Answer[<span class="stringliteral">&#39;qctemplate&#39;</span>] = Aux[<span class="stringliteral">&#39;qctemplate&#39;</span>]
<a name="l02020"></a>02020         Answer[<span class="stringliteral">&#39;qcrems&#39;</span>] = Aux[<span class="stringliteral">&#39;qcrems&#39;</span>]
<a name="l02021"></a>02021         Answer[<span class="stringliteral">&#39;elem&#39;</span>] = Aux[<span class="stringliteral">&#39;elem&#39;</span>]
<a name="l02022"></a>02022         <span class="keywordflow">if</span> <span class="stringliteral">&#39;qm_ghost&#39;</span> <span class="keywordflow">in</span> Aux:
<a name="l02023"></a>02023             Answer[<span class="stringliteral">&#39;qm_ghost&#39;</span>] = Aux[<span class="stringliteral">&#39;qm_ghost&#39;</span>]
<a name="l02024"></a>02024         <span class="comment"># Copy out the charge and multiplicity</span>
<a name="l02025"></a>02025         Answer[<span class="stringliteral">&#39;charge&#39;</span>] = int(Floats[<span class="stringliteral">&#39;charge&#39;</span>][0])
<a name="l02026"></a>02026         Answer[<span class="stringliteral">&#39;mult&#39;</span>]   = int(Floats[<span class="stringliteral">&#39;mult&#39;</span>][0]) + 1
<a name="l02027"></a>02027         <span class="comment"># Copy out the energies and forces</span>
<a name="l02028"></a>02028         <span class="comment"># Q-Chem can print out gradients with several different headings.</span>
<a name="l02029"></a>02029         <span class="comment"># We start with the most reliable heading and work our way down.</span>
<a name="l02030"></a>02030         <span class="keywordflow">if</span> len(Mats[<span class="stringliteral">&#39;analytical_grad&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]) &gt; 0:
<a name="l02031"></a>02031             Answer[<span class="stringliteral">&#39;qm_forces&#39;</span>] = Mats[<span class="stringliteral">&#39;analytical_grad&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]
<a name="l02032"></a>02032         <span class="keywordflow">if</span> len(Mats[<span class="stringliteral">&#39;gradient_mp2&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]) &gt; 0:
<a name="l02033"></a>02033             Answer[<span class="stringliteral">&#39;qm_forces&#39;</span>] = Mats[<span class="stringliteral">&#39;gradient_mp2&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]
<a name="l02034"></a>02034         <span class="keywordflow">elif</span> len(Mats[<span class="stringliteral">&#39;gradient_dualbas&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]) &gt; 0:
<a name="l02035"></a>02035             Answer[<span class="stringliteral">&#39;qm_forces&#39;</span>] = Mats[<span class="stringliteral">&#39;gradient_dualbas&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]
<a name="l02036"></a>02036         <span class="keywordflow">elif</span> len(Mats[<span class="stringliteral">&#39;gradient_scf&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]) &gt; 0:
<a name="l02037"></a>02037             Answer[<span class="stringliteral">&#39;qm_forces&#39;</span>] = Mats[<span class="stringliteral">&#39;gradient_scf&#39;</span>][<span class="stringliteral">&#39;All&#39;</span>]
<a name="l02038"></a>02038         <span class="comment">#else:</span>
<a name="l02039"></a>02039         <span class="comment">#    raise Exception(&#39;There are no forces in %s&#39; % fnm)</span>
<a name="l02040"></a>02040         <span class="comment"># Also work our way down with the energies.</span>
<a name="l02041"></a>02041         <span class="keywordflow">if</span> len(Floats[<span class="stringliteral">&#39;energy_ccsdt&#39;</span>]) &gt; 0:
<a name="l02042"></a>02042             Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>] = Floats[<span class="stringliteral">&#39;energy_ccsdt&#39;</span>]
<a name="l02043"></a>02043         <span class="keywordflow">elif</span> len(Floats[<span class="stringliteral">&#39;energy_ccsd&#39;</span>]) &gt; 0:
<a name="l02044"></a>02044             Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>] = Floats[<span class="stringliteral">&#39;energy_ccsd&#39;</span>]
<a name="l02045"></a>02045         <span class="keywordflow">elif</span> len(Floats[<span class="stringliteral">&#39;energy_mp2&#39;</span>]) &gt; 0:
<a name="l02046"></a>02046             Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>] = Floats[<span class="stringliteral">&#39;energy_mp2&#39;</span>]
<a name="l02047"></a>02047         <span class="keywordflow">elif</span> len(energy_scf) &gt; 0:
<a name="l02048"></a>02048             <span class="keywordflow">if</span> <span class="stringliteral">&#39;correlation&#39;</span> <span class="keywordflow">in</span> Answer[<span class="stringliteral">&#39;qcrems&#39;</span>][0] <span class="keywordflow">and</span> Answer[<span class="stringliteral">&#39;qcrems&#39;</span>][0][<span class="stringliteral">&#39;correlation&#39;</span>].lower() <span class="keywordflow">in</span> [<span class="stringliteral">&#39;mp2&#39;</span>, <span class="stringliteral">&#39;rimp2&#39;</span>, <span class="stringliteral">&#39;ccsd&#39;</span>, <span class="stringliteral">&#39;ccsd(t)&#39;</span>]:
<a name="l02049"></a>02049                 <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&quot;Q-Chem was called with a post-HF theory but we only got the SCF energy&quot;</span>)
<a name="l02050"></a>02050             Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>] = energy_scf
<a name="l02051"></a>02051         <span class="keywordflow">else</span>:
<a name="l02052"></a>02052             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;There are no energies in %s&#39;</span> % fnm)
<a name="l02053"></a>02053     
<a name="l02054"></a>02054         <span class="comment">#### Sanity checks</span>
<a name="l02055"></a>02055         <span class="comment"># We currently don&#39;t have a graceful way of dealing with SCF convergence failures in the output file.</span>
<a name="l02056"></a>02056         <span class="comment"># For instance, a failed calculation will have elem / xyz but no forces. :/</span>
<a name="l02057"></a>02057         <span class="keywordflow">if</span> 0 <span class="keywordflow">in</span> conv:
<a name="l02058"></a>02058             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;SCF convergence failure encountered in parsing %s&#39;</span> % fnm)
<a name="l02059"></a>02059         <span class="comment"># The molecule should have only one charge and one multiplicity</span>
<a name="l02060"></a>02060         <span class="keywordflow">if</span> len(set(Floats[<span class="stringliteral">&#39;charge&#39;</span>])) != 1 <span class="keywordflow">or</span> len(set(Floats[<span class="stringliteral">&#39;mult&#39;</span>])) != 1:
<a name="l02061"></a>02061             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Unexpected number of charges or multiplicities in parsing %s&#39;</span> % fnm)
<a name="l02062"></a>02062         lens = [len(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>], Answer[<span class="stringliteral">&#39;xyzs&#39;</span>]]
<a name="l02063"></a>02063         <span class="keywordflow">if</span> len(set(lens)) != 1:
<a name="l02064"></a>02064             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;The number of energies and coordinates in %s are not the same : %s&#39;</span> % (fnm, str(lens)))
<a name="l02065"></a>02065         <span class="comment"># The number of atoms should all be the same</span>
<a name="l02066"></a>02066         <span class="keywordflow">if</span> len(set([len(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> Answer[<span class="stringliteral">&#39;xyzs&#39;</span>]])) != 1:
<a name="l02067"></a>02067             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;The numbers of atoms across frames in %s are not all the same&#39;</span> % (fnm))
<a name="l02068"></a>02068 
<a name="l02069"></a>02069         <span class="keywordflow">if</span> <span class="stringliteral">&#39;qm_forces&#39;</span> <span class="keywordflow">in</span> Answer:
<a name="l02070"></a>02070             <span class="keywordflow">for</span> i, frc <span class="keywordflow">in</span> enumerate(Answer[<span class="stringliteral">&#39;qm_forces&#39;</span>]):
<a name="l02071"></a>02071                 Answer[<span class="stringliteral">&#39;qm_forces&#39;</span>][i] = frc.T
<a name="l02072"></a>02072         <span class="comment"># A strange peculiarity; Q-Chem sometimes prints out the final Mulliken charges a second time, after the geometry optimization.</span>
<a name="l02073"></a>02073         <span class="keywordflow">if</span> mkchg != []:
<a name="l02074"></a>02074             Answer[<span class="stringliteral">&#39;qm_mulliken_charges&#39;</span>] = list(np.array(mkchg[:len(Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>])]))
<a name="l02075"></a>02075         <span class="keywordflow">if</span> mkspn != []:
<a name="l02076"></a>02076             Answer[<span class="stringliteral">&#39;qm_mulliken_spins&#39;</span>] = list(np.array(mkspn[:len(Answer[<span class="stringliteral">&#39;qm_energies&#39;</span>])]))
<a name="l02077"></a>02077 
<a name="l02078"></a>02078         <span class="keywordflow">return</span> Answer
<a name="l02079"></a>02079     
<a name="l02080"></a>02080     <span class="comment">#=====================================#</span>
<a name="l02081"></a>02081     <span class="comment">#|         Writing functions         |#</span>
<a name="l02082"></a>02082     <span class="comment">#=====================================#</span>
<a name="l02083"></a>02083 
<a name="l02084"></a>02084     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#af46b2ba6ef777cf8301bc16e157c724d">write_qcin</a>(self, select):
<a name="l02085"></a>02085         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a80851250d8e749bea882d5aa4bcfcdd1">require</a>(<span class="stringliteral">&#39;qctemplate&#39;</span>,<span class="stringliteral">&#39;qcrems&#39;</span>,<span class="stringliteral">&#39;charge&#39;</span>,<span class="stringliteral">&#39;mult&#39;</span>,<span class="stringliteral">&#39;xyzs&#39;</span>,<span class="stringliteral">&#39;elem&#39;</span>)
<a name="l02086"></a>02086         out = []
<a name="l02087"></a>02087         <span class="keywordflow">for</span> I <span class="keywordflow">in</span> select:
<a name="l02088"></a>02088             xyz = self.xyzs[I]
<a name="l02089"></a>02089             remidx = 0
<a name="l02090"></a>02090             molecule_printed = <span class="keyword">False</span>
<a name="l02091"></a>02091             <span class="comment"># Each &#39;extchg&#39; has number_of_atoms * 4 elements corresponding to x, y, z, q.</span>
<a name="l02092"></a>02092             <span class="keywordflow">if</span> <span class="stringliteral">&#39;qm_extchgs&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l02093"></a>02093                 extchg = self.qm_extchgs[I]
<a name="l02094"></a>02094                 out.append(<span class="stringliteral">&#39;$external_charges&#39;</span>)
<a name="l02095"></a>02095                 <span class="keywordflow">print</span> extchg.shape
<a name="l02096"></a>02096                 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(extchg)):
<a name="l02097"></a>02097                     out.append(<span class="stringliteral">&quot;% 15.10f % 15.10f % 15.10f %15.10f&quot;</span> % (extchg[i,0],extchg[i,1],extchg[i,2],extchg[i,3]))
<a name="l02098"></a>02098                 out.append(<span class="stringliteral">&#39;$end&#39;</span>)
<a name="l02099"></a>02099             <span class="keywordflow">for</span> SectName, SectData <span class="keywordflow">in</span> self.qctemplate:
<a name="l02100"></a>02100                 <span class="keywordflow">if</span> SectName != <span class="stringliteral">&#39;@@@@&#39;</span>:
<a name="l02101"></a>02101                     out.append(<span class="stringliteral">&#39;$%s&#39;</span> % SectName)
<a name="l02102"></a>02102                     <span class="keywordflow">for</span> line <span class="keywordflow">in</span> SectData:
<a name="l02103"></a>02103                         out.append(line)
<a name="l02104"></a>02104                     <span class="keywordflow">if</span> SectName == <span class="stringliteral">&#39;molecule&#39;</span>:
<a name="l02105"></a>02105                         <span class="keywordflow">if</span> molecule_printed == <span class="keyword">False</span>:
<a name="l02106"></a>02106                             molecule_printed = <span class="keyword">True</span>
<a name="l02107"></a>02107                             out.append(<span class="stringliteral">&quot;%i %i&quot;</span> % (self.charge, self.mult))
<a name="l02108"></a>02108                             an = 0
<a name="l02109"></a>02109                             <span class="keywordflow">for</span> e, x <span class="keywordflow">in</span> zip(self.elem, xyz):
<a name="l02110"></a>02110                                 pre = <span class="stringliteral">&#39;@&#39;</span> <span class="keywordflow">if</span> (<span class="stringliteral">&#39;qm_ghost&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a> <span class="keywordflow">and</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[<span class="stringliteral">&#39;qm_ghost&#39;</span>][an]) <span class="keywordflow">else</span> <span class="stringliteral">&#39;&#39;</span>
<a name="l02111"></a>02111                                 suf =  self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>[<span class="stringliteral">&#39;qcsuf&#39;</span>][an] <span class="keywordflow">if</span> <span class="stringliteral">&#39;qcsuf&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a> <span class="keywordflow">else</span> <span class="stringliteral">&#39;&#39;</span>
<a name="l02112"></a>02112                                 out.append(pre + <a class="code" href="namespaceforcebalance_1_1molecule.html#a2eba3cad44138b3b10ea883240888412" title="Print a line consisting of (element, x, y, z) in accordance with .xyz file format.">format_xyz_coord</a>(e, x) + suf)
<a name="l02113"></a>02113                                 an += 1
<a name="l02114"></a>02114                     <span class="keywordflow">if</span> SectName == <span class="stringliteral">&#39;rem&#39;</span>:
<a name="l02115"></a>02115                         <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> self.qcrems[remidx].items():
<a name="l02116"></a>02116                             out.append(<span class="stringliteral">&quot;%-21s %-s&quot;</span> % (key, str(val)))
<a name="l02117"></a>02117                         remidx += 1
<a name="l02118"></a>02118                     <span class="keywordflow">if</span> SectName == <span class="stringliteral">&#39;comments&#39;</span> <span class="keywordflow">and</span> <span class="stringliteral">&#39;comms&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l02119"></a>02119                         out.append(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a5e092c726455a18c9300f5c5362121d8" title="Read in stuff if we passed in a file name, otherwise return an empty instance.">comms</a>[I])
<a name="l02120"></a>02120                     out.append(<span class="stringliteral">&#39;$end&#39;</span>)
<a name="l02121"></a>02121                 <span class="keywordflow">else</span>:
<a name="l02122"></a>02122                     out.append(<span class="stringliteral">&#39;@@@@&#39;</span>)
<a name="l02123"></a>02123                 out.append(<span class="stringliteral">&#39;&#39;</span>)
<a name="l02124"></a>02124             <span class="comment">#if I &lt; (len(self) - 1):</span>
<a name="l02125"></a>02125             <span class="keywordflow">if</span> I != select[-1]:
<a name="l02126"></a>02126                 out.append(<span class="stringliteral">&#39;@@@@&#39;</span>)
<a name="l02127"></a>02127                 out.append(<span class="stringliteral">&#39;&#39;</span>)
<a name="l02128"></a>02128         <span class="keywordflow">return</span> out
<a name="l02129"></a>02129 
<a name="l02130"></a>02130     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#adc6620e8287edabe161442de12295f75">write_xyz</a>(self, select):
<a name="l02131"></a>02131         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a80851250d8e749bea882d5aa4bcfcdd1">require</a>(<span class="stringliteral">&#39;elem&#39;</span>,<span class="stringliteral">&#39;xyzs&#39;</span>)
<a name="l02132"></a>02132         out = []
<a name="l02133"></a>02133         <span class="keywordflow">for</span> I <span class="keywordflow">in</span> select:
<a name="l02134"></a>02134             xyz = self.xyzs[I]
<a name="l02135"></a>02135             out.append(<span class="stringliteral">&quot;%-5i&quot;</span> % self.na)
<a name="l02136"></a>02136             out.append(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a5e092c726455a18c9300f5c5362121d8" title="Read in stuff if we passed in a file name, otherwise return an empty instance.">comms</a>[I])
<a name="l02137"></a>02137             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):
<a name="l02138"></a>02138                 out.append(<a class="code" href="namespaceforcebalance_1_1molecule.html#a2eba3cad44138b3b10ea883240888412" title="Print a line consisting of (element, x, y, z) in accordance with .xyz file format.">format_xyz_coord</a>(self.elem[i],xyz[i]))
<a name="l02139"></a>02139         <span class="keywordflow">return</span> out
<a name="l02140"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#af46b2ba6ef777cf8301bc16e157c724d">02140</a> 
<a name="l02141"></a>02141     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#aba14226f272f91c91ecf7060ff136a2b">write_molproq</a>(self, select):
<a name="l02142"></a>02142         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a80851250d8e749bea882d5aa4bcfcdd1">require</a>(<span class="stringliteral">&#39;xyzs&#39;</span>,<span class="stringliteral">&#39;partial_charge&#39;</span>)
<a name="l02143"></a>02143         out = []
<a name="l02144"></a>02144         <span class="keywordflow">for</span> I <span class="keywordflow">in</span> select:
<a name="l02145"></a>02145             xyz = self.xyzs[I]
<a name="l02146"></a>02146             <span class="comment"># Comment comes first, then number of atoms.</span>
<a name="l02147"></a>02147             out.append(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a5e092c726455a18c9300f5c5362121d8" title="Read in stuff if we passed in a file name, otherwise return an empty instance.">comms</a>[I])
<a name="l02148"></a>02148             out.append(<span class="stringliteral">&quot;%-5i&quot;</span> % self.na)
<a name="l02149"></a>02149             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):
<a name="l02150"></a>02150                 out.append(<span class="stringliteral">&quot;% 15.10f % 15.10f % 15.10f % 15.10f   0&quot;</span> % (xyz[i,0],xyz[i,1],xyz[i,2],self.partial_charge[i]))
<a name="l02151"></a>02151         <span class="keywordflow">return</span> out
<a name="l02152"></a>02152 
<a name="l02153"></a>02153     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#aab5ea35ab9d68559fd6ea7b747c2bddb">write_mdcrd</a>(self, select):
<a name="l02154"></a>02154         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a80851250d8e749bea882d5aa4bcfcdd1">require</a>(<span class="stringliteral">&#39;xyzs&#39;</span>)
<a name="l02155"></a>02155         <span class="comment"># In mdcrd files, there is only one comment line</span>
<a name="l02156"></a>02156         out = [<span class="stringliteral">&#39;mdcrd file generated using ForceBalance&#39;</span>] 
<a name="l02157"></a>02157         <span class="keywordflow">for</span> I <span class="keywordflow">in</span> select:
<a name="l02158"></a>02158             xyz = self.xyzs[I]
<a name="l02159"></a>02159             out += [<span class="stringliteral">&#39;&#39;</span>.join([<span class="stringliteral">&quot;%8.3f&quot;</span> % i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> g]) <span class="keywordflow">for</span> g <span class="keywordflow">in</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#a7fe52c2928c7b0329882541bef2e34cd" title="Groups a big long iterable into groups of ten or what have you.">grouper</a>(10, list(xyz.flatten()))]
<a name="l02160"></a>02160             <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l02161"></a>02161                 out.append(<span class="stringliteral">&#39;&#39;</span>.join([<span class="stringliteral">&quot;%8.3f&quot;</span> % i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> [self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac84c67d37f00c0f65e6fb6126e19f9bb">boxes</a>[I].a, self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac84c67d37f00c0f65e6fb6126e19f9bb">boxes</a>[I].b, self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac84c67d37f00c0f65e6fb6126e19f9bb">boxes</a>[I].c]]))
<a name="l02162"></a>02162         <span class="keywordflow">return</span> out
<a name="l02163"></a>02163 
<a name="l02164"></a>02164     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a95782abfb36e7080a1b98bfad2ced4f3">write_arc</a>(self, select):
<a name="l02165"></a>02165         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a80851250d8e749bea882d5aa4bcfcdd1">require</a>(<span class="stringliteral">&#39;elem&#39;</span>,<span class="stringliteral">&#39;xyzs&#39;</span>)
<a name="l02166"></a>02166         out = []
<a name="l02167"></a>02167         <span class="keywordflow">if</span> <span class="stringliteral">&#39;tinkersuf&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l02168"></a>02168             sys.stderr.write(<span class="stringliteral">&quot;Beware, this .arc file contains no atom type or topology info\n&quot;</span>)
<a name="l02169"></a>02169         <span class="keywordflow">for</span> I <span class="keywordflow">in</span> select:
<a name="l02170"></a>02170             xyz = self.xyzs[I]
<a name="l02171"></a>02171             out.append(<span class="stringliteral">&quot;%6i  %s&quot;</span> % (self.na, self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a5e092c726455a18c9300f5c5362121d8" title="Read in stuff if we passed in a file name, otherwise return an empty instance.">comms</a>[I]))
<a name="l02172"></a>02172             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):
<a name="l02173"></a>02173                 out.append(<span class="stringliteral">&quot;%6i  %s%s&quot;</span> % (i+1,<a class="code" href="namespaceforcebalance_1_1molecule.html#a2eba3cad44138b3b10ea883240888412" title="Print a line consisting of (element, x, y, z) in accordance with .xyz file format.">format_xyz_coord</a>(self.elem[i],xyz[i],tinker=<span class="keyword">True</span>),self.tinkersuf[i] <span class="keywordflow">if</span> <span class="stringliteral">&#39;tinkersuf&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a> <span class="keywordflow">else</span> <span class="stringliteral">&#39;&#39;</span>))
<a name="l02174"></a>02174         <span class="keywordflow">return</span> out
<a name="l02175"></a>02175 
<a name="l02176"></a>02176     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a503eae2cee228e4cc5fc736504714925">write_gro</a>(self, select):
<a name="l02177"></a>02177         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a80851250d8e749bea882d5aa4bcfcdd1">require</a>(<span class="stringliteral">&#39;elem&#39;</span>,<span class="stringliteral">&#39;xyzs&#39;</span>)
<a name="l02178"></a>02178         out = []
<a name="l02179"></a>02179         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ad47d05a3ea76e013a628bd7b25ae3050">require_resname</a>()
<a name="l02180"></a>02180         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a90fe456919fda305703e36af389e60e1">require_resid</a>()
<a name="l02181"></a>02181         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a03af3cfb99ea8f1c8c7e93d04bdcf967">require_boxes</a>()
<a name="l02182"></a>02182 
<a name="l02183"></a>02183         <span class="keywordflow">if</span> <span class="stringliteral">&#39;atomname&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l02184"></a>02184             atomname = [<span class="stringliteral">&quot;%s%i&quot;</span> % (self.elem[i], i+1) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]
<a name="l02185"></a>02185         <span class="keywordflow">else</span>:
<a name="l02186"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#adc6620e8287edabe161442de12295f75">02186</a>             atomname = self.atomname
<a name="l02187"></a>02187 
<a name="l02188"></a>02188         <span class="keywordflow">for</span> I <span class="keywordflow">in</span> select:
<a name="l02189"></a>02189             xyz = self.xyzs[I]
<a name="l02190"></a>02190             xyzwrite = xyz.copy()
<a name="l02191"></a>02191             xyzwrite /= 10.0 <span class="comment"># GROMACS uses nanometers</span>
<a name="l02192"></a>02192             out.append(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a5e092c726455a18c9300f5c5362121d8" title="Read in stuff if we passed in a file name, otherwise return an empty instance.">comms</a>[I])
<a name="l02193"></a>02193             <span class="comment">#out.append(&quot;Generated by ForceBalance from %s&quot; % self.fnm)</span>
<a name="l02194"></a>02194             out.append(<span class="stringliteral">&quot;%5i&quot;</span> % self.na)
<a name="l02195"></a>02195             <span class="keywordflow">for</span> an, line <span class="keywordflow">in</span> enumerate(xyzwrite):
<a name="l02196"></a>02196                 out.append(<a class="code" href="namespaceforcebalance_1_1molecule.html#a41c13064e4285973aa6c49369d3d3390" title="Print a line in accordance with .gro file format, with six decimal points of precision.">format_gro_coord</a>(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#afcd4c8e1671af626d0267a243e69530d">resid</a>[an],self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a4aebc6ada9bda74a6740568d4f3658eb">resname</a>[an],atomname[an],an+1,xyzwrite[an]))
<a name="l02197"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#aba14226f272f91c91ecf7060ff136a2b">02197</a>             out.append(<a class="code" href="namespaceforcebalance_1_1molecule.html#ae25aa5331b3a2dd0e9d1e184380357db" title="Print a line corresponding to the box vector in accordance with .gro file format.">format_gro_box</a>(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac84c67d37f00c0f65e6fb6126e19f9bb">boxes</a>[I]))
<a name="l02198"></a>02198         <span class="keywordflow">return</span> out
<a name="l02199"></a>02199 
<a name="l02200"></a>02200     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a0dee435704418bf51199d6bab6d92249">write_dcd</a>(self, select):
<a name="l02201"></a>02201         <span class="keywordflow">if</span> _dcdlib.vmdplugin_init() != 0:
<a name="l02202"></a>02202             <span class="keywordflow">raise</span> IOError(<span class="stringliteral">&quot;Unable to init DCD plugin&quot;</span>)
<a name="l02203"></a>02203         natoms    = c_int(self.na)
<a name="l02204"></a>02204         dcd       = _dcdlib.open_dcd_write(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a7887451529cc2b396240b6e4ebfcc2de" title="Fill in comments.">fout</a>, <span class="stringliteral">&quot;dcd&quot;</span>, natoms)
<a name="l02205"></a>02205         ts        = <a class="code" href="classforcebalance_1_1molecule_1_1MolfileTimestep.html" title="Wrapper for the timestep C structure used in molfile plugins.">MolfileTimestep</a>()
<a name="l02206"></a>02206         _xyz      = c_float * (natoms.value * 3)
<a name="l02207"></a>02207         <span class="keywordflow">for</span> I <span class="keywordflow">in</span> select:
<a name="l02208"></a>02208             xyz = self.xyzs[I]
<a name="l02209"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#aab5ea35ab9d68559fd6ea7b747c2bddb">02209</a>             ts.coords = _xyz(*list(xyz.flatten()))
<a name="l02210"></a>02210             ts.A      = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac84c67d37f00c0f65e6fb6126e19f9bb">boxes</a>[I].a <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a> <span class="keywordflow">else</span> 1.0
<a name="l02211"></a>02211             ts.B      = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac84c67d37f00c0f65e6fb6126e19f9bb">boxes</a>[I].b <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a> <span class="keywordflow">else</span> 1.0
<a name="l02212"></a>02212             ts.C      = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac84c67d37f00c0f65e6fb6126e19f9bb">boxes</a>[I].c <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a> <span class="keywordflow">else</span> 1.0
<a name="l02213"></a>02213             result    = _dcdlib.write_timestep(dcd, byref(ts))
<a name="l02214"></a>02214             <span class="keywordflow">if</span> result != 0:
<a name="l02215"></a>02215                 <span class="keywordflow">raise</span> IOError(<span class="stringliteral">&quot;Error encountered when writing DCD&quot;</span>)
<a name="l02216"></a>02216         <span class="comment">## Close the DCD file</span>
<a name="l02217"></a>02217         _dcdlib.close_file_write(dcd)
<a name="l02218"></a>02218         dcd = <span class="keywordtype">None</span>
<a name="l02219"></a>02219 
<a name="l02220"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a95782abfb36e7080a1b98bfad2ced4f3">02220</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a47082443566cd50add3f2ec20af9cc10" title="Save to a PDB.">write_pdb</a>(self, select):
<a name="l02221"></a>02221         <span class="stringliteral">&quot;&quot;&quot;Save to a PDB. Copied wholesale from MSMBuilder.</span>
<a name="l02222"></a>02222 <span class="stringliteral">        COLUMNS  TYPE   FIELD  DEFINITION</span>
<a name="l02223"></a>02223 <span class="stringliteral">        ---------------------------------------------</span>
<a name="l02224"></a>02224 <span class="stringliteral">        7-11      int   serial        Atom serial number.</span>
<a name="l02225"></a>02225 <span class="stringliteral">        13-16     string name          Atom name.</span>
<a name="l02226"></a>02226 <span class="stringliteral">        17        string altLoc        Alternate location indicator.</span>
<a name="l02227"></a>02227 <span class="stringliteral">        18-20 (17-21 KAB)    string resName       Residue name.</span>
<a name="l02228"></a>02228 <span class="stringliteral">        22        string chainID       Chain identifier.</span>
<a name="l02229"></a>02229 <span class="stringliteral">        23-26     int    resSeq        Residue sequence number.</span>
<a name="l02230"></a>02230 <span class="stringliteral">        27        string iCode         Code for insertion of residues.</span>
<a name="l02231"></a>02231 <span class="stringliteral">        31-38     float  x             Orthogonal coordinates for X in</span>
<a name="l02232"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a503eae2cee228e4cc5fc736504714925">02232</a> <span class="stringliteral">        Angstroms.</span>
<a name="l02233"></a>02233 <span class="stringliteral">        39-46     float  y             Orthogonal coordinates for Y in</span>
<a name="l02234"></a>02234 <span class="stringliteral">        Angstroms.</span>
<a name="l02235"></a>02235 <span class="stringliteral">        47-54     float  z             Orthogonal coordinates for Z in</span>
<a name="l02236"></a>02236 <span class="stringliteral">        Angstroms.</span>
<a name="l02237"></a>02237 <span class="stringliteral">        55-60     float  occupancy     Occupancy.</span>
<a name="l02238"></a>02238 <span class="stringliteral">        61-66     float  tempFactor    Temperature factor.</span>
<a name="l02239"></a>02239 <span class="stringliteral">        73-76     string segID         Segment identifier, left-justified.</span>
<a name="l02240"></a>02240 <span class="stringliteral">        77-78     string element       Element symbol, right-justified.</span>
<a name="l02241"></a>02241 <span class="stringliteral">        79-80     string charge        Charge on the atom.</span>
<a name="l02242"></a>02242 <span class="stringliteral"></span>
<a name="l02243"></a>02243 <span class="stringliteral">        CRYST1 line, added by Lee-Ping</span>
<a name="l02244"></a>02244 <span class="stringliteral">        COLUMNS  TYPE   FIELD  DEFINITION</span>
<a name="l02245"></a>02245 <span class="stringliteral">        ---------------------------------------</span>
<a name="l02246"></a>02246 <span class="stringliteral">         7-15    float  a      a (Angstroms).</span>
<a name="l02247"></a>02247 <span class="stringliteral">        16-24    float  b      b (Angstroms).</span>
<a name="l02248"></a>02248 <span class="stringliteral">        25-33    float  c      c (Angstroms).</span>
<a name="l02249"></a>02249 <span class="stringliteral">        34-40    float  alpha  alpha (degrees).</span>
<a name="l02250"></a>02250 <span class="stringliteral">        41-47    float  beta   beta (degrees).</span>
<a name="l02251"></a>02251 <span class="stringliteral">        48-54    float  gamma  gamma (degrees).</span>
<a name="l02252"></a>02252 <span class="stringliteral">        56-66    string sGroup Space group.</span>
<a name="l02253"></a>02253 <span class="stringliteral">        67-70    int    z      Z value.</span>
<a name="l02254"></a>02254 <span class="stringliteral"></span>
<a name="l02255"></a>02255 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l02256"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a0dee435704418bf51199d6bab6d92249">02256</a>         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a80851250d8e749bea882d5aa4bcfcdd1">require</a>(<span class="stringliteral">&#39;xyzs&#39;</span>)
<a name="l02257"></a>02257         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ad47d05a3ea76e013a628bd7b25ae3050">require_resname</a>()
<a name="l02258"></a>02258         self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a90fe456919fda305703e36af389e60e1">require_resid</a>()
<a name="l02259"></a>02259         ATOMS = self.atomname <span class="keywordflow">if</span> <span class="stringliteral">&#39;atomname&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a> <span class="keywordflow">else</span> [<span class="stringliteral">&quot;%s%i&quot;</span> % (self.elem[i], i+1) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]
<a name="l02260"></a>02260         CHAIN = self.chain <span class="keywordflow">if</span> <span class="stringliteral">&#39;chain&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a> <span class="keywordflow">else</span> [1 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]
<a name="l02261"></a>02261         RESNAMES = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a4aebc6ada9bda74a6740568d4f3658eb">resname</a>
<a name="l02262"></a>02262         RESNUMS = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#afcd4c8e1671af626d0267a243e69530d">resid</a>
<a name="l02263"></a>02263 
<a name="l02264"></a>02264         out = []
<a name="l02265"></a>02265         <span class="keywordflow">if</span> min(RESNUMS) == 0:
<a name="l02266"></a>02266             RESNUMS = [i+1 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> RESNUMS]
<a name="l02267"></a>02267 
<a name="l02268"></a>02268         <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l02269"></a>02269             a = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac84c67d37f00c0f65e6fb6126e19f9bb">boxes</a>[0].a
<a name="l02270"></a>02270             b = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac84c67d37f00c0f65e6fb6126e19f9bb">boxes</a>[0].b
<a name="l02271"></a>02271             c = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac84c67d37f00c0f65e6fb6126e19f9bb">boxes</a>[0].c
<a name="l02272"></a>02272             alpha = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac84c67d37f00c0f65e6fb6126e19f9bb">boxes</a>[0].alpha
<a name="l02273"></a>02273             beta = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac84c67d37f00c0f65e6fb6126e19f9bb">boxes</a>[0].beta
<a name="l02274"></a>02274             gamma = self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac84c67d37f00c0f65e6fb6126e19f9bb">boxes</a>[0].gamma
<a name="l02275"></a>02275             line=np.chararray(80)
<a name="l02276"></a>02276             line[:] = <span class="stringliteral">&#39; &#39;</span>
<a name="l02277"></a>02277             line[0:6]=np.array(list(<span class="stringliteral">&quot;CRYST1&quot;</span>))
<a name="l02278"></a>02278             line=np.array(line,<span class="stringliteral">&#39;str&#39;</span>)
<a name="l02279"></a>02279             line[6:15] =np.array(list((<span class="stringliteral">&quot;%9.3f&quot;</span>%(a))))
<a name="l02280"></a>02280             line[15:24]=np.array(list((<span class="stringliteral">&quot;%9.3f&quot;</span>%(b))))
<a name="l02281"></a>02281             line[24:33]=np.array(list((<span class="stringliteral">&quot;%9.3f&quot;</span>%(c))))
<a name="l02282"></a>02282             line[33:40]=np.array(list((<span class="stringliteral">&quot;%7.2f&quot;</span>%(alpha))))
<a name="l02283"></a>02283             line[40:47]=np.array(list((<span class="stringliteral">&quot;%7.2f&quot;</span>%(beta))))
<a name="l02284"></a>02284             line[47:54]=np.array(list((<span class="stringliteral">&quot;%7.2f&quot;</span>%(gamma))))
<a name="l02285"></a>02285             <span class="comment"># LPW: Put in a dummy space group, we never use it.</span>
<a name="l02286"></a>02286             line[55:66]=np.array(list(str(<span class="stringliteral">&quot;P 21 21 21&quot;</span>).rjust(11)))
<a name="l02287"></a>02287             line[66:70]=np.array(list(str(4).rjust(4)))
<a name="l02288"></a>02288             out.append(line.tostring())
<a name="l02289"></a>02289             
<a name="l02290"></a>02290         <span class="keywordflow">for</span> I <span class="keywordflow">in</span> select:
<a name="l02291"></a>02291             XYZ = self.xyzs[I]
<a name="l02292"></a>02292             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na):
<a name="l02293"></a>02293                 ATOMNUM = i + 1
<a name="l02294"></a>02294                 line=np.chararray(80)
<a name="l02295"></a>02295                 line[:]=<span class="stringliteral">&#39; &#39;</span>
<a name="l02296"></a>02296                 line[0:4]=np.array(list(<span class="stringliteral">&quot;ATOM&quot;</span>))
<a name="l02297"></a>02297                 line=np.array(line,<span class="stringliteral">&#39;str&#39;</span>)
<a name="l02298"></a>02298                 line[6:11]=np.array(list(str(ATOMNUM%100000).rjust(5)))
<a name="l02299"></a>02299                 <span class="comment"># if ATOMNUM &lt; 100000:</span>
<a name="l02300"></a>02300                 <span class="comment">#     line[6:11]=np.array(list(str(ATOMNUM%100000).rjust(5)))</span>
<a name="l02301"></a>02301                 <span class="comment"># else:</span>
<a name="l02302"></a>02302                 <span class="comment">#     line[6:11]=np.array(list(hex(ATOMNUM)[2:].rjust(5)))</span>
<a name="l02303"></a>02303                 <span class="comment">#Molprobity is picky about atom name centering</span>
<a name="l02304"></a>02304                 <span class="keywordflow">if</span> len(str(ATOMS[i]))==3:
<a name="l02305"></a>02305                     line[12:16]=np.array(list(str(ATOMS[i]).rjust(4)))
<a name="l02306"></a>02306                 <span class="keywordflow">elif</span> len(str(ATOMS[i]))==2:
<a name="l02307"></a>02307                     line[12:16]=np.array(list(<span class="stringliteral">&quot; &quot;</span>+str(ATOMS[i])+<span class="stringliteral">&quot; &quot;</span>))
<a name="l02308"></a>02308                 <span class="keywordflow">elif</span> len(str(ATOMS[i]))==1:
<a name="l02309"></a>02309                     line[12:16]=np.array(list(<span class="stringliteral">&quot; &quot;</span>+str(ATOMS[i])+<span class="stringliteral">&quot;  &quot;</span>))
<a name="l02310"></a>02310                 <span class="keywordflow">else</span>:
<a name="l02311"></a>02311                     line[12:16]=np.array(list(str(ATOMS[i]).center(4)))
<a name="l02312"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a47082443566cd50add3f2ec20af9cc10">02312</a>                 <span class="keywordflow">if</span> len(str(RESNAMES[i]))==3:
<a name="l02313"></a>02313                     line[17:20]=np.array(list(str(RESNAMES[i])))
<a name="l02314"></a>02314                 <span class="keywordflow">else</span>:
<a name="l02315"></a>02315                     line[17:21]=np.array(list(str(RESNAMES[i]).ljust(4)))
<a name="l02316"></a>02316 
<a name="l02317"></a>02317                 line[21]=str(CHAIN[i]).rjust(1)
<a name="l02318"></a>02318                 line[22:26]=np.array(list(str(RESNUMS[i]%10000).rjust(4)))
<a name="l02319"></a>02319                 <span class="comment"># if RESNUMS[i] &lt; 100000:</span>
<a name="l02320"></a>02320                 <span class="comment">#     line[22:26]=np.array(list(str(RESNUMS[i]).rjust(4)))</span>
<a name="l02321"></a>02321                 <span class="comment"># else:</span>
<a name="l02322"></a>02322                 <span class="comment">#     line[22:26]=np.array(list(hex(RESNUMS[i])[2:].rjust(4)))</span>
<a name="l02323"></a>02323 
<a name="l02324"></a>02324                 x=XYZ[i][0]
<a name="l02325"></a>02325                 y=XYZ[i][1]
<a name="l02326"></a>02326                 z=XYZ[i][2]
<a name="l02327"></a>02327                 sx=np.sign(x)
<a name="l02328"></a>02328                 sy=np.sign(y)
<a name="l02329"></a>02329                 sz=np.sign(z)
<a name="l02330"></a>02330 
<a name="l02331"></a>02331                 line[30:38]=np.array(list((<span class="stringliteral">&quot;%8.3f&quot;</span>%(x))))
<a name="l02332"></a>02332                 line[38:46]=np.array(list((<span class="stringliteral">&quot;%8.3f&quot;</span>%(y))))
<a name="l02333"></a>02333                 line[46:54]=np.array(list((<span class="stringliteral">&quot;%8.3f&quot;</span>%(z))))
<a name="l02334"></a>02334 
<a name="l02335"></a>02335                 <span class="keywordflow">if</span> ATOMNUM!=-1:
<a name="l02336"></a>02336                     out.append(line.tostring())
<a name="l02337"></a>02337             out.append(<span class="stringliteral">&#39;ENDMDL&#39;</span>)
<a name="l02338"></a>02338         <span class="keywordflow">if</span> <span class="stringliteral">&#39;bonds&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l02339"></a>02339             connects = [<span class="stringliteral">&quot;CONECT%5i&quot;</span> % (b0+1) + <span class="stringliteral">&quot;&quot;</span>.join([<span class="stringliteral">&quot;%5i&quot;</span> % (b[1]+1) <span class="keywordflow">for</span> b <span class="keywordflow">in</span> self.bonds <span class="keywordflow">if</span> b[0] == b0]) <span class="keywordflow">for</span> b0 <span class="keywordflow">in</span> sorted(list(set(b[0] <span class="keywordflow">for</span> b <span class="keywordflow">in</span> self.bonds)))]
<a name="l02340"></a>02340             out += connects
<a name="l02341"></a>02341         <span class="keywordflow">return</span> out
<a name="l02342"></a>02342         
<a name="l02343"></a>02343     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a1ef6aefd3218f8ab3f9dc2b37e602fbf" title="Text quantum data format.">write_qdata</a>(self, select):
<a name="l02344"></a>02344         <span class="stringliteral">&quot;&quot;&quot; Text quantum data format. &quot;&quot;&quot;</span>
<a name="l02345"></a>02345         <span class="comment">#self.require(&#39;xyzs&#39;,&#39;qm_energies&#39;,&#39;qm_forces&#39;)</span>
<a name="l02346"></a>02346         out = []
<a name="l02347"></a>02347         <span class="keywordflow">for</span> I <span class="keywordflow">in</span> select:
<a name="l02348"></a>02348             xyz = self.xyzs[I]
<a name="l02349"></a>02349             out.append(<span class="stringliteral">&quot;JOB %i&quot;</span> % I)
<a name="l02350"></a>02350             out.append(<span class="stringliteral">&quot;COORDS&quot;</span>+<a class="code" href="namespaceforcebalance_1_1molecule.html#a58c3f09152db4d1c6e1db9df29c60c43">pvec</a>(xyz))
<a name="l02351"></a>02351             <span class="keywordflow">if</span> <span class="stringliteral">&#39;qm_energies&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l02352"></a>02352                 out.append(<span class="stringliteral">&quot;ENERGY % .12e&quot;</span> % self.qm_energies[I])
<a name="l02353"></a>02353             <span class="keywordflow">if</span> <span class="stringliteral">&#39;mm_energies&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l02354"></a>02354                 out.append(<span class="stringliteral">&quot;EMD0   % .12e&quot;</span> % self.mm_energies[I])
<a name="l02355"></a>02355             <span class="keywordflow">if</span> <span class="stringliteral">&#39;qm_forces&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l02356"></a>02356                 out.append(<span class="stringliteral">&quot;FORCES&quot;</span>+<a class="code" href="namespaceforcebalance_1_1molecule.html#a58c3f09152db4d1c6e1db9df29c60c43">pvec</a>(self.qm_forces[I]))
<a name="l02357"></a>02357             <span class="keywordflow">if</span> <span class="stringliteral">&#39;qm_espxyzs&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a> <span class="keywordflow">and</span> <span class="stringliteral">&#39;qm_espvals&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l02358"></a>02358                 out.append(<span class="stringliteral">&quot;ESPXYZ&quot;</span>+<a class="code" href="namespaceforcebalance_1_1molecule.html#a58c3f09152db4d1c6e1db9df29c60c43">pvec</a>(self.qm_espxyzs[I]))
<a name="l02359"></a>02359                 out.append(<span class="stringliteral">&quot;ESPVAL&quot;</span>+<a class="code" href="namespaceforcebalance_1_1molecule.html#a58c3f09152db4d1c6e1db9df29c60c43">pvec</a>(self.qm_espvals[I]))
<a name="l02360"></a>02360             <span class="keywordflow">if</span> <span class="stringliteral">&#39;qm_interaction&#39;</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>: 
<a name="l02361"></a>02361                 out.append(<span class="stringliteral">&quot;INTERACTION % .12e&quot;</span> % self.qm_interaction[I])
<a name="l02362"></a>02362             out.append(<span class="stringliteral">&#39;&#39;</span>)
<a name="l02363"></a>02363         <span class="keywordflow">return</span> out
<a name="l02364"></a>02364 
<a name="l02365"></a>02365     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a90fe456919fda305703e36af389e60e1">require_resid</a>(self):
<a name="l02366"></a>02366         <span class="keywordflow">if</span> <span class="stringliteral">&#39;resid&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l02367"></a>02367             na_res = int(raw_input(<span class="stringliteral">&quot;Enter how many atoms are in a residue, or zero as a single residue -&gt; &quot;</span>))
<a name="l02368"></a>02368             <span class="keywordflow">if</span> na_res == 0:
<a name="l02369"></a>02369                 self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#afcd4c8e1671af626d0267a243e69530d">resid</a> = [1 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]
<a name="l02370"></a>02370             <span class="keywordflow">else</span>:
<a name="l02371"></a>02371                 self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#afcd4c8e1671af626d0267a243e69530d">resid</a> = [1 + i/na_res <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]
<a name="l02372"></a>02372             
<a name="l02373"></a>02373     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ad47d05a3ea76e013a628bd7b25ae3050">require_resname</a>(self):
<a name="l02374"></a>02374         <span class="keywordflow">if</span> <span class="stringliteral">&#39;resname&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a>:
<a name="l02375"></a>02375             resname = raw_input(<span class="stringliteral">&quot;Enter a residue name (3-letter like &#39;SOL&#39;) -&gt; &quot;</span>)
<a name="l02376"></a>02376             self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a4aebc6ada9bda74a6740568d4f3658eb">resname</a> = [resname <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.na)]
<a name="l02377"></a>02377             
<a name="l02378"></a>02378     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a03af3cfb99ea8f1c8c7e93d04bdcf967">require_boxes</a>(self):
<a name="l02379"></a>02379         <span class="keyword">def </span>buildbox(line):
<a name="l02380"></a>02380             s = [float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> line.split()]
<a name="l02381"></a>02381             <span class="keywordflow">if</span> len(s) == 1:
<a name="l02382"></a>02382                 a = s[0]
<a name="l02383"></a>02383                 b = s[0]
<a name="l02384"></a>02384                 c = s[0]
<a name="l02385"></a>02385                 alpha = 90.0
<a name="l02386"></a>02386                 beta = 90.0
<a name="l02387"></a>02387                 gamma = 90.0
<a name="l02388"></a>02388                 <span class="keywordflow">return</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#a0a6e3e79b04534bf2e83d09def189444" title="This function takes in three lattice lengths and three lattice angles, and tries to return a complete...">BuildLatticeFromLengthsAngles</a>(a, b, c, alpha, beta, gamma)
<a name="l02389"></a>02389             <span class="keywordflow">elif</span> len(s) == 3:
<a name="l02390"></a>02390                 a = s[0]
<a name="l02391"></a>02391                 b = s[1]
<a name="l02392"></a>02392                 c = s[2]
<a name="l02393"></a>02393                 alpha = 90.0
<a name="l02394"></a>02394                 beta = 90.0
<a name="l02395"></a>02395                 gamma = 90.0
<a name="l02396"></a>02396                 <span class="keywordflow">return</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#a0a6e3e79b04534bf2e83d09def189444" title="This function takes in three lattice lengths and three lattice angles, and tries to return a complete...">BuildLatticeFromLengthsAngles</a>(a, b, c, alpha, beta, gamma)
<a name="l02397"></a>02397             <span class="keywordflow">elif</span> len(s) == 6:
<a name="l02398"></a>02398                 a = s[0]
<a name="l02399"></a>02399                 b = s[1]
<a name="l02400"></a>02400                 c = s[2]
<a name="l02401"></a>02401                 alpha = s[3]
<a name="l02402"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a1ef6aefd3218f8ab3f9dc2b37e602fbf">02402</a>                 beta = s[4]
<a name="l02403"></a>02403                 gamma = s[5]
<a name="l02404"></a>02404                 <span class="keywordflow">return</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#a0a6e3e79b04534bf2e83d09def189444" title="This function takes in three lattice lengths and three lattice angles, and tries to return a complete...">BuildLatticeFromLengthsAngles</a>(a, b, c, alpha, beta, gamma)
<a name="l02405"></a>02405             <span class="keywordflow">elif</span> len(s) == 9:
<a name="l02406"></a>02406                 v1 = np.array([s[0], s[3], s[4]])
<a name="l02407"></a>02407                 v2 = np.array([s[5], s[1], s[6]])
<a name="l02408"></a>02408                 v3 = np.array([s[7], s[8], s[2]])
<a name="l02409"></a>02409                 <span class="keywordflow">return</span> <a class="code" href="namespaceforcebalance_1_1molecule.html#a29fb1ac9324f4280f07c65baea339989" title="This function takes in three lattice vectors and tries to return a complete box specification.">BuildLatticeFromVectors</a>(v1, v2, v3)
<a name="l02410"></a>02410             <span class="keywordflow">else</span>:
<a name="l02411"></a>02411                 <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&quot;Not sure what to do since you gave me %i numbers&quot;</span> % len(s))
<a name="l02412"></a>02412             
<a name="l02413"></a>02413         <span class="keywordflow">if</span> <span class="stringliteral">&#39;boxes&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a8698f94608be34eeba6eaa4c52dc5249">Data</a> <span class="keywordflow">or</span> len(self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac84c67d37f00c0f65e6fb6126e19f9bb">boxes</a>) != self.ns:
<a name="l02414"></a>02414             sys.stderr.write(<span class="stringliteral">&quot;Please specify the periodic box using:\n&quot;</span>)
<a name="l02415"></a>02415             sys.stderr.write(<span class="stringliteral">&quot;1 float (cubic lattice length in Angstrom)\n&quot;</span>)
<a name="l02416"></a>02416             sys.stderr.write(<span class="stringliteral">&quot;3 floats (orthogonal lattice lengths in Angstrom)\n&quot;</span>)
<a name="l02417"></a>02417             sys.stderr.write(<span class="stringliteral">&quot;6 floats (triclinic lattice lengths and angles in degrees)\n&quot;</span>)
<a name="l02418"></a>02418             sys.stderr.write(<span class="stringliteral">&quot;9 floats (triclinic lattice vectors v1(x) v2(y) v3(z) v1(y) v1(z) v2(x) v2(z) v3(x) v3(y) in Angstrom)\n&quot;</span>)
<a name="l02419"></a>02419             sys.stderr.write(<span class="stringliteral">&quot;Or: Name of a file containing one of these lines for each frame in the trajectory\n&quot;</span>)
<a name="l02420"></a>02420             boxstr = raw_input(<span class="stringliteral">&quot;Box Vector Input: -&gt; &quot;</span>)
<a name="l02421"></a>02421             <span class="keywordflow">if</span> os.path.exists(boxstr):
<a name="l02422"></a>02422                 boxfile = open(boxstr).readlines()
<a name="l02423"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#afcd4c8e1671af626d0267a243e69530d">02423</a>                 <span class="keywordflow">if</span> len(boxfile) != len(self):
<a name="l02424"></a>02424                     <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Tried to read in the box file, but it has a different length from the number of frames.&#39;</span>)
<a name="l02425"></a>02425                 <span class="keywordflow">else</span>:
<a name="l02426"></a>02426                     self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac84c67d37f00c0f65e6fb6126e19f9bb">boxes</a> = [buildbox(line) <span class="keywordflow">for</span> line <span class="keywordflow">in</span> boxfile]
<a name="l02427"></a>02427             <span class="keywordflow">else</span>:
<a name="l02428"></a>02428                 mybox = buildbox(boxstr)
<a name="l02429"></a>02429                 self.<a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#ac84c67d37f00c0f65e6fb6126e19f9bb">boxes</a> = [mybox <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.ns)]
<a name="l02430"></a>02430 
<a name="l02431"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a4aebc6ada9bda74a6740568d4f3658eb">02431</a> <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1molecule.html#ab9cb167fbbd809aedcf8c7434d405547">main</a>():
<a name="l02432"></a>02432     <span class="keywordflow">print</span> <span class="stringliteral">&quot;Basic usage as an executable: molecule.py input.format1 output.format2&quot;</span>
<a name="l02433"></a>02433     <span class="keywordflow">print</span> <span class="stringliteral">&quot;where format stands for xyz, pdb, gro, etc.&quot;</span>
<a name="l02434"></a>02434     Mao = <a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html" title="Lee-Ping&#39;s general file format conversion class.">Molecule</a>(sys.argv[1])
<a name="l02435"></a>02435     Mao.write(sys.argv[2])
<a name="l02436"></a><a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html#a03af3cfb99ea8f1c8c7e93d04bdcf967">02436</a> 
<a name="l02437"></a>02437 <span class="keywordflow">if</span> __name__ == <span class="stringliteral">&quot;__main__&quot;</span>:
<a name="l02438"></a>02438     <a class="code" href="namespaceforcebalance_1_1molecule.html#ab9cb167fbbd809aedcf8c7434d405547">main</a>()
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Sun Aug 4 2013 17:48:44 for ForceBalance API by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
