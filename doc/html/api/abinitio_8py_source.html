<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ForceBalance API: abinitio.py Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="ForceBalanceLogo_sm.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ForceBalance API
   &#160;<span id="projectnumber">1.1</span>
   </div>
   <div id="projectbrief">Automated optimization of force fields and empirical potentials</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../index.html"><span>Main Page</span></a></li>
      <li ><a href="roadmap.html"><span>Project Roadmap</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">abinitio.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="abinitio_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespaceforcebalance_1_1abinitio.html">00001</a> <span class="stringliteral">&quot;&quot;&quot; @package forcebalance.abinitio Ab-initio fitting module (energies, forces, resp).</span>
<a name="l00002"></a>00002 <span class="stringliteral"></span>
<a name="l00003"></a>00003 <span class="stringliteral">@author Lee-Ping Wang</span>
<a name="l00004"></a>00004 <span class="stringliteral">@date 05/2012</span>
<a name="l00005"></a>00005 <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="keyword">import</span> os
<a name="l00008"></a>00008 <span class="keyword">import</span> shutil
<a name="l00009"></a>00009 <span class="keyword">from</span> forcebalance.nifty <span class="keyword">import</span> col, eqcgmx, flat, floatornan, fqcgmx, invert_svd, kb, printcool, bohrang, warn_press_key
<a name="l00010"></a>00010 <span class="keyword">from</span> numpy <span class="keyword">import</span> append, array, cross, diag, dot, exp, log, mat, mean, ones, outer, sqrt, where, zeros, linalg, savetxt, hstack, sum, abs, vstack, max, arange
<a name="l00011"></a>00011 <span class="keyword">from</span> forcebalance.target <span class="keyword">import</span> Target
<a name="l00012"></a>00012 <span class="keyword">from</span> forcebalance.molecule <span class="keyword">import</span> Molecule, format_xyz_coord
<a name="l00013"></a>00013 <span class="keyword">from</span> re <span class="keyword">import</span> match, sub
<a name="l00014"></a>00014 <span class="keyword">import</span> subprocess
<a name="l00015"></a>00015 <span class="keyword">from</span> subprocess <span class="keyword">import</span> PIPE
<a name="l00016"></a>00016 <span class="keyword">from</span> forcebalance.finite_difference <span class="keyword">import</span> fdwrap, f1d2p, f12d3p, in_fd
<a name="l00017"></a>00017 <span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict, OrderedDict
<a name="l00018"></a>00018 <span class="keyword">import</span> itertools
<a name="l00019"></a>00019 <span class="comment">#from IPython import embed</span>
<a name="l00020"></a>00020 <span class="comment">#from _increment import AbInitio_Build</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="keyword">from</span> forcebalance.output <span class="keyword">import</span> getLogger
<a name="l00023"></a>00023 logger = getLogger(__name__)
<a name="l00024"></a><a class="code" href="namespaceforcebalance_1_1abinitio.html#ae2b6e10e893811325c7103493ac30921">00024</a> 
<a name="l00025"></a>00025 <span class="keyword">class </span><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html" title="Subclass of Target for fitting force fields to ab initio data.">AbInitio</a>(<a class="code" href="classforcebalance_1_1target_1_1Target.html" title="Base class for all fitting targets.">Target</a>):
<a name="l00026"></a>00026 
<a name="l00027"></a>00027     <span class="stringliteral">&quot;&quot;&quot; Subclass of Target for fitting force fields to ab initio data.</span>
<a name="l00028"></a>00028 <span class="stringliteral"></span>
<a name="l00029"></a>00029 <span class="stringliteral">    Currently Gromacs-X2, Gromacs, Tinker, OpenMM and AMBER are supported.</span>
<a name="l00030"></a>00030 <span class="stringliteral"></span>
<a name="l00031"></a>00031 <span class="stringliteral">    We introduce the following concepts:</span>
<a name="l00032"></a>00032 <span class="stringliteral">    - The number of snapshots</span>
<a name="l00033"></a>00033 <span class="stringliteral">    - The reference energies and forces (eqm, fqm) and the file they belong in (qdata.txt)</span>
<a name="l00034"></a>00034 <span class="stringliteral">    - The sampling simulation energies (emd0)</span>
<a name="l00035"></a>00035 <span class="stringliteral">    - The WHAM Boltzmann weights (these are computed externally and passed in)</span>
<a name="l00036"></a>00036 <span class="stringliteral">    - The QM Boltzmann weights (computed internally using the difference between eqm and emd0)</span>
<a name="l00037"></a>00037 <span class="stringliteral"></span>
<a name="l00038"></a>00038 <span class="stringliteral">    There are also these little details:</span>
<a name="l00039"></a>00039 <span class="stringliteral">    - Switches for whether to turn on certain Boltzmann weights (they stack)</span>
<a name="l00040"></a>00040 <span class="stringliteral">    - Temperature for the QM Boltzmann weights</span>
<a name="l00041"></a>00041 <span class="stringliteral">    - Whether to fit a subset of atoms</span>
<a name="l00042"></a>00042 <span class="stringliteral"></span>
<a name="l00043"></a>00043 <span class="stringliteral">    This subclass contains the &#39;get&#39; method for building the objective</span>
<a name="l00044"></a>00044 <span class="stringliteral">    function from any simulation software (a driver to run the program and</span>
<a name="l00045"></a>00045 <span class="stringliteral">    read output is still required).  The &#39;get&#39; method can be overridden</span>
<a name="l00046"></a>00046 <span class="stringliteral">    by subclasses like AbInitio_GMX.&quot;&quot;&quot;</span>
<a name="l00047"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html">00047</a>     
<a name="l00048"></a>00048     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad6d702694d6cd99e3432183e5c4860c9" title="Initialization; define a few core concepts.">__init__</a>(self,options,tgt_opts,forcefield):
<a name="l00049"></a>00049         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00050"></a>00050 <span class="stringliteral">        Initialization; define a few core concepts.</span>
<a name="l00051"></a>00051 <span class="stringliteral"></span>
<a name="l00052"></a>00052 <span class="stringliteral">        @todo Obtain the number of true atoms (or the particle -&gt; atom mapping)</span>
<a name="l00053"></a>00053 <span class="stringliteral">        from the force field.</span>
<a name="l00054"></a>00054 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056         <span class="comment">## Initialize the base class</span>
<a name="l00057"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad6d702694d6cd99e3432183e5c4860c9">00057</a>         super(AbInitio,self).<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad6d702694d6cd99e3432183e5c4860c9" title="Initialization; define a few core concepts.">__init__</a>(options,tgt_opts,forcefield)
<a name="l00058"></a>00058         
<a name="l00059"></a>00059         <span class="comment">#======================================#</span>
<a name="l00060"></a>00060         <span class="comment"># Options that are given by the parser #</span>
<a name="l00061"></a>00061         <span class="comment">#======================================#</span>
<a name="l00062"></a>00062         
<a name="l00063"></a>00063         <span class="comment">## Number of snapshots</span>
<a name="l00064"></a>00064         self.set_option(tgt_opts,<span class="stringliteral">&#39;shots&#39;</span>,<span class="stringliteral">&#39;ns&#39;</span>)
<a name="l00065"></a>00065         <span class="comment">## Whether to use WHAM Boltzmann weights</span>
<a name="l00066"></a>00066         self.set_option(tgt_opts,<span class="stringliteral">&#39;whamboltz&#39;</span>,<span class="stringliteral">&#39;whamboltz&#39;</span>)
<a name="l00067"></a>00067         <span class="comment">## Whether to use the Sampling Correction</span>
<a name="l00068"></a>00068         self.set_option(tgt_opts,<span class="stringliteral">&#39;sampcorr&#39;</span>,<span class="stringliteral">&#39;sampcorr&#39;</span>)
<a name="l00069"></a>00069         <span class="comment">## Whether to match Absolute Energies (make sure you know what you&#39;re doing)</span>
<a name="l00070"></a>00070         self.set_option(tgt_opts,<span class="stringliteral">&#39;absolute&#39;</span>,<span class="stringliteral">&#39;absolute&#39;</span>)
<a name="l00071"></a>00071         <span class="comment">## Whether to use the Covariance Matrix</span>
<a name="l00072"></a>00072         self.set_option(tgt_opts,<span class="stringliteral">&#39;covariance&#39;</span>,<span class="stringliteral">&#39;covariance&#39;</span>)
<a name="l00073"></a>00073         <span class="comment">## Whether to use QM Boltzmann weights</span>
<a name="l00074"></a>00074         self.set_option(tgt_opts,<span class="stringliteral">&#39;qmboltz&#39;</span>,<span class="stringliteral">&#39;qmboltz&#39;</span>)
<a name="l00075"></a>00075         <span class="comment">## The temperature for QM Boltzmann weights</span>
<a name="l00076"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae5c60f421336c2ecb716be16b8d51fdf">00076</a>         self.set_option(tgt_opts,<span class="stringliteral">&#39;qmboltztemp&#39;</span>,<span class="stringliteral">&#39;qmboltztemp&#39;</span>)
<a name="l00077"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a5d7019720cce40eb336b82b5d0c74f87">00077</a>         <span class="comment">## Number of atoms that we are fitting</span>
<a name="l00078"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a621b8b2fb62435de36c6895ba6ea09aa">00078</a>         self.set_option(tgt_opts,<span class="stringliteral">&#39;fitatoms&#39;</span>,<span class="stringliteral">&#39;fitatoms&#39;</span>)
<a name="l00079"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a975f07dd65ff96266fbd9fe2d9683ab3">00079</a>         <span class="comment">## Whether to fit Energies.</span>
<a name="l00080"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a6b773c8a8a0134fdb4773eff6b23a4b9">00080</a>         self.set_option(tgt_opts,<span class="stringliteral">&#39;energy&#39;</span>,<span class="stringliteral">&#39;energy&#39;</span>)
<a name="l00081"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae86f6ee41ce05057b44fb1bc8bb1282b">00081</a>         <span class="comment">## Whether to fit Forces.</span>
<a name="l00082"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a011b973a1779275fe19fd1c72037b435">00082</a>         self.set_option(tgt_opts,<span class="stringliteral">&#39;force&#39;</span>,<span class="stringliteral">&#39;force&#39;</span>)
<a name="l00083"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#af8f5ab3fd98876e7ea923ed90c48e66d">00083</a>         <span class="comment">## Whether to fit Electrostatic Potential.</span>
<a name="l00084"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a45edac867fa720c26a6f959c3dd5a139">00084</a>         self.set_option(tgt_opts,<span class="stringliteral">&#39;resp&#39;</span>,<span class="stringliteral">&#39;resp&#39;</span>)
<a name="l00085"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ac04e91428155e8d5c4a1a14328e9cc99">00085</a>         self.set_option(tgt_opts,<span class="stringliteral">&#39;resp_a&#39;</span>,<span class="stringliteral">&#39;resp_a&#39;</span>)
<a name="l00086"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a0c48a57c247e6afe97fd178e8b5bce0d">00086</a>         self.set_option(tgt_opts,<span class="stringliteral">&#39;resp_b&#39;</span>,<span class="stringliteral">&#39;resp_b&#39;</span>)
<a name="l00087"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a9954395e5bb893da066002238d7dbacd">00087</a>         <span class="comment">## Weights for the three components.</span>
<a name="l00088"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad19dc7dc7d2593c143700182dc614435">00088</a>         self.set_option(tgt_opts,<span class="stringliteral">&#39;w_energy&#39;</span>,<span class="stringliteral">&#39;w_energy&#39;</span>)
<a name="l00089"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a112c4e1af07517633c5c149c07c4aa8c">00089</a>         self.set_option(tgt_opts,<span class="stringliteral">&#39;w_force&#39;</span>,<span class="stringliteral">&#39;w_force&#39;</span>)
<a name="l00090"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad3dfbd9d397bb7b2bbc3fe0374291e34">00090</a>         self.set_option(tgt_opts,<span class="stringliteral">&#39;force_map&#39;</span>,<span class="stringliteral">&#39;force_map&#39;</span>)
<a name="l00091"></a>00091         self.set_option(tgt_opts,<span class="stringliteral">&#39;w_netforce&#39;</span>,<span class="stringliteral">&#39;w_netforce&#39;</span>)
<a name="l00092"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3eceb701813ccb83d11a0dc71df835b7">00092</a>         self.set_option(tgt_opts,<span class="stringliteral">&#39;w_torque&#39;</span>,<span class="stringliteral">&#39;w_torque&#39;</span>)
<a name="l00093"></a>00093         self.set_option(tgt_opts,<span class="stringliteral">&#39;w_resp&#39;</span>,<span class="stringliteral">&#39;w_resp&#39;</span>)
<a name="l00094"></a>00094         <span class="comment">## Option for how much data to write to disk.</span>
<a name="l00095"></a>00095         self.set_option(tgt_opts,<span class="stringliteral">&#39;writelevel&#39;</span>,<span class="stringliteral">&#39;writelevel&#39;</span>)
<a name="l00096"></a>00096         <span class="comment">## Whether to do energy and force calculations for the whole trajectory, or to do</span>
<a name="l00097"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#abab8d9c8cbf4eddc5a3c10b6240423e6">00097</a>         <span class="comment">## one calculation per snapshot.</span>
<a name="l00098"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a430661954fff8c1979eb9ac28523bb5e">00098</a>         self.set_option(tgt_opts,<span class="stringliteral">&#39;all_at_once&#39;</span>,<span class="stringliteral">&#39;all_at_once&#39;</span>)
<a name="l00099"></a>00099         <span class="comment">## OpenMM-only option - whether to run the energies and forces internally.</span>
<a name="l00100"></a>00100         self.set_option(tgt_opts,<span class="stringliteral">&#39;run_internal&#39;</span>,<span class="stringliteral">&#39;run_internal&#39;</span>)
<a name="l00101"></a>00101         <span class="comment">## Whether we have virtual sites (set at the global option level)</span>
<a name="l00102"></a>00102         self.set_option(options,<span class="stringliteral">&#39;have_vsite&#39;</span>,<span class="stringliteral">&#39;have_vsite&#39;</span>)
<a name="l00103"></a>00103         <span class="comment">#======================================#</span>
<a name="l00104"></a>00104         <span class="comment">#     Variables which are set here     #</span>
<a name="l00105"></a>00105         <span class="comment">#======================================#</span>
<a name="l00106"></a>00106         <span class="comment">## WHAM Boltzmann weights</span>
<a name="l00107"></a>00107         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae5c60f421336c2ecb716be16b8d51fdf" title="Initialize the base class.">whamboltz_wts</a> = []
<a name="l00108"></a>00108         <span class="comment">## QM Boltzmann weights</span>
<a name="l00109"></a>00109         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a5d7019720cce40eb336b82b5d0c74f87" title="QM Boltzmann weights.">qmboltz_wts</a>   = []
<a name="l00110"></a>00110         <span class="comment">## Reference (QM) energies</span>
<a name="l00111"></a>00111         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a621b8b2fb62435de36c6895ba6ea09aa" title="Reference (QM) energies.">eqm</a>           = []
<a name="l00112"></a>00112         <span class="comment">## Energies of the sampling simulation</span>
<a name="l00113"></a>00113         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a975f07dd65ff96266fbd9fe2d9683ab3" title="Energies of the sampling simulation.">emd0</a>          = []
<a name="l00114"></a>00114         <span class="comment">## Reference (QM) forces</span>
<a name="l00115"></a>00115         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a6b773c8a8a0134fdb4773eff6b23a4b9" title="Reference (QM) forces.">fqm</a>           = []
<a name="l00116"></a>00116         <span class="comment">## ESP grid points</span>
<a name="l00117"></a>00117         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae86f6ee41ce05057b44fb1bc8bb1282b" title="ESP grid points.">espxyz</a>        = []
<a name="l00118"></a>00118         <span class="comment">## ESP values</span>
<a name="l00119"></a>00119         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a011b973a1779275fe19fd1c72037b435" title="ESP values.">espval</a>        = []
<a name="l00120"></a>00120         <span class="comment">## The qdata.txt file that contains the QM energies and forces</span>
<a name="l00121"></a>00121         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#af8f5ab3fd98876e7ea923ed90c48e66d" title="The qdata.txt file that contains the QM energies and forces.">qfnm</a> = os.path.join(self.tgtdir,<span class="stringliteral">&quot;qdata.txt&quot;</span>)
<a name="l00122"></a>00122         <span class="comment">## The number of atoms in the QM calculation (Irrelevant if not fitting forces)</span>
<a name="l00123"></a>00123         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a45edac867fa720c26a6f959c3dd5a139" title="The number of atoms in the QM calculation (Irrelevant if not fitting forces)">qmatoms</a>      = 0
<a name="l00124"></a>00124         <span class="comment">## Qualitative Indicator: average energy error (in kJ/mol)</span>
<a name="l00125"></a>00125         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a003717f2442aac7d1067e74b89a14cc7" title="Qualitative Indicator: average energy error (in kJ/mol)">e_err</a> = 0.0
<a name="l00126"></a>00126         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ac04e91428155e8d5c4a1a14328e9cc99">e_err_pct</a> = <span class="keywordtype">None</span>
<a name="l00127"></a>00127         <span class="comment">## Qualitative Indicator: average force error (fractional)</span>
<a name="l00128"></a>00128         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2df838b5d83710d5d35e3ccccbf7c656" title="Qualitative Indicator: average force error (fractional)">f_err</a> = 0.0
<a name="l00129"></a>00129         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a0c48a57c247e6afe97fd178e8b5bce0d">f_err_pct</a> = 0.0
<a name="l00130"></a>00130         <span class="comment">## Qualitative Indicator: &quot;relative RMS&quot; for electrostatic potential</span>
<a name="l00131"></a>00131         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3a1a04d4af74efa8ff6a1fb8bb6bcc10" title="Qualitative Indicator: &quot;relative RMS&quot; for electrostatic potential.">esp_err</a> = 0.0
<a name="l00132"></a>00132         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a6f22f2576168b879342fb60913ffc134">nf_err</a> = 0.0
<a name="l00133"></a>00133         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a73def1269c075f82fe20dae6117d75bb">nf_err_pct</a> = 0.0
<a name="l00134"></a>00134         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a9954395e5bb893da066002238d7dbacd">tq_err_pct</a> = 0.0
<a name="l00135"></a>00135         <span class="comment">## Whether to compute net forces and torques, or not.</span>
<a name="l00136"></a>00136         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad19dc7dc7d2593c143700182dc614435" title="Whether to compute net forces and torques, or not.">use_nft</a>       = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa9fa8ad127d442e9b545088eb741b9eb">w_netforce</a> &gt; 0 <span class="keywordflow">or</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab4468582c2c010bec490e65a34cdc40a">w_torque</a> &gt; 0
<a name="l00137"></a>00137         <span class="comment">## Read in the trajectory file</span>
<a name="l00138"></a>00138         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a86f4e2b085f139886d54855f432a2672" title="Read in the trajectory file.">ns</a> == -1:
<a name="l00139"></a>00139             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a112c4e1af07517633c5c149c07c4aa8c">traj</a> = <a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html" title="Lee-Ping&#39;s general file format conversion class.">Molecule</a>(os.path.join(self.root,self.tgtdir,self.trajfnm))
<a name="l00140"></a>00140             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a86f4e2b085f139886d54855f432a2672" title="Read in the trajectory file.">ns</a> = len(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a112c4e1af07517633c5c149c07c4aa8c">traj</a>)
<a name="l00141"></a>00141         <span class="keywordflow">else</span>:
<a name="l00142"></a>00142             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a112c4e1af07517633c5c149c07c4aa8c">traj</a> = <a class="code" href="classforcebalance_1_1molecule_1_1Molecule.html" title="Lee-Ping&#39;s general file format conversion class.">Molecule</a>(os.path.join(self.root,self.tgtdir,self.trajfnm))[:self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a86f4e2b085f139886d54855f432a2672" title="Read in the trajectory file.">ns</a>]
<a name="l00143"></a>00143         <span class="comment">## The number of (atoms + drude particles + virtual sites)</span>
<a name="l00144"></a>00144         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad3dfbd9d397bb7b2bbc3fe0374291e34" title="The number of (atoms + drude particles + virtual sites)">nparticles</a>  = len(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a112c4e1af07517633c5c149c07c4aa8c">traj</a>.elem)
<a name="l00145"></a>00145         <span class="comment">## This is a default-dict containing a number of atom-wise lists, such as the</span>
<a name="l00146"></a>00146         <span class="comment">## residue number of each atom, the mass of each atom, and so on.</span>
<a name="l00147"></a>00147         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3eceb701813ccb83d11a0dc71df835b7" title="This is a default-dict containing a number of atom-wise lists, such as the residue number of each ato...">AtomLists</a> = defaultdict(list)
<a name="l00148"></a>00148         <span class="comment">## Read in the topology</span>
<a name="l00149"></a>00149         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a9f405c452a0a4081cd7da07938520920">read_topology</a>()
<a name="l00150"></a>00150         <span class="comment">## Read in the reference data</span>
<a name="l00151"></a>00151         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa73bedbf1e2cf19f2fa1e88815f1bd86" title="Read the reference ab initio data from a file such as qdata.txt.">read_reference_data</a>()
<a name="l00152"></a>00152         <span class="comment">## Prepare the temporary directory</span>
<a name="l00153"></a>00153         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2d0f465f1988fd6bc611f7de4b59fd04" title="Prepare the temporary directory, by default does nothing.">prepare_temp_directory</a>(options,tgt_opts)
<a name="l00154"></a>00154         <span class="comment">## The below two options are related to whether we want to rebuild virtual site positions.</span>
<a name="l00155"></a>00155         <span class="comment">## Rebuild the distance matrix if virtual site positions have changed</span>
<a name="l00156"></a>00156         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#abab8d9c8cbf4eddc5a3c10b6240423e6" title="Read in the topology.">new_vsites</a> = <span class="keyword">True</span>
<a name="l00157"></a>00157         <span class="comment">## Save the mvals from the last time we updated the vsites.</span>
<a name="l00158"></a>00158         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a430661954fff8c1979eb9ac28523bb5e" title="Save the mvals from the last time we updated the vsites.">save_vmvals</a> = {}
<a name="l00159"></a>00159         self.set_option(<span class="keywordtype">None</span>, <span class="stringliteral">&#39;shots&#39;</span>, val=self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a86f4e2b085f139886d54855f432a2672" title="Read in the trajectory file.">ns</a>)
<a name="l00160"></a>00160 
<a name="l00161"></a>00161     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a9f405c452a0a4081cd7da07938520920">read_topology</a>(self):
<a name="l00162"></a>00162         <span class="comment"># Arthur: Document this.</span>
<a name="l00163"></a>00163         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a32164696f808febd50eafae10d10a7e7">topology_flag</a> = <span class="keyword">False</span>
<a name="l00164"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a32164696f808febd50eafae10d10a7e7">00164</a> 
<a name="l00165"></a>00165     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a7475857193eefd4edd020d4f2a8fec17">build_invdist</a>(self, mvals):
<a name="l00166"></a>00166         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.FF.np):
<a name="l00167"></a>00167             <span class="keywordflow">if</span> <span class="stringliteral">&#39;VSITE&#39;</span> <span class="keywordflow">in</span> self.FF.plist[i]:
<a name="l00168"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a7475857193eefd4edd020d4f2a8fec17">00168</a>                 <span class="keywordflow">if</span> i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a430661954fff8c1979eb9ac28523bb5e" title="Save the mvals from the last time we updated the vsites.">save_vmvals</a> <span class="keywordflow">and</span> mvals[i] != self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a430661954fff8c1979eb9ac28523bb5e" title="Save the mvals from the last time we updated the vsites.">save_vmvals</a>[i]:
<a name="l00169"></a>00169                     self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#abab8d9c8cbf4eddc5a3c10b6240423e6" title="Read in the topology.">new_vsites</a> = <span class="keyword">True</span>
<a name="l00170"></a>00170                     <span class="keywordflow">break</span>
<a name="l00171"></a>00171         <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#abab8d9c8cbf4eddc5a3c10b6240423e6" title="Read in the topology.">new_vsites</a>: <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ac90a96916a049717e14bc1f757577f24">invdists</a>
<a name="l00172"></a>00172         <span class="keywordflow">if</span> any([<span class="stringliteral">&#39;VSITE&#39;</span> <span class="keywordflow">in</span> i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.FF.map.keys()]) <span class="keywordflow">or</span> self.have_vsite:
<a name="l00173"></a>00173             logger.info(<span class="stringliteral">&quot;\rGenerating virtual site positions.%s&quot;</span> % (<span class="stringliteral">&quot; &quot;</span>*30))
<a name="l00174"></a>00174             pvals = self.FF.make(mvals)
<a name="l00175"></a>00175             self.generate_vsite_positions()
<a name="l00176"></a>00176         <span class="comment"># prepare the distance matrix for esp computations</span>
<a name="l00177"></a>00177         <span class="keywordflow">if</span> len(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae86f6ee41ce05057b44fb1bc8bb1282b" title="ESP grid points.">espxyz</a>) &gt; 0:
<a name="l00178"></a>00178             invdists = []
<a name="l00179"></a>00179             logger.info(<span class="stringliteral">&quot;\rPreparing the distance matrix... it will have %i * %i * %i = %i elements&quot;</span> % (self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a86f4e2b085f139886d54855f432a2672" title="Read in the trajectory file.">ns</a>, self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a15710ca46f6141a6e5b00a382aa56632">nesp</a>, self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad3dfbd9d397bb7b2bbc3fe0374291e34" title="The number of (atoms + drude particles + virtual sites)">nparticles</a>, self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a86f4e2b085f139886d54855f432a2672" title="Read in the trajectory file.">ns</a> * self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a15710ca46f6141a6e5b00a382aa56632">nesp</a> * self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad3dfbd9d397bb7b2bbc3fe0374291e34" title="The number of (atoms + drude particles + virtual sites)">nparticles</a>))
<a name="l00180"></a>00180             sn = 0
<a name="l00181"></a>00181             <span class="keywordflow">for</span> espset, xyz <span class="keywordflow">in</span> zip(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae86f6ee41ce05057b44fb1bc8bb1282b" title="ESP grid points.">espxyz</a>, self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a112c4e1af07517633c5c149c07c4aa8c">traj</a>.xyzs):
<a name="l00182"></a>00182                 logger.info(<span class="stringliteral">&quot;\rGenerating ESP distances for snapshot %i%s&quot;</span> % (sn, <span class="stringliteral">&quot; &quot;</span>*50))
<a name="l00183"></a>00183                 esparr = array(espset).reshape(-1,3)
<a name="l00184"></a>00184                 <span class="comment"># Create a matrix with Nesp rows and Natoms columns.</span>
<a name="l00185"></a>00185                 DistMat = array([[linalg.norm(i - j) <span class="keywordflow">for</span> j <span class="keywordflow">in</span> xyz] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> esparr])
<a name="l00186"></a>00186                 <span class="comment">#print &quot;DistMat min/max: % .3f % .3f&quot; % (min(flat(DistMat)), max(flat(DistMat)))</span>
<a name="l00187"></a>00187                 <span class="comment"># xyztest = [&#39;%i&#39; % (self.nesp + self.nparticles),&#39;Testing ESP for frame number %i&#39; % sn]</span>
<a name="l00188"></a>00188                 <span class="comment"># for i, x in enumerate(xyz):</span>
<a name="l00189"></a>00189                 <span class="comment">#     xyztest.append(format_xyz_coord(sub(&#39;[0-9]&#39;,&#39;&#39;,self.FF.atomnames[i]),x))</span>
<a name="l00190"></a>00190                 <span class="comment"># for i in esparr:</span>
<a name="l00191"></a>00191                 <span class="comment">#     xyztest.append(format_xyz_coord(&quot;He&quot;,i))</span>
<a name="l00192"></a>00192                 <span class="comment">#with open(&#39;test.xyz&#39;,&#39;w&#39; if sn == 0 else &#39;a&#39;) as f: f.writelines([l+&#39;\n&#39; for l in xyztest])</span>
<a name="l00193"></a>00193                 invdists.append(1. / (DistMat / bohrang))
<a name="l00194"></a>00194                 sn += 1
<a name="l00195"></a>00195         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.FF.np):
<a name="l00196"></a>00196             <span class="keywordflow">if</span> <span class="stringliteral">&#39;VSITE&#39;</span> <span class="keywordflow">in</span> self.FF.plist[i]:
<a name="l00197"></a>00197                 self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a430661954fff8c1979eb9ac28523bb5e" title="Save the mvals from the last time we updated the vsites.">save_vmvals</a>[i] = mvals[i]
<a name="l00198"></a>00198         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#abab8d9c8cbf4eddc5a3c10b6240423e6" title="Read in the topology.">new_vsites</a> = <span class="keyword">False</span>
<a name="l00199"></a>00199         <span class="keywordflow">return</span> array(invdists)
<a name="l00200"></a>00200 
<a name="l00201"></a>00201     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#afbf86c26158a68cae7460b4106809fdd">compute_netforce_torque</a>(self, xyz, force, QM=False):
<a name="l00202"></a>00202         <span class="comment"># Convert an array of (3 * n_atoms) atomistic forces</span>
<a name="l00203"></a>00203         <span class="comment"># to an array of (3 * (n_forces + n_torques)) net forces and torques.</span>
<a name="l00204"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a88902db5981ca2088a7cf47f5f9aa83a">00204</a>         <span class="comment"># This code is rather slow.  It requires the system to have a list</span>
<a name="l00205"></a>00205         <span class="comment"># of masses and blocking numbers.</span>
<a name="l00206"></a>00206         <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a32164696f808febd50eafae10d10a7e7">topology_flag</a>:
<a name="l00207"></a>00207             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Cannot do net forces and torques for class %s because read_topology is not implemented&#39;</span> % self.__class__.__name__)
<a name="l00208"></a>00208 
<a name="l00209"></a>00209         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab5b58642be0ba7651c16031f955189dc">force_map</a> == <span class="stringliteral">&#39;molecule&#39;</span>:
<a name="l00210"></a>00210             Block = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3eceb701813ccb83d11a0dc71df835b7" title="This is a default-dict containing a number of atom-wise lists, such as the residue number of each ato...">AtomLists</a>[<span class="stringliteral">&#39;MoleculeNumber&#39;</span>]
<a name="l00211"></a>00211         <span class="keywordflow">elif</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab5b58642be0ba7651c16031f955189dc">force_map</a> == <span class="stringliteral">&#39;residue&#39;</span>:
<a name="l00212"></a>00212             Block = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3eceb701813ccb83d11a0dc71df835b7" title="This is a default-dict containing a number of atom-wise lists, such as the residue number of each ato...">AtomLists</a>[<span class="stringliteral">&#39;ResidueNumber&#39;</span>]
<a name="l00213"></a>00213         <span class="keywordflow">elif</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab5b58642be0ba7651c16031f955189dc">force_map</a> == <span class="stringliteral">&#39;chargegroup&#39;</span>:
<a name="l00214"></a>00214             Block = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3eceb701813ccb83d11a0dc71df835b7" title="This is a default-dict containing a number of atom-wise lists, such as the residue number of each ato...">AtomLists</a>[<span class="stringliteral">&#39;ChargeGroupNumber&#39;</span>]
<a name="l00215"></a>00215         <span class="keywordflow">else</span>:
<a name="l00216"></a>00216             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Please choose a valid force_map keyword: molecule, residue, chargegroup&#39;</span>)
<a name="l00217"></a>00217 
<a name="l00218"></a>00218         <span class="comment"># Try to be intelligent here.  Before computing net forces and torques, first filter out all particles that are not atoms.</span>
<a name="l00219"></a>00219         <span class="keywordflow">if</span> len(xyz) &gt; self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>:
<a name="l00220"></a>00220             xyz1 = array([xyz[i] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(xyz)) <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3eceb701813ccb83d11a0dc71df835b7" title="This is a default-dict containing a number of atom-wise lists, such as the residue number of each ato...">AtomLists</a>[<span class="stringliteral">&#39;ParticleType&#39;</span>][i] == <span class="stringliteral">&#39;A&#39;</span>])
<a name="l00221"></a>00221         <span class="keywordflow">else</span>:
<a name="l00222"></a>00222             xyz1 = xyz.copy()
<a name="l00223"></a>00223 
<a name="l00224"></a>00224         <span class="keywordflow">if</span> len(Block) &gt; self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>:
<a name="l00225"></a>00225             Block = [Block[i] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(Block)) <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3eceb701813ccb83d11a0dc71df835b7" title="This is a default-dict containing a number of atom-wise lists, such as the residue number of each ato...">AtomLists</a>[<span class="stringliteral">&#39;ParticleType&#39;</span>][i] == <span class="stringliteral">&#39;A&#39;</span>]
<a name="l00226"></a>00226 
<a name="l00227"></a>00227         <span class="keywordflow">if</span> len(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3eceb701813ccb83d11a0dc71df835b7" title="This is a default-dict containing a number of atom-wise lists, such as the residue number of each ato...">AtomLists</a>[<span class="stringliteral">&#39;Mass&#39;</span>]) &gt; self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>:
<a name="l00228"></a>00228             Mass = array([self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3eceb701813ccb83d11a0dc71df835b7" title="This is a default-dict containing a number of atom-wise lists, such as the residue number of each ato...">AtomLists</a>[<span class="stringliteral">&#39;Mass&#39;</span>][i] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(xyz)) <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3eceb701813ccb83d11a0dc71df835b7" title="This is a default-dict containing a number of atom-wise lists, such as the residue number of each ato...">AtomLists</a>[<span class="stringliteral">&#39;ParticleType&#39;</span>][i] == <span class="stringliteral">&#39;A&#39;</span>])
<a name="l00229"></a>00229         <span class="keywordflow">else</span>:
<a name="l00230"></a>00230             Mass = array(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3eceb701813ccb83d11a0dc71df835b7" title="This is a default-dict containing a number of atom-wise lists, such as the residue number of each ato...">AtomLists</a>[<span class="stringliteral">&#39;Mass&#39;</span>])
<a name="l00231"></a>00231 
<a name="l00232"></a>00232         NetForces = []
<a name="l00233"></a>00233         Torques = []
<a name="l00234"></a>00234         <span class="keywordflow">for</span> b <span class="keywordflow">in</span> sorted(set(Block)):
<a name="l00235"></a>00235             AtomBlock = array([i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(Block)) <span class="keywordflow">if</span> Block[i] == b])
<a name="l00236"></a>00236             CrdBlock = array(list(itertools.chain(*[range(3*i, 3*i+3) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> AtomBlock])))
<a name="l00237"></a>00237             com = sum(xyz1[AtomBlock]*outer(Mass[AtomBlock],ones(3)), axis=0) / sum(Mass[AtomBlock])
<a name="l00238"></a>00238             frc = force[CrdBlock].reshape(-1,3)
<a name="l00239"></a>00239             NetForce = sum(frc, axis=0)
<a name="l00240"></a>00240             xyzb = xyz1[AtomBlock]
<a name="l00241"></a>00241             Torque = zeros(3, dtype=float)
<a name="l00242"></a>00242             <span class="keywordflow">for</span> a <span class="keywordflow">in</span> range(len(xyzb)):
<a name="l00243"></a>00243                 R = xyzb[a] - com
<a name="l00244"></a>00244                 F = frc[a]
<a name="l00245"></a>00245                 <span class="comment"># I think the unit of torque is in nm x kJ / nm.</span>
<a name="l00246"></a>00246                 Torque += cross(R, F) / 10
<a name="l00247"></a>00247             NetForces += [i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> NetForce]
<a name="l00248"></a>00248             <span class="comment"># Increment the torques only if we have more than one atom in our block.</span>
<a name="l00249"></a>00249             <span class="keywordflow">if</span> len(xyzb) &gt; 1:
<a name="l00250"></a>00250                 Torques += [i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> Torque]
<a name="l00251"></a>00251         netfrc_torque = array(NetForces + Torques)
<a name="l00252"></a>00252         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa4eadda3b8377b783dec2d327cb66fa6">nnf</a> = len(NetForces)/3
<a name="l00253"></a>00253         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a88902db5981ca2088a7cf47f5f9aa83a">ntq</a> = len(Torques)/3
<a name="l00254"></a>00254         <span class="keywordflow">return</span> netfrc_torque
<a name="l00255"></a>00255 
<a name="l00256"></a>00256     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa73bedbf1e2cf19f2fa1e88815f1bd86" title="Read the reference ab initio data from a file such as qdata.txt.">read_reference_data</a>(self):
<a name="l00257"></a>00257         
<a name="l00258"></a>00258         <span class="stringliteral">&quot;&quot;&quot; Read the reference ab initio data from a file such as qdata.txt.</span>
<a name="l00259"></a>00259 <span class="stringliteral"></span>
<a name="l00260"></a>00260 <span class="stringliteral">        @todo Add an option for picking any slice out of</span>
<a name="l00261"></a>00261 <span class="stringliteral">        qdata.txt, helpful for cross-validation</span>
<a name="l00262"></a>00262 <span class="stringliteral">        </span>
<a name="l00263"></a>00263 <span class="stringliteral">        @todo Closer integration of reference data with program -</span>
<a name="l00264"></a>00264 <span class="stringliteral">        leave behind the qdata.txt format?  (For now, I like the</span>
<a name="l00265"></a>00265 <span class="stringliteral">        readability of qdata.txt)</span>
<a name="l00266"></a>00266 <span class="stringliteral"></span>
<a name="l00267"></a>00267 <span class="stringliteral">        After reading in the information from qdata.txt, it is converted</span>
<a name="l00268"></a>00268 <span class="stringliteral">        into the GROMACS energy units (kind of an arbitrary choice);</span>
<a name="l00269"></a>00269 <span class="stringliteral">        forces (kind of a misnomer in qdata.txt) are multipled by -1</span>
<a name="l00270"></a>00270 <span class="stringliteral">        to convert gradients to forces.</span>
<a name="l00271"></a>00271 <span class="stringliteral"></span>
<a name="l00272"></a>00272 <span class="stringliteral">        We also subtract out the mean energies of all energy arrays</span>
<a name="l00273"></a>00273 <span class="stringliteral">        because energy/force matching does not account for zero-point</span>
<a name="l00274"></a>00274 <span class="stringliteral">        energy differences between MM and QM (i.e. energy of electrons</span>
<a name="l00275"></a>00275 <span class="stringliteral">        in core orbitals).</span>
<a name="l00276"></a>00276 <span class="stringliteral"></span>
<a name="l00277"></a>00277 <span class="stringliteral">        The configurations in force/energy matching typically come</span>
<a name="l00278"></a>00278 <span class="stringliteral">        from a the thermodynamic ensemble of the MM force field at</span>
<a name="l00279"></a>00279 <span class="stringliteral">        some temperature (by running MD, for example), and for many</span>
<a name="l00280"></a>00280 <span class="stringliteral">        reasons it is helpful to introduce non-Boltzmann weights in</span>
<a name="l00281"></a>00281 <span class="stringliteral">        front of these configurations.  There are two options: WHAM</span>
<a name="l00282"></a>00282 <span class="stringliteral">        Boltzmann weights (for combining the weights of several</span>
<a name="l00283"></a>00283 <span class="stringliteral">        simulations together) and QM Boltzmann weights (for converting</span>
<a name="l00284"></a>00284 <span class="stringliteral">        MM weights into QM weights).  Note that the two sets of weights</span>
<a name="l00285"></a>00285 <span class="stringliteral">        &#39;stack&#39;; i.e. they can be used at the same time.</span>
<a name="l00286"></a>00286 <span class="stringliteral"></span>
<a name="l00287"></a>00287 <span class="stringliteral">        A &#39;hybrid&#39; ensemble is possible where we use 50% MM and 50% QM</span>
<a name="l00288"></a>00288 <span class="stringliteral">        weights.  Please read more in LPW and Troy Van Voorhis, JCP</span>
<a name="l00289"></a>00289 <span class="stringliteral">        Vol. 133, Pg. 231101 (2010), doi:10.1063/1.3519043.</span>
<a name="l00290"></a>00290 <span class="stringliteral">        </span>
<a name="l00291"></a>00291 <span class="stringliteral">        @todo The WHAM Boltzmann weights are generated by external</span>
<a name="l00292"></a>00292 <span class="stringliteral">        scripts (wanalyze.py and make-wham-data.sh) and passed in;</span>
<a name="l00293"></a>00293 <span class="stringliteral">        perhaps these scripts can be added to the ForceBalance</span>
<a name="l00294"></a>00294 <span class="stringliteral">        distribution or integrated more tightly.</span>
<a name="l00295"></a>00295 <span class="stringliteral"></span>
<a name="l00296"></a>00296 <span class="stringliteral">        Finally, note that using non-Boltzmann weights degrades the</span>
<a name="l00297"></a>00297 <span class="stringliteral">        statistical information content of the snapshots.  This</span>
<a name="l00298"></a>00298 <span class="stringliteral">        problem will generally become worse if the ensemble to which</span>
<a name="l00299"></a>00299 <span class="stringliteral">        we&#39;re reweighting is dramatically different from the one we&#39;re</span>
<a name="l00300"></a>00300 <span class="stringliteral">        sampling from.  We end up with a set of Boltzmann weights like</span>
<a name="l00301"></a>00301 <span class="stringliteral">        [1e-9, 1e-9, 1.0, 1e-9, 1e-9 ... ] and this is essentially just</span>
<a name="l00302"></a>00302 <span class="stringliteral">        one snapshot.  I believe Troy is working on something to cure</span>
<a name="l00303"></a>00303 <span class="stringliteral">        this problem.</span>
<a name="l00304"></a>00304 <span class="stringliteral"></span>
<a name="l00305"></a>00305 <span class="stringliteral">        Here, we have a measure for the information content of our snapshots,</span>
<a name="l00306"></a>00306 <span class="stringliteral">        which comes easily from the definition of information entropy:</span>
<a name="l00307"></a>00307 <span class="stringliteral"></span>
<a name="l00308"></a>00308 <span class="stringliteral">        S = -1*Sum_i(P_i*log(P_i))</span>
<a name="l00309"></a>00309 <span class="stringliteral">        InfoContent = exp(-S)</span>
<a name="l00310"></a>00310 <span class="stringliteral"></span>
<a name="l00311"></a>00311 <span class="stringliteral">        With uniform weights, InfoContent is equal to the number of snapshots;</span>
<a name="l00312"></a>00312 <span class="stringliteral">        with horrible weights, InfoContent is closer to one.</span>
<a name="l00313"></a>00313 <span class="stringliteral"></span>
<a name="l00314"></a>00314 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00315"></a>00315         <span class="comment"># Parse the qdata.txt file</span>
<a name="l00316"></a>00316         <span class="keywordflow">for</span> line <span class="keywordflow">in</span> open(os.path.join(self.root,self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#af8f5ab3fd98876e7ea923ed90c48e66d" title="The qdata.txt file that contains the QM energies and forces.">qfnm</a>)):
<a name="l00317"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a8f3cbe570dfaf74f84f71817cd3fb008">00317</a>             sline = line.split()
<a name="l00318"></a>00318             <span class="keywordflow">if</span> len(sline) == 0: <span class="keywordflow">continue</span>
<a name="l00319"></a>00319             <span class="keywordflow">elif</span> sline[0] == <span class="stringliteral">&#39;ENERGY&#39;</span>:
<a name="l00320"></a>00320                 self.eqm.append(float(sline[1]))
<a name="l00321"></a>00321             <span class="keywordflow">elif</span> sline[0] == <span class="stringliteral">&#39;EMD0&#39;</span>:
<a name="l00322"></a>00322                 self.emd0.append(float(sline[1]))
<a name="l00323"></a>00323             <span class="keywordflow">elif</span> sline[0] == <span class="stringliteral">&#39;FORCES&#39;</span>:
<a name="l00324"></a>00324                 self.fqm.append([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline[1:]])
<a name="l00325"></a>00325             <span class="keywordflow">elif</span> sline[0] == <span class="stringliteral">&#39;ESPXYZ&#39;</span>:
<a name="l00326"></a>00326                 self.espxyz.append([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline[1:]])
<a name="l00327"></a>00327             <span class="keywordflow">elif</span> sline[0] == <span class="stringliteral">&#39;ESPVAL&#39;</span>:
<a name="l00328"></a>00328                 self.espval.append([float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline[1:]])
<a name="l00329"></a>00329             <span class="keywordflow">if</span> all(len(i) <span class="keywordflow">in</span> [self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a86f4e2b085f139886d54855f432a2672" title="Read in the trajectory file.">ns</a>, 0] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> [self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a621b8b2fb62435de36c6895ba6ea09aa" title="Reference (QM) energies.">eqm</a>, self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a6b773c8a8a0134fdb4773eff6b23a4b9" title="Reference (QM) forces.">fqm</a>, self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a975f07dd65ff96266fbd9fe2d9683ab3" title="Energies of the sampling simulation.">emd0</a>, self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae86f6ee41ce05057b44fb1bc8bb1282b" title="ESP grid points.">espxyz</a>, self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a011b973a1779275fe19fd1c72037b435" title="ESP values.">espval</a>]) <span class="keywordflow">and</span> len(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a621b8b2fb62435de36c6895ba6ea09aa" title="Reference (QM) energies.">eqm</a>) == self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a86f4e2b085f139886d54855f432a2672" title="Read in the trajectory file.">ns</a>:
<a name="l00330"></a>00330                 <span class="keywordflow">break</span>
<a name="l00331"></a>00331         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a86f4e2b085f139886d54855f432a2672" title="Read in the trajectory file.">ns</a> = len(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a621b8b2fb62435de36c6895ba6ea09aa" title="Reference (QM) energies.">eqm</a>)
<a name="l00332"></a>00332         <span class="comment"># Turn everything into arrays, convert to kJ/mol, and subtract the mean energy from the energy arrays</span>
<a name="l00333"></a>00333         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a621b8b2fb62435de36c6895ba6ea09aa" title="Reference (QM) energies.">eqm</a> = array(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a621b8b2fb62435de36c6895ba6ea09aa" title="Reference (QM) energies.">eqm</a>)
<a name="l00334"></a>00334         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a621b8b2fb62435de36c6895ba6ea09aa" title="Reference (QM) energies.">eqm</a> *= eqcgmx
<a name="l00335"></a>00335         <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.absolute:
<a name="l00336"></a>00336             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a621b8b2fb62435de36c6895ba6ea09aa" title="Reference (QM) energies.">eqm</a> -= mean(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a621b8b2fb62435de36c6895ba6ea09aa" title="Reference (QM) energies.">eqm</a>)
<a name="l00337"></a>00337         <span class="keywordflow">else</span>:
<a name="l00338"></a>00338             logger.info(<span class="stringliteral">&quot;Fitting absolute energies.  Make sure you know what you are doing!\n&quot;</span>)
<a name="l00339"></a>00339         <span class="keywordflow">if</span> len(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a6b773c8a8a0134fdb4773eff6b23a4b9" title="Reference (QM) forces.">fqm</a>) &gt; 0:
<a name="l00340"></a>00340             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a6b773c8a8a0134fdb4773eff6b23a4b9" title="Reference (QM) forces.">fqm</a> = array(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a6b773c8a8a0134fdb4773eff6b23a4b9" title="Reference (QM) forces.">fqm</a>)
<a name="l00341"></a>00341             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a6b773c8a8a0134fdb4773eff6b23a4b9" title="Reference (QM) forces.">fqm</a> *= fqcgmx
<a name="l00342"></a>00342             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a45edac867fa720c26a6f959c3dd5a139" title="The number of atoms in the QM calculation (Irrelevant if not fitting forces)">qmatoms</a> = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a6b773c8a8a0134fdb4773eff6b23a4b9" title="Reference (QM) forces.">fqm</a>.shape[1]/3
<a name="l00343"></a>00343         <span class="keywordflow">else</span>:
<a name="l00344"></a>00344             logger.info(<span class="stringliteral">&quot;QM forces are not present, only fitting energies.\n&quot;</span>)
<a name="l00345"></a>00345             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a54baa14272a2312e0fe1b77a0554c0aa">force</a> = 0
<a name="l00346"></a>00346             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2f68f2c95e481c03e05b03d55851107f">w_force</a> = 0
<a name="l00347"></a>00347         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a15710ca46f6141a6e5b00a382aa56632">nesp</a> = len(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a011b973a1779275fe19fd1c72037b435" title="ESP values.">espval</a>[0]) <span class="keywordflow">if</span> len(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a011b973a1779275fe19fd1c72037b435" title="ESP values.">espval</a>) &gt; 0 <span class="keywordflow">else</span> 0
<a name="l00348"></a>00348         <span class="comment"># Here we may choose a subset of atoms to do the force matching.</span>
<a name="l00349"></a>00349         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a54baa14272a2312e0fe1b77a0554c0aa">force</a>:
<a name="l00350"></a>00350             <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a> == 0: 
<a name="l00351"></a>00351                 self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a> = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a45edac867fa720c26a6f959c3dd5a139" title="The number of atoms in the QM calculation (Irrelevant if not fitting forces)">qmatoms</a>
<a name="l00352"></a>00352             <span class="keywordflow">elif</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a> &gt; self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a45edac867fa720c26a6f959c3dd5a139" title="The number of atoms in the QM calculation (Irrelevant if not fitting forces)">qmatoms</a>:
<a name="l00353"></a>00353                 <a class="code" href="namespaceforcebalance_1_1nifty.html#abb8f59044961a12588e0653c2baa8b01">warn_press_key</a>(<span class="stringliteral">&quot;There are more fitting atoms than the total number of atoms in the QM calculation (something is probably wrong)&quot;</span>)
<a name="l00354"></a>00354             <span class="keywordflow">else</span>:
<a name="l00355"></a>00355                 <span class="comment"># Indicate to Gromacs that we&#39;re only fitting the first however-many atoms.</span>
<a name="l00356"></a>00356                 logger.info(<span class="stringliteral">&quot;We&#39;re only fitting the first %i atoms\n&quot;</span> % self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>)
<a name="l00357"></a>00357                 <span class="comment">#print &quot;The quantum force matrix appears to contain more components (%i) than those being fit (%i).&quot; % (fqmm.shape[1], 3*self.fitatoms)</span>
<a name="l00358"></a>00358                 logger.info(<span class="stringliteral">&quot;Pruning the quantum force matrix...\n&quot;</span>)
<a name="l00359"></a>00359                 self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a6b773c8a8a0134fdb4773eff6b23a4b9" title="Reference (QM) forces.">fqm</a>  = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a6b773c8a8a0134fdb4773eff6b23a4b9" title="Reference (QM) forces.">fqm</a>[:, :3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>].copy()
<a name="l00360"></a>00360         <span class="keywordflow">else</span>:
<a name="l00361"></a>00361             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a> = 0
<a name="l00362"></a>00362             
<a name="l00363"></a>00363         <span class="keywordflow">if</span> len(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a975f07dd65ff96266fbd9fe2d9683ab3" title="Energies of the sampling simulation.">emd0</a>) &gt; 0:
<a name="l00364"></a>00364             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a975f07dd65ff96266fbd9fe2d9683ab3" title="Energies of the sampling simulation.">emd0</a> = array(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a975f07dd65ff96266fbd9fe2d9683ab3" title="Energies of the sampling simulation.">emd0</a>)
<a name="l00365"></a>00365             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a975f07dd65ff96266fbd9fe2d9683ab3" title="Energies of the sampling simulation.">emd0</a> -= mean(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a975f07dd65ff96266fbd9fe2d9683ab3" title="Energies of the sampling simulation.">emd0</a>)
<a name="l00366"></a>00366         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a8f3cbe570dfaf74f84f71817cd3fb008">whamboltz</a> == <span class="keyword">True</span>:
<a name="l00367"></a>00367             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae5c60f421336c2ecb716be16b8d51fdf" title="Initialize the base class.">whamboltz_wts</a> = array([float(i.strip()) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> open(os.path.join(self.root,self.tgtdir,<span class="stringliteral">&quot;wham-weights.txt&quot;</span>)).readlines()])
<a name="l00368"></a>00368             <span class="comment">#   This is a constant pre-multiplier in front of every snapshot.</span>
<a name="l00369"></a>00369             bar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Using WHAM MM Boltzmann weights.&quot;</span>, color=4)
<a name="l00370"></a>00370             <span class="keywordflow">if</span> os.path.exists(os.path.join(self.root,self.tgtdir,<span class="stringliteral">&quot;wham-master.txt&quot;</span>)):
<a name="l00371"></a>00371                 whaminfo = open(os.path.join(self.root,self.tgtdir,<span class="stringliteral">&quot;wham-master.txt&quot;</span>)).readlines()
<a name="l00372"></a>00372                 logger.info(<span class="stringliteral">&quot;From wham-master.txt, I can see that you&#39;re using %i generations\n&quot;</span> % len(whaminfo))
<a name="l00373"></a>00373                 logger.info(<span class="stringliteral">&quot;Relative weight of each generation:\n&quot;</span>)
<a name="l00374"></a>00374                 shotcounter = 0
<a name="l00375"></a>00375                 <span class="keywordflow">for</span> line <span class="keywordflow">in</span> whaminfo:
<a name="l00376"></a>00376                     sline = line.split()
<a name="l00377"></a>00377                     genshots = int(sline[2])
<a name="l00378"></a>00378                     weight = sum(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae5c60f421336c2ecb716be16b8d51fdf" title="Initialize the base class.">whamboltz_wts</a>[shotcounter:shotcounter+genshots])/sum(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae5c60f421336c2ecb716be16b8d51fdf" title="Initialize the base class.">whamboltz_wts</a>)
<a name="l00379"></a>00379                     logger.info(<span class="stringliteral">&quot; %s, %i snapshots, weight %.3e\n&quot;</span> % (sline[0], genshots, weight))
<a name="l00380"></a>00380                     shotcounter += genshots
<a name="l00381"></a>00381             <span class="keywordflow">else</span>:
<a name="l00382"></a>00382                 logger.info(<span class="stringliteral">&quot;Oops... WHAM files don&#39;t exist?\n&quot;</span>)
<a name="l00383"></a>00383             logger.info(bar)
<a name="l00384"></a>00384         <span class="keywordflow">else</span>:
<a name="l00385"></a>00385             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae5c60f421336c2ecb716be16b8d51fdf" title="Initialize the base class.">whamboltz_wts</a> = ones(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a86f4e2b085f139886d54855f432a2672" title="Read in the trajectory file.">ns</a>)
<a name="l00386"></a>00386         <span class="keywordflow">if</span> self.qmboltz &gt; 0:
<a name="l00387"></a>00387             <span class="comment"># LPW I haven&#39;t revised this section yet</span>
<a name="l00388"></a>00388             <span class="comment"># Do I need to?</span>
<a name="l00389"></a>00389             logboltz = -(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a621b8b2fb62435de36c6895ba6ea09aa" title="Reference (QM) energies.">eqm</a> - mean(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a621b8b2fb62435de36c6895ba6ea09aa" title="Reference (QM) energies.">eqm</a>) - self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a975f07dd65ff96266fbd9fe2d9683ab3" title="Energies of the sampling simulation.">emd0</a> + mean(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a975f07dd65ff96266fbd9fe2d9683ab3" title="Energies of the sampling simulation.">emd0</a>)) / kb / self.qmboltztemp
<a name="l00390"></a>00390             logboltz -= max(logboltz) <span class="comment"># Normalizes boltzmann weights</span>
<a name="l00391"></a>00391             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a5d7019720cce40eb336b82b5d0c74f87" title="QM Boltzmann weights.">qmboltz_wts</a> = exp(logboltz)
<a name="l00392"></a>00392             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a5d7019720cce40eb336b82b5d0c74f87" title="QM Boltzmann weights.">qmboltz_wts</a> /= sum(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a5d7019720cce40eb336b82b5d0c74f87" title="QM Boltzmann weights.">qmboltz_wts</a>)
<a name="l00393"></a>00393             <span class="comment"># where simply gathers the nonzero values otherwise we get lots of NaNs</span>
<a name="l00394"></a>00394             qbwhere = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a5d7019720cce40eb336b82b5d0c74f87" title="QM Boltzmann weights.">qmboltz_wts</a>[where(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a5d7019720cce40eb336b82b5d0c74f87" title="QM Boltzmann weights.">qmboltz_wts</a>)[0]]
<a name="l00395"></a>00395             <span class="comment"># Compute ze InfoContent!</span>
<a name="l00396"></a>00396             qmboltzent = -sum(qbwhere*log(qbwhere))
<a name="l00397"></a>00397             logger.info(<span class="stringliteral">&quot;Quantum Boltzmann weights are ON, the formula is exp(-b(E_qm-E_mm)),&quot;</span>)
<a name="l00398"></a>00398             logger.info(<span class="stringliteral">&quot;distribution entropy is %.3f, equivalent to %.2f snapshots\n&quot;</span> % (qmboltzent, exp(qmboltzent)))
<a name="l00399"></a>00399             logger.info(<span class="stringliteral">&quot;%.1f%% is mixed into the MM boltzmann weights.\n&quot;</span> % (self.qmboltz*100))
<a name="l00400"></a>00400         <span class="keywordflow">else</span>:
<a name="l00401"></a>00401             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a5d7019720cce40eb336b82b5d0c74f87" title="QM Boltzmann weights.">qmboltz_wts</a> = ones(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a86f4e2b085f139886d54855f432a2672" title="Read in the trajectory file.">ns</a>)
<a name="l00402"></a>00402         <span class="comment"># At this point, self.fqm is a (number of snapshots) x (3 x number of atoms) array.</span>
<a name="l00403"></a>00403         <span class="comment"># Now we can transform it into a (number of snapshots) x (3 x number of residues + 3 x number of residues) array.</span>
<a name="l00404"></a>00404         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad19dc7dc7d2593c143700182dc614435" title="Whether to compute net forces and torques, or not.">use_nft</a>:
<a name="l00405"></a>00405             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#add8cbee2d95e5702d7a0d1538f26539a">nftqm</a> = []
<a name="l00406"></a>00406             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a6b773c8a8a0134fdb4773eff6b23a4b9" title="Reference (QM) forces.">fqm</a>)):
<a name="l00407"></a>00407                 self.nftqm.append(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#afbf86c26158a68cae7460b4106809fdd">compute_netforce_torque</a>(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a112c4e1af07517633c5c149c07c4aa8c">traj</a>.xyzs[i], self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a6b773c8a8a0134fdb4773eff6b23a4b9" title="Reference (QM) forces.">fqm</a>[i]))
<a name="l00408"></a>00408             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#add8cbee2d95e5702d7a0d1538f26539a">nftqm</a> = array(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#add8cbee2d95e5702d7a0d1538f26539a">nftqm</a>)
<a name="l00409"></a>00409             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a89697453350c3013d227c3037608d51f">fref</a> = hstack((self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a6b773c8a8a0134fdb4773eff6b23a4b9" title="Reference (QM) forces.">fqm</a>, self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#add8cbee2d95e5702d7a0d1538f26539a">nftqm</a>))
<a name="l00410"></a>00410         <span class="keywordflow">else</span>:
<a name="l00411"></a>00411             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a89697453350c3013d227c3037608d51f">fref</a> = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a6b773c8a8a0134fdb4773eff6b23a4b9" title="Reference (QM) forces.">fqm</a>
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2d0f465f1988fd6bc611f7de4b59fd04" title="Prepare the temporary directory, by default does nothing.">prepare_temp_directory</a>(self, options, tgt_opts):
<a name="l00414"></a>00414         <span class="stringliteral">&quot;&quot;&quot; Prepare the temporary directory, by default does nothing &quot;&quot;&quot;</span>
<a name="l00415"></a>00415         <span class="keywordflow">return</span>
<a name="l00416"></a>00416         
<a name="l00417"></a>00417     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3260db78e8c174f04a64661c4e5c181c">indicate</a>(self):
<a name="l00418"></a>00418         Headings = [<span class="stringliteral">&quot;Physical Variable&quot;</span>, <span class="stringliteral">&quot;Difference\n(Calc-Ref)&quot;</span>, <span class="stringliteral">&quot;Denominator\n RMS (Ref)&quot;</span>, <span class="stringliteral">&quot; Percent \nDifference&quot;</span>]
<a name="l00419"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2d0f465f1988fd6bc611f7de4b59fd04">00419</a>         Data = OrderedDict([])
<a name="l00420"></a>00420         <span class="keywordflow">if</span> self.energy:
<a name="l00421"></a>00421             Data[<span class="stringliteral">&#39;Energy (kJ/mol)&#39;</span>] = [<span class="stringliteral">&quot;%8.4f&quot;</span> % self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a003717f2442aac7d1067e74b89a14cc7" title="Qualitative Indicator: average energy error (in kJ/mol)">e_err</a>,
<a name="l00422"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3260db78e8c174f04a64661c4e5c181c">00422</a>                                        <span class="stringliteral">&quot;%8.4f&quot;</span> % self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a0fa6ba3ce272657e4f284267b35574ad">e_ref</a>,
<a name="l00423"></a>00423                                        <span class="stringliteral">&quot;%.4f%%&quot;</span> % (self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ac04e91428155e8d5c4a1a14328e9cc99">e_err_pct</a>*100)]
<a name="l00424"></a>00424         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a54baa14272a2312e0fe1b77a0554c0aa">force</a>:
<a name="l00425"></a>00425             Data[<span class="stringliteral">&#39;Gradient (kJ/mol/A)&#39;</span>] = [<span class="stringliteral">&quot;%8.4f&quot;</span> % (self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2df838b5d83710d5d35e3ccccbf7c656" title="Qualitative Indicator: average force error (fractional)">f_err</a>/10),
<a name="l00426"></a>00426                                            <span class="stringliteral">&quot;%8.4f&quot;</span> % (self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a945a7463f68474234fa8fdfe93888ff1">f_ref</a>/10),
<a name="l00427"></a>00427                                            <span class="stringliteral">&quot;%.4f%%&quot;</span> % (self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a0c48a57c247e6afe97fd178e8b5bce0d">f_err_pct</a>*100)]
<a name="l00428"></a>00428             <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad19dc7dc7d2593c143700182dc614435" title="Whether to compute net forces and torques, or not.">use_nft</a>:
<a name="l00429"></a>00429                 Data[<span class="stringliteral">&#39;Net Force (kJ/mol/A)&#39;</span>] = [<span class="stringliteral">&quot;%8.4f&quot;</span> % (self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a6f22f2576168b879342fb60913ffc134">nf_err</a>/10),
<a name="l00430"></a>00430                                                 <span class="stringliteral">&quot;%8.4f&quot;</span> % (self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad83ddb614190a3c3e647060ce3e063ad">nf_ref</a>/10),
<a name="l00431"></a>00431                                                 <span class="stringliteral">&quot;%.4f%%&quot;</span> % (self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a73def1269c075f82fe20dae6117d75bb">nf_err_pct</a>*100)]
<a name="l00432"></a>00432                 Data[<span class="stringliteral">&#39;Torque (kJ/mol/rad)&#39;</span>] = [<span class="stringliteral">&quot;%8.4f&quot;</span> % self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a36857e469f48d8bddbd3b288a92cac10">tq_err</a>,
<a name="l00433"></a>00433                                                <span class="stringliteral">&quot;%8.4f&quot;</span> % self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a35ffa4510b557dd4fbce2cd8276fa09b">tq_ref</a>,
<a name="l00434"></a>00434                                                <span class="stringliteral">&quot;%.4f%%&quot;</span> % (self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a9954395e5bb893da066002238d7dbacd">tq_err_pct</a>*100)]
<a name="l00435"></a>00435         self.printcool_table(data=Data, headings=Headings, color=0)
<a name="l00436"></a>00436 
<a name="l00437"></a>00437     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3d28520925c6dfd179647d0abf7e1368">energy_force_transformer_all</a>(self):
<a name="l00438"></a>00438         M = self.energy_force_driver_all()
<a name="l00439"></a>00439         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a54baa14272a2312e0fe1b77a0554c0aa">force</a>:
<a name="l00440"></a>00440             <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad19dc7dc7d2593c143700182dc614435" title="Whether to compute net forces and torques, or not.">use_nft</a>:
<a name="l00441"></a>00441                 Nfts = []
<a name="l00442"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3d28520925c6dfd179647d0abf7e1368">00442</a>                 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(M)):
<a name="l00443"></a>00443                     Fm  = M[i][1:]
<a name="l00444"></a>00444                     Nft = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#afbf86c26158a68cae7460b4106809fdd">compute_netforce_torque</a>(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a112c4e1af07517633c5c149c07c4aa8c">traj</a>.xyzs[i], Fm)
<a name="l00445"></a>00445                     Nfts.append(Nft)
<a name="l00446"></a>00446                 Nfts = array(Nfts)
<a name="l00447"></a>00447                 <span class="keywordflow">return</span> hstack((M, Nfts))
<a name="l00448"></a>00448             <span class="keywordflow">else</span>:
<a name="l00449"></a>00449                 <span class="keywordflow">return</span> M
<a name="l00450"></a>00450         <span class="keywordflow">else</span>:
<a name="l00451"></a>00451             <span class="keywordflow">return</span> M
<a name="l00452"></a>00452 
<a name="l00453"></a>00453     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a9167da321a9fff748eef5ebe754cc7ca">energy_force_transformer</a>(self,i):
<a name="l00454"></a>00454         M = self.energy_force_driver(i)
<a name="l00455"></a>00455         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a54baa14272a2312e0fe1b77a0554c0aa">force</a>:
<a name="l00456"></a>00456             <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad19dc7dc7d2593c143700182dc614435" title="Whether to compute net forces and torques, or not.">use_nft</a>:
<a name="l00457"></a>00457                 Fm  = M[1:]
<a name="l00458"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a9167da321a9fff748eef5ebe754cc7ca">00458</a>                 Nft = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#afbf86c26158a68cae7460b4106809fdd">compute_netforce_torque</a>(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a112c4e1af07517633c5c149c07c4aa8c">traj</a>.xyzs[i], Fm)
<a name="l00459"></a>00459                 <span class="keywordflow">return</span> hstack((M, Nft))
<a name="l00460"></a>00460             <span class="keywordflow">else</span>:
<a name="l00461"></a>00461                 <span class="keywordflow">return</span> M
<a name="l00462"></a>00462         <span class="keywordflow">else</span>:
<a name="l00463"></a>00463             <span class="keywordflow">return</span> M[0]
<a name="l00464"></a>00464 
<a name="l00465"></a>00465     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a313c848f46579817803c8a3ff100974e" title="LPW 06-30-2013.">get_energy_force_</a>(self, mvals, AGrad=False, AHess=False):
<a name="l00466"></a>00466         <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00467"></a>00467 <span class="stringliteral">        LPW 06-30-2013</span>
<a name="l00468"></a>00468 <span class="stringliteral">        </span>
<a name="l00469"></a>00469 <span class="stringliteral">        This subroutine builds the objective function (and optionally</span>
<a name="l00470"></a>00470 <span class="stringliteral">        its derivatives) from a general simulation software.  This is</span>
<a name="l00471"></a>00471 <span class="stringliteral">        in contrast to using GROMACS-X2, which computes the objective</span>
<a name="l00472"></a>00472 <span class="stringliteral">        function and prints it out; then &#39;get&#39; only needs to call</span>
<a name="l00473"></a>00473 <span class="stringliteral">        GROMACS and read it in.</span>
<a name="l00474"></a>00474 <span class="stringliteral"></span>
<a name="l00475"></a>00475 <span class="stringliteral">        This subroutine interfaces with simulation software &#39;drivers&#39;.</span>
<a name="l00476"></a>00476 <span class="stringliteral">        The driver is only expected to give the energy and forces.</span>
<a name="l00477"></a>00477 <span class="stringliteral"></span>
<a name="l00478"></a>00478 <span class="stringliteral">        Now this subroutine may sound trivial since the objective</span>
<a name="l00479"></a>00479 <span class="stringliteral">        function is simply a least-squares quantity (M-Q)^2 - but</span>
<a name="l00480"></a>00480 <span class="stringliteral">        there are a number of nontrivial considerations.  I will list</span>
<a name="l00481"></a>00481 <span class="stringliteral">        them here.</span>
<a name="l00482"></a>00482 <span class="stringliteral">        </span>
<a name="l00483"></a>00483 <span class="stringliteral">        0) Polytensor formulation: Because there may exist covariance</span>
<a name="l00484"></a>00484 <span class="stringliteral">        between different components of the force (or covariance</span>
<a name="l00485"></a>00485 <span class="stringliteral">        between the energy and the force), we build the objective</span>
<a name="l00486"></a>00486 <span class="stringliteral">        function by taking outer products of vectors that have the</span>
<a name="l00487"></a>00487 <span class="stringliteral">        form [E F_1x F_1y F_1z F_2x F_2y ... ], and then we trace it</span>
<a name="l00488"></a>00488 <span class="stringliteral">        with the inverse of the covariance matrix to get the objective</span>
<a name="l00489"></a>00489 <span class="stringliteral">        function.</span>
<a name="l00490"></a>00490 <span class="stringliteral"></span>
<a name="l00491"></a>00491 <span class="stringliteral">        This version implements both the polytensor formulation and the standard formulation.</span>
<a name="l00492"></a>00492 <span class="stringliteral"></span>
<a name="l00493"></a>00493 <span class="stringliteral">        1) Boltzmann weights and normalization: Each snapshot has its</span>
<a name="l00494"></a>00494 <span class="stringliteral">        own Boltzmann weight, which may or may not be normalized.</span>
<a name="l00495"></a>00495 <span class="stringliteral">        This subroutine does the normalization automatically.</span>
<a name="l00496"></a>00496 <span class="stringliteral">        </span>
<a name="l00497"></a>00497 <span class="stringliteral">        2) Subtracting out the mean energy gap: The zero-point energy</span>
<a name="l00498"></a>00498 <span class="stringliteral">        difference between reference data and simulation is</span>
<a name="l00499"></a>00499 <span class="stringliteral">        meaningless.  This subroutine subtracts it out.</span>
<a name="l00500"></a>00500 <span class="stringliteral">        </span>
<a name="l00501"></a>00501 <span class="stringliteral">        3) Hybrid ensembles: This program builds a combined objective</span>
<a name="l00502"></a>00502 <span class="stringliteral">        function from both MM and QM ensembles, which is rigorously</span>
<a name="l00503"></a>00503 <span class="stringliteral">        better than using a single ensemble.</span>
<a name="l00504"></a>00504 <span class="stringliteral"></span>
<a name="l00505"></a>00505 <span class="stringliteral">        Note that this subroutine does not do EVERYTHING that</span>
<a name="l00506"></a>00506 <span class="stringliteral">        GROMACS-X2 can do, which includes:</span>
<a name="l00507"></a>00507 <span class="stringliteral">        </span>
<a name="l00508"></a>00508 <span class="stringliteral">        1) Internal coordinate systems</span>
<a name="l00509"></a>00509 <span class="stringliteral">        2) &#39;Sampling correction&#39; (deprecated, since it doesn&#39;t seem to work)</span>
<a name="l00510"></a>00510 <span class="stringliteral">        3) Analytic derivatives</span>
<a name="l00511"></a>00511 <span class="stringliteral">        </span>
<a name="l00512"></a>00512 <span class="stringliteral">        In the previous code (ForTune) this subroutine used analytic</span>
<a name="l00513"></a>00513 <span class="stringliteral">        first derivatives of the energy and force to build the</span>
<a name="l00514"></a>00514 <span class="stringliteral">        derivatives of the objective function.  Here I will take a</span>
<a name="l00515"></a>00515 <span class="stringliteral">        simplified approach, because building the derivatives are</span>
<a name="l00516"></a>00516 <span class="stringliteral">        cumbersome.  For now we will return the objective function</span>
<a name="l00517"></a>00517 <span class="stringliteral">        ONLY.  A two-point central difference should give us the first</span>
<a name="l00518"></a>00518 <span class="stringliteral">        and diagonal second derivative anyhow.</span>
<a name="l00519"></a>00519 <span class="stringliteral"></span>
<a name="l00520"></a>00520 <span class="stringliteral">        @todo Parallelization over snapshots is not implemented yet</span>
<a name="l00521"></a>00521 <span class="stringliteral"></span>
<a name="l00522"></a>00522 <span class="stringliteral">        @param[in] mvals Mathematical parameter values</span>
<a name="l00523"></a>00523 <span class="stringliteral">        @param[in] AGrad Switch to turn on analytic gradient</span>
<a name="l00524"></a>00524 <span class="stringliteral">        @param[in] AHess Switch to turn on analytic Hessian</span>
<a name="l00525"></a>00525 <span class="stringliteral">        @return Answer Contribution to the objective function</span>
<a name="l00526"></a>00526 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00527"></a>00527         cv = self.covariance <span class="comment"># Whether covariance matrix is turned on</span>
<a name="l00528"></a>00528         <span class="keywordflow">if</span> cv <span class="keywordflow">and</span> (AGrad <span class="keywordflow">or</span> AHess):
<a name="l00529"></a>00529             <a class="code" href="namespaceforcebalance_1_1nifty.html#abb8f59044961a12588e0653c2baa8b01">warn_press_key</a>(<span class="stringliteral">&quot;Covariance is turned on, gradients requested but not implemented (will skip over grad.)&quot;</span>)
<a name="l00530"></a>00530         Answer = {}
<a name="l00531"></a>00531         <span class="comment"># Create the new force field!!</span>
<a name="l00532"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab4468582c2c010bec490e65a34cdc40a">00532</a>         pvals = self.FF.make(mvals)
<a name="l00533"></a>00533 
<a name="l00534"></a>00534         <span class="comment">#======================================#</span>
<a name="l00535"></a>00535         <span class="comment">#   Copied from the old ForTune code   #</span>
<a name="l00536"></a>00536         <span class="comment">#======================================#</span>
<a name="l00537"></a>00537         NC   = 3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>
<a name="l00538"></a>00538         NCP1 = 3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>+1
<a name="l00539"></a>00539         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad19dc7dc7d2593c143700182dc614435" title="Whether to compute net forces and torques, or not.">use_nft</a>:
<a name="l00540"></a>00540             NCP1 += 3*(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa4eadda3b8377b783dec2d327cb66fa6">nnf</a> + self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a88902db5981ca2088a7cf47f5f9aa83a">ntq</a>)
<a name="l00541"></a>00541         np   = self.FF.np
<a name="l00542"></a>00542         ns   = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a86f4e2b085f139886d54855f432a2672" title="Read in the trajectory file.">ns</a>
<a name="l00543"></a>00543         <span class="comment">#==============================================================#</span>
<a name="l00544"></a>00544         <span class="comment"># Note: Because of hybrid ensembles, we form two separate      #</span>
<a name="l00545"></a>00545         <span class="comment"># objective functions.  This means the code is (trivially)     #</span>
<a name="l00546"></a>00546         <span class="comment"># doubled in length because there are two sets of Boltzmann    #</span>
<a name="l00547"></a>00547         <span class="comment"># weights.  In principle I could write a general subroutine    #</span>
<a name="l00548"></a>00548         <span class="comment"># for a single set of Boltzmann weights and call it twice, but #</span>
<a name="l00549"></a>00549         <span class="comment"># that would require me to loop over the snapshots twice.      #</span>
<a name="l00550"></a>00550         <span class="comment"># However, after the loop over snapshots, the subroutine that  #</span>
<a name="l00551"></a>00551         <span class="comment"># builds the objective function (build_objective, above) is    #</span>
<a name="l00552"></a>00552         <span class="comment"># called twice using the MM-ensemble and QM-ensemble           #</span>
<a name="l00553"></a>00553         <span class="comment"># variables.                                                   #</span>
<a name="l00554"></a>00554         <span class="comment">#                                                              #</span>
<a name="l00555"></a>00555         <span class="comment">#            STEP 1: Form all of the arrays.                   #</span>
<a name="l00556"></a>00556         <span class="comment">#                                                              #</span>
<a name="l00557"></a>00557         <span class="comment"># An explanation of variable names follows.                    #</span>
<a name="l00558"></a>00558         <span class="comment"># Z(Y)  = The partition function in the MM (QM) ensemble       #</span>
<a name="l00559"></a>00559         <span class="comment"># M0_M  = The mean of the MM values in the MM ensemble         #</span>
<a name="l00560"></a>00560         <span class="comment"># QQ_Q  = The unnormalized expected value of &lt;Q(X)Q&gt;           #</span>
<a name="l00561"></a>00561         <span class="comment"># Later on we divide these quantities by Z to normalize,       #</span>
<a name="l00562"></a>00562         <span class="comment"># and optionally Q0(X)Q0 is subtracted from QQ to get the      #</span>
<a name="l00563"></a>00563         <span class="comment"># covariance.                                                  #</span>
<a name="l00564"></a>00564         <span class="comment">#==============================================================#</span>
<a name="l00565"></a>00565         <span class="keywordflow">if</span> (self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab8c3b9a3e74ced53cc5f4e6f3c6c06ef">w_energy</a> == 0.0 <span class="keywordflow">and</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2f68f2c95e481c03e05b03d55851107f">w_force</a> == 0.0 <span class="keywordflow">and</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa9fa8ad127d442e9b545088eb741b9eb">w_netforce</a> == 0.0 <span class="keywordflow">and</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab4468582c2c010bec490e65a34cdc40a">w_torque</a> == 0.0):
<a name="l00566"></a>00566             AGrad = <span class="keyword">False</span>
<a name="l00567"></a>00567             AHess = <span class="keyword">False</span>
<a name="l00568"></a>00568         Z       = 0.0
<a name="l00569"></a>00569         Y       = 0.0
<a name="l00570"></a>00570         <span class="comment"># The average force / net force per atom in kJ/mol/nm. (Added LPW 6/30)</span>
<a name="l00571"></a>00571         <span class="comment"># Torques are in kj/mol/nm x nm.</span>
<a name="l00572"></a>00572         qF_M     = 0
<a name="l00573"></a>00573         qN_M     = 0
<a name="l00574"></a>00574         qT_M     = 0
<a name="l00575"></a>00575         qF_Q     = 0
<a name="l00576"></a>00576         qN_Q     = 0
<a name="l00577"></a>00577         qT_Q     = 0
<a name="l00578"></a>00578         dF_M     = 0
<a name="l00579"></a>00579         dN_M     = 0
<a name="l00580"></a>00580         dT_M     = 0
<a name="l00581"></a>00581         dF_Q     = 0
<a name="l00582"></a>00582         dN_Q     = 0
<a name="l00583"></a>00583         dT_Q     = 0
<a name="l00584"></a>00584         Q = zeros(NCP1,dtype=float)
<a name="l00585"></a>00585         <span class="comment"># Mean quantities</span>
<a name="l00586"></a>00586         M0_M    = zeros(NCP1,dtype=float)
<a name="l00587"></a>00587         Q0_M    = zeros(NCP1,dtype=float)
<a name="l00588"></a>00588         M0_Q    = zeros(NCP1,dtype=float)
<a name="l00589"></a>00589         Q0_Q    = zeros(NCP1,dtype=float)
<a name="l00590"></a>00590         <span class="keywordflow">if</span> cv:
<a name="l00591"></a>00591             QQ_M    = zeros((NCP1,NCP1),dtype=float)
<a name="l00592"></a>00592             QQ_Q    = zeros((NCP1,NCP1),dtype=float)
<a name="l00593"></a>00593             <span class="comment">#==============================================================#</span>
<a name="l00594"></a>00594             <span class="comment"># Objective function polytensors: This is formed in a loop     #</span>
<a name="l00595"></a>00595             <span class="comment"># over snapshots by taking the outer product (Q-M)(X)(Q-M),    #</span>
<a name="l00596"></a>00596             <span class="comment"># multiplying by the Boltzmann weight, and then summing.       #</span>
<a name="l00597"></a>00597             <span class="comment">#==============================================================#</span>
<a name="l00598"></a>00598             SPiXi = zeros((NCP1,NCP1),dtype=float)
<a name="l00599"></a>00599             SRiXi = zeros((NCP1,NCP1),dtype=float)
<a name="l00600"></a>00600         <span class="keywordflow">else</span>:
<a name="l00601"></a>00601             <span class="comment"># Derivatives</span>
<a name="l00602"></a>00602             M_p     = zeros((np,NCP1),dtype=float)
<a name="l00603"></a>00603             M_pp    = zeros((np,NCP1),dtype=float)
<a name="l00604"></a>00604             X0_M    = zeros(NCP1,dtype=float)
<a name="l00605"></a>00605             QQ_M    = zeros(NCP1,dtype=float)
<a name="l00606"></a>00606             X0_Q    = zeros(NCP1,dtype=float)
<a name="l00607"></a>00607             Q0_Q    = zeros(NCP1,dtype=float)
<a name="l00608"></a>00608             QQ_Q    = zeros(NCP1,dtype=float)
<a name="l00609"></a>00609             <span class="comment"># Means of gradients</span>
<a name="l00610"></a>00610             M0_M_p  = zeros((np,NCP1),dtype=float)
<a name="l00611"></a>00611             M0_Q_p  = zeros((np,NCP1),dtype=float)
<a name="l00612"></a>00612             M0_M_pp = zeros((np,NCP1),dtype=float)
<a name="l00613"></a>00613             M0_Q_pp = zeros((np,NCP1),dtype=float)
<a name="l00614"></a>00614             <span class="comment"># Objective functions</span>
<a name="l00615"></a>00615             SPiXi = zeros(NCP1,dtype=float)
<a name="l00616"></a>00616             SRiXi = zeros(NCP1,dtype=float)
<a name="l00617"></a>00617             <span class="keywordflow">if</span> AGrad:
<a name="l00618"></a>00618                 SPiXi_p = zeros((np,NCP1),dtype=float)
<a name="l00619"></a>00619                 SRiXi_p = zeros((np,NCP1),dtype=float)
<a name="l00620"></a>00620                 X2_M_p = zeros(np,dtype=float)
<a name="l00621"></a>00621                 X2_Q_p = zeros(np,dtype=float)
<a name="l00622"></a>00622             <span class="keywordflow">if</span> AHess:
<a name="l00623"></a>00623                 SPiXi_pq = zeros((np,np,NCP1),dtype=float)
<a name="l00624"></a>00624                 SRiXi_pq = zeros((np,np,NCP1),dtype=float)
<a name="l00625"></a>00625                 X2_M_pq = zeros((np,np),dtype=float)
<a name="l00626"></a>00626                 X2_Q_pq = zeros((np,np),dtype=float)
<a name="l00627"></a>00627             M_all = zeros((ns,NCP1),dtype=float)
<a name="l00628"></a>00628             <span class="keywordflow">if</span> AGrad <span class="keywordflow">and</span> self.all_at_once:
<a name="l00629"></a>00629                 dM_all = zeros((ns,np,NCP1),dtype=float)
<a name="l00630"></a>00630                 ddM_all = zeros((ns,np,NCP1),dtype=float)
<a name="l00631"></a>00631         QBN = dot(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a5d7019720cce40eb336b82b5d0c74f87" title="QM Boltzmann weights.">qmboltz_wts</a>[:ns],self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae5c60f421336c2ecb716be16b8d51fdf" title="Initialize the base class.">whamboltz_wts</a>[:ns])
<a name="l00632"></a>00632         <span class="comment">#==============================================================#</span>
<a name="l00633"></a>00633         <span class="comment">#             STEP 2: Loop through the snapshots.              #</span>
<a name="l00634"></a>00634         <span class="comment">#==============================================================#</span>
<a name="l00635"></a>00635         <span class="keywordflow">if</span> self.all_at_once:
<a name="l00636"></a>00636             logger.info(<span class="stringliteral">&quot;\rExecuting\r&quot;</span>)
<a name="l00637"></a>00637             M_all = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3d28520925c6dfd179647d0abf7e1368">energy_force_transformer_all</a>()
<a name="l00638"></a>00638             <span class="keywordflow">if</span> <span class="keywordflow">not</span> cv <span class="keywordflow">and</span> (AGrad <span class="keywordflow">or</span> AHess):
<a name="l00639"></a>00639                 <span class="keyword">def </span>callM(mvals_):
<a name="l00640"></a>00640                     logger.info(<span class="stringliteral">&quot;\r&quot;</span>)
<a name="l00641"></a>00641                     pvals = self.FF.make(mvals_)
<a name="l00642"></a>00642                     <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3d28520925c6dfd179647d0abf7e1368">energy_force_transformer_all</a>()
<a name="l00643"></a>00643                 <span class="keywordflow">for</span> p <span class="keywordflow">in</span> range(np):
<a name="l00644"></a>00644                     dM_all[:,p,:], ddM_all[:,p,:] = <a class="code" href="namespaceforcebalance_1_1finite__difference.html#aa69a8819e4680091f400303c1d6ddeb7" title="A three-point finite difference stencil.">f12d3p</a>(<a class="code" href="namespaceforcebalance_1_1finite__difference.html#ae484c591ae8c4e5bae73a0ef2660c339" title="A function wrapper for finite difference designed for differentiating &#39;get&#39;-type functions.">fdwrap</a>(callM, mvals, p), h = self.h, f0 = M_all)
<a name="l00645"></a>00645         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(ns):
<a name="l00646"></a>00646             <span class="keywordflow">if</span> i % 100 == 0:
<a name="l00647"></a>00647                 logger.info(<span class="stringliteral">&quot;\rIncrementing quantities for snapshot %i\r&quot;</span> % i)
<a name="l00648"></a>00648             <span class="comment"># Build Boltzmann weights and increment partition function.</span>
<a name="l00649"></a>00649             P   = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae5c60f421336c2ecb716be16b8d51fdf" title="Initialize the base class.">whamboltz_wts</a>[i]
<a name="l00650"></a>00650             Z  += P
<a name="l00651"></a>00651             R   = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a5d7019720cce40eb336b82b5d0c74f87" title="QM Boltzmann weights.">qmboltz_wts</a>[i]*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae5c60f421336c2ecb716be16b8d51fdf" title="Initialize the base class.">whamboltz_wts</a>[i] / QBN
<a name="l00652"></a>00652             Y  += R
<a name="l00653"></a>00653             <span class="comment"># Recall reference (QM) data</span>
<a name="l00654"></a>00654             Q[0] = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a621b8b2fb62435de36c6895ba6ea09aa" title="Reference (QM) energies.">eqm</a>[i]
<a name="l00655"></a>00655             <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a54baa14272a2312e0fe1b77a0554c0aa">force</a>:
<a name="l00656"></a>00656                 Q[1:] = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a89697453350c3013d227c3037608d51f">fref</a>[i,:].copy()
<a name="l00657"></a>00657             <span class="comment"># Increment the average quantities.</span>
<a name="l00658"></a>00658             <span class="keywordflow">if</span> cv:
<a name="l00659"></a>00659                 QQ     = outer(Q,Q)
<a name="l00660"></a>00660             <span class="keywordflow">else</span>:
<a name="l00661"></a>00661                 QQ     = Q*Q
<a name="l00662"></a>00662             <span class="comment"># Call the simulation software to get the MM quantities.</span>
<a name="l00663"></a>00663             <span class="keywordflow">if</span> self.all_at_once:
<a name="l00664"></a>00664                 M = M_all[i]
<a name="l00665"></a>00665             <span class="keywordflow">else</span>:
<a name="l00666"></a>00666                 <span class="keywordflow">if</span> i % 100 == 0:
<a name="l00667"></a>00667                     logger.info(<span class="stringliteral">&quot;Shot %i\r&quot;</span> % i)
<a name="l00668"></a>00668                 M = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a9167da321a9fff748eef5ebe754cc7ca">energy_force_transformer</a>(i)
<a name="l00669"></a>00669                 M_all[i,:] = M.copy()
<a name="l00670"></a>00670             <span class="keywordflow">if</span> <span class="keywordflow">not</span> cv:
<a name="l00671"></a>00671                 X     = M-Q
<a name="l00672"></a>00672             <span class="comment"># Increment the average values.</span>
<a name="l00673"></a>00673             <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a54baa14272a2312e0fe1b77a0554c0aa">force</a>:
<a name="l00674"></a>00674                 dfrcarray = mean(array([linalg.norm(M[1+3*j:1+3*j+3] - Q[1+3*j:1+3*j+3]) <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>)]))
<a name="l00675"></a>00675                 qfrcarray = mean(array([linalg.norm(Q[1+3*j:1+3*j+3]) <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>)]))
<a name="l00676"></a>00676                 dF_M    += P*dfrcarray
<a name="l00677"></a>00677                 dF_Q    += R*dfrcarray
<a name="l00678"></a>00678                 qF_M    += P*qfrcarray
<a name="l00679"></a>00679                 qF_Q    += R*qfrcarray
<a name="l00680"></a>00680                 <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad19dc7dc7d2593c143700182dc614435" title="Whether to compute net forces and torques, or not.">use_nft</a>:
<a name="l00681"></a>00681                     dnfrcarray = mean(array([linalg.norm(M[1+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>+3*j:1+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>+3*j+3] - Q[1+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>+3*j:1+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>+3*j+3]) <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa4eadda3b8377b783dec2d327cb66fa6">nnf</a>)]))
<a name="l00682"></a>00682                     qnfrcarray = mean(array([linalg.norm(Q[1+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>+3*j:1+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>+3*j+3]) <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa4eadda3b8377b783dec2d327cb66fa6">nnf</a>)]))
<a name="l00683"></a>00683                     dN_M    += P*dnfrcarray
<a name="l00684"></a>00684                     dN_Q    += R*dnfrcarray
<a name="l00685"></a>00685                     qN_M    += P*qnfrcarray
<a name="l00686"></a>00686                     qN_Q    += R*qnfrcarray
<a name="l00687"></a>00687                     dtrqarray = mean(array([linalg.norm(M[1+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa4eadda3b8377b783dec2d327cb66fa6">nnf</a>+3*j:1+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa4eadda3b8377b783dec2d327cb66fa6">nnf</a>+3*j+3] - Q[1+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa4eadda3b8377b783dec2d327cb66fa6">nnf</a>+3*j:1+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa4eadda3b8377b783dec2d327cb66fa6">nnf</a>+3*j+3]) <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a88902db5981ca2088a7cf47f5f9aa83a">ntq</a>)]))
<a name="l00688"></a>00688                     qtrqarray = mean(array([linalg.norm(Q[1+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa4eadda3b8377b783dec2d327cb66fa6">nnf</a>+3*j:1+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>+3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa4eadda3b8377b783dec2d327cb66fa6">nnf</a>+3*j+3]) <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a88902db5981ca2088a7cf47f5f9aa83a">ntq</a>)]))
<a name="l00689"></a>00689                     dT_M    += P*dtrqarray
<a name="l00690"></a>00690                     dT_Q    += R*dtrqarray
<a name="l00691"></a>00691                     qT_M    += P*qtrqarray
<a name="l00692"></a>00692                     qT_Q    += R*qtrqarray
<a name="l00693"></a>00693             <span class="comment"># The [0] indicates that we are fitting the RMS force and not the RMSD</span>
<a name="l00694"></a>00694             <span class="comment"># (without the covariance, subtracting a mean force doesn&#39;t make sense.)</span>
<a name="l00695"></a>00695             M0_M[0] += P*M[0]
<a name="l00696"></a>00696             M0_Q[0] += R*M[0]
<a name="l00697"></a>00697             Q0_M[0] += P*Q[0]
<a name="l00698"></a>00698             Q0_Q[0] += R*Q[0]
<a name="l00699"></a>00699             QQ_M += P*QQ
<a name="l00700"></a>00700             QQ_Q += R*QQ
<a name="l00701"></a>00701             <span class="keywordflow">if</span> <span class="keywordflow">not</span> cv:
<a name="l00702"></a>00702                 X0_M[0] += P*X[0]
<a name="l00703"></a>00703                 X0_Q[0] += R*X[0]
<a name="l00704"></a>00704             <span class="comment"># Increment the objective function.</span>
<a name="l00705"></a>00705             <span class="keywordflow">if</span> cv:
<a name="l00706"></a>00706                 Xi  = outer(M,M) - 2*outer(Q,M) + outer(Q,Q)
<a name="l00707"></a>00707             <span class="keywordflow">else</span>:
<a name="l00708"></a>00708                 Xi     = X**2                   
<a name="l00709"></a>00709             SPiXi += P * Xi
<a name="l00710"></a>00710             SRiXi += R * Xi
<a name="l00711"></a>00711             <span class="comment">#==============================================================#</span>
<a name="l00712"></a>00712             <span class="comment">#      STEP 2a: Increment gradients and mean quantities.       #</span>
<a name="l00713"></a>00713             <span class="comment">#   This is only implemented for the case without covariance.  #</span>
<a name="l00714"></a>00714             <span class="comment">#==============================================================#</span>
<a name="l00715"></a>00715             <span class="keywordflow">if</span> <span class="keywordflow">not</span> cv:
<a name="l00716"></a>00716                 <span class="keywordflow">for</span> p <span class="keywordflow">in</span> range(np):
<a name="l00717"></a>00717                     <span class="keywordflow">if</span> <span class="keywordflow">not</span> AGrad: <span class="keywordflow">continue</span>
<a name="l00718"></a>00718                     <span class="keywordflow">if</span> self.all_at_once:
<a name="l00719"></a>00719                         M_p[p] = dM_all[i, p]
<a name="l00720"></a>00720                         M_pp[p] = ddM_all[i, p]
<a name="l00721"></a>00721                     <span class="keywordflow">else</span>:
<a name="l00722"></a>00722                         <span class="keyword">def </span>callM(mvals_):
<a name="l00723"></a>00723                             <span class="keywordflow">if</span> i % 100 == 0:
<a name="l00724"></a>00724                                 logger.info(<span class="stringliteral">&quot;\r&quot;</span>)
<a name="l00725"></a>00725                             pvals = self.FF.make(mvals_)
<a name="l00726"></a>00726                             <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a9167da321a9fff748eef5ebe754cc7ca">energy_force_transformer</a>(i)
<a name="l00727"></a>00727                         M_p[p],M_pp[p] = <a class="code" href="namespaceforcebalance_1_1finite__difference.html#aa69a8819e4680091f400303c1d6ddeb7" title="A three-point finite difference stencil.">f12d3p</a>(<a class="code" href="namespaceforcebalance_1_1finite__difference.html#ae484c591ae8c4e5bae73a0ef2660c339" title="A function wrapper for finite difference designed for differentiating &#39;get&#39;-type functions.">fdwrap</a>(callM, mvals, p), h = self.h, f0 = M)
<a name="l00728"></a>00728                     <span class="comment"># The [0] indicates that we are fitting the RMS force and not the RMSD</span>
<a name="l00729"></a>00729                     <span class="comment"># (without the covariance, subtracting a mean force doesn&#39;t make sense.)</span>
<a name="l00730"></a>00730                     M0_M_p[p][0]  += P * M_p[p][0]
<a name="l00731"></a>00731                     M0_Q_p[p][0]  += R * M_p[p][0]
<a name="l00732"></a>00732                     <span class="comment">#M0_M_pp[p][0] += P * M_pp[p][0]</span>
<a name="l00733"></a>00733                     <span class="comment">#M0_Q_pp[p][0] += R * M_pp[p][0]</span>
<a name="l00734"></a>00734                     Xi_p        = 2 * X * M_p[p]
<a name="l00735"></a>00735                     SPiXi_p[p] += P * Xi_p
<a name="l00736"></a>00736                     SRiXi_p[p] += R * Xi_p
<a name="l00737"></a>00737                     <span class="keywordflow">if</span> <span class="keywordflow">not</span> AHess: <span class="keywordflow">continue</span>
<a name="l00738"></a>00738                     <span class="keywordflow">if</span> self.all_at_once:
<a name="l00739"></a>00739                         M_pp[p] = ddM_all[i, p]
<a name="l00740"></a>00740                     <span class="comment"># This formula is more correct, but perhapsively convergence is slower.</span>
<a name="l00741"></a>00741                     <span class="comment">#Xi_pq       = 2 * (M_p[p] * M_p[p] + X * M_pp[p])</span>
<a name="l00742"></a>00742                     <span class="comment"># Gauss-Newton formula for approximate Hessian</span>
<a name="l00743"></a>00743                     Xi_pq       = 2 * (M_p[p] * M_p[p])
<a name="l00744"></a>00744                     SPiXi_pq[p,p] += P * Xi_pq
<a name="l00745"></a>00745                     SRiXi_pq[p,p] += R * Xi_pq
<a name="l00746"></a>00746                     <span class="keywordflow">for</span> q <span class="keywordflow">in</span> range(p):
<a name="l00747"></a>00747                         Xi_pq          = 2 * M_p[p] * M_p[q]
<a name="l00748"></a>00748                         SPiXi_pq[p,q] += P * Xi_pq
<a name="l00749"></a>00749                         SRiXi_pq[p,q] += R * Xi_pq
<a name="l00750"></a>00750 
<a name="l00751"></a>00751         <span class="comment"># Dump energies and forces to disk.</span>
<a name="l00752"></a>00752         M_all_print = M_all.copy()
<a name="l00753"></a>00753         <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.absolute:
<a name="l00754"></a>00754             M_all_print[:,0] -= mean(M_all_print[:,0])
<a name="l00755"></a>00755         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a54baa14272a2312e0fe1b77a0554c0aa">force</a>:
<a name="l00756"></a>00756             Q_all_print = hstack((<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a621b8b2fb62435de36c6895ba6ea09aa" title="Reference (QM) energies.">eqm</a>),self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a89697453350c3013d227c3037608d51f">fref</a>))
<a name="l00757"></a>00757         <span class="keywordflow">else</span>:
<a name="l00758"></a>00758             Q_all_print = <a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a621b8b2fb62435de36c6895ba6ea09aa" title="Reference (QM) energies.">eqm</a>)
<a name="l00759"></a>00759         <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.absolute:
<a name="l00760"></a>00760             Q_all_print[:,0] -= mean(Q_all_print[:,0])
<a name="l00761"></a>00761         <span class="keywordflow">if</span> self.writelevel &gt; 1:
<a name="l00762"></a>00762             savetxt(<span class="stringliteral">&#39;M.txt&#39;</span>,M_all_print)
<a name="l00763"></a>00763             savetxt(<span class="stringliteral">&#39;Q.txt&#39;</span>,Q_all_print)
<a name="l00764"></a>00764         EnergyComparison = hstack((<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(Q_all_print[:,0]),<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(M_all_print[:,0])))
<a name="l00765"></a>00765         <span class="keywordflow">if</span> self.writelevel &gt; 0:
<a name="l00766"></a>00766             savetxt(<span class="stringliteral">&#39;QM-vs-MM-energies.txt&#39;</span>,EnergyComparison)
<a name="l00767"></a>00767         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a54baa14272a2312e0fe1b77a0554c0aa">force</a>:
<a name="l00768"></a>00768             <span class="comment"># Write .xyz files which can be viewed in vmd.</span>
<a name="l00769"></a>00769             <span class="keywordflow">try</span>:
<a name="l00770"></a>00770                 <span class="comment"># Only print forces on true atoms, and ignore virtual sites.</span>
<a name="l00771"></a>00771                 TrueAtoms = array([i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a112c4e1af07517633c5c149c07c4aa8c">traj</a>.na) <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3eceb701813ccb83d11a0dc71df835b7" title="This is a default-dict containing a number of atom-wise lists, such as the residue number of each ato...">AtomLists</a>[<span class="stringliteral">&#39;ParticleType&#39;</span>][i] == <span class="stringliteral">&#39;A&#39;</span>])
<a name="l00772"></a>00772             <span class="keywordflow">except</span>:
<a name="l00773"></a>00773                 TrueAtoms = arange(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a112c4e1af07517633c5c149c07c4aa8c">traj</a>.na)
<a name="l00774"></a>00774             QMTraj = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a112c4e1af07517633c5c149c07c4aa8c">traj</a>[:].atom_select(TrueAtoms)
<a name="l00775"></a>00775             Mforce_obj = QMTraj[:]
<a name="l00776"></a>00776             Qforce_obj = QMTraj[:]
<a name="l00777"></a>00777             Mforce_print = array(M_all_print[:,1:3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>+1])
<a name="l00778"></a>00778             Qforce_print = array(Q_all_print[:,1:3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>+1])
<a name="l00779"></a>00779             Dforce_norm = array([linalg.norm(Mforce_print[i,:] - Qforce_print[i,:]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(ns)])
<a name="l00780"></a>00780             MaxComp = max(abs(vstack((Mforce_print,Qforce_print)).flatten()))
<a name="l00781"></a>00781             Mforce_print /= MaxComp
<a name="l00782"></a>00782             Qforce_print /= MaxComp
<a name="l00783"></a>00783             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(ns):
<a name="l00784"></a>00784                 Mforce_obj.xyzs[i] = Mforce_print[i, :].reshape(-1,3)
<a name="l00785"></a>00785                 Qforce_obj.xyzs[i] = Qforce_print[i, :].reshape(-1,3)
<a name="l00786"></a>00786             <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a> &lt; self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a45edac867fa720c26a6f959c3dd5a139" title="The number of atoms in the QM calculation (Irrelevant if not fitting forces)">qmatoms</a>:
<a name="l00787"></a>00787                 Fpad = zeros((self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a45edac867fa720c26a6f959c3dd5a139" title="The number of atoms in the QM calculation (Irrelevant if not fitting forces)">qmatoms</a> - self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>, 3),dtype=float)
<a name="l00788"></a>00788                 Mforce_obj.xyzs[i] = vstack((Mforce_obj.xyzs[i], Fpad))
<a name="l00789"></a>00789                 Qforce_obj.xyzs[i] = vstack((Qforce_obj.xyzs[i], Fpad))
<a name="l00790"></a>00790             <span class="keywordflow">if</span> Mforce_obj.na != Mforce_obj.xyzs[0].shape[0]:
<a name="l00791"></a>00791                 <a class="code" href="namespaceforcebalance_1_1nifty.html#a26e563ec71ed229c30f3d61d3448c8f1" title="Prints a warning but will only do so once in a given run.">warn_once</a>(<span class="stringliteral">&#39;\x1b[91mThe printing of forces is not set up correctly.  Not printing forces.  Please report this issue.\x1b[0m&#39;</span>)
<a name="l00792"></a>00792             <span class="keywordflow">else</span>:
<a name="l00793"></a>00793                 <span class="keywordflow">if</span> self.writelevel &gt; 1:
<a name="l00794"></a>00794                     QMTraj.write(<span class="stringliteral">&#39;coords.xyz&#39;</span>)
<a name="l00795"></a>00795                     Mforce_obj.elem = [<span class="stringliteral">&#39;H&#39;</span> <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(Mforce_obj.na)]
<a name="l00796"></a>00796                     Mforce_obj.write(<span class="stringliteral">&#39;MMforce.xyz&#39;</span>)
<a name="l00797"></a>00797                     Qforce_obj.elem = [<span class="stringliteral">&#39;H&#39;</span> <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(Qforce_obj.na)]
<a name="l00798"></a>00798                     Qforce_obj.write(<span class="stringliteral">&#39;QMforce.xyz&#39;</span>)
<a name="l00799"></a>00799                 <span class="comment">#savetxt(&#39;Dforce_norm.dat&#39;, Dforce_norm)</span>
<a name="l00800"></a>00800                 <span class="keywordflow">if</span> self.writelevel &gt; 0:
<a name="l00801"></a>00801                     savetxt(<span class="stringliteral">&#39;Dforce_norm.dat&#39;</span>, Dforce_norm)
<a name="l00802"></a>00802 
<a name="l00803"></a>00803 
<a name="l00804"></a>00804         <span class="comment">#==============================================================#</span>
<a name="l00805"></a>00805         <span class="comment">#    STEP 3: Build the (co)variance matrix and invert it.      #</span>
<a name="l00806"></a>00806         <span class="comment"># In the case of no covariance, this is just a diagonal matrix #</span>
<a name="l00807"></a>00807         <span class="comment"># with the RMSD energy in [0,0] and the RMS gradient in [n, n] #</span>
<a name="l00808"></a>00808         <span class="comment">#==============================================================#</span>
<a name="l00809"></a>00809         logger.info(<span class="stringliteral">&quot;Done with snapshots, building objective function now\r&quot;</span>)
<a name="l00810"></a>00810         <span class="keywordflow">if</span> (self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab8c3b9a3e74ced53cc5f4e6f3c6c06ef">w_energy</a> &gt; 0.0 <span class="keywordflow">or</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2f68f2c95e481c03e05b03d55851107f">w_force</a> &gt; 0.0 <span class="keywordflow">or</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa9fa8ad127d442e9b545088eb741b9eb">w_netforce</a> &gt; 0.0 <span class="keywordflow">or</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab4468582c2c010bec490e65a34cdc40a">w_torque</a> &gt; 0.0):
<a name="l00811"></a>00811             wtot    = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab8c3b9a3e74ced53cc5f4e6f3c6c06ef">w_energy</a> + self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2f68f2c95e481c03e05b03d55851107f">w_force</a> + self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa9fa8ad127d442e9b545088eb741b9eb">w_netforce</a> + self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab4468582c2c010bec490e65a34cdc40a">w_torque</a>
<a name="l00812"></a>00812             EWt     = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab8c3b9a3e74ced53cc5f4e6f3c6c06ef">w_energy</a> / wtot
<a name="l00813"></a>00813             FWt     = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2f68f2c95e481c03e05b03d55851107f">w_force</a> / wtot
<a name="l00814"></a>00814             NWt     = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa9fa8ad127d442e9b545088eb741b9eb">w_netforce</a> / wtot
<a name="l00815"></a>00815             TWt     = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab4468582c2c010bec490e65a34cdc40a">w_torque</a> / wtot
<a name="l00816"></a>00816         <span class="keywordflow">else</span>:
<a name="l00817"></a>00817             EWt = 0.0
<a name="l00818"></a>00818             FWt = 0.0
<a name="l00819"></a>00819             NWt = 0.0
<a name="l00820"></a>00820             TWt = 0.0
<a name="l00821"></a>00821         <span class="comment"># Build the weight vector/matrix, so the force contribution is suppressed by 1/3N</span>
<a name="l00822"></a>00822         <span class="keywordflow">if</span> cv:
<a name="l00823"></a>00823             WM      = zeros((NCP1,NCP1),dtype=float)
<a name="l00824"></a>00824             WM[0,0] = sqrt(EWt)
<a name="l00825"></a>00825             start   = 1
<a name="l00826"></a>00826             block   = 3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>
<a name="l00827"></a>00827             end     = start + block
<a name="l00828"></a>00828             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(start, end):
<a name="l00829"></a>00829                 WM[i, i] = sqrt(FWt / block)
<a name="l00830"></a>00830             <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad19dc7dc7d2593c143700182dc614435" title="Whether to compute net forces and torques, or not.">use_nft</a>:
<a name="l00831"></a>00831                 start   = end
<a name="l00832"></a>00832                 block   = 3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa4eadda3b8377b783dec2d327cb66fa6">nnf</a>
<a name="l00833"></a>00833                 end     = start + block
<a name="l00834"></a>00834                 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(start, end):
<a name="l00835"></a>00835                     WM[i, i] = sqrt(NWt / block)
<a name="l00836"></a>00836                 start   = end
<a name="l00837"></a>00837                 block   = 3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a88902db5981ca2088a7cf47f5f9aa83a">ntq</a>
<a name="l00838"></a>00838                 end     = start + block
<a name="l00839"></a>00839                 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(start, end):
<a name="l00840"></a>00840                     WM[i, i] = sqrt(TWt / block)
<a name="l00841"></a>00841         <span class="keywordflow">else</span>:
<a name="l00842"></a>00842             WM      = zeros(NCP1,dtype=float)
<a name="l00843"></a>00843             WM[0] = sqrt(EWt)
<a name="l00844"></a>00844             <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a54baa14272a2312e0fe1b77a0554c0aa">force</a>:
<a name="l00845"></a>00845                 start   = 1
<a name="l00846"></a>00846                 block   = 3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2fba4108ea80f3e1f44cf4c96cd6d530">fitatoms</a>
<a name="l00847"></a>00847                 end     = start + block
<a name="l00848"></a>00848                 WM[start:end] = sqrt(FWt / block)
<a name="l00849"></a>00849                 <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad19dc7dc7d2593c143700182dc614435" title="Whether to compute net forces and torques, or not.">use_nft</a>:
<a name="l00850"></a>00850                     start   = end
<a name="l00851"></a>00851                     block   = 3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa4eadda3b8377b783dec2d327cb66fa6">nnf</a>
<a name="l00852"></a>00852                     end     = start + block
<a name="l00853"></a>00853                     WM[start:end] = sqrt(NWt / block)
<a name="l00854"></a>00854                     start   = end
<a name="l00855"></a>00855                     block   = 3*self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a88902db5981ca2088a7cf47f5f9aa83a">ntq</a>
<a name="l00856"></a>00856                     end     = start + block
<a name="l00857"></a>00857                     WM[start:end] = sqrt(TWt / block)
<a name="l00858"></a>00858         <span class="keywordflow">if</span> cv:
<a name="l00859"></a>00859             <span class="comment">#==============================================================#</span>
<a name="l00860"></a>00860             <span class="comment">#                      The covariance matrix                   #</span>
<a name="l00861"></a>00861             <span class="comment">#                                                              #</span>
<a name="l00862"></a>00862             <span class="comment"># Note: There is a detail here that might appear peculiar :    #</span>
<a name="l00863"></a>00863             <span class="comment"># I&#39;m building only one covariance matrix from both ensembles. #</span>
<a name="l00864"></a>00864             <span class="comment"># This is the proper thing to do, believe me.                  #</span>
<a name="l00865"></a>00865             <span class="comment"># The functional form looks like (X2_M + X2_Q)(C)^-1           #</span>
<a name="l00866"></a>00866             <span class="comment"># I will build X2_M C^-1 and X2_Q C^-1 separately.             #</span>
<a name="l00867"></a>00867             <span class="comment">#==============================================================#</span>
<a name="l00868"></a>00868             QBP  = self.qmboltz
<a name="l00869"></a>00869             MBP  = 1 - self.qmboltz
<a name="l00870"></a>00870             C    = MBP*(QQ_M-outer(Q0_M,Q0_M)/Z)/Z + QBP*(QQ_Q-outer(Q0_Q,Q0_Q)/Y)/Y
<a name="l00871"></a>00871             Ci   = <a class="code" href="namespaceforcebalance_1_1nifty.html#a4c82187e92dfeb8a159f4aa44b501c40" title="Invert a matrix using singular value decomposition.">invert_svd</a>(C)
<a name="l00872"></a>00872             <span class="comment"># Get rid of energy-force covariance</span>
<a name="l00873"></a>00873             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(1,NCP1):
<a name="l00874"></a>00874                 Ci[0,i] = 0.0;
<a name="l00875"></a>00875                 Ci[i,0] = 0.0;
<a name="l00876"></a>00876             WCiW = array(mat(WM) * mat(Ci) * mat(WM)) <span class="comment"># Weighted covariance matrix.</span>
<a name="l00877"></a>00877         <span class="keywordflow">else</span>:
<a name="l00878"></a>00878             <span class="comment"># Here we&#39;re just using the variance.</span>
<a name="l00879"></a>00879             QBP  = self.qmboltz
<a name="l00880"></a>00880             MBP  = 1 - self.qmboltz
<a name="l00881"></a>00881             C    = MBP*(QQ_M-Q0_M*Q0_M/Z)/Z + QBP*(QQ_Q-Q0_Q*Q0_Q/Y)/Y
<a name="l00882"></a>00882             <span class="comment"># Normalize the force components</span>
<a name="l00883"></a>00883             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(1, len(C), 3):
<a name="l00884"></a>00884                 C[i:i+3] = mean(C[i:i+3])
<a name="l00885"></a>00885             Ci    = 1. / C
<a name="l00886"></a>00886             WCiW = WM * Ci * WM
<a name="l00887"></a>00887         <span class="comment">#==============================================================#</span>
<a name="l00888"></a>00888         <span class="comment"># STEP 4: Build the objective function and its derivatives.    #</span>
<a name="l00889"></a>00889         <span class="comment"># Note that building derivatives with covariance is not yet    #</span>
<a name="l00890"></a>00890         <span class="comment"># implemented, but can use external warpper to differentiate   #</span>
<a name="l00891"></a>00891         <span class="comment">#==============================================================#</span>
<a name="l00892"></a>00892         <span class="keywordflow">if</span> cv:
<a name="l00893"></a>00893             X2_M  = <a class="code" href="namespaceforcebalance_1_1abinitio.html#aadd1d6c5a34c82d495d6be7380b73601" title="This function builds an objective function (number) from the complicated polytensor and covariance ma...">build_objective</a>(SPiXi,WCiW,Z,Q0_M,M0_M,NCP1)
<a name="l00894"></a>00894             X2_Q  = <a class="code" href="namespaceforcebalance_1_1abinitio.html#aadd1d6c5a34c82d495d6be7380b73601" title="This function builds an objective function (number) from the complicated polytensor and covariance ma...">build_objective</a>(SRiXi,WCiW,Y,Q0_Q,M0_Q,NCP1)
<a name="l00895"></a>00895         <span class="keywordflow">else</span>:
<a name="l00896"></a>00896             X2_M  = <a class="code" href="namespaceforcebalance_1_1abinitio.html#aba970cb59bab95eec79027ea05655110" title="A more generalized version of build_objective which is callable for derivatives, but the covariance i...">weighted_variance</a>(SPiXi,WCiW,Z,X0_M,X0_M,NCP1,subtract_mean = <span class="keywordflow">not</span> self.absolute)
<a name="l00897"></a>00897             X2_Q  = <a class="code" href="namespaceforcebalance_1_1abinitio.html#aba970cb59bab95eec79027ea05655110" title="A more generalized version of build_objective which is callable for derivatives, but the covariance i...">weighted_variance</a>(SRiXi,WCiW,Y,X0_Q,X0_Q,NCP1,subtract_mean = <span class="keywordflow">not</span> self.absolute)
<a name="l00898"></a>00898             <span class="keywordflow">for</span> p <span class="keywordflow">in</span> range(np):
<a name="l00899"></a>00899                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> AGrad: <span class="keywordflow">continue</span>
<a name="l00900"></a>00900                 X2_M_p[p] = <a class="code" href="namespaceforcebalance_1_1abinitio.html#aba970cb59bab95eec79027ea05655110" title="A more generalized version of build_objective which is callable for derivatives, but the covariance i...">weighted_variance</a>(SPiXi_p[p],WCiW,Z,2*X0_M,M0_M_p[p],NCP1,subtract_mean = <span class="keywordflow">not</span> self.absolute)
<a name="l00901"></a>00901                 X2_Q_p[p] = <a class="code" href="namespaceforcebalance_1_1abinitio.html#aba970cb59bab95eec79027ea05655110" title="A more generalized version of build_objective which is callable for derivatives, but the covariance i...">weighted_variance</a>(SRiXi_p[p],WCiW,Y,2*X0_Q,M0_Q_p[p],NCP1,subtract_mean = <span class="keywordflow">not</span> self.absolute)
<a name="l00902"></a>00902                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> AHess: <span class="keywordflow">continue</span>
<a name="l00903"></a>00903                 X2_M_pq[p,p] = <a class="code" href="namespaceforcebalance_1_1abinitio.html#ab9554761125a4ec7c3c13d6ae4ea537d" title="A bit of a hack, since we have to subtract out two mean quantities to get Hessian elements...">weighted_variance2</a>(SPiXi_pq[p,p],WCiW,Z,2*M0_M_p[p],M0_M_p[p],2*X0_M,M0_M_pp[p],NCP1,subtract_mean = <span class="keywordflow">not</span> self.absolute)
<a name="l00904"></a>00904                 X2_Q_pq[p,p] = <a class="code" href="namespaceforcebalance_1_1abinitio.html#ab9554761125a4ec7c3c13d6ae4ea537d" title="A bit of a hack, since we have to subtract out two mean quantities to get Hessian elements...">weighted_variance2</a>(SRiXi_pq[p,p],WCiW,Y,2*M0_Q_p[p],M0_Q_p[p],2*X0_Q,M0_Q_pp[p],NCP1,subtract_mean = <span class="keywordflow">not</span> self.absolute)
<a name="l00905"></a>00905                 <span class="keywordflow">for</span> q <span class="keywordflow">in</span> range(p):
<a name="l00906"></a>00906                     X2_M_pq[p,q] = <a class="code" href="namespaceforcebalance_1_1abinitio.html#aba970cb59bab95eec79027ea05655110" title="A more generalized version of build_objective which is callable for derivatives, but the covariance i...">weighted_variance</a>(SPiXi_pq[p,q],WCiW,Z,2*M0_M_p[p],M0_M_p[q],NCP1,subtract_mean = <span class="keywordflow">not</span> self.absolute)
<a name="l00907"></a>00907                     X2_Q_pq[p,q] = <a class="code" href="namespaceforcebalance_1_1abinitio.html#aba970cb59bab95eec79027ea05655110" title="A more generalized version of build_objective which is callable for derivatives, but the covariance i...">weighted_variance</a>(SRiXi_pq[p,q],WCiW,Y,2*M0_Q_p[p],M0_Q_p[q],NCP1,subtract_mean = <span class="keywordflow">not</span> self.absolute)
<a name="l00908"></a>00908                     <span class="comment"># Get the other half of the Hessian matrix.</span>
<a name="l00909"></a>00909                     X2_M_pq[q,p] = X2_M_pq[p,q]
<a name="l00910"></a>00910                     X2_Q_pq[q,p] = X2_Q_pq[p,q]
<a name="l00911"></a>00911         <span class="comment">#==============================================================#</span>
<a name="l00912"></a>00912         <span class="comment">#            STEP 5: Build the return quantities.              #</span>
<a name="l00913"></a>00913         <span class="comment">#==============================================================#</span>
<a name="l00914"></a>00914         <span class="comment"># The objective function</span>
<a name="l00915"></a>00915         X2   = MBP * X2_M    + QBP * X2_Q
<a name="l00916"></a>00916         <span class="keywordflow">if</span> <span class="keywordflow">not</span> cv:
<a name="l00917"></a>00917             <span class="comment"># Derivatives of the objective function</span>
<a name="l00918"></a>00918             G = zeros(np,dtype=float)
<a name="l00919"></a>00919             H = zeros((np,np),dtype=float)
<a name="l00920"></a>00920             <span class="keywordflow">for</span> p <span class="keywordflow">in</span> range(np):
<a name="l00921"></a>00921                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> AGrad: <span class="keywordflow">continue</span>
<a name="l00922"></a>00922                 G[p] = MBP * X2_M_p[p] + QBP * X2_Q_p[p]
<a name="l00923"></a>00923                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> AHess: <span class="keywordflow">continue</span>
<a name="l00924"></a>00924                 <span class="keywordflow">for</span> q <span class="keywordflow">in</span> range(np):
<a name="l00925"></a>00925                     H[p,q] = MBP * X2_M_pq[p,q] + QBP * X2_Q_pq[p,q]
<a name="l00926"></a>00926         <span class="comment"># Energy error in kJ/mol</span>
<a name="l00927"></a>00927         <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.absolute:
<a name="l00928"></a>00928             E0_M = (2*Q0_M[0]*M0_M[0] - Q0_M[0]*Q0_M[0] - M0_M[0]*M0_M[0])/Z/Z;
<a name="l00929"></a>00929             E0_Q = (2*Q0_Q[0]*M0_Q[0] - Q0_Q[0]*Q0_Q[0] - M0_Q[0]*M0_Q[0])/Y/Y;
<a name="l00930"></a>00930         <span class="keywordflow">else</span>:
<a name="l00931"></a>00931             E0_M = 0.0
<a name="l00932"></a>00932             E0_Q = 0.0
<a name="l00933"></a>00933         <span class="keywordflow">if</span> cv:
<a name="l00934"></a>00934             dE     = MBP * sqrt(SPiXi[0,0]/Z + E0_M) + QBP * sqrt(SRiXi[0,0]/Y + E0_Q)
<a name="l00935"></a>00935         <span class="keywordflow">else</span>:
<a name="l00936"></a>00936             dE     = MBP * sqrt(SPiXi[0]/Z + E0_M) + QBP * sqrt(SRiXi[0]/Y + E0_Q)
<a name="l00937"></a>00937         <span class="comment"># Fractional energy error.</span>
<a name="l00938"></a>00938         dEfrac = MBP * sqrt((SPiXi[0]/Z + E0_M) / (QQ_M[0]/Z - Q0_M[0]**2/Z/Z)) + QBP * sqrt((SRiXi[0]/Y + E0_Q) / (QQ_Q[0]/Y - Q0_Q[0]**2/Y/Y))
<a name="l00939"></a>00939         <span class="comment"># Absolute and Fractional force error.</span>
<a name="l00940"></a>00940         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a54baa14272a2312e0fe1b77a0554c0aa">force</a>:
<a name="l00941"></a>00941             dF = MBP * dF_M / Z + QBP * dF_Q / Y
<a name="l00942"></a>00942             qF = MBP * qF_M / Z + QBP * qF_Q / Y
<a name="l00943"></a>00943             dFfrac = MBP * (dF_M/qF_M) + QBP * (dF_Q/qF_Q)
<a name="l00944"></a>00944             <span class="comment"># Old code for generating percentage force errors is less intuitive.</span>
<a name="l00945"></a>00945             <span class="comment"># if cv:</span>
<a name="l00946"></a>00946             <span class="comment">#     dFfrac = MBP * sqrt(mean(array([SPiXi[i,i]/QQ_M[i,i] for i in range(1,1+3*self.fitatoms) if abs(QQ_M[i,i]) &gt; 1e-3 ]))) + \</span>
<a name="l00947"></a>00947             <span class="comment">#         QBP * sqrt(mean(array([SRiXi[i,i]/QQ_Q[i,i] for i in range(1,1+3*self.fitatoms) if abs(QQ_Q[i,i]) &gt; 1e-3])))</span>
<a name="l00948"></a>00948             <span class="comment"># else:</span>
<a name="l00949"></a>00949             <span class="comment">#     dFfrac = MBP * sqrt(mean(array([SPiXi[i]/QQ_M[i] for i in range(1,1+3*self.fitatoms) if abs(QQ_M[i]) &gt; 1e-3]))) + \</span>
<a name="l00950"></a>00950             <span class="comment">#         QBP * sqrt(mean(array([SRiXi[i]/QQ_Q[i] for i in range(1,1+3*self.fitatoms) if abs(QQ_Q[i]) &gt; 1e-3])))</span>
<a name="l00951"></a>00951         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad19dc7dc7d2593c143700182dc614435" title="Whether to compute net forces and torques, or not.">use_nft</a>:
<a name="l00952"></a>00952             dN = MBP * dN_M / Z + QBP * dN_Q / Y
<a name="l00953"></a>00953             qN = MBP * qN_M / Z + QBP * qN_Q / Y
<a name="l00954"></a>00954             dNfrac = MBP * dN_M / qN_M + QBP * dN_Q / qN_Q
<a name="l00955"></a>00955             dT = MBP * dT_M / Z + QBP * dT_Q / Y
<a name="l00956"></a>00956             qT = MBP * qT_M / Z + QBP * qT_Q / Y
<a name="l00957"></a>00957             dTfrac = MBP * dT_M / qT_M + QBP * dT_Q / qT_Q
<a name="l00958"></a>00958             <span class="comment"># if cv:</span>
<a name="l00959"></a>00959             <span class="comment">#     dNfrac = MBP * sqrt(mean(array([SPiXi[i,i]/QQ_M[i,i] for i in range(1+3*self.fitatoms, 1+3*(self.fitatoms+self.nnf))]))) + \</span>
<a name="l00960"></a>00960             <span class="comment">#         QBP * sqrt(mean(array([SRiXi[i,i]/QQ_Q[i,i] for i in range(1+3*self.fitatoms, 1+3*(self.fitatoms+self.nnf))])))</span>
<a name="l00961"></a>00961             <span class="comment">#     dTfrac = MBP * sqrt(mean(array([SPiXi[i,i]/QQ_M[i,i] for i in range(1+3*(self.fitatoms+self.nnf), 1+3*(self.fitatoms+self.nnf+self.ntq))]))) + \</span>
<a name="l00962"></a>00962             <span class="comment">#         QBP * sqrt(mean(array([SRiXi[i,i]/QQ_Q[i,i] for i in range(1+3*(self.fitatoms+self.nnf), 1+3*(self.fitatoms+self.nnf+self.ntq))])))</span>
<a name="l00963"></a>00963             <span class="comment"># else:</span>
<a name="l00964"></a>00964             <span class="comment">#     dNfrac = MBP * sqrt(mean(array([SPiXi[i]/QQ_M[i] for i in range(1+3*self.fitatoms, 1+3*(self.fitatoms+self.nnf)) if abs(QQ_M[i]) &gt; 1e-3]))) + \</span>
<a name="l00965"></a>00965             <span class="comment">#         QBP * sqrt(mean(array([SRiXi[i]/QQ_Q[i] for i in range(1+3*self.fitatoms, 1+3*(self.fitatoms+self.nnf)) if abs(QQ_Q[i]) &gt; 1e-3])))</span>
<a name="l00966"></a>00966             <span class="comment">#     dTfrac = MBP * sqrt(mean(array([SPiXi[i]/QQ_M[i] for i in range(1+3*(self.fitatoms+self.nnf), 1+3*(self.fitatoms+self.nnf+self.ntq)) if abs(QQ_M[i]) &gt; 1e-3]))) + \</span>
<a name="l00967"></a>00967             <span class="comment">#         QBP * sqrt(mean(array([SRiXi[i]/QQ_Q[i] for i in range(1+3*(self.fitatoms+self.nnf), 1+3*(self.fitatoms+self.nnf+self.ntq)) if abs(QQ_Q[i]) &gt; 1e-3])))</span>
<a name="l00968"></a>00968         <span class="comment"># Save values to qualitative indicator if not inside finite difference code.</span>
<a name="l00969"></a>00969         <span class="keywordflow">if</span> <span class="keywordflow">not</span> <a class="code" href="namespaceforcebalance_1_1finite__difference.html#ad84d3e385db1190e7d8ef58bc08a6c52" title="Invoking this function from anywhere will tell us whether we&#39;re being called by a finite-difference f...">in_fd</a>():
<a name="l00970"></a>00970             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a0fa6ba3ce272657e4f284267b35574ad">e_ref</a> = MBP * sqrt(QQ_M[0]/Z - Q0_M[0]**2/Z/Z) + QBP * sqrt((QQ_Q[0]/Y - Q0_Q[0]**2/Y/Y))
<a name="l00971"></a>00971             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a003717f2442aac7d1067e74b89a14cc7" title="Qualitative Indicator: average energy error (in kJ/mol)">e_err</a> = dE
<a name="l00972"></a>00972             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ac04e91428155e8d5c4a1a14328e9cc99">e_err_pct</a> = dEfrac
<a name="l00973"></a>00973             <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a54baa14272a2312e0fe1b77a0554c0aa">force</a>:
<a name="l00974"></a>00974                 self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a945a7463f68474234fa8fdfe93888ff1">f_ref</a> = qF
<a name="l00975"></a>00975                 self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2df838b5d83710d5d35e3ccccbf7c656" title="Qualitative Indicator: average force error (fractional)">f_err</a> = dF
<a name="l00976"></a>00976                 self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a0c48a57c247e6afe97fd178e8b5bce0d">f_err_pct</a> = dFfrac
<a name="l00977"></a>00977             <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad19dc7dc7d2593c143700182dc614435" title="Whether to compute net forces and torques, or not.">use_nft</a>:
<a name="l00978"></a>00978                 self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad83ddb614190a3c3e647060ce3e063ad">nf_ref</a> = qN
<a name="l00979"></a>00979                 self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a6f22f2576168b879342fb60913ffc134">nf_err</a> = dN
<a name="l00980"></a>00980                 self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a73def1269c075f82fe20dae6117d75bb">nf_err_pct</a> = dNfrac
<a name="l00981"></a>00981                 self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a35ffa4510b557dd4fbce2cd8276fa09b">tq_ref</a> = qT
<a name="l00982"></a>00982                 self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a36857e469f48d8bddbd3b288a92cac10">tq_err</a> = dT
<a name="l00983"></a>00983                 self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a9954395e5bb893da066002238d7dbacd">tq_err_pct</a> = dTfrac
<a name="l00984"></a>00984             pvals = self.FF.make(mvals) <span class="comment"># Write a force field that isn&#39;t perturbed by finite differences.</span>
<a name="l00985"></a>00985         <span class="keywordflow">if</span> cv:
<a name="l00986"></a>00986             Answer = {<span class="stringliteral">&#39;X&#39;</span>:X2, <span class="stringliteral">&#39;G&#39;</span>:zeros(self.FF.np), <span class="stringliteral">&#39;H&#39;</span>:zeros((self.FF.np,self.FF.np))}
<a name="l00987"></a>00987         <span class="keywordflow">else</span>:
<a name="l00988"></a>00988             Answer = {<span class="stringliteral">&#39;X&#39;</span>:X2, <span class="stringliteral">&#39;G&#39;</span>:G, <span class="stringliteral">&#39;H&#39;</span>:H}
<a name="l00989"></a>00989         <span class="keywordflow">return</span> Answer
<a name="l00990"></a>00990 
<a name="l00991"></a>00991     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#abfe50569805218075c5942fd3be8bbe7" title="Electrostatic potential fitting.">get_resp_</a>(self, mvals, AGrad=False, AHess=False):
<a name="l00992"></a>00992         <span class="stringliteral">&quot;&quot;&quot; Electrostatic potential fitting.  Implements the RESP objective function.  (In Python so obviously not optimized.) &quot;&quot;&quot;</span>
<a name="l00993"></a>00993         <span class="keywordflow">if</span> (self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab949767e48e84f747f0e84c304d80004">w_resp</a> == 0.0):
<a name="l00994"></a>00994             AGrad = <span class="keyword">False</span>
<a name="l00995"></a>00995             AHess = <span class="keyword">False</span>
<a name="l00996"></a>00996         Answer = {}
<a name="l00997"></a>00997         pvals = self.FF.make(mvals)
<a name="l00998"></a>00998 
<a name="l00999"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab949767e48e84f747f0e84c304d80004">00999</a>         <span class="comment"># Build the distance matrix for ESP fitting.</span>
<a name="l01000"></a>01000         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ac90a96916a049717e14bc1f757577f24">invdists</a> = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a7475857193eefd4edd020d4f2a8fec17">build_invdist</a>(mvals)
<a name="l01001"></a>01001 
<a name="l01002"></a>01002         ns = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a86f4e2b085f139886d54855f432a2672" title="Read in the trajectory file.">ns</a>
<a name="l01003"></a>01003         np = self.FF.np
<a name="l01004"></a>01004         Z = 0
<a name="l01005"></a>01005         Y = 0
<a name="l01006"></a>01006         <span class="keyword">def </span>getqatoms(mvals_):
<a name="l01007"></a>01007             <span class="stringliteral">&quot;&quot;&quot; This function takes the mathematical parameter values and returns the charges on the ATOMS (fancy mapping going on) &quot;&quot;&quot;</span>
<a name="l01008"></a>01008             logger.info(<span class="stringliteral">&quot;\r&quot;</span>)
<a name="l01009"></a>01009             <span class="comment"># Need to update the positions of atoms, if there are virtual sites.</span>
<a name="l01010"></a>01010             pvals = self.FF.create_pvals(mvals_)
<a name="l01011"></a>01011             qvals = [pvals[i] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.FF.qmap]
<a name="l01012"></a>01012             <span class="comment"># All of a sudden I need the number of virtual sites.</span>
<a name="l01013"></a>01013             qatoms = zeros(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ad3dfbd9d397bb7b2bbc3fe0374291e34" title="The number of (atoms + drude particles + virtual sites)">nparticles</a>)
<a name="l01014"></a>01014             <span class="keywordflow">for</span> i, jj <span class="keywordflow">in</span> enumerate(self.FF.qid):
<a name="l01015"></a>01015                 <span class="keywordflow">for</span> j <span class="keywordflow">in</span> jj:
<a name="l01016"></a>01016                     qatoms[j] = qvals[i]
<a name="l01017"></a>01017             <span class="keywordflow">return</span> qatoms
<a name="l01018"></a>01018 
<a name="l01019"></a>01019         <span class="comment"># Obtain a derivative matrix the stupid way</span>
<a name="l01020"></a>01020         <span class="keywordflow">if</span> AGrad:
<a name="l01021"></a>01021             <span class="comment"># dqPdqM = []</span>
<a name="l01022"></a>01022             <span class="comment"># for i in range(np):</span>
<a name="l01023"></a>01023             <span class="comment">#     print &quot;Now working on parameter number&quot;, i</span>
<a name="l01024"></a>01024             <span class="comment">#     dqPdqM.append(f12d3p(fdwrap(getqatoms,mvals,i), h = self.h)[0])</span>
<a name="l01025"></a>01025             <span class="comment"># dqPdqM = mat(dqPdqM).T</span>
<a name="l01026"></a>01026             dqPdqM = mat([<a class="code" href="namespaceforcebalance_1_1finite__difference.html#aa69a8819e4680091f400303c1d6ddeb7" title="A three-point finite difference stencil.">f12d3p</a>(<a class="code" href="namespaceforcebalance_1_1finite__difference.html#ae484c591ae8c4e5bae73a0ef2660c339" title="A function wrapper for finite difference designed for differentiating &#39;get&#39;-type functions.">fdwrap</a>(getqatoms,mvals,i), h = self.h)[0] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(np)]).T
<a name="l01027"></a>01027         xyzs = array(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a112c4e1af07517633c5c149c07c4aa8c">traj</a>.xyzs)
<a name="l01028"></a>01028         espqvals = array(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a011b973a1779275fe19fd1c72037b435" title="ESP values.">espval</a>)
<a name="l01029"></a>01029         espxyz   = array(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae86f6ee41ce05057b44fb1bc8bb1282b" title="ESP grid points.">espxyz</a>)
<a name="l01030"></a>01030 
<a name="l01031"></a>01031         ddVdqPdVS = {}
<a name="l01032"></a>01032         <span class="comment"># Second derivative of the inverse distance matrix with respect to the virtual site position</span>
<a name="l01033"></a>01033         dddVdqPdVS2 = {}
<a name="l01034"></a>01034         <span class="keywordflow">if</span> AGrad:
<a name="l01035"></a>01035             <span class="keywordflow">for</span> p <span class="keywordflow">in</span> range(np):
<a name="l01036"></a>01036                 <span class="keywordflow">if</span> <span class="stringliteral">&#39;VSITE&#39;</span> <span class="keywordflow">in</span> self.FF.plist[p]:
<a name="l01037"></a>01037                     ddVdqPdVS[p], dddVdqPdVS2[p] = <a class="code" href="namespaceforcebalance_1_1finite__difference.html#aa69a8819e4680091f400303c1d6ddeb7" title="A three-point finite difference stencil.">f12d3p</a>(<a class="code" href="namespaceforcebalance_1_1finite__difference.html#ae484c591ae8c4e5bae73a0ef2660c339" title="A function wrapper for finite difference designed for differentiating &#39;get&#39;-type functions.">fdwrap</a>(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a7475857193eefd4edd020d4f2a8fec17">build_invdist</a>,mvals,p), h = self.h, f0 = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ac90a96916a049717e14bc1f757577f24">invdists</a>)
<a name="l01038"></a>01038         X = 0
<a name="l01039"></a>01039         D = 0
<a name="l01040"></a>01040         G = zeros(np, dtype=float)
<a name="l01041"></a>01041         H = zeros((np, np), dtype=float)
<a name="l01042"></a>01042         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a86f4e2b085f139886d54855f432a2672" title="Read in the trajectory file.">ns</a>):
<a name="l01043"></a>01043             P   = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae5c60f421336c2ecb716be16b8d51fdf" title="Initialize the base class.">whamboltz_wts</a>[i]
<a name="l01044"></a>01044             Z  += P
<a name="l01045"></a>01045             dVdqP   = mat(self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ac90a96916a049717e14bc1f757577f24">invdists</a>[i])
<a name="l01046"></a>01046             espqval = espqvals[i]
<a name="l01047"></a>01047             espmval = dVdqP * <a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(getqatoms(mvals))
<a name="l01048"></a>01048             desp    = <a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(espmval) - espqval
<a name="l01049"></a>01049             X      += P * dot(desp, desp) / self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a15710ca46f6141a6e5b00a382aa56632">nesp</a>
<a name="l01050"></a>01050             D      += P * (dot(espqval, espqval) / self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a15710ca46f6141a6e5b00a382aa56632">nesp</a> - (sum(espqval) / self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a15710ca46f6141a6e5b00a382aa56632">nesp</a>)**2)
<a name="l01051"></a>01051             <span class="keywordflow">if</span> AGrad:
<a name="l01052"></a>01052                 dVdqM   = (dVdqP * dqPdqM).T
<a name="l01053"></a>01053                 <span class="keywordflow">for</span> p, vsd <span class="keywordflow">in</span> ddVdqPdVS.items():
<a name="l01054"></a>01054                     dVdqM[p,:] += <a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(vsd[i] * <a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(getqatoms(mvals)))
<a name="l01055"></a>01055                 G      += <a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(P * 2 * dVdqM * <a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(desp)) / self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a15710ca46f6141a6e5b00a382aa56632">nesp</a>
<a name="l01056"></a>01056                 <span class="keywordflow">if</span> AHess:
<a name="l01057"></a>01057                     d2VdqM2 = zeros(dVdqM.shape, dtype=float)
<a name="l01058"></a>01058                     <span class="keywordflow">for</span> p, vsd <span class="keywordflow">in</span> dddVdqPdVS2.items():
<a name="l01059"></a>01059                         d2VdqM2[p,:] += <a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(vsd[i] * <a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(getqatoms(mvals)))
<a name="l01060"></a>01060                     H      += array(P * 2 * (dVdqM * dVdqM.T + d2VdqM2 * <a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(desp))) / self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a15710ca46f6141a6e5b00a382aa56632">nesp</a>
<a name="l01061"></a>01061         <span class="comment"># Redundant but we keep it anyway</span>
<a name="l01062"></a>01062         D /= Z
<a name="l01063"></a>01063         X /= Z
<a name="l01064"></a>01064         X /= D
<a name="l01065"></a>01065         G /= Z
<a name="l01066"></a>01066         G /= D
<a name="l01067"></a>01067         H /= Z
<a name="l01068"></a>01068         H /= D
<a name="l01069"></a>01069         <span class="keywordflow">if</span> <span class="keywordflow">not</span> <a class="code" href="namespaceforcebalance_1_1finite__difference.html#ad84d3e385db1190e7d8ef58bc08a6c52" title="Invoking this function from anywhere will tell us whether we&#39;re being called by a finite-difference f...">in_fd</a>():
<a name="l01070"></a>01070             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a3a1a04d4af74efa8ff6a1fb8bb6bcc10" title="Qualitative Indicator: &quot;relative RMS&quot; for electrostatic potential.">esp_err</a> = sqrt(X)
<a name="l01071"></a>01071         <span class="comment"># Following is the restraint part</span>
<a name="l01072"></a>01072         <span class="comment"># RESP hyperbola &quot;strength&quot; parameter; 0.0005 is weak, 0.001 is strong</span>
<a name="l01073"></a>01073         <span class="comment"># RESP hyperbola &quot;tightness&quot; parameter; don&#39;t need to change this</span>
<a name="l01074"></a>01074         a = self.resp_a
<a name="l01075"></a>01075         b = self.resp_b
<a name="l01076"></a>01076         q = getqatoms(mvals)
<a name="l01077"></a>01077         R   = a*sum((q**2 + b**2)**0.5 - b)
<a name="l01078"></a>01078         dR  = a*q*(q**2 + b**2)**-0.5
<a name="l01079"></a>01079         ddR = a*b**2*(q**2 + b**2)**-1.5
<a name="l01080"></a>01080         self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ac4f8e85daeccb2e46b724eddc76d38e1">respterm</a> = R
<a name="l01081"></a>01081         X += R
<a name="l01082"></a>01082         <span class="keywordflow">if</span> AGrad:
<a name="l01083"></a>01083             G += <a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(dqPdqM.T * <a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(dR))
<a name="l01084"></a>01084             <span class="keywordflow">if</span> AHess:
<a name="l01085"></a>01085                 H += diag(<a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(dqPdqM.T * <a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(ddR)))
<a name="l01086"></a>01086             
<a name="l01087"></a>01087         Answer = {<span class="stringliteral">&#39;X&#39;</span>:X,<span class="stringliteral">&#39;G&#39;</span>:G,<span class="stringliteral">&#39;H&#39;</span>:H}
<a name="l01088"></a>01088         <span class="keywordflow">return</span> Answer
<a name="l01089"></a>01089 
<a name="l01090"></a>01090     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2bb3ed7209707f688ec8b731392466b5" title="Every target must be able to return a contribution to the objective function - however, this must be implemented in the specific subclass.">get</a>(self, mvals, AGrad=False, AHess=False):
<a name="l01091"></a>01091         Answer = {<span class="stringliteral">&#39;X&#39;</span>:0.0, <span class="stringliteral">&#39;G&#39;</span>:zeros(self.FF.np, dtype=float), <span class="stringliteral">&#39;H&#39;</span>:zeros((self.FF.np, self.FF.np), dtype=float)}
<a name="l01092"></a>01092         tw = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab8c3b9a3e74ced53cc5f4e6f3c6c06ef">w_energy</a> + self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2f68f2c95e481c03e05b03d55851107f">w_force</a> + self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa9fa8ad127d442e9b545088eb741b9eb">w_netforce</a> + self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab4468582c2c010bec490e65a34cdc40a">w_torque</a> + self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab949767e48e84f747f0e84c304d80004">w_resp</a>
<a name="l01093"></a>01093         <span class="keywordflow">if</span> tw &gt; 0.0:
<a name="l01094"></a>01094             w_ef = (self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab8c3b9a3e74ced53cc5f4e6f3c6c06ef">w_energy</a> + self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a2f68f2c95e481c03e05b03d55851107f">w_force</a> + self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#aa9fa8ad127d442e9b545088eb741b9eb">w_netforce</a> + self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab4468582c2c010bec490e65a34cdc40a">w_torque</a>) / tw
<a name="l01095"></a>01095             w_resp = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ab949767e48e84f747f0e84c304d80004">w_resp</a> / tw
<a name="l01096"></a>01096         <span class="keywordflow">else</span>:
<a name="l01097"></a>01097             w_ef = 0.0
<a name="l01098"></a><a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae27974d01fbc7d485ce3e049a54943bc">01098</a>             w_resp = 0.0
<a name="l01099"></a>01099         <span class="keywordflow">if</span> self.energy <span class="keywordflow">or</span> self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a54baa14272a2312e0fe1b77a0554c0aa">force</a>:
<a name="l01100"></a>01100             Answer_EF = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a313c848f46579817803c8a3ff100974e" title="LPW 06-30-2013.">get_energy_force_</a>(mvals, AGrad, AHess)
<a name="l01101"></a>01101             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> Answer_EF:
<a name="l01102"></a>01102                 Answer[i] += w_ef * Answer_EF[i]
<a name="l01103"></a>01103         <span class="keywordflow">if</span> self.resp:
<a name="l01104"></a>01104             Answer_ESP = self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#abfe50569805218075c5942fd3be8bbe7" title="Electrostatic potential fitting.">get_resp_</a>(mvals, AGrad, AHess)
<a name="l01105"></a>01105             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> Answer_ESP:
<a name="l01106"></a>01106                 Answer[i] += w_resp * Answer_ESP[i]
<a name="l01107"></a>01107         <span class="keywordflow">if</span> <span class="keywordflow">not</span> any([self.energy, self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#a54baa14272a2312e0fe1b77a0554c0aa">force</a>, self.resp]):
<a name="l01108"></a>01108             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&quot;Ab initio fitting must have at least one of: Energy, Force, ESP&quot;</span>)
<a name="l01109"></a>01109         <span class="keywordflow">if</span> <span class="keywordflow">not</span> <a class="code" href="namespaceforcebalance_1_1finite__difference.html#ad84d3e385db1190e7d8ef58bc08a6c52" title="Invoking this function from anywhere will tell us whether we&#39;re being called by a finite-difference f...">in_fd</a>():
<a name="l01110"></a>01110             self.<a class="code" href="classforcebalance_1_1abinitio_1_1AbInitio.html#ae27974d01fbc7d485ce3e049a54943bc">objective</a> = Answer[<span class="stringliteral">&#39;X&#39;</span>]
<a name="l01111"></a>01111         <span class="keywordflow">return</span> Answer
<a name="l01112"></a>01112 
<a name="l01113"></a>01113 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1abinitio.html#aba970cb59bab95eec79027ea05655110" title="A more generalized version of build_objective which is callable for derivatives, but the covariance i...">weighted_variance</a>(SPiXi,WCiW,Z,L,R,NCP1,subtract_mean=True):
<a name="l01114"></a>01114     <span class="stringliteral">&quot;&quot;&quot; A more generalized version of build_objective which is</span>
<a name="l01115"></a>01115 <span class="stringliteral">    callable for derivatives, but the covariance is not there anymore. &quot;&quot;&quot;</span>
<a name="l01116"></a>01116     <span class="comment"># These are the functions that we are building.</span>
<a name="l01117"></a>01117     X2        = 0.0
<a name="l01118"></a>01118     <span class="comment"># Divide by Z to normalize</span>
<a name="l01119"></a>01119     XiZ       = SPiXi/Z
<a name="l01120"></a>01120     <span class="comment"># Subtract out the average energy.</span>
<a name="l01121"></a>01121     <span class="keywordflow">if</span> subtract_mean:
<a name="l01122"></a>01122         XiZ[0] -= (L[0] * R[0])/Z/Z
<a name="l01123"></a>01123     <span class="comment"># Return the answer.</span>
<a name="l01124"></a><a class="code" href="namespaceforcebalance_1_1abinitio.html#aba970cb59bab95eec79027ea05655110">01124</a>     X2      = dot(XiZ.flatten(),WCiW.flatten())
<a name="l01125"></a>01125     <span class="keywordflow">return</span> X2
<a name="l01126"></a>01126 
<a name="l01127"></a>01127 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1abinitio.html#ab9554761125a4ec7c3c13d6ae4ea537d" title="A bit of a hack, since we have to subtract out two mean quantities to get Hessian elements...">weighted_variance2</a>(SPiXi,WCiW,Z,L,R,L2,R2,NCP1,subtract_mean=True):
<a name="l01128"></a>01128     <span class="stringliteral">&quot;&quot;&quot; A bit of a hack, since we have to subtract out two mean quantities to get Hessian elements. &quot;&quot;&quot;</span>
<a name="l01129"></a>01129     <span class="comment"># These are the functions that we are building.</span>
<a name="l01130"></a>01130     X2        = 0.0
<a name="l01131"></a>01131     <span class="comment"># Divide by Z to normalize</span>
<a name="l01132"></a>01132     XiZ       = SPiXi/Z
<a name="l01133"></a>01133     <span class="comment"># Subtract out the average energy.</span>
<a name="l01134"></a>01134     <span class="keywordflow">if</span> subtract_mean:
<a name="l01135"></a>01135         XiZ[0] -= (L[0] * R[0])/Z/Z
<a name="l01136"></a>01136         XiZ[0] -= (L2[0] * R2[0])/Z/Z
<a name="l01137"></a>01137     <span class="comment"># Return the answer.</span>
<a name="l01138"></a><a class="code" href="namespaceforcebalance_1_1abinitio.html#ab9554761125a4ec7c3c13d6ae4ea537d">01138</a>     X2      = dot(XiZ.flatten(),WCiW.flatten())
<a name="l01139"></a>01139     <span class="keywordflow">return</span> X2
<a name="l01140"></a>01140 
<a name="l01141"></a>01141 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1abinitio.html#aadd1d6c5a34c82d495d6be7380b73601" title="This function builds an objective function (number) from the complicated polytensor and covariance ma...">build_objective</a>(SPiXi,WCiW,Z,Q0,M0,NCP1,subtract_mean=True):
<a name="l01142"></a>01142 
<a name="l01143"></a>01143     <span class="stringliteral">&quot;&quot;&quot; This function builds an objective function (number) from the</span>
<a name="l01144"></a>01144 <span class="stringliteral">    complicated polytensor and covariance matrices. &quot;&quot;&quot;</span>
<a name="l01145"></a>01145 
<a name="l01146"></a>01146     <span class="comment"># These are the functions that we are building.</span>
<a name="l01147"></a>01147     X2    = 0.0
<a name="l01148"></a>01148     <span class="comment"># Divide by Z to normalize</span>
<a name="l01149"></a>01149     XiZ       = SPiXi/Z
<a name="l01150"></a>01150     <span class="keywordflow">if</span> subtract_mean:
<a name="l01151"></a>01151         <span class="comment"># Subtract out the zero-point energy gap</span>
<a name="l01152"></a>01152         XiZ[0,0] -= (M0[0]*M0[0] + Q0[0]*Q0[0] - 2*Q0[0]*M0[0])/Z/Z
<a name="l01153"></a>01153         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(1,NCP1):
<a name="l01154"></a><a class="code" href="namespaceforcebalance_1_1abinitio.html#aadd1d6c5a34c82d495d6be7380b73601">01154</a>             XiZ[0,i] -= (M0[i]*M0[0] + Q0[i]*Q0[0] - 2*Q0[i]*M0[0])/Z/Z
<a name="l01155"></a>01155             XiZ[i,0] -= (M0[0]*M0[i] + Q0[0]*Q0[i] - 2*Q0[0]*M0[i])/Z/Z
<a name="l01156"></a>01156     <span class="comment">### This is the objective function! LAAAAA ###</span>
<a name="l01157"></a>01157     X2      = dot(XiZ.flatten(),WCiW.flatten())
<a name="l01158"></a>01158     <span class="keywordflow">return</span> X2
<a name="l01159"></a>01159 
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Fri Aug 23 2013 15:01:34 for ForceBalance API by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
