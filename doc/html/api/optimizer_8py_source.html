<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ForceBalance API: optimizer.py Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="ForceBalanceLogo_sm.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ForceBalance API
   &#160;<span id="projectnumber">1.1</span>
   </div>
   <div id="projectbrief">Automated optimization of force fields and empirical potentials</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../index.html"><span>Main Page</span></a></li>
      <li ><a href="roadmap.html"><span>Project Roadmap</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">optimizer.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="optimizer_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespaceforcebalance_1_1optimizer.html">00001</a> <span class="stringliteral">&quot;&quot;&quot; @package forcebalance.optimizer Optimization algorithms.</span>
<a name="l00002"></a>00002 <span class="stringliteral"></span>
<a name="l00003"></a>00003 <span class="stringliteral">My current implementation is to have a single optimizer class with several methods</span>
<a name="l00004"></a>00004 <span class="stringliteral">contained inside.</span>
<a name="l00005"></a>00005 <span class="stringliteral"></span>
<a name="l00006"></a>00006 <span class="stringliteral">@author Lee-Ping Wang</span>
<a name="l00007"></a>00007 <span class="stringliteral">@date 12/2011</span>
<a name="l00008"></a>00008 <span class="stringliteral"></span>
<a name="l00009"></a>00009 <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="keyword">import</span> os, pickle, re, sys
<a name="l00012"></a>00012 <span class="keyword">import</span> numpy <span class="keyword">as</span> np
<a name="l00013"></a>00013 <span class="keyword">from</span> copy <span class="keyword">import</span> deepcopy
<a name="l00014"></a>00014 <span class="keyword">from</span> numpy.linalg <span class="keyword">import</span> eig, norm, solve
<a name="l00015"></a>00015 <span class="keyword">import</span> forcebalance
<a name="l00016"></a>00016 <span class="keyword">from</span> forcebalance.nifty <span class="keyword">import</span> col, flat, row, printcool, printcool_dictionary, pvec1d, pmat2d, warn_press_key, invert_svd
<a name="l00017"></a>00017 <span class="keyword">from</span> forcebalance.finite_difference <span class="keyword">import</span> f1d7p, f1d5p, fdwrap
<a name="l00018"></a>00018 <span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict
<a name="l00019"></a>00019 <span class="keyword">import</span> random
<a name="l00020"></a>00020 <span class="keyword">from</span> forcebalance.output <span class="keyword">import</span> getLogger, DEBUG
<a name="l00021"></a>00021 logger = getLogger(__name__)
<a name="l00022"></a><a class="code" href="namespaceforcebalance_1_1optimizer.html#a3a90d52ff4e74cd917ce709e53b330df">00022</a> 
<a name="l00023"></a>00023 <span class="comment"># Global variable corresponding to the iteration number.</span>
<a name="l00024"></a>00024 ITERATION_NUMBER = 0
<a name="l00025"></a><a class="code" href="namespaceforcebalance_1_1optimizer.html#a8b0e063c6ff704cbe779b65f400ff37e">00025</a> <span class="comment"># Global variable corresponding to whether the optimization took a good step.</span>
<a name="l00026"></a>00026 GOODSTEP = 0
<a name="l00027"></a><a class="code" href="namespaceforcebalance_1_1optimizer.html#a638d98f2fea0c85ac05d0cf5f7efef84">00027</a> 
<a name="l00028"></a>00028 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1optimizer.html#ae1f6c649703a22b2f767a5f6bf53297b">Counter</a>():
<a name="l00029"></a><a class="code" href="namespaceforcebalance_1_1optimizer.html#ae1f6c649703a22b2f767a5f6bf53297b">00029</a>     <span class="keyword">global</span> ITERATION_NUMBER
<a name="l00030"></a>00030     <span class="keywordflow">return</span> ITERATION_NUMBER
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="keyword">def </span><a class="code" href="namespaceforcebalance_1_1optimizer.html#ab43948ecf30c90d319e0c0b107fe484a">GoodStep</a>():
<a name="l00033"></a><a class="code" href="namespaceforcebalance_1_1optimizer.html#ab43948ecf30c90d319e0c0b107fe484a">00033</a>     <span class="keyword">global</span> GOODSTEP
<a name="l00034"></a>00034     <span class="keywordflow">return</span> GOODSTEP
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="keyword">class </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html" title="Optimizer class.">Optimizer</a>(forcebalance.BaseClass):
<a name="l00037"></a>00037     <span class="stringliteral">&quot;&quot;&quot; Optimizer class.  Contains several methods for numerical optimization.</span>
<a name="l00038"></a>00038 <span class="stringliteral"></span>
<a name="l00039"></a>00039 <span class="stringliteral">    For various reasons, the optimizer depends on the force field and fitting</span>
<a name="l00040"></a>00040 <span class="stringliteral">    targets (i.e. we cannot treat it as a fully independent numerical optimizer).</span>
<a name="l00041"></a>00041 <span class="stringliteral">    The dependency is rather weak which suggests that I can remove it someday.</span>
<a name="l00042"></a>00042 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00043"></a>00043         
<a name="l00044"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html">00044</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a674f1c17cbfaffa7955fb5d833d33e0b" title="Create an Optimizer object.">__init__</a>(self,options,Objective,FF):
<a name="l00045"></a>00045         <span class="stringliteral">&quot;&quot;&quot; Create an Optimizer object.</span>
<a name="l00046"></a>00046 <span class="stringliteral">        </span>
<a name="l00047"></a>00047 <span class="stringliteral">        The optimizer depends on both the FF and the fitting targets so there</span>
<a name="l00048"></a>00048 <span class="stringliteral">        is a chain of dependencies: FF --&gt; FitSim --&gt; Optimizer, and FF --&gt; Optimizer</span>
<a name="l00049"></a>00049 <span class="stringliteral">        </span>
<a name="l00050"></a>00050 <span class="stringliteral">        Here&#39;s what we do:</span>
<a name="l00051"></a>00051 <span class="stringliteral">        - Take options from the parser</span>
<a name="l00052"></a>00052 <span class="stringliteral">        - Pass in the objective function, force field, all fitting targets</span>
<a name="l00053"></a>00053 <span class="stringliteral"></span>
<a name="l00054"></a>00054 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00055"></a>00055         super(Optimizer, self).<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a674f1c17cbfaffa7955fb5d833d33e0b" title="Create an Optimizer object.">__init__</a>(options)
<a name="l00056"></a>00056 
<a name="l00057"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a674f1c17cbfaffa7955fb5d833d33e0b">00057</a>         <span class="comment">## A list of all the things we can ask the optimizer to do.</span>
<a name="l00058"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#acd9866c0bb48a8f49f2dca1d83441bde">00058</a>         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#acd9866c0bb48a8f49f2dca1d83441bde" title="A list of all the things we can ask the optimizer to do.">OptTab</a>    = {<span class="stringliteral">&#39;NEWTONRAPHSON&#39;</span>     : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a5b6e95f9f49b7d970ac8441d68a0023f" title="Optimize the force field parameters using the Newton-Raphson method (.">NewtonRaphson</a>, 
<a name="l00059"></a>00059                           <span class="stringliteral">&#39;NEWTON&#39;</span>            : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a5b6e95f9f49b7d970ac8441d68a0023f" title="Optimize the force field parameters using the Newton-Raphson method (.">NewtonRaphson</a>, 
<a name="l00060"></a>00060                           <span class="stringliteral">&#39;NR&#39;</span>                : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a5b6e95f9f49b7d970ac8441d68a0023f" title="Optimize the force field parameters using the Newton-Raphson method (.">NewtonRaphson</a>, 
<a name="l00061"></a>00061                           <span class="stringliteral">&#39;BFGS&#39;</span>              : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a58b957fe289822934711c29dfeb8d203" title="Optimize the force field parameters using the BFGS method; currently the recommended choice (...">BFGS</a>,
<a name="l00062"></a>00062                           <span class="stringliteral">&#39;POWELL&#39;</span>            : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a0745b2e3607ef308ba48bb1d34e5be79" title="Use SciPy&#39;s built-in Powell direction-set algorithm to optimize the parameters.">Powell</a>,
<a name="l00063"></a>00063                           <span class="stringliteral">&#39;SIMPLEX&#39;</span>           : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6b3af8115718f61a6a21c3297d717ead" title="Use SciPy&#39;s built-in simplex algorithm to optimize the parameters.">Simplex</a>,
<a name="l00064"></a>00064                           <span class="stringliteral">&#39;ANNEAL&#39;</span>            : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a183911848e43ca0be1893b87290dc31e" title="Use SciPy&#39;s built-in simulated annealing algorithm to optimize the parameters.">Anneal</a>,
<a name="l00065"></a>00065                           <span class="stringliteral">&#39;GENETIC&#39;</span>           : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a50ffc779fbba5a99085cba45d868fc29" title="Genetic algorithm, under development.">GeneticAlgorithm</a>,
<a name="l00066"></a>00066                           <span class="stringliteral">&#39;CONJUGATEGRADIENT&#39;</span> : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ad1e151204a172a4e75737b2b699d1623" title="Use SciPy&#39;s built-in simulated annealing algorithm to optimize the parameters.">ConjugateGradient</a>,
<a name="l00067"></a>00067                           <span class="stringliteral">&#39;SCAN_MVALS&#39;</span>        : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a43ab8c6bea2b3112468922ab61163f67" title="Scan through the mathematical parameter space.">ScanMVals</a>,
<a name="l00068"></a>00068                           <span class="stringliteral">&#39;SCAN_PVALS&#39;</span>        : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a70bff76f2e56d87c8dee8aa92fe56d29" title="Scan through the physical parameter space.">ScanPVals</a>,
<a name="l00069"></a>00069                           <span class="stringliteral">&#39;SINGLE&#39;</span>            : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a1477d2b88faa1d4991418538133abcff" title="A single-point objective function computation.">SinglePoint</a>,
<a name="l00070"></a>00070                           <span class="stringliteral">&#39;GRADIENT&#39;</span>          : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ac5adf24cf3ea3976eb67f75b6b89d101" title="A single-point gradient computation.">Gradient</a>,
<a name="l00071"></a>00071                           <span class="stringliteral">&#39;HESSIAN&#39;</span>           : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a0c16ad8678a6480e235a45d69fb077d3" title="A single-point Hessian computation.">Hessian</a>,
<a name="l00072"></a>00072                           <span class="stringliteral">&#39;FDCHECKG&#39;</span>          : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aacf96d137fb0e491af7e380c8bd61eb9" title="Finite-difference checker for the objective function gradient.">FDCheckG</a>,
<a name="l00073"></a>00073                           <span class="stringliteral">&#39;FDCHECKH&#39;</span>          : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#adb86c1f6580bb088a23563a6103986fe" title="Finite-difference checker for the objective function Hessian.">FDCheckH</a>
<a name="l00074"></a>00074                           }
<a name="l00075"></a>00075         
<a name="l00076"></a>00076         <span class="comment">#======================================#</span>
<a name="l00077"></a>00077         <span class="comment"># Options that are given by the parser #</span>
<a name="l00078"></a>00078         <span class="comment">#======================================#</span>
<a name="l00079"></a>00079         <span class="comment">## The root directory</span>
<a name="l00080"></a>00080         self.set_option(options,<span class="stringliteral">&#39;root&#39;</span>,<span class="stringliteral">&#39;root&#39;</span>)
<a name="l00081"></a>00081         <span class="comment">## The job type</span>
<a name="l00082"></a>00082         self.set_option(options,<span class="stringliteral">&#39;jobtype&#39;</span>,<span class="stringliteral">&#39;jobtype&#39;</span>)
<a name="l00083"></a>00083         <span class="comment">## Initial step size trust radius</span>
<a name="l00084"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1">00084</a>         self.set_option(options,<span class="stringliteral">&#39;trust0&#39;</span>,<span class="stringliteral">&#39;trust0&#39;</span>)
<a name="l00085"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a45f221523fe7b5b869967d7640b49864">00085</a>         <span class="comment">## Minimum trust radius (for noisy objective functions)</span>
<a name="l00086"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb">00086</a>         self.set_option(options,<span class="stringliteral">&#39;mintrust&#39;</span>,<span class="stringliteral">&#39;mintrust&#39;</span>)
<a name="l00087"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd">00087</a>         <span class="comment">## Lower bound on Hessian eigenvalue (below this, we add in steepest descent)</span>
<a name="l00088"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a482102f9a8fc0fa5120db5078684fb53">00088</a>         self.set_option(options,<span class="stringliteral">&#39;eig_lowerbound&#39;</span>,<span class="stringliteral">&#39;eps&#39;</span>)
<a name="l00089"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75">00089</a>         <span class="comment">## Guess value for Brent</span>
<a name="l00090"></a>00090         self.set_option(options,<span class="stringliteral">&#39;lm_guess&#39;</span>,<span class="stringliteral">&#39;lmg&#39;</span>)
<a name="l00091"></a>00091         <span class="comment">## Step size for numerical finite difference</span>
<a name="l00092"></a>00092         self.set_option(options,<span class="stringliteral">&#39;finite_difference_h&#39;</span>,<span class="stringliteral">&#39;h&#39;</span>)
<a name="l00093"></a>00093         <span class="comment">## Number of steps to average over</span>
<a name="l00094"></a>00094         self.set_option(options,<span class="stringliteral">&#39;objective_history&#39;</span>,<span class="stringliteral">&#39;hist&#39;</span>)
<a name="l00095"></a>00095         <span class="comment">## Function value convergence threshold</span>
<a name="l00096"></a>00096         self.set_option(options,<span class="stringliteral">&#39;convergence_objective&#39;</span>,<span class="stringliteral">&#39;conv_obj&#39;</span>)
<a name="l00097"></a>00097         <span class="comment">## Step size convergence threshold</span>
<a name="l00098"></a>00098         self.set_option(options,<span class="stringliteral">&#39;convergence_step&#39;</span>,<span class="stringliteral">&#39;conv_stp&#39;</span>)
<a name="l00099"></a>00099         <span class="comment">## Gradient convergence threshold</span>
<a name="l00100"></a>00100         self.set_option(options,<span class="stringliteral">&#39;convergence_gradient&#39;</span>,<span class="stringliteral">&#39;conv_grd&#39;</span>)
<a name="l00101"></a>00101         <span class="comment">## Maximum number of optimization steps</span>
<a name="l00102"></a>00102         self.set_option(options,<span class="stringliteral">&#39;maxstep&#39;</span>,<span class="stringliteral">&#39;maxstep&#39;</span>)
<a name="l00103"></a>00103         <span class="comment">## For scan[mp]vals: The parameter index to scan over</span>
<a name="l00104"></a>00104         self.set_option(options,<span class="stringliteral">&#39;scanindex_num&#39;</span>,<span class="stringliteral">&#39;idxnum&#39;</span>)
<a name="l00105"></a>00105         <span class="comment">## For scan[mp]vals: The parameter name to scan over, it just looks up an index</span>
<a name="l00106"></a>00106         self.set_option(options,<span class="stringliteral">&#39;scanindex_name&#39;</span>,<span class="stringliteral">&#39;idxname&#39;</span>)
<a name="l00107"></a>00107         <span class="comment">## For scan[mp]vals: The values that are fed into the scanner</span>
<a name="l00108"></a>00108         self.set_option(options,<span class="stringliteral">&#39;scan_vals&#39;</span>,<span class="stringliteral">&#39;scan_vals&#39;</span>)
<a name="l00109"></a>00109         <span class="comment">## Name of the checkpoint file that we&#39;re reading in</span>
<a name="l00110"></a>00110         self.set_option(options,<span class="stringliteral">&#39;readchk&#39;</span>,<span class="stringliteral">&#39;rchk_fnm&#39;</span>)
<a name="l00111"></a>00111         <span class="comment">## Name of the checkpoint file that we&#39;re writing out</span>
<a name="l00112"></a>00112         self.set_option(options,<span class="stringliteral">&#39;writechk&#39;</span>,<span class="stringliteral">&#39;wchk_fnm&#39;</span>)
<a name="l00113"></a>00113         <span class="comment">## Whether to write the checkpoint file at every step</span>
<a name="l00114"></a>00114         self.set_option(options,<span class="stringliteral">&#39;writechk_step&#39;</span>,<span class="stringliteral">&#39;wchk_step&#39;</span>)
<a name="l00115"></a>00115         <span class="comment">## Adaptive trust radius adjustment factor</span>
<a name="l00116"></a>00116         self.set_option(options,<span class="stringliteral">&#39;adaptive_factor&#39;</span>,<span class="stringliteral">&#39;adapt_fac&#39;</span>)
<a name="l00117"></a>00117         <span class="comment">## Adaptive trust radius adjustment damping</span>
<a name="l00118"></a>00118         self.set_option(options,<span class="stringliteral">&#39;adaptive_damping&#39;</span>,<span class="stringliteral">&#39;adapt_damp&#39;</span>)
<a name="l00119"></a>00119         <span class="comment">## Whether to print gradient during each step of the optimization</span>
<a name="l00120"></a>00120         self.set_option(options,<span class="stringliteral">&#39;print_gradient&#39;</span>,<span class="stringliteral">&#39;print_grad&#39;</span>)
<a name="l00121"></a>00121         <span class="comment">## Whether to print Hessian during each step of the optimization</span>
<a name="l00122"></a>00122         self.set_option(options,<span class="stringliteral">&#39;print_hessian&#39;</span>,<span class="stringliteral">&#39;print_hess&#39;</span>)
<a name="l00123"></a>00123         <span class="comment">## Whether to print parameters during each step of the optimization</span>
<a name="l00124"></a>00124         self.set_option(options,<span class="stringliteral">&#39;print_parameters&#39;</span>,<span class="stringliteral">&#39;print_vals&#39;</span>)
<a name="l00125"></a>00125         <span class="comment">## Error tolerance (if objective function rises by less than this, then the optimizer will forge ahead!)</span>
<a name="l00126"></a>00126         self.set_option(options,<span class="stringliteral">&#39;error_tolerance&#39;</span>,<span class="stringliteral">&#39;err_tol&#39;</span>)
<a name="l00127"></a>00127         <span class="comment">## Search tolerance (The nonlinear search will stop if the change is below this threshold)</span>
<a name="l00128"></a>00128         self.set_option(options,<span class="stringliteral">&#39;search_tolerance&#39;</span>,<span class="stringliteral">&#39;search_tol&#39;</span>)
<a name="l00129"></a>00129         self.set_option(options,<span class="stringliteral">&#39;read_mvals&#39;</span>)
<a name="l00130"></a>00130         self.set_option(options,<span class="stringliteral">&#39;read_pvals&#39;</span>)
<a name="l00131"></a>00131         
<a name="l00132"></a>00132         <span class="comment">#======================================#</span>
<a name="l00133"></a>00133         <span class="comment">#     Variables which are set here     #</span>
<a name="l00134"></a>00134         <span class="comment">#======================================#</span>
<a name="l00135"></a>00135         <span class="comment">## The objective function (needs to pass in when I instantiate)</span>
<a name="l00136"></a>00136         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The root directory.">Objective</a> = Objective
<a name="l00137"></a>00137         <span class="comment">## Whether the penalty function is hyperbolic</span>
<a name="l00138"></a>00138         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a45f221523fe7b5b869967d7640b49864" title="Whether the penalty function is hyperbolic.">bhyp</a>      = Objective.Penalty.ptyp != 2
<a name="l00139"></a>00139         <span class="comment">## The force field itself</span>
<a name="l00140"></a>00140         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>        = FF
<a name="l00141"></a>00141         
<a name="l00142"></a>00142         <span class="comment">#======================================#</span>
<a name="l00143"></a>00143         <span class="comment">#    Variables from the force field    #</span>
<a name="l00144"></a>00144         <span class="comment">#======================================#</span>
<a name="l00145"></a>00145         <span class="comment">## The indices to be excluded from the Hessian update</span>
<a name="l00146"></a>00146         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>  = list(FF.excision)
<a name="l00147"></a>00147 
<a name="l00148"></a>00148         <span class="comment">## Number of parameters</span>
<a name="l00149"></a>00149         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a482102f9a8fc0fa5120db5078684fb53" title="Number of parameters.">np</a>        = FF.np
<a name="l00150"></a>00150         <span class="comment">## The original parameter values</span>
<a name="l00151"></a>00151         <span class="keywordflow">if</span> options[<span class="stringliteral">&#39;read_mvals&#39;</span>] != <span class="keywordtype">None</span>:
<a name="l00152"></a>00152             self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>    = np.array(options[<span class="stringliteral">&#39;read_mvals&#39;</span>])
<a name="l00153"></a>00153         <span class="keywordflow">elif</span> options[<span class="stringliteral">&#39;read_pvals&#39;</span>] != <span class="keywordtype">None</span>:
<a name="l00154"></a>00154             self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>    = FF.create_mvals(options[<span class="stringliteral">&#39;read_pvals&#39;</span>])
<a name="l00155"></a>00155         <span class="keywordflow">else</span>:
<a name="l00156"></a>00156             self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>    = np.zeros(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.np)
<a name="l00157"></a>00157 
<a name="l00158"></a>00158         <span class="comment">## Print the optimizer options.</span>
<a name="l00159"></a>00159         <a class="code" href="namespaceforcebalance_1_1nifty.html#a51180e960742cc7547749fdfb3513ec4" title="See documentation for printcool; this is a nice way to print out keys/values in a dictionary...">printcool_dictionary</a>(self.PrintOptionDict, title=<span class="stringliteral">&quot;Setup for optimizer&quot;</span>)
<a name="l00160"></a>00160         <span class="comment">## Load the checkpoint file.</span>
<a name="l00161"></a>00161         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a05ee5fe985b3e2ec71071ca061e42d66" title="Read the checkpoint file for the main optimizer.">readchk</a>()
<a name="l00162"></a>00162         
<a name="l00163"></a>00163     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a85688c895ce936fa4368d9e2f7fcb4b5" title="Call the appropriate optimizer.">Run</a>(self):
<a name="l00164"></a>00164         <span class="stringliteral">&quot;&quot;&quot; Call the appropriate optimizer.  This is the method we might want to call from an executable. &quot;&quot;&quot;</span>
<a name="l00165"></a>00165 
<a name="l00166"></a>00166         xk = self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#acd9866c0bb48a8f49f2dca1d83441bde" title="A list of all the things we can ask the optimizer to do.">OptTab</a>[self.jobtype]()
<a name="l00167"></a>00167         
<a name="l00168"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a85688c895ce936fa4368d9e2f7fcb4b5">00168</a>         <span class="comment">## Sometimes the optimizer doesn&#39;t return anything (i.e. in the case of a single point calculation)</span>
<a name="l00169"></a>00169         <span class="comment">## In these situations, don&#39;t do anything</span>
<a name="l00170"></a>00170         <span class="keywordflow">if</span> xk == <span class="keywordtype">None</span>: <span class="keywordflow">return</span>
<a name="l00171"></a>00171 
<a name="l00172"></a>00172         <span class="comment">## Check derivatives by finite difference after the optimization is over (for good measure)</span>
<a name="l00173"></a>00173         check_after = <span class="keyword">False</span>
<a name="l00174"></a>00174         <span class="keywordflow">if</span> check_after:
<a name="l00175"></a>00175             self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a> = xk.copy()
<a name="l00176"></a>00176             self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aacf96d137fb0e491af7e380c8bd61eb9" title="Finite-difference checker for the objective function gradient.">FDCheckG</a>()
<a name="l00177"></a>00177 
<a name="l00178"></a>00178         <span class="comment">## Print out final answer</span>
<a name="l00179"></a>00179         final_print = <span class="keyword">True</span>
<a name="l00180"></a>00180         <span class="keywordflow">if</span> final_print:
<a name="l00181"></a>00181             bar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Final optimization parameters:\n Paste to input file to restart&quot;</span>,bold=<span class="keyword">True</span>,color=4)
<a name="l00182"></a>00182             logger.info(<span class="stringliteral">&quot;read_mvals\n&quot;</span>)
<a name="l00183"></a>00183             self.FF.print_map(xk)
<a name="l00184"></a>00184             logger.info(<span class="stringliteral">&quot;/read_mvals\n&quot;</span>)
<a name="l00185"></a>00185             bar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Final physical parameters:&quot;</span>,bold=<span class="keyword">True</span>,color=4)
<a name="l00186"></a>00186             self.FF.print_map(self.FF.create_pvals(xk))
<a name="l00187"></a>00187             logger.info(bar)
<a name="l00188"></a>00188             self.FF.make(xk,<span class="keyword">False</span>,<span class="stringliteral">&#39;result&#39;</span>)
<a name="l00189"></a>00189             logger.info(<span class="stringliteral">&quot;\nThe final force field has been printed to the &#39;result&#39; directory.\n&quot;</span>)
<a name="l00190"></a>00190             <span class="comment">#bar = printcool(&quot;\x1b[1;45;93mCongratulations, ForceBalance has finished\x1b[0m\n\x1b[1;45;93mGive yourself a pat on the back!\x1b[0m&quot;)</span>
<a name="l00191"></a>00191             bar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Congratulations, ForceBalance has finished\nGive yourself a pat on the back!&quot;</span>,ansi=<span class="stringliteral">&quot;1;44;93&quot;</span>)
<a name="l00192"></a>00192 
<a name="l00193"></a>00193         <span class="comment">## Write out stuff to checkpoint file</span>
<a name="l00194"></a>00194         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aa7ac7cda43b70ac58ccbd6c8445e88ef" title="Write the checkpoint file for the main optimizer.">writechk</a>()
<a name="l00195"></a>00195 
<a name="l00196"></a>00196         <span class="keywordflow">return</span> xk
<a name="l00197"></a>00197             
<a name="l00198"></a>00198     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a1d222f82239075ea0d6b9294b2f50e12" title="The main ForceBalance adaptive trust-radius pseudo-Newton optimizer.">MainOptimizer</a>(self,b_BFGS=0):
<a name="l00199"></a>00199         <span class="stringliteral">&quot;&quot;&quot; The main ForceBalance adaptive trust-radius pseudo-Newton optimizer.  Tried and true in many situations. :)</span>
<a name="l00200"></a>00200 <span class="stringliteral"></span>
<a name="l00201"></a>00201 <span class="stringliteral">        Usually this function is called with the BFGS or NewtonRaphson</span>
<a name="l00202"></a>00202 <span class="stringliteral">        method.  The NewtonRaphson method is consistently the best</span>
<a name="l00203"></a>00203 <span class="stringliteral">        method I have, because I always provide at least an</span>
<a name="l00204"></a>00204 <span class="stringliteral">        approximate Hessian to the objective function.  The BFGS</span>
<a name="l00205"></a>00205 <span class="stringliteral">        method is vestigial and currently does not work.</span>
<a name="l00206"></a>00206 <span class="stringliteral"></span>
<a name="l00207"></a>00207 <span class="stringliteral">        BFGS is a pseudo-Newton method in the sense that it builds an</span>
<a name="l00208"></a>00208 <span class="stringliteral">        approximate Hessian matrix from the gradient information in previous</span>
<a name="l00209"></a>00209 <span class="stringliteral">        steps; Newton-Raphson requires the actual Hessian matrix.</span>
<a name="l00210"></a>00210 <span class="stringliteral">        However, the algorithms are similar in that they both compute the</span>
<a name="l00211"></a>00211 <span class="stringliteral">        step by inverting the Hessian and multiplying by the gradient.</span>
<a name="l00212"></a>00212 <span class="stringliteral"></span>
<a name="l00213"></a>00213 <span class="stringliteral">        The method adaptively changes the step size.  If the step is</span>
<a name="l00214"></a>00214 <span class="stringliteral">        sufficiently good (i.e. the objective function goes down by a</span>
<a name="l00215"></a>00215 <span class="stringliteral">        large fraction of the predicted decrease), then the step size</span>
<a name="l00216"></a>00216 <span class="stringliteral">        is increased; if the step is bad, then it rejects the step and</span>
<a name="l00217"></a>00217 <span class="stringliteral">        tries again.</span>
<a name="l00218"></a>00218 <span class="stringliteral"></span>
<a name="l00219"></a>00219 <span class="stringliteral">        The optimization is terminated after either a function value or</span>
<a name="l00220"></a>00220 <span class="stringliteral">        step size tolerance is reached.</span>
<a name="l00221"></a>00221 <span class="stringliteral"></span>
<a name="l00222"></a>00222 <span class="stringliteral">        @param[in] b_BFGS Switch to use BFGS (True) or Newton-Raphson (False)</span>
<a name="l00223"></a>00223 <span class="stringliteral"></span>
<a name="l00224"></a>00224 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00225"></a>00225         <span class="keywordflow">if</span> any([<span class="stringliteral">&#39;liquid&#39;</span> <span class="keywordflow">in</span> tgt.name.lower() <span class="keywordflow">for</span> tgt <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The root directory.">Objective</a>.Targets]) <span class="keywordflow">and</span> self.conv_obj &lt; 1e-3:
<a name="l00226"></a>00226             <a class="code" href="namespaceforcebalance_1_1nifty.html#abb8f59044961a12588e0653c2baa8b01">warn_press_key</a>(<span class="stringliteral">&quot;Condensed phase targets detected - may not converge with current choice of convergence_objective (%.e)\nRecommended range is 1e-2 - 1e-1 for this option.&quot;</span> % self.conv_obj)
<a name="l00227"></a>00227         <span class="comment"># Parameters for the adaptive trust radius</span>
<a name="l00228"></a>00228         a = self.adapt_fac  <span class="comment"># Default value is 0.5, decrease to make more conservative.  Zero to turn off all adaptive.</span>
<a name="l00229"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a1d222f82239075ea0d6b9294b2f50e12">00229</a>         b = self.adapt_damp <span class="comment"># Default value is 0.5, increase to make more conservative</span>
<a name="l00230"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a">00230</a>         <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>( <span class="stringliteral">&quot;Main Optimizer\n%s Mode%s&quot;</span> % (<span class="stringliteral">&quot;BFGS&quot;</span> <span class="keywordflow">if</span> b_BFGS <span class="keywordflow">else</span> <span class="stringliteral">&quot;Newton-Raphson&quot;</span>, <span class="stringliteral">&quot; (Static Radius)&quot;</span> <span class="keywordflow">if</span> a == 0.0 <span class="keywordflow">else</span> <span class="stringliteral">&quot; (Adaptive Radius)&quot;</span>), ansi=1, bold=1)
<a name="l00231"></a>00231         <span class="comment"># First, set a bunch of starting values</span>
<a name="l00232"></a>00232         Ord         = 1 <span class="keywordflow">if</span> b_BFGS <span class="keywordflow">else</span> 2
<a name="l00233"></a>00233         <span class="comment">#Ord         = 2</span>
<a name="l00234"></a>00234         <span class="keyword">global</span> ITERATION_NUMBER
<a name="l00235"></a>00235         ITERATION_NUMBER = 0
<a name="l00236"></a>00236         <span class="keyword">global</span> GOODSTEP
<a name="l00237"></a>00237         Best_Step = 1
<a name="l00238"></a>00238         <span class="keywordflow">if</span> all(i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a> <span class="keywordflow">for</span> i <span class="keywordflow">in</span> [<span class="stringliteral">&#39;xk&#39;</span>,<span class="stringliteral">&#39;X&#39;</span>,<span class="stringliteral">&#39;G&#39;</span>,<span class="stringliteral">&#39;H&#39;</span>,<span class="stringliteral">&#39;ehist&#39;</span>,<span class="stringliteral">&#39;x_best&#39;</span>,<span class="stringliteral">&#39;xk_prev&#39;</span>,<span class="stringliteral">&#39;trust&#39;</span>]):
<a name="l00239"></a>00239             logger.info(<span class="stringliteral">&quot;Reading initial objective, gradient, Hessian from checkpoint file\n&quot;</span>)
<a name="l00240"></a>00240             xk, X, G, H, ehist     = self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>[<span class="stringliteral">&#39;xk&#39;</span>], self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>[<span class="stringliteral">&#39;X&#39;</span>], self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>[<span class="stringliteral">&#39;G&#39;</span>], self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>[<span class="stringliteral">&#39;H&#39;</span>], self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>[<span class="stringliteral">&#39;ehist&#39;</span>]
<a name="l00241"></a>00241             X_best, xk_prev, trust = self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>[<span class="stringliteral">&#39;x_best&#39;</span>], self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>[<span class="stringliteral">&#39;xk_prev&#39;</span>], self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>[<span class="stringliteral">&#39;trust&#39;</span>]
<a name="l00242"></a>00242         <span class="keywordflow">else</span>:
<a name="l00243"></a>00243             xk       = self.mvals0.copy()
<a name="l00244"></a>00244             logger.info(<span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00245"></a>00245             data     = self.Objective.Full(xk,Ord,verbose=<span class="keyword">True</span>)
<a name="l00246"></a>00246             X, G, H  = data[<span class="stringliteral">&#39;X&#39;</span>], data[<span class="stringliteral">&#39;G&#39;</span>], data[<span class="stringliteral">&#39;H&#39;</span>]
<a name="l00247"></a>00247             ehist    = np.array([X])
<a name="l00248"></a>00248             xk_prev  = xk.copy()
<a name="l00249"></a>00249             trust    = abs(self.trust0)
<a name="l00250"></a>00250             X_best   = X
<a name="l00251"></a>00251 
<a name="l00252"></a>00252         X_prev   = X
<a name="l00253"></a>00253         G_prev   = G.copy()
<a name="l00254"></a>00254         H_stor   = H.copy()
<a name="l00255"></a>00255         ndx    = 0.0
<a name="l00256"></a>00256         color  = <span class="stringliteral">&quot;\x1b[1m&quot;</span>
<a name="l00257"></a>00257         nxk = norm(xk)
<a name="l00258"></a>00258         ngr = norm(G)
<a name="l00259"></a>00259 
<a name="l00260"></a>00260         Quality  = 0.0
<a name="l00261"></a>00261         restep = <span class="keyword">False</span>
<a name="l00262"></a>00262         GOODSTEP = 1
<a name="l00263"></a>00263         Ord         = 1 <span class="keywordflow">if</span> b_BFGS <span class="keywordflow">else</span> 2
<a name="l00264"></a>00264 
<a name="l00265"></a>00265         <span class="keywordflow">while</span> 1: <span class="comment"># Loop until convergence is reached.</span>
<a name="l00266"></a>00266             <span class="comment">## Put data into the checkpoint file</span>
<a name="l00267"></a>00267             self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a> = {<span class="stringliteral">&#39;xk&#39;</span>: xk, <span class="stringliteral">&#39;X&#39;</span> : X, <span class="stringliteral">&#39;G&#39;</span> : G, <span class="stringliteral">&#39;H&#39;</span>: H, <span class="stringliteral">&#39;ehist&#39;</span>: ehist,
<a name="l00268"></a>00268                         <span class="stringliteral">&#39;x_best&#39;</span>: X_best,<span class="stringliteral">&#39;xk_prev&#39;</span>: xk_prev, <span class="stringliteral">&#39;trust&#39;</span>: trust}
<a name="l00269"></a>00269             <span class="keywordflow">if</span> self.wchk_step:
<a name="l00270"></a>00270                 self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aa7ac7cda43b70ac58ccbd6c8445e88ef" title="Write the checkpoint file for the main optimizer.">writechk</a>()
<a name="l00271"></a>00271             stdfront = len(ehist) &gt; self.hist <span class="keywordflow">and</span> np.std(np.sort(ehist)[:self.hist]) <span class="keywordflow">or</span> (len(ehist) &gt; 0 <span class="keywordflow">and</span> np.std(ehist) <span class="keywordflow">or</span> 0.0)
<a name="l00272"></a>00272             stdfront *= 2
<a name="l00273"></a>00273             logger.info(<span class="stringliteral">&quot;%6s%12s%12s%12s%14s%12s%12s\n&quot;</span> % (<span class="stringliteral">&quot;Step&quot;</span>, <span class="stringliteral">&quot;  |k|  &quot;</span>,<span class="stringliteral">&quot;  |dk|  &quot;</span>,<span class="stringliteral">&quot; |grad| &quot;</span>,<span class="stringliteral">&quot;    -=X2=-  &quot;</span>,<span class="stringliteral">&quot;Delta(X2)&quot;</span>, <span class="stringliteral">&quot;StepQual&quot;</span>))
<a name="l00274"></a>00274             logger.info(<span class="stringliteral">&quot;%6i%12.3e%12.3e%12.3e%s%14.5e\x1b[0m%12.3e% 11.3f\n\n&quot;</span> % (ITERATION_NUMBER, nxk, ndx, ngr, color, X, stdfront, Quality))
<a name="l00275"></a>00275             <span class="comment"># Check the convergence criteria</span>
<a name="l00276"></a>00276             <span class="keywordflow">if</span> ngr &lt; self.conv_grd:
<a name="l00277"></a>00277                 logger.info(<span class="stringliteral">&quot;Convergence criterion reached for gradient norm (%.2e)\n&quot;</span> % self.conv_grd)
<a name="l00278"></a>00278                 <span class="keywordflow">break</span>
<a name="l00279"></a>00279             <span class="keywordflow">if</span> ITERATION_NUMBER == self.maxstep:
<a name="l00280"></a>00280                 logger.info(<span class="stringliteral">&quot;Maximum number of optimization steps reached (%i)\n&quot;</span> % ITERATION_NUMBER)
<a name="l00281"></a>00281                 <span class="keywordflow">break</span>
<a name="l00282"></a>00282             <span class="keywordflow">if</span> ndx &lt; self.conv_stp <span class="keywordflow">and</span> ITERATION_NUMBER &gt; 0 <span class="keywordflow">and</span> <span class="keywordflow">not</span> restep:
<a name="l00283"></a>00283                 logger.info(<span class="stringliteral">&quot;Convergence criterion reached in step size (%.2e)\n&quot;</span> % self.conv_stp)
<a name="l00284"></a>00284                 <span class="keywordflow">break</span>
<a name="l00285"></a>00285             <span class="keywordflow">if</span> stdfront &lt; self.conv_obj <span class="keywordflow">and</span> len(ehist) &gt; self.hist <span class="keywordflow">and</span> <span class="keywordflow">not</span> restep: <span class="comment"># Factor of two is so [0,1] stdev is normalized to 1</span>
<a name="l00286"></a>00286                 logger.info(<span class="stringliteral">&quot;Convergence criterion reached for objective function (%.2e)\n&quot;</span> % self.conv_obj)
<a name="l00287"></a>00287                 <span class="keywordflow">break</span>
<a name="l00288"></a>00288             <span class="keywordflow">if</span> self.print_grad:
<a name="l00289"></a>00289                 bar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Total Gradient&quot;</span>,color=4)
<a name="l00290"></a>00290                 self.FF.print_map(vals=G,precision=8)
<a name="l00291"></a>00291                 logger.info(bar)
<a name="l00292"></a>00292             <span class="keywordflow">if</span> self.print_hess:
<a name="l00293"></a>00293                 bar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Total Hessian&quot;</span>,color=4)
<a name="l00294"></a>00294                 <a class="code" href="namespaceforcebalance_1_1nifty.html#af61d76c8eb78c8ee52a43e239ff26cb4" title="Printout of a 2-D matrix.">pmat2d</a>(H,precision=8)
<a name="l00295"></a>00295                 logger.info(bar)
<a name="l00296"></a>00296             <span class="keywordflow">for</span> key, val <span class="keywordflow">in</span> self.Objective.ObjDict.items():
<a name="l00297"></a>00297                 <span class="keywordflow">if</span> Best_Step:
<a name="l00298"></a>00298                     self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The root directory.">Objective</a>.ObjDict_Last[key] = val
<a name="l00299"></a>00299             restep = <span class="keyword">False</span>
<a name="l00300"></a>00300             dx, dX_expect, bump = self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aacc231ff56f5d87597a95f4e543360a2" title="Computes the next step in the parameter space.">step</a>(xk, data, trust)
<a name="l00301"></a>00301             old_pk = self.FF.create_pvals(xk)
<a name="l00302"></a>00302             old_xk = xk.copy()
<a name="l00303"></a>00303             <span class="comment"># Increment the iteration counter.</span>
<a name="l00304"></a>00304             ITERATION_NUMBER += 1
<a name="l00305"></a>00305             <span class="comment"># Take a step in the parameter space.</span>
<a name="l00306"></a>00306             xk += dx
<a name="l00307"></a>00307             <span class="keywordflow">if</span> self.print_vals:
<a name="l00308"></a>00308                 pk = self.FF.create_pvals(xk)
<a name="l00309"></a>00309                 dp = pk - old_pk
<a name="l00310"></a>00310                 bar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Mathematical Parameters (Current + Step = Next)&quot;</span>,color=5)
<a name="l00311"></a>00311                 self.FF.print_map(vals=[<span class="stringliteral">&quot;% .4e %s %.4e = % .4e&quot;</span> % (old_xk[i], <span class="stringliteral">&#39;+&#39;</span> <span class="keywordflow">if</span> dx[i] &gt;= 0 <span class="keywordflow">else</span> <span class="stringliteral">&#39;-&#39;</span>, abs(dx[i]), xk[i]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(xk))])
<a name="l00312"></a>00312                 logger.info(bar)
<a name="l00313"></a>00313                 bar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Physical Parameters (Current + Step = Next)&quot;</span>,color=5)
<a name="l00314"></a>00314                 self.FF.print_map(vals=[<span class="stringliteral">&quot;% .4e %s %.4e = % .4e&quot;</span> % (old_pk[i], <span class="stringliteral">&#39;+&#39;</span> <span class="keywordflow">if</span> dp[i] &gt;= 0 <span class="keywordflow">else</span> <span class="stringliteral">&#39;-&#39;</span>, abs(dp[i]), pk[i]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(pk))])
<a name="l00315"></a>00315                 logger.info(bar)
<a name="l00316"></a>00316             <span class="comment"># Evaluate the objective function and its derivatives.</span>
<a name="l00317"></a>00317             data        = self.Objective.Full(xk,Ord,verbose=<span class="keyword">True</span>)
<a name="l00318"></a>00318             X, G, H = data[<span class="stringliteral">&#39;X&#39;</span>], data[<span class="stringliteral">&#39;G&#39;</span>], data[<span class="stringliteral">&#39;H&#39;</span>]
<a name="l00319"></a>00319             ndx = norm(dx)
<a name="l00320"></a>00320             nxk = norm(xk)
<a name="l00321"></a>00321             ngr = norm(G)
<a name="l00322"></a>00322             drc = abs(<a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(dx)).argmax()
<a name="l00323"></a>00323 
<a name="l00324"></a>00324             dX_actual = X - X_prev
<a name="l00325"></a>00325             <span class="keywordflow">try</span>:
<a name="l00326"></a>00326                 Quality = dX_actual / dX_expect
<a name="l00327"></a>00327             <span class="keywordflow">except</span>:
<a name="l00328"></a>00328                 logger.warning(<span class="stringliteral">&quot;Warning: Step size of zero detected (i.e. wrong direction).  Try reducing the finite_difference_h parameter\n&quot;</span>)
<a name="l00329"></a>00329                 Quality = 1.0 <span class="comment"># This is a step length of zero.</span>
<a name="l00330"></a>00330 
<a name="l00331"></a>00331             <span class="keywordflow">if</span> Quality &lt;= 0.25 <span class="keywordflow">and</span> X &lt; (X_prev + self.err_tol) <span class="keywordflow">and</span> self.trust0 &gt; 0:
<a name="l00332"></a>00332                 <span class="comment"># If the step quality is bad, then we should decrease the trust radius.</span>
<a name="l00333"></a>00333                 trust = max(ndx*(1./(1+a)), self.mintrust)
<a name="l00334"></a>00334                 logger.info(<span class="stringliteral">&quot;Low quality step, reducing trust radius to % .4e\n&quot;</span> % trust)
<a name="l00335"></a>00335             <span class="keywordflow">if</span> Quality &gt;= 0.75 <span class="keywordflow">and</span> bump <span class="keywordflow">and</span> self.trust0 &gt; 0:
<a name="l00336"></a>00336                 <span class="comment"># If the step quality is good, then we should increase the trust radius.</span>
<a name="l00337"></a>00337                 <span class="comment"># The &#39;a&#39; factor is how much we should grow or shrink the trust radius each step</span>
<a name="l00338"></a>00338                 <span class="comment"># and the &#39;b&#39; factor determines how closely we are tied down to the original value.</span>
<a name="l00339"></a>00339                 <span class="comment"># Recommend values 0.5 and 0.5</span>
<a name="l00340"></a>00340                 trust += a*trust*np.exp(-b*(trust/self.trust0 - 1))
<a name="l00341"></a>00341             <span class="keywordflow">if</span> X &gt; (X_prev + self.err_tol):
<a name="l00342"></a>00342                 Best_Step = 0
<a name="l00343"></a>00343                 <span class="comment"># Toggle switch for rejection (experimenting with no rejection)</span>
<a name="l00344"></a>00344                 Rejects = <span class="keyword">True</span>
<a name="l00345"></a>00345                 GOODSTEP = 0
<a name="l00346"></a>00346                 Reevaluate = <span class="keyword">True</span>
<a name="l00347"></a>00347                 trust = max(ndx*(1./(1+a)), self.mintrust)
<a name="l00348"></a>00348                 logger.info(<span class="stringliteral">&quot;Rejecting step and reducing trust radius to % .4e\n&quot;</span> % trust)
<a name="l00349"></a>00349                 <span class="keywordflow">if</span> Rejects:
<a name="l00350"></a>00350                     xk = xk_prev.copy()
<a name="l00351"></a>00351                     <span class="keywordflow">if</span> Reevaluate:
<a name="l00352"></a>00352                         restep = <span class="keyword">True</span>
<a name="l00353"></a>00353                         color = <span class="stringliteral">&quot;\x1b[91m&quot;</span>
<a name="l00354"></a>00354                         logger.info(<span class="stringliteral">&quot;%6s%12s%12s%12s%14s%12s%12s\n&quot;</span> % (<span class="stringliteral">&quot;Step&quot;</span>, <span class="stringliteral">&quot;  |k|  &quot;</span>,<span class="stringliteral">&quot;  |dk|  &quot;</span>,<span class="stringliteral">&quot; |grad| &quot;</span>,<span class="stringliteral">&quot;    -=X2=-  &quot;</span>,<span class="stringliteral">&quot;Delta(X2)&quot;</span>, <span class="stringliteral">&quot;StepQual&quot;</span>))
<a name="l00355"></a>00355                         logger.info(<span class="stringliteral">&quot;%6i%12.3e%12.3e%12.3e%s%14.5e\x1b[0m%12.3e% 11.3f\n\n&quot;</span> % (ITERATION_NUMBER, nxk, ndx, ngr, color, X, stdfront, Quality))
<a name="l00356"></a>00356                         <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Objective function rises!\nRe-evaluating at the previous point..&quot;</span>,color=1)
<a name="l00357"></a>00357                         ITERATION_NUMBER += 1
<a name="l00358"></a>00358                         data        = self.Objective.Full(xk,Ord,verbose=<span class="keyword">True</span>)
<a name="l00359"></a>00359                         GOODSTEP = 1
<a name="l00360"></a>00360                         X, G, H = data[<span class="stringliteral">&#39;X&#39;</span>], data[<span class="stringliteral">&#39;G&#39;</span>], data[<span class="stringliteral">&#39;H&#39;</span>]
<a name="l00361"></a>00361                         X_prev = X
<a name="l00362"></a>00362                         dx *= 0
<a name="l00363"></a>00363                         ndx = norm(dx)
<a name="l00364"></a>00364                         nxk = norm(xk)
<a name="l00365"></a>00365                         ngr = norm(G)
<a name="l00366"></a>00366                         Quality = 0.0
<a name="l00367"></a>00367                         color = <span class="stringliteral">&quot;\x1b[0m&quot;</span>
<a name="l00368"></a>00368                     <span class="keywordflow">else</span>:
<a name="l00369"></a>00369                         color = <span class="stringliteral">&quot;\x1b[91m&quot;</span>
<a name="l00370"></a>00370                         G = G_prev.copy()
<a name="l00371"></a>00371                         H = H_stor.copy()
<a name="l00372"></a>00372                         data = deepcopy(datastor)
<a name="l00373"></a>00373                     <span class="keywordflow">continue</span>
<a name="l00374"></a>00374             <span class="keywordflow">else</span>:
<a name="l00375"></a>00375                 GOODSTEP = 1
<a name="l00376"></a>00376                 <span class="keywordflow">if</span> X &gt; X_best:
<a name="l00377"></a>00377                     Best_Step = 0
<a name="l00378"></a>00378                     color = <span class="stringliteral">&quot;\x1b[95m&quot;</span>
<a name="l00379"></a>00379                 <span class="keywordflow">else</span>:
<a name="l00380"></a>00380                     Best_Step = 1
<a name="l00381"></a>00381                     color = <span class="stringliteral">&quot;\x1b[92m&quot;</span>
<a name="l00382"></a>00382                     X_best = X
<a name="l00383"></a>00383                 ehist = np.append(ehist, X)
<a name="l00384"></a>00384             <span class="comment"># Hessian update for BFGS.</span>
<a name="l00385"></a>00385             <span class="keywordflow">if</span> b_BFGS:
<a name="l00386"></a>00386                 Hnew = H_stor.copy()
<a name="l00387"></a>00387                 Dx   = <a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(xk - xk_prev)
<a name="l00388"></a>00388                 Dy   = <a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(G  - G_prev)
<a name="l00389"></a>00389                 Mat1 = (Dy*Dy.T)/(Dy.T*Dx)[0,0]
<a name="l00390"></a>00390                 Mat2 = ((Hnew*Dx)*(Hnew*Dx).T)/(Dx.T*Hnew*Dx)[0,0]
<a name="l00391"></a>00391                 Hnew += Mat1-Mat2
<a name="l00392"></a>00392                 H = Hnew.copy()
<a name="l00393"></a>00393                 data[<span class="stringliteral">&#39;H&#39;</span>] = H.copy()
<a name="l00394"></a>00394 
<a name="l00395"></a>00395             datastor= deepcopy(data)
<a name="l00396"></a>00396             G_prev  = G.copy()
<a name="l00397"></a>00397             H_stor  = H.copy()
<a name="l00398"></a>00398             xk_prev = xk.copy()
<a name="l00399"></a>00399             X_prev  = X
<a name="l00400"></a>00400             <span class="keywordflow">if</span> len(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.parmdestroy_this) &gt; 0:
<a name="l00401"></a>00401                 self.FF.parmdestroy_save.append(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.parmdestroy_this)
<a name="l00402"></a>00402                 self.FF.linedestroy_save.append(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.linedestroy_this)
<a name="l00403"></a>00403         
<a name="l00404"></a>00404         bar = <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Final objective function value\nFull: % .6e  Un-penalized: % .6e&quot;</span> % (data[<span class="stringliteral">&#39;X&#39;</span>],data[<span class="stringliteral">&#39;X0&#39;</span>]), <span class="stringliteral">&#39;@&#39;</span>, bold=<span class="keyword">True</span>, color=2)
<a name="l00405"></a>00405         <span class="keywordflow">return</span> xk
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 
<a name="l00408"></a>00408     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aacc231ff56f5d87597a95f4e543360a2" title="Computes the next step in the parameter space.">step</a>(self, xk, data, trust):
<a name="l00409"></a>00409         <span class="stringliteral">&quot;&quot;&quot; Computes the next step in the parameter space.  There are lots of tricks here that I will document later.</span>
<a name="l00410"></a>00410 <span class="stringliteral"></span>
<a name="l00411"></a>00411 <span class="stringliteral">        @param[in] G The gradient</span>
<a name="l00412"></a>00412 <span class="stringliteral">        @param[in] H The Hessian</span>
<a name="l00413"></a>00413 <span class="stringliteral">        @param[in] trust The trust radius</span>
<a name="l00414"></a>00414 <span class="stringliteral">        </span>
<a name="l00415"></a>00415 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00416"></a>00416         <span class="keyword">from</span> scipy <span class="keyword">import</span> optimize
<a name="l00417"></a>00417 
<a name="l00418"></a>00418         X, G, H = (data[<span class="stringliteral">&#39;X0&#39;</span>], data[<span class="stringliteral">&#39;G0&#39;</span>], data[<span class="stringliteral">&#39;H0&#39;</span>]) <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a45f221523fe7b5b869967d7640b49864" title="Whether the penalty function is hyperbolic.">bhyp</a> <span class="keywordflow">else</span> (data[<span class="stringliteral">&#39;X&#39;</span>], data[<span class="stringliteral">&#39;G&#39;</span>], data[<span class="stringliteral">&#39;H&#39;</span>])
<a name="l00419"></a>00419         H1 = H.copy()
<a name="l00420"></a>00420         H1 = np.delete(H1, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>, axis=0)
<a name="l00421"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aacc231ff56f5d87597a95f4e543360a2">00421</a>         H1 = np.delete(H1, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>, axis=1)
<a name="l00422"></a>00422         Eig = eig(H1)[0]            <span class="comment"># Diagonalize Hessian</span>
<a name="l00423"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a145e90c7776604285424a54ed484d651">00423</a>         Emin = min(Eig)
<a name="l00424"></a>00424         <span class="keywordflow">if</span> Emin &lt; self.eps:         <span class="comment"># Mix in SD step if Hessian minimum eigenvalue is negative</span>
<a name="l00425"></a>00425             <span class="comment"># Experiment.</span>
<a name="l00426"></a>00426             Adj = max(self.eps, 0.01*abs(Emin)) - Emin
<a name="l00427"></a>00427             logger.info(<span class="stringliteral">&quot;Hessian has a small or negative eigenvalue (%.1e), mixing in some steepest descent (%.1e) to correct this.\n&quot;</span> % (Emin, Adj))
<a name="l00428"></a>00428             logger.info(<span class="stringliteral">&quot;Eigenvalues are:\n&quot;</span>)   <span class="comment">###</span>
<a name="l00429"></a>00429             <a class="code" href="namespaceforcebalance_1_1nifty.html#a27e3a9dc144a5ad505509ac9ede08d7d" title="Printout of a 1-D vector.">pvec1d</a>(Eig)                <span class="comment">###</span>
<a name="l00430"></a>00430             H += Adj*np.eye(H.shape[0])
<a name="l00431"></a>00431 
<a name="l00432"></a>00432         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a45f221523fe7b5b869967d7640b49864" title="Whether the penalty function is hyperbolic.">bhyp</a>:
<a name="l00433"></a>00433             G = np.delete(G, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>)
<a name="l00434"></a>00434             H = np.delete(H, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>, axis=0)
<a name="l00435"></a>00435             H = np.delete(H, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>, axis=1)
<a name="l00436"></a>00436             xkd = np.delete(xk, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>)
<a name="l00437"></a>00437             <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The root directory.">Objective</a>.Penalty.fmul != 0.0:
<a name="l00438"></a>00438                 <a class="code" href="namespaceforcebalance_1_1nifty.html#abb8f59044961a12588e0653c2baa8b01">warn_press_key</a>(<span class="stringliteral">&quot;Using the multiplicative hyperbolic penalty is discouraged!&quot;</span>)
<a name="l00439"></a>00439             <span class="comment"># This is the gradient and Hessian without the contributions from the hyperbolic constraint.</span>
<a name="l00440"></a>00440             Obj0 = {<span class="stringliteral">&#39;X&#39;</span>:X,<span class="stringliteral">&#39;G&#39;</span>:G,<span class="stringliteral">&#39;H&#39;</span>:H}
<a name="l00441"></a>00441             <span class="keyword">class </span>Hyper(object):
<a name="l00442"></a>00442                 <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a674f1c17cbfaffa7955fb5d833d33e0b" title="Create an Optimizer object.">__init__</a>(self, HL, Penalty):
<a name="l00443"></a>00443                     self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aa082af516e968d41a0e54e5f5901601f">H</a> = HL.copy()
<a name="l00444"></a>00444                     self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#af11c90b57a4d7ba5f93e8d2e4cbc69e8">dx</a> = 1e10 * np.ones(len(HL),dtype=float)
<a name="l00445"></a>00445                     self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a145e90c7776604285424a54ed484d651">Val</a> = 0
<a name="l00446"></a>00446                     self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#afda86a3f46feafc0f581f4e6f223ebcf">Grad</a> = np.zeros(len(HL),dtype=float)
<a name="l00447"></a>00447                     self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ae284871845ef6112dfd915bcb413ef8a">Hess</a> = np.zeros((len(HL),len(HL)),dtype=float)
<a name="l00448"></a>00448                     self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aaf7fba3e0abb466918f5954160e9cbd4">Penalty</a> = Penalty
<a name="l00449"></a>00449                 <span class="keyword">def </span>_compute(self, dx):
<a name="l00450"></a>00450                     self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#af11c90b57a4d7ba5f93e8d2e4cbc69e8">dx</a> = dx.copy()
<a name="l00451"></a>00451                     Tmp = np.mat(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aa082af516e968d41a0e54e5f5901601f">H</a>)*<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(dx)
<a name="l00452"></a>00452                     Reg_Term   = self.Penalty.compute(xkd+<a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(dx), Obj0)
<a name="l00453"></a>00453                     self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a145e90c7776604285424a54ed484d651">Val</a>   = (X + np.dot(dx, G) + 0.5*<a class="code" href="namespaceforcebalance_1_1nifty.html#a6c9727360cdff8f3011a12cc54d0e86e" title="Given any list, array, or matrix, return a 1-row matrix.">row</a>(dx)*Tmp + Reg_Term[0] - data[<span class="stringliteral">&#39;X&#39;</span>])[0,0]
<a name="l00454"></a>00454                     self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#afda86a3f46feafc0f581f4e6f223ebcf">Grad</a>  = <a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(G) + Tmp) + Reg_Term[1]
<a name="l00455"></a>00455                 <span class="keyword">def </span>compute_val(self, dx):
<a name="l00456"></a>00456                     <span class="keywordflow">if</span> norm(dx - self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#af11c90b57a4d7ba5f93e8d2e4cbc69e8">dx</a>) &gt; 1e-8:
<a name="l00457"></a>00457                         self._compute(dx)
<a name="l00458"></a>00458                     <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a145e90c7776604285424a54ed484d651">Val</a>
<a name="l00459"></a>00459                 <span class="keyword">def </span>compute_grad(self, dx):
<a name="l00460"></a>00460                     <span class="keywordflow">if</span> norm(dx - self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#af11c90b57a4d7ba5f93e8d2e4cbc69e8">dx</a>) &gt; 1e-8:
<a name="l00461"></a>00461                         self._compute(dx)
<a name="l00462"></a>00462                     <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#afda86a3f46feafc0f581f4e6f223ebcf">Grad</a>
<a name="l00463"></a>00463                 <span class="keyword">def </span>compute_hess(self, dx):
<a name="l00464"></a>00464                     <span class="keywordflow">if</span> norm(dx - self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#af11c90b57a4d7ba5f93e8d2e4cbc69e8">dx</a>) &gt; 1e-8:
<a name="l00465"></a>00465                         self._compute(dx)
<a name="l00466"></a>00466                     <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ae284871845ef6112dfd915bcb413ef8a">Hess</a>
<a name="l00467"></a>00467             <span class="keyword">def </span>hyper_solver(L):
<a name="l00468"></a>00468                 dx0 = np.zeros(len(xkd),dtype=float)
<a name="l00469"></a>00469                 <span class="comment">#dx0 = np.delete(dx0, self.excision)</span>
<a name="l00470"></a>00470                 <span class="comment"># HL = H + (L-1)**2*np.diag(np.diag(H))</span>
<a name="l00471"></a>00471                 <span class="comment"># Attempt to use plain Levenberg</span>
<a name="l00472"></a>00472                 HL = H + (L-1)**2*np.eye(len(H))
<a name="l00473"></a>00473 
<a name="l00474"></a>00474                 HYP = Hyper(HL, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The root directory.">Objective</a>.Penalty)
<a name="l00475"></a>00475                 <span class="keywordflow">try</span>:
<a name="l00476"></a>00476                     Opt1 = optimize.fmin_bfgs(HYP.compute_val,dx0,fprime=HYP.compute_grad,gtol=1e-5,full_output=<span class="keyword">True</span>,disp=0)
<a name="l00477"></a>00477                 <span class="keywordflow">except</span>:
<a name="l00478"></a>00478                     Opt1 = optimize.fmin(HYP.compute_val,dx0,full_output=<span class="keyword">True</span>,disp=0)
<a name="l00479"></a>00479                 <span class="keywordflow">try</span>:
<a name="l00480"></a>00480                     Opt2 = optimize.fmin_bfgs(HYP.compute_val,-xkd,fprime=HYP.compute_grad,gtol=1e-5,full_output=<span class="keyword">True</span>,disp=0)
<a name="l00481"></a>00481                 <span class="keywordflow">except</span>:
<a name="l00482"></a>00482                     Opt2 = optimize.fmin(HYP.compute_val,-xkd,full_output=<span class="keyword">True</span>,disp=0)
<a name="l00483"></a>00483                 <span class="comment">#Opt2 = optimize.fmin(HYP.compute_val,-xkd,full_output=True,disp=0)</span>
<a name="l00484"></a>00484                 dx1, sol1 = Opt1[0], Opt1[1]
<a name="l00485"></a>00485                 dx2, sol2 = Opt2[0], Opt2[1]
<a name="l00486"></a>00486                 dxb, sol = (dx1, sol1) <span class="keywordflow">if</span> sol1 &lt;= sol2 <span class="keywordflow">else</span> (dx2, sol2)
<a name="l00487"></a>00487                 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>:    <span class="comment"># Reinsert deleted coordinates - don&#39;t take a step in those directions</span>
<a name="l00488"></a>00488                     dxb = np.insert(dxb, i, 0)
<a name="l00489"></a>00489                 <span class="keywordflow">return</span> dxb, sol
<a name="l00490"></a>00490         <span class="keywordflow">else</span>:
<a name="l00491"></a>00491             <span class="comment"># G0 and H0 are used for determining the expected function change.</span>
<a name="l00492"></a>00492             G0 = G.copy()
<a name="l00493"></a>00493             H0 = H.copy()
<a name="l00494"></a>00494             G = np.delete(G, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>)
<a name="l00495"></a>00495             H = np.delete(H, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>, axis=0)
<a name="l00496"></a>00496             H = np.delete(H, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>, axis=1)
<a name="l00497"></a>00497             
<a name="l00498"></a>00498             logger.debug(<span class="stringliteral">&quot;Inverting Hessian:\n&quot;</span>)                 <span class="comment">###</span>
<a name="l00499"></a>00499             logger.debug(<span class="stringliteral">&quot; G:\n&quot;</span>)                                <span class="comment">###</span>
<a name="l00500"></a>00500             <a class="code" href="namespaceforcebalance_1_1nifty.html#a27e3a9dc144a5ad505509ac9ede08d7d" title="Printout of a 1-D vector.">pvec1d</a>(G,precision=5, loglevel=DEBUG)                <span class="comment">###</span>
<a name="l00501"></a>00501             logger.debug(<span class="stringliteral">&quot; H:\n&quot;</span>)                                <span class="comment">###</span>
<a name="l00502"></a>00502             <a class="code" href="namespaceforcebalance_1_1nifty.html#af61d76c8eb78c8ee52a43e239ff26cb4" title="Printout of a 2-D matrix.">pmat2d</a>(H,precision=5, loglevel=DEBUG)                <span class="comment">###</span>
<a name="l00503"></a>00503             
<a name="l00504"></a>00504             Hi = <a class="code" href="namespaceforcebalance_1_1nifty.html#a4c82187e92dfeb8a159f4aa44b501c40" title="Invert a matrix using singular value decomposition.">invert_svd</a>(np.mat(H))
<a name="l00505"></a>00505             dx = <a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(-1 * Hi * <a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(G))
<a name="l00506"></a>00506             
<a name="l00507"></a>00507             logger.debug(<span class="stringliteral">&quot; dx:\n&quot;</span>)                               <span class="comment">###</span>
<a name="l00508"></a>00508             <a class="code" href="namespaceforcebalance_1_1nifty.html#a27e3a9dc144a5ad505509ac9ede08d7d" title="Printout of a 1-D vector.">pvec1d</a>(dx,precision=5, loglevel=DEBUG)                     <span class="comment">###</span>
<a name="l00509"></a>00509             <span class="comment"># dxa = -solve(H, G)          # Take Newton Raphson Step ; use -1*G if want steepest descent.</span>
<a name="l00510"></a>00510             <span class="comment"># dxa = flat(dxa)</span>
<a name="l00511"></a>00511             <span class="comment"># print &quot; dxa:&quot;                              ###</span>
<a name="l00512"></a>00512             <span class="comment"># pvec1d(dxa,precision=5)                    ###</span>
<a name="l00513"></a>00513             
<a name="l00514"></a>00514             logger.info(<span class="stringliteral">&#39;\n&#39;</span>)                                      <span class="comment">###</span>
<a name="l00515"></a>00515             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>:    <span class="comment"># Reinsert deleted coordinates - don&#39;t take a step in those directions</span>
<a name="l00516"></a>00516                 dx = np.insert(dx, i, 0)
<a name="l00517"></a>00517             <span class="keyword">def </span>para_solver(L):
<a name="l00518"></a>00518                 <span class="comment"># Levenberg-Marquardt</span>
<a name="l00519"></a>00519                 <span class="comment"># HT = H + (L-1)**2*np.diag(np.diag(H))</span>
<a name="l00520"></a>00520                 <span class="comment"># Attempt to use plain Levenberg</span>
<a name="l00521"></a>00521                 HT = H + (L-1)**2*np.eye(len(H))
<a name="l00522"></a>00522                 logger.debug(<span class="stringliteral">&quot;Inverting Scaled Hessian:\n&quot;</span>)                       <span class="comment">###</span>
<a name="l00523"></a>00523                 logger.debug(<span class="stringliteral">&quot; G:\n&quot;</span>)                                             <span class="comment">###</span>
<a name="l00524"></a>00524                 <a class="code" href="namespaceforcebalance_1_1nifty.html#a27e3a9dc144a5ad505509ac9ede08d7d" title="Printout of a 1-D vector.">pvec1d</a>(G,precision=5, loglevel=DEBUG)                                   <span class="comment">###</span>
<a name="l00525"></a>00525                 logger.debug(<span class="stringliteral">&quot; HT: (Scal = %.4f)\n&quot;</span> % (1+(L-1)**2))               <span class="comment">###</span>
<a name="l00526"></a>00526                 <a class="code" href="namespaceforcebalance_1_1nifty.html#af61d76c8eb78c8ee52a43e239ff26cb4" title="Printout of a 2-D matrix.">pmat2d</a>(HT,precision=5, loglevel=DEBUG)                                  <span class="comment">###</span>
<a name="l00527"></a>00527                 Hi = <a class="code" href="namespaceforcebalance_1_1nifty.html#a4c82187e92dfeb8a159f4aa44b501c40" title="Invert a matrix using singular value decomposition.">invert_svd</a>(np.mat(HT))
<a name="l00528"></a>00528                 dx = <a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(-1 * Hi * <a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(G))
<a name="l00529"></a>00529                 logger.debug(<span class="stringliteral">&quot; dx:\n&quot;</span>)                                            <span class="comment">###</span>
<a name="l00530"></a>00530                 <a class="code" href="namespaceforcebalance_1_1nifty.html#a27e3a9dc144a5ad505509ac9ede08d7d" title="Printout of a 1-D vector.">pvec1d</a>(dx,precision=5, loglevel=DEBUG)                                  <span class="comment">###</span>
<a name="l00531"></a>00531                 <span class="comment"># dxa = -solve(HT, G)</span>
<a name="l00532"></a>00532                 <span class="comment"># dxa = flat(dxa)</span>
<a name="l00533"></a>00533                 <span class="comment"># print &quot; dxa:&quot;                                           ###</span>
<a name="l00534"></a>00534                 <span class="comment"># pvec1d(dxa,precision=5)                                 ###</span>
<a name="l00535"></a>00535                 <span class="comment"># print                                                   ###</span>
<a name="l00536"></a>00536                 sol = <a class="code" href="namespaceforcebalance_1_1nifty.html#a52114ceee9d55f94d9aecb3e176de294" title="Given any list, array, or matrix, return a single-index array.">flat</a>(0.5*<a class="code" href="namespaceforcebalance_1_1nifty.html#a6c9727360cdff8f3011a12cc54d0e86e" title="Given any list, array, or matrix, return a 1-row matrix.">row</a>(dx)*np.mat(H)*<a class="code" href="namespaceforcebalance_1_1nifty.html#afb3f205bce4984856e766af7e9fdaca8" title="Given any list, array, or matrix, return a 1-column matrix.">col</a>(dx))[0] + np.dot(dx,G)
<a name="l00537"></a>00537                 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>:    <span class="comment"># Reinsert deleted coordinates - don&#39;t take a step in those directions</span>
<a name="l00538"></a>00538                     dx = np.insert(dx, i, 0)
<a name="l00539"></a>00539                 <span class="keywordflow">return</span> dx, sol
<a name="l00540"></a>00540     
<a name="l00541"></a>00541         <span class="keyword">def </span>solver(L):
<a name="l00542"></a>00542             <span class="keywordflow">return</span> hyper_solver(L) <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a45f221523fe7b5b869967d7640b49864" title="Whether the penalty function is hyperbolic.">bhyp</a> <span class="keywordflow">else</span> para_solver(L)
<a name="l00543"></a>00543     
<a name="l00544"></a>00544         <span class="keyword">def </span>trust_fun(L):
<a name="l00545"></a>00545             N = norm(solver(L)[0])
<a name="l00546"></a>00546             logger.debug(<span class="stringliteral">&quot;\rL = %.4e, Hessian diagonal addition = %.4e: found length %.4e, objective is %.4e\n&quot;</span> % (L, (L-1)**2, N, (N - trust)**2))
<a name="l00547"></a>00547             <span class="keywordflow">return</span> (N - trust)**2
<a name="l00548"></a>00548 
<a name="l00549"></a>00549         <span class="keyword">def </span>search_fun(L):
<a name="l00550"></a>00550             <span class="comment"># Evaluate ONLY the objective function.  Most useful when</span>
<a name="l00551"></a>00551             <span class="comment"># the objective is cheap, but the derivative is expensive.</span>
<a name="l00552"></a>00552             dx, sol = solver(L) <span class="comment"># dx is how much the step changes from the previous step.</span>
<a name="l00553"></a>00553             <span class="comment"># This is our trial step.</span>
<a name="l00554"></a>00554             xk_ = dx + xk
<a name="l00555"></a>00555             Result = self.Objective.Full(xk_,0,verbose=<span class="keyword">False</span>)[<span class="stringliteral">&#39;X&#39;</span>] - data[<span class="stringliteral">&#39;X&#39;</span>]
<a name="l00556"></a>00556             logger.info(<span class="stringliteral">&quot;Searching! Hessian diagonal addition = %.4e, L = % .4e, length %.4e, result %.4e\n&quot;</span> % ((L-1)**2,L,norm(dx),Result))
<a name="l00557"></a>00557             <span class="keywordflow">return</span> Result
<a name="l00558"></a>00558         
<a name="l00559"></a>00559         <span class="keywordflow">if</span> self.trust0 &gt; 0: <span class="comment"># This is the trust region code.</span>
<a name="l00560"></a>00560             bump = <span class="keyword">False</span>
<a name="l00561"></a>00561             dx, expect = solver(1)
<a name="l00562"></a>00562             dxnorm = norm(dx)
<a name="l00563"></a>00563             <span class="keywordflow">if</span> dxnorm &gt; trust:
<a name="l00564"></a>00564                 bump = <span class="keyword">True</span>
<a name="l00565"></a>00565                 <span class="comment"># Tried a few optimizers here, seems like Brent works well.</span>
<a name="l00566"></a>00566                 <span class="comment"># Okay, the problem with Brent is that the tolerance is fractional.  </span>
<a name="l00567"></a>00567                 <span class="comment"># If the optimized value is zero, then it takes a lot of meaningless steps.</span>
<a name="l00568"></a>00568                 LOpt = optimize.brent(trust_fun,brack=(self.lmg,self.lmg*4),tol=1e-6)
<a name="l00569"></a>00569                 <span class="comment">### Result = optimize.fmin_powell(trust_fun,3,xtol=self.search_tol,ftol=self.search_tol,full_output=1,disp=0)</span>
<a name="l00570"></a>00570                 <span class="comment">### LOpt = Result[0]</span>
<a name="l00571"></a>00571                 dx, expect = solver(LOpt)
<a name="l00572"></a>00572                 dxnorm = norm(dx)
<a name="l00573"></a>00573 
<a name="l00574"></a>00574                 logger.info(<span class="stringliteral">&quot;\rLevenberg-Marquardt: %s step found (length %.3e), % .8f added to Hessian diagonal\n&quot;</span> % (<span class="stringliteral">&#39;hyperbolic-regularized&#39;</span> <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a45f221523fe7b5b869967d7640b49864" title="Whether the penalty function is hyperbolic.">bhyp</a> <span class="keywordflow">else</span> <span class="stringliteral">&#39;Newton-Raphson&#39;</span>, dxnorm, (LOpt-1)**2))
<a name="l00575"></a>00575         <span class="keywordflow">else</span>: <span class="comment"># This is the nonlinear search code.</span>
<a name="l00576"></a>00576             <span class="comment"># First obtain a step that is the same length as the provided trust radius.</span>
<a name="l00577"></a>00577             LOpt = optimize.brent(trust_fun,brack=(self.lmg,self.lmg*4),tol=1e-6)
<a name="l00578"></a>00578             bump = <span class="keyword">False</span>
<a name="l00579"></a>00579             Result = optimize.brent(search_fun,brack=(LOpt,LOpt*4),tol=self.search_tol,full_output=1)
<a name="l00580"></a>00580             <span class="comment">### optimize.fmin(search_fun,0,xtol=1e-8,ftol=data[&#39;X&#39;]*0.1,full_output=1,disp=0)</span>
<a name="l00581"></a>00581             <span class="comment">### Result = optimize.fmin_powell(search_fun,3,xtol=self.search_tol,ftol=self.search_tol,full_output=1,disp=0)</span>
<a name="l00582"></a>00582             dx, _ = solver(Result[0])
<a name="l00583"></a>00583             expect = Result[1]
<a name="l00584"></a>00584 
<a name="l00585"></a>00585         <span class="comment">## Decide which parameters to redirect.</span>
<a name="l00586"></a>00586         <span class="comment">## Currently not used.</span>
<a name="l00587"></a>00587         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The root directory.">Objective</a>.Penalty.ptyp <span class="keywordflow">in</span> [3,4,5]:
<a name="l00588"></a>00588             self.FF.make_redirect(dx+xk)
<a name="l00589"></a>00589 
<a name="l00590"></a>00590         <span class="keywordflow">return</span> dx, expect, bump
<a name="l00591"></a>00591 
<a name="l00592"></a>00592     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a5b6e95f9f49b7d970ac8441d68a0023f" title="Optimize the force field parameters using the Newton-Raphson method (.">NewtonRaphson</a>(self):
<a name="l00593"></a>00593         <span class="stringliteral">&quot;&quot;&quot; Optimize the force field parameters using the Newton-Raphson method (@see MainOptimizer) &quot;&quot;&quot;</span>
<a name="l00594"></a>00594         <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a1d222f82239075ea0d6b9294b2f50e12" title="The main ForceBalance adaptive trust-radius pseudo-Newton optimizer.">MainOptimizer</a>(b_BFGS=0)
<a name="l00595"></a>00595 
<a name="l00596"></a>00596     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a58b957fe289822934711c29dfeb8d203" title="Optimize the force field parameters using the BFGS method; currently the recommended choice (...">BFGS</a>(self):
<a name="l00597"></a>00597         <span class="stringliteral">&quot;&quot;&quot; Optimize the force field parameters using the BFGS method; currently the recommended choice (@see MainOptimizer) &quot;&quot;&quot;</span>
<a name="l00598"></a>00598         <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a1d222f82239075ea0d6b9294b2f50e12" title="The main ForceBalance adaptive trust-radius pseudo-Newton optimizer.">MainOptimizer</a>(b_BFGS=1)
<a name="l00599"></a>00599 
<a name="l00600"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a5b6e95f9f49b7d970ac8441d68a0023f">00600</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a503e87533bd9c257cb9c4b505af9c1de" title="Driver for SciPy optimizations.">ScipyOptimizer</a>(self,Algorithm=&quot;None&quot;):
<a name="l00601"></a>00601         <span class="stringliteral">&quot;&quot;&quot; Driver for SciPy optimizations.</span>
<a name="l00602"></a>00602 <span class="stringliteral"></span>
<a name="l00603"></a>00603 <span class="stringliteral">        Using any of the SciPy optimizers requires that SciPy is installed.</span>
<a name="l00604"></a>00604 <span class="stringliteral">        This method first defines several wrappers around the objective function that the SciPy</span>
<a name="l00605"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a58b957fe289822934711c29dfeb8d203">00605</a> <span class="stringliteral">        optimizers can use.  Then it calls the algorith mitself.</span>
<a name="l00606"></a>00606 <span class="stringliteral"></span>
<a name="l00607"></a>00607 <span class="stringliteral">        @param[in] Algorithm The optimization algorithm to use, for example &#39;powell&#39;, &#39;simplex&#39; or &#39;anneal&#39;</span>
<a name="l00608"></a>00608 <span class="stringliteral"></span>
<a name="l00609"></a>00609 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00610"></a>00610         <span class="keyword">from</span> scipy <span class="keyword">import</span> optimize
<a name="l00611"></a>00611         <span class="keyword">def </span>xwrap(func,verbose=True):
<a name="l00612"></a>00612             <span class="keyword">def </span>my_func(mvals):
<a name="l00613"></a>00613                 <span class="keywordflow">if</span> verbose: logger.info(<span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00614"></a>00614                 Answer = func(mvals,Order=0,verbose=verbose)[<span class="stringliteral">&#39;X&#39;</span>]
<a name="l00615"></a>00615                 dx = (my_func.x_best - Answer) <span class="keywordflow">if</span> my_func.x_best != <span class="keywordtype">None</span> <span class="keywordflow">else</span> 0.0
<a name="l00616"></a>00616                 <span class="keywordflow">if</span> Answer &lt; my_func.x_best <span class="keywordflow">or</span> my_func.x_best == <span class="keywordtype">None</span>:
<a name="l00617"></a>00617                     color = <span class="stringliteral">&quot;\x1b[92m&quot;</span>
<a name="l00618"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a503e87533bd9c257cb9c4b505af9c1de">00618</a>                     my_func.x_best = Answer
<a name="l00619"></a>00619                 <span class="keywordflow">else</span>:
<a name="l00620"></a>00620                     color = <span class="stringliteral">&quot;\x1b[91m&quot;</span>
<a name="l00621"></a>00621                 <span class="keywordflow">if</span> verbose:
<a name="l00622"></a>00622                     <span class="keywordflow">if</span> self.print_vals:
<a name="l00623"></a>00623                         logger.info(<span class="stringliteral">&quot;k=&quot;</span> + <span class="stringliteral">&#39; &#39;</span>.join([<span class="stringliteral">&quot;% .4f&quot;</span> % i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> mvals]) + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00624"></a>00624                     logger.info(<span class="stringliteral">&quot;X2= %s%12.3e\x1b[0m d(X2)= %12.3e\n&quot;</span> % (color,Answer,dx))
<a name="l00625"></a>00625                 <span class="keywordflow">if</span> Answer != Answer:
<a name="l00626"></a>00626                     <span class="keywordflow">return</span> 1e10
<a name="l00627"></a>00627                 <span class="keywordflow">else</span>:
<a name="l00628"></a>00628                     <span class="keywordflow">return</span> Answer
<a name="l00629"></a>00629             my_func.x_best = <span class="keywordtype">None</span>
<a name="l00630"></a>00630             <span class="keywordflow">return</span> my_func
<a name="l00631"></a>00631         <span class="keyword">def </span>gwrap(func,verbose=True):
<a name="l00632"></a>00632             <span class="keyword">def </span>my_gfunc(mvals):
<a name="l00633"></a>00633                 <span class="keywordflow">if</span> verbose: logger.info(<span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00634"></a>00634                 Output = func(mvals,Order=1,verbose=verbose)
<a name="l00635"></a>00635                 Answer = Output[<span class="stringliteral">&#39;G&#39;</span>]
<a name="l00636"></a>00636                 Objective = Output[<span class="stringliteral">&#39;X&#39;</span>]
<a name="l00637"></a>00637                 dx = (my_gfunc.x_best - Objective) <span class="keywordflow">if</span> my_gfunc.x_best != <span class="keywordtype">None</span> <span class="keywordflow">else</span> 0.0
<a name="l00638"></a>00638                 <span class="keywordflow">if</span> Objective &lt; my_gfunc.x_best <span class="keywordflow">or</span> my_gfunc.x_best == <span class="keywordtype">None</span>:
<a name="l00639"></a>00639                     color = <span class="stringliteral">&quot;\x1b[92m&quot;</span>
<a name="l00640"></a>00640                     my_gfunc.x_best = Objective
<a name="l00641"></a>00641                 <span class="keywordflow">else</span>:
<a name="l00642"></a>00642                     color = <span class="stringliteral">&quot;\x1b[91m&quot;</span>
<a name="l00643"></a>00643                 <span class="keywordflow">if</span> verbose:
<a name="l00644"></a>00644                     <span class="keywordflow">if</span> self.print_vals:
<a name="l00645"></a>00645                         logger.info(<span class="stringliteral">&quot;k=&quot;</span> + <span class="stringliteral">&#39; &#39;</span>.join([<span class="stringliteral">&quot;% .4f&quot;</span> % i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> mvals]) + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00646"></a>00646                     logger.info(<span class="stringliteral">&quot;|Grad|= %12.3e X2= %s%12.3e\x1b[0m d(X2)= %12.3e\n\n&quot;</span> % (norm(Answer),color,Objective,dx))
<a name="l00647"></a>00647                 <span class="keywordflow">return</span> Answer
<a name="l00648"></a>00648             my_gfunc.x_best = <span class="keywordtype">None</span>
<a name="l00649"></a>00649             <span class="keywordflow">return</span> my_gfunc
<a name="l00650"></a>00650         <span class="keywordflow">if</span> Algorithm == <span class="stringliteral">&quot;powell&quot;</span>:
<a name="l00651"></a>00651             <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Minimizing Objective Function using Powell&#39;s Method&quot;</span> , ansi=1, bold=1)
<a name="l00652"></a>00652             <span class="keywordflow">return</span> optimize.fmin_powell(xwrap(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The root directory.">Objective</a>.Full),self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,ftol=self.conv_obj,xtol=self.conv_stp,maxiter=self.maxstep)
<a name="l00653"></a>00653         <span class="keywordflow">elif</span> Algorithm == <span class="stringliteral">&quot;simplex&quot;</span>:
<a name="l00654"></a>00654             <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Minimizing Objective Function using Simplex Method&quot;</span> , ansi=1, bold=1)
<a name="l00655"></a>00655             <span class="keywordflow">return</span> optimize.fmin(xwrap(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The root directory.">Objective</a>.Full),self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,ftol=self.conv_obj,xtol=self.conv_stp,maxiter=self.maxstep,maxfun=self.maxstep*10)
<a name="l00656"></a>00656         <span class="keywordflow">elif</span> Algorithm == <span class="stringliteral">&quot;anneal&quot;</span>:
<a name="l00657"></a>00657             <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Minimizing Objective Function using Simulated Annealing&quot;</span> , ansi=1, bold=1)
<a name="l00658"></a>00658             <span class="keywordflow">return</span> optimize.anneal(xwrap(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The root directory.">Objective</a>.Full),self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,lower=-1*self.trust0*np.ones(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a482102f9a8fc0fa5120db5078684fb53" title="Number of parameters.">np</a>),upper=self.trust0*np.ones(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a482102f9a8fc0fa5120db5078684fb53" title="Number of parameters.">np</a>),schedule=<span class="stringliteral">&#39;boltzmann&#39;</span>)
<a name="l00659"></a>00659         <span class="keywordflow">elif</span> Algorithm == <span class="stringliteral">&quot;cg&quot;</span>:
<a name="l00660"></a>00660             <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Minimizing Objective Function using Conjugate Gradient&quot;</span> , ansi=1, bold=1)
<a name="l00661"></a>00661             <span class="keywordflow">return</span> optimize.fmin_cg(xwrap(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The root directory.">Objective</a>.Full,verbose=<span class="keyword">False</span>),self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,fprime=gwrap(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The root directory.">Objective</a>.Full),gtol=self.conv_grd)
<a name="l00662"></a>00662 
<a name="l00663"></a>00663     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a50ffc779fbba5a99085cba45d868fc29" title="Genetic algorithm, under development.">GeneticAlgorithm</a>(self):
<a name="l00664"></a>00664         
<a name="l00665"></a>00665         <span class="stringliteral">&quot;&quot;&quot; </span>
<a name="l00666"></a>00666 <span class="stringliteral">        Genetic algorithm, under development. It currently works but a</span>
<a name="l00667"></a>00667 <span class="stringliteral">        genetic algorithm is more like a concept; i.e. there is no</span>
<a name="l00668"></a>00668 <span class="stringliteral">        single way to implement it.</span>
<a name="l00669"></a>00669 <span class="stringliteral">        </span>
<a name="l00670"></a>00670 <span class="stringliteral">        @todo Massive parallelization hasn&#39;t been implemented yet</span>
<a name="l00671"></a>00671 <span class="stringliteral"></span>
<a name="l00672"></a>00672 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00673"></a>00673         <span class="keyword">def </span>generate_fresh(rows, cols):
<a name="l00674"></a>00674             new_guys = np.zeros((rows, cols))
<a name="l00675"></a>00675             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(rows):
<a name="l00676"></a>00676                 new_guys[i, int(cols*np.random.random())] = self.trust0 * np.random.randn()
<a name="l00677"></a>00677             <span class="keywordflow">return</span> new_guys
<a name="l00678"></a>00678         
<a name="l00679"></a>00679         <span class="keyword">def </span>cross_over(chrom1, chrom2):
<a name="l00680"></a>00680             crosspt = 1 + int((len(chrom1) - 1) * np.random.random())
<a name="l00681"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a50ffc779fbba5a99085cba45d868fc29">00681</a>             Ans1 = np.hstack((chrom1[:crosspt],chrom2[crosspt:]))
<a name="l00682"></a>00682             Ans2 = np.hstack((chrom2[:crosspt],chrom1[crosspt:]))
<a name="l00683"></a>00683             <span class="keywordflow">return</span> Ans1, Ans2
<a name="l00684"></a>00684 
<a name="l00685"></a>00685         <span class="keyword">def </span>mutate(chrom):
<a name="l00686"></a>00686             mutpt = int(len(chrom) * np.random.random())
<a name="l00687"></a>00687             chrom[mutpt] += self.trust0 * np.random.randn()
<a name="l00688"></a>00688             <span class="keywordflow">return</span> chrom
<a name="l00689"></a>00689 
<a name="l00690"></a>00690         <span class="keyword">def </span>initial_generation():
<a name="l00691"></a>00691             <span class="keywordflow">return</span> np.vstack((self.mvals0.copy(),np.random.randn(PopSize, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.np)*self.trust0)) / (self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.np ** 0.5)
<a name="l00692"></a>00692             <span class="comment">#return np.vstack((self.mvals0.copy(),generate_fresh(PopSize, self.np)))</span>
<a name="l00693"></a>00693 
<a name="l00694"></a>00694         <span class="keyword">def </span>calculate_fitness(pop):
<a name="l00695"></a>00695             <span class="keywordflow">return</span> [self.Objective.Full(i,Order=0,verbose=<span class="keyword">False</span>)[<span class="stringliteral">&#39;X&#39;</span>] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> pop]
<a name="l00696"></a>00696 
<a name="l00697"></a>00697         <span class="keyword">def </span>sort_by_fitness(fits):
<a name="l00698"></a>00698             <span class="keywordflow">return</span> np.sort(fits), np.argsort(fits)
<a name="l00699"></a>00699 
<a name="l00700"></a>00700         <span class="keyword">def </span>generate_new_population(sorted, pop):
<a name="l00701"></a>00701             newpop = pop[sorted[1]]
<a name="l00702"></a>00702             <span class="comment"># Individuals in this range are kept</span>
<a name="l00703"></a>00703             a = range(KeepNum)
<a name="l00704"></a>00704             logger.info(<span class="stringliteral">&quot;Keeping: &quot;</span> + str(a) + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00705"></a>00705             random.shuffle(a)
<a name="l00706"></a>00706             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(0, KeepNum, 2):
<a name="l00707"></a>00707                 logger.info(<span class="stringliteral">&quot;%i and %i reproducing to replace %i and %i\n&quot;</span> % (a[i],a[i+1],len(newpop)-i-2,len(newpop)-i-1))
<a name="l00708"></a>00708                 newpop[-i-1], newpop[-i-2] = cross_over(newpop[a[i]],newpop[a[i+1]])
<a name="l00709"></a>00709             b = range(KeepNum, len(newpop))
<a name="l00710"></a>00710             random.shuffle(b)
<a name="l00711"></a>00711             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> b[:MutNum]:
<a name="l00712"></a>00712                 logger.info(<span class="stringliteral">&quot;Randomly mutating %i\n&quot;</span> % i)
<a name="l00713"></a>00713                 newpop[i] = mutate(newpop[i])
<a name="l00714"></a>00714             <span class="keywordflow">return</span> newpop
<a name="l00715"></a>00715             
<a name="l00716"></a>00716         <span class="keyword">def </span>xwrap(func,verbose=True):
<a name="l00717"></a>00717             <span class="keyword">def </span>my_func(mvals):
<a name="l00718"></a>00718                 <span class="keywordflow">if</span> verbose: logger.info(<span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00719"></a>00719                 Answer = func(mvals,Order=0,verbose=verbose)[<span class="stringliteral">&#39;X&#39;</span>]
<a name="l00720"></a>00720                 dx = (my_func.x_best - Answer) <span class="keywordflow">if</span> my_func.x_best != <span class="keywordtype">None</span> <span class="keywordflow">else</span> 0.0
<a name="l00721"></a>00721                 <span class="keywordflow">if</span> Answer &lt; my_func.x_best <span class="keywordflow">or</span> my_func.x_best == <span class="keywordtype">None</span>:
<a name="l00722"></a>00722                     color = <span class="stringliteral">&quot;\x1b[92m&quot;</span>
<a name="l00723"></a>00723                     my_func.x_best = Answer
<a name="l00724"></a>00724                 <span class="keywordflow">else</span>:
<a name="l00725"></a>00725                     color = <span class="stringliteral">&quot;\x1b[91m&quot;</span>
<a name="l00726"></a>00726                 <span class="keywordflow">if</span> verbose:
<a name="l00727"></a>00727                     logger.info(<span class="stringliteral">&quot;k=&quot;</span> + <span class="stringliteral">&#39; &#39;</span>.join([<span class="stringliteral">&quot;% .4f&quot;</span> % i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> mvals]) + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00728"></a>00728                     logger.info(<span class="stringliteral">&quot;X2= %s%12.3e\x1b[0m d(X2)= %12.3e\n&quot;</span> % (color,Answer,dx))
<a name="l00729"></a>00729                 <span class="keywordflow">return</span> Answer
<a name="l00730"></a>00730             my_func.x_best = <span class="keywordtype">None</span>
<a name="l00731"></a>00731             <span class="keywordflow">return</span> my_func
<a name="l00732"></a>00732 
<a name="l00733"></a>00733         PopSize = 120
<a name="l00734"></a>00734         KeepThresh = 0.5
<a name="l00735"></a>00735         MutProb = 0.1
<a name="l00736"></a>00736         CrosProb = 0.5
<a name="l00737"></a>00737         
<a name="l00738"></a>00738         KeepNum = int(KeepThresh * PopSize)
<a name="l00739"></a>00739         MutNum = int(MutProb * PopSize)
<a name="l00740"></a>00740         CrosNum = int(CrosProb/2 * PopSize) * 2
<a name="l00741"></a>00741         Population = initial_generation()
<a name="l00742"></a>00742         Gen = 0
<a name="l00743"></a>00743 
<a name="l00744"></a>00744         Best = [[],[]]
<a name="l00745"></a>00745 
<a name="l00746"></a>00746         <span class="keywordflow">while</span> <span class="keyword">True</span>:
<a name="l00747"></a>00747             <span class="comment">#print Population</span>
<a name="l00748"></a>00748             Fits = calculate_fitness(Population)
<a name="l00749"></a>00749             Sorted = sort_by_fitness(Fits)
<a name="l00750"></a>00750             logger.info(str(Sorted))
<a name="l00751"></a>00751             Best[0].append(Sorted[0][0])
<a name="l00752"></a>00752             Best[1].append(Population[Sorted[1][0]])
<a name="l00753"></a>00753             logger.info(str(Best))
<a name="l00754"></a>00754             <span class="keywordflow">if</span> Gen == self.maxstep: <span class="keywordflow">break</span>
<a name="l00755"></a>00755             Population = generate_new_population(Sorted, Population)
<a name="l00756"></a>00756             Gen += 1
<a name="l00757"></a>00757 
<a name="l00758"></a>00758         logger.info(str(Best))
<a name="l00759"></a>00759         <span class="keywordflow">return</span> Population[Sorted[1][0]]
<a name="l00760"></a>00760         
<a name="l00761"></a>00761 
<a name="l00762"></a>00762     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6b3af8115718f61a6a21c3297d717ead" title="Use SciPy&#39;s built-in simplex algorithm to optimize the parameters.">Simplex</a>(self):
<a name="l00763"></a>00763         <span class="stringliteral">&quot;&quot;&quot; Use SciPy&#39;s built-in simplex algorithm to optimize the parameters. @see Optimizer::ScipyOptimizer &quot;&quot;&quot;</span>
<a name="l00764"></a>00764         <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a503e87533bd9c257cb9c4b505af9c1de" title="Driver for SciPy optimizations.">ScipyOptimizer</a>(Algorithm=<span class="stringliteral">&quot;simplex&quot;</span>)
<a name="l00765"></a>00765 
<a name="l00766"></a>00766     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a0745b2e3607ef308ba48bb1d34e5be79" title="Use SciPy&#39;s built-in Powell direction-set algorithm to optimize the parameters.">Powell</a>(self):
<a name="l00767"></a>00767         <span class="stringliteral">&quot;&quot;&quot; Use SciPy&#39;s built-in Powell direction-set algorithm to optimize the parameters. @see Optimizer::ScipyOptimizer &quot;&quot;&quot;</span>
<a name="l00768"></a>00768         <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a503e87533bd9c257cb9c4b505af9c1de" title="Driver for SciPy optimizations.">ScipyOptimizer</a>(Algorithm=<span class="stringliteral">&quot;powell&quot;</span>)
<a name="l00769"></a>00769 
<a name="l00770"></a>00770     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a183911848e43ca0be1893b87290dc31e" title="Use SciPy&#39;s built-in simulated annealing algorithm to optimize the parameters.">Anneal</a>(self):
<a name="l00771"></a>00771         <span class="stringliteral">&quot;&quot;&quot; Use SciPy&#39;s built-in simulated annealing algorithm to optimize the parameters. @see Optimizer::ScipyOptimizer &quot;&quot;&quot;</span>
<a name="l00772"></a>00772         <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a503e87533bd9c257cb9c4b505af9c1de" title="Driver for SciPy optimizations.">ScipyOptimizer</a>(Algorithm=<span class="stringliteral">&quot;anneal&quot;</span>)
<a name="l00773"></a>00773 
<a name="l00774"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6b3af8115718f61a6a21c3297d717ead">00774</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ad1e151204a172a4e75737b2b699d1623" title="Use SciPy&#39;s built-in simulated annealing algorithm to optimize the parameters.">ConjugateGradient</a>(self):
<a name="l00775"></a>00775         <span class="stringliteral">&quot;&quot;&quot; Use SciPy&#39;s built-in simulated annealing algorithm to optimize the parameters. @see Optimizer::ScipyOptimizer &quot;&quot;&quot;</span>
<a name="l00776"></a>00776         <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a503e87533bd9c257cb9c4b505af9c1de" title="Driver for SciPy optimizations.">ScipyOptimizer</a>(Algorithm=<span class="stringliteral">&quot;cg&quot;</span>)
<a name="l00777"></a>00777 
<a name="l00778"></a>00778     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6c7508252398ff7e00469c4c8acb0a48" title="Scan through parameter values.">Scan_Values</a>(self,MathPhys=1):
<a name="l00779"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a0745b2e3607ef308ba48bb1d34e5be79">00779</a>         <span class="stringliteral">&quot;&quot;&quot; Scan through parameter values.</span>
<a name="l00780"></a>00780 <span class="stringliteral"></span>
<a name="l00781"></a>00781 <span class="stringliteral">        This option is activated using the inputs:</span>
<a name="l00782"></a>00782 <span class="stringliteral"></span>
<a name="l00783"></a>00783 <span class="stringliteral">        @code</span>
<a name="l00784"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a183911848e43ca0be1893b87290dc31e">00784</a> <span class="stringliteral">        scan[mp]vals</span>
<a name="l00785"></a>00785 <span class="stringliteral">        scan_vals low:hi:nsteps</span>
<a name="l00786"></a>00786 <span class="stringliteral">        scan_idxnum (number) -or-</span>
<a name="l00787"></a>00787 <span class="stringliteral">        scan_idxname (name)</span>
<a name="l00788"></a>00788 <span class="stringliteral">        @endcode</span>
<a name="l00789"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ad1e151204a172a4e75737b2b699d1623">00789</a> <span class="stringliteral">        </span>
<a name="l00790"></a>00790 <span class="stringliteral">        This method goes to the specified parameter indices and scans through</span>
<a name="l00791"></a>00791 <span class="stringliteral">        the supplied values, evaluating the objective function at every step.</span>
<a name="l00792"></a>00792 <span class="stringliteral"></span>
<a name="l00793"></a>00793 <span class="stringliteral">        I hope this method will be useful for people who just want to look at</span>
<a name="l00794"></a>00794 <span class="stringliteral">        changing one or two parameters and seeing how it affects the force</span>
<a name="l00795"></a>00795 <span class="stringliteral">        field performance.</span>
<a name="l00796"></a>00796 <span class="stringliteral"></span>
<a name="l00797"></a>00797 <span class="stringliteral">        @todo Maybe a multidimensional grid can be done.</span>
<a name="l00798"></a>00798 <span class="stringliteral">        @param[in] MathPhys Switch to use mathematical (True) or physical (False) parameters.</span>
<a name="l00799"></a>00799 <span class="stringliteral">        </span>
<a name="l00800"></a>00800 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00801"></a>00801         <span class="comment"># First make sure that the user entered the correct syntax.</span>
<a name="l00802"></a>00802         <span class="keywordflow">try</span>:
<a name="l00803"></a>00803             vals_in = [float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.scan_vals.split(<span class="stringliteral">&quot;:&quot;</span>)]
<a name="l00804"></a>00804         <span class="keywordflow">except</span>:
<a name="l00805"></a>00805             logger.error(<span class="stringliteral">&quot;Syntax error: in the input file please use scan_vals low:hi:nsteps\n&quot;</span>)
<a name="l00806"></a>00806             sys.exit(1)
<a name="l00807"></a>00807         <span class="keywordflow">if</span> len(vals_in) != 3:
<a name="l00808"></a>00808             logger.error(<span class="stringliteral">&quot;Syntax error: in the input file please use scan_vals low:hi:nsteps\n&quot;</span>)
<a name="l00809"></a>00809             sys.exit(1)
<a name="l00810"></a>00810         idx = [int(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.idxnum]
<a name="l00811"></a>00811         <span class="keywordflow">for</span> j <span class="keywordflow">in</span> self.idxname:
<a name="l00812"></a>00812             idx += [self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.map[i] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.map <span class="keywordflow">if</span> j <span class="keywordflow">in</span> i]
<a name="l00813"></a>00813         idx = set(idx)
<a name="l00814"></a>00814         scanvals = np.linspace(vals_in[0],vals_in[1],vals_in[2])
<a name="l00815"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6c7508252398ff7e00469c4c8acb0a48">00815</a>         logger.info(str(vals_in) + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00816"></a>00816         logger.info(str(scanvals) + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00817"></a>00817         <span class="keywordflow">for</span> pidx <span class="keywordflow">in</span> idx:
<a name="l00818"></a>00818             <span class="keywordflow">if</span> MathPhys:
<a name="l00819"></a>00819                 logger.info(<span class="stringliteral">&quot;Scanning parameter %i (%s) in the mathematical space\n&quot;</span> % (pidx,self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.plist[pidx]))
<a name="l00820"></a>00820                 vals = self.mvals0.copy()
<a name="l00821"></a>00821             <span class="keywordflow">else</span>:
<a name="l00822"></a>00822                 logger.info(<span class="stringliteral">&quot;Scanning parameter %i (%s) in the physical space\n&quot;</span> % (pidx,self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.plist[pidx]))
<a name="l00823"></a>00823                 self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.use_pvals = <span class="keyword">True</span>
<a name="l00824"></a>00824                 vals = self.FF.pvals0.copy()
<a name="l00825"></a>00825             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> scanvals:
<a name="l00826"></a>00826                 vals[pidx] = i
<a name="l00827"></a>00827                 data        = self.Objective.Full(vals,Order=0)
<a name="l00828"></a>00828                 logger.info(<span class="stringliteral">&quot;Value = % .4e Objective = % .4e\n&quot;</span> % (i, data[<span class="stringliteral">&#39;X&#39;</span>]))
<a name="l00829"></a>00829 
<a name="l00830"></a>00830     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a43ab8c6bea2b3112468922ab61163f67" title="Scan through the mathematical parameter space.">ScanMVals</a>(self):
<a name="l00831"></a>00831         <span class="stringliteral">&quot;&quot;&quot; Scan through the mathematical parameter space. @see Optimizer::ScanValues &quot;&quot;&quot;</span>
<a name="l00832"></a>00832         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6c7508252398ff7e00469c4c8acb0a48" title="Scan through parameter values.">Scan_Values</a>(1)
<a name="l00833"></a>00833 
<a name="l00834"></a>00834     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a70bff76f2e56d87c8dee8aa92fe56d29" title="Scan through the physical parameter space.">ScanPVals</a>(self):
<a name="l00835"></a>00835         <span class="stringliteral">&quot;&quot;&quot; Scan through the physical parameter space. @see Optimizer::ScanValues &quot;&quot;&quot;</span>
<a name="l00836"></a>00836         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6c7508252398ff7e00469c4c8acb0a48" title="Scan through parameter values.">Scan_Values</a>(0)
<a name="l00837"></a>00837 
<a name="l00838"></a>00838     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a1477d2b88faa1d4991418538133abcff" title="A single-point objective function computation.">SinglePoint</a>(self):
<a name="l00839"></a>00839         <span class="stringliteral">&quot;&quot;&quot; A single-point objective function computation. &quot;&quot;&quot;</span>
<a name="l00840"></a>00840         data        = self.Objective.Full(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,Order=0,verbose=<span class="keyword">True</span>)
<a name="l00841"></a>00841         logger.info(<span class="stringliteral">&quot;The objective function is:&quot;</span> + str(data[<span class="stringliteral">&#39;X&#39;</span>]) + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00842"></a>00842 
<a name="l00843"></a>00843     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ac5adf24cf3ea3976eb67f75b6b89d101" title="A single-point gradient computation.">Gradient</a>(self):
<a name="l00844"></a>00844         <span class="stringliteral">&quot;&quot;&quot; A single-point gradient computation. &quot;&quot;&quot;</span>
<a name="l00845"></a>00845         data        = self.Objective.Full(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,Order=1)
<a name="l00846"></a>00846         logger.info(str(data[<span class="stringliteral">&#39;X&#39;</span>]) + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00847"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a43ab8c6bea2b3112468922ab61163f67">00847</a>         logger.info(str(data[<span class="stringliteral">&#39;G&#39;</span>]) + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00848"></a>00848         logger.info(str(data[<span class="stringliteral">&#39;H&#39;</span>]) + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00849"></a>00849 
<a name="l00850"></a>00850     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a0c16ad8678a6480e235a45d69fb077d3" title="A single-point Hessian computation.">Hessian</a>(self):
<a name="l00851"></a>00851         <span class="stringliteral">&quot;&quot;&quot; A single-point Hessian computation. &quot;&quot;&quot;</span>
<a name="l00852"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a70bff76f2e56d87c8dee8aa92fe56d29">00852</a>         data        = self.Objective.Full(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,Order=2)
<a name="l00853"></a>00853         logger.info(str(data[<span class="stringliteral">&#39;X&#39;</span>]) + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00854"></a>00854         logger.info(str(data[<span class="stringliteral">&#39;G&#39;</span>]) + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00855"></a>00855         logger.info(str(data[<span class="stringliteral">&#39;H&#39;</span>]) + <span class="stringliteral">&#39;\n&#39;</span>)
<a name="l00856"></a>00856 
<a name="l00857"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a1477d2b88faa1d4991418538133abcff">00857</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aacf96d137fb0e491af7e380c8bd61eb9" title="Finite-difference checker for the objective function gradient.">FDCheckG</a>(self):
<a name="l00858"></a>00858         <span class="stringliteral">&quot;&quot;&quot; Finite-difference checker for the objective function gradient.</span>
<a name="l00859"></a>00859 <span class="stringliteral"></span>
<a name="l00860"></a>00860 <span class="stringliteral">        For each element in the gradient, use a five-point finite difference</span>
<a name="l00861"></a>00861 <span class="stringliteral">        stencil to compute a finite-difference derivative, and compare it to</span>
<a name="l00862"></a>00862 <span class="stringliteral">        the analytic result.</span>
<a name="l00863"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ac5adf24cf3ea3976eb67f75b6b89d101">00863</a> <span class="stringliteral"></span>
<a name="l00864"></a>00864 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00865"></a>00865 
<a name="l00866"></a>00866         Adata        = self.Objective.Full(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,Order=1)[<span class="stringliteral">&#39;G&#39;</span>]
<a name="l00867"></a>00867         Fdata        = np.zeros(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.np,dtype=float)
<a name="l00868"></a>00868         <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Checking first derivatives by finite difference!\n%-8s%-20s%13s%13s%13s%13s&quot;</span> \
<a name="l00869"></a>00869                   % (<span class="stringliteral">&quot;Index&quot;</span>, <span class="stringliteral">&quot;Parameter ID&quot;</span>,<span class="stringliteral">&quot;Analytic&quot;</span>,<span class="stringliteral">&quot;Numerical&quot;</span>,<span class="stringliteral">&quot;Difference&quot;</span>,<span class="stringliteral">&quot;Fractional&quot;</span>),bold=1,color=5)
<a name="l00870"></a>00870         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.np):
<a name="l00871"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a0c16ad8678a6480e235a45d69fb077d3">00871</a>             Fdata[i] = <a class="code" href="namespaceforcebalance_1_1finite__difference.html#a9be9f0d21300958092e380514e2e980d" title="A highly accurate seven-point finite difference stencil for computing derivatives of a function...">f1d7p</a>(<a class="code" href="namespaceforcebalance_1_1finite__difference.html#ae484c591ae8c4e5bae73a0ef2660c339" title="A function wrapper for finite difference designed for differentiating &#39;get&#39;-type functions.">fdwrap</a>(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The root directory.">Objective</a>.Full,self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,i,<span class="stringliteral">&#39;X&#39;</span>,Order=0),self.h)
<a name="l00872"></a>00872             Denom = max(abs(Adata[i]),abs(Fdata[i]))
<a name="l00873"></a>00873             Denom = Denom &gt; 1e-8 <span class="keywordflow">and</span> Denom <span class="keywordflow">or</span> 1e-8
<a name="l00874"></a>00874             D = Adata[i] - Fdata[i]
<a name="l00875"></a>00875             Q = (Adata[i] - Fdata[i])/Denom
<a name="l00876"></a>00876             cD = abs(D) &gt; 0.5 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[1;91m&quot;</span> <span class="keywordflow">or</span> (abs(D) &gt; 1e-2 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[91m&quot;</span> <span class="keywordflow">or</span> (abs(D) &gt; 1e-5 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[93m&quot;</span> <span class="keywordflow">or</span> <span class="stringliteral">&quot;\x1b[92m&quot;</span>))
<a name="l00877"></a>00877             cQ = abs(Q) &gt; 0.5 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[1;91m&quot;</span> <span class="keywordflow">or</span> (abs(Q) &gt; 1e-2 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[91m&quot;</span> <span class="keywordflow">or</span> (abs(Q) &gt; 1e-5 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[93m&quot;</span> <span class="keywordflow">or</span> <span class="stringliteral">&quot;\x1b[92m&quot;</span>))
<a name="l00878"></a>00878             logger.info(<span class="stringliteral">&quot;\r    %-8i%-20s% 13.4e% 13.4e%s% 13.4e%s% 13.4e\x1b[0m\n&quot;</span> \
<a name="l00879"></a>00879                   % (i, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.plist[i][:20], Adata[i], Fdata[i], cD, D, cQ, Q))
<a name="l00880"></a>00880 
<a name="l00881"></a>00881     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#adb86c1f6580bb088a23563a6103986fe" title="Finite-difference checker for the objective function Hessian.">FDCheckH</a>(self):
<a name="l00882"></a>00882         <span class="stringliteral">&quot;&quot;&quot; Finite-difference checker for the objective function Hessian.</span>
<a name="l00883"></a>00883 <span class="stringliteral"></span>
<a name="l00884"></a>00884 <span class="stringliteral">        For each element in the Hessian, use a five-point stencil in both</span>
<a name="l00885"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aacf96d137fb0e491af7e380c8bd61eb9">00885</a> <span class="stringliteral">        parameter indices to compute a finite-difference derivative, and</span>
<a name="l00886"></a>00886 <span class="stringliteral">        compare it to the analytic result.</span>
<a name="l00887"></a>00887 <span class="stringliteral"></span>
<a name="l00888"></a>00888 <span class="stringliteral">        This is meant to be a foolproof checker, so it is pretty slow.  We</span>
<a name="l00889"></a>00889 <span class="stringliteral">        could write a faster checker if we assumed we had accurate first</span>
<a name="l00890"></a>00890 <span class="stringliteral">        derivatives, but it&#39;s better to not make that assumption.</span>
<a name="l00891"></a>00891 <span class="stringliteral"></span>
<a name="l00892"></a>00892 <span class="stringliteral">        The second derivative is computed by double-wrapping the objective</span>
<a name="l00893"></a>00893 <span class="stringliteral">        function via the &#39;wrap2&#39; function.</span>
<a name="l00894"></a>00894 <span class="stringliteral"></span>
<a name="l00895"></a>00895 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00896"></a>00896         Adata        = self.Objective.Full(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,Order=2)[<span class="stringliteral">&#39;H&#39;</span>]
<a name="l00897"></a>00897         Fdata        = np.zeros((self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.np,self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.np),dtype=float)
<a name="l00898"></a>00898         <a class="code" href="namespaceforcebalance_1_1nifty.html#a11babd62dc7bca389162c6318f9672ca" title="Cool-looking printout for slick formatting of output.">printcool</a>(<span class="stringliteral">&quot;Checking second derivatives by finite difference!\n%-8s%-20s%-20s%13s%13s%13s%13s&quot;</span> \
<a name="l00899"></a>00899                   % (<span class="stringliteral">&quot;Index&quot;</span>, <span class="stringliteral">&quot;Parameter1 ID&quot;</span>, <span class="stringliteral">&quot;Parameter2 ID&quot;</span>, <span class="stringliteral">&quot;Analytic&quot;</span>,<span class="stringliteral">&quot;Numerical&quot;</span>,<span class="stringliteral">&quot;Difference&quot;</span>,<span class="stringliteral">&quot;Fractional&quot;</span>),bold=1,color=5)
<a name="l00900"></a>00900 
<a name="l00901"></a>00901         <span class="comment"># Whee, our double-wrapped finite difference second derivative!</span>
<a name="l00902"></a>00902         <span class="keyword">def </span>wrap2(mvals0,pidxi,pidxj):
<a name="l00903"></a>00903             <span class="keyword">def </span>func1(arg):
<a name="l00904"></a>00904                 mvals = list(mvals0)
<a name="l00905"></a>00905                 mvals[pidxj] += arg
<a name="l00906"></a>00906                 <span class="keywordflow">return</span> <a class="code" href="namespaceforcebalance_1_1finite__difference.html#a123c5d5dea0f3f50ab57796bb3bc39be" title="A highly accurate five-point finite difference stencil for computing derivatives of a function...">f1d5p</a>(<a class="code" href="namespaceforcebalance_1_1finite__difference.html#ae484c591ae8c4e5bae73a0ef2660c339" title="A function wrapper for finite difference designed for differentiating &#39;get&#39;-type functions.">fdwrap</a>(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The root directory.">Objective</a>.Full,mvals,pidxi,<span class="stringliteral">&#39;X&#39;</span>,Order=0),self.h)
<a name="l00907"></a>00907             <span class="keywordflow">return</span> func1
<a name="l00908"></a>00908         
<a name="l00909"></a>00909         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.np):
<a name="l00910"></a>00910             <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(i,self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.np):
<a name="l00911"></a>00911                 Fdata[i,j] = <a class="code" href="namespaceforcebalance_1_1finite__difference.html#a123c5d5dea0f3f50ab57796bb3bc39be" title="A highly accurate five-point finite difference stencil for computing derivatives of a function...">f1d5p</a>(wrap2(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,i,j),self.h)
<a name="l00912"></a>00912                 Denom = max(abs(Adata[i,j]),abs(Fdata[i,j]))
<a name="l00913"></a>00913                 Denom = Denom &gt; 1e-8 <span class="keywordflow">and</span> Denom <span class="keywordflow">or</span> 1e-8
<a name="l00914"></a>00914                 D = Adata[i,j] - Fdata[i,j]
<a name="l00915"></a>00915                 Q = (Adata[i,j] - Fdata[i,j])/Denom
<a name="l00916"></a>00916                 cD = abs(D) &gt; 0.5 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[1;91m&quot;</span> <span class="keywordflow">or</span> (abs(D) &gt; 1e-2 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[91m&quot;</span> <span class="keywordflow">or</span> (abs(D) &gt; 1e-5 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[93m&quot;</span> <span class="keywordflow">or</span> <span class="stringliteral">&quot;\x1b[92m&quot;</span>))
<a name="l00917"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#adb86c1f6580bb088a23563a6103986fe">00917</a>                 cQ = abs(Q) &gt; 0.5 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[1;91m&quot;</span> <span class="keywordflow">or</span> (abs(Q) &gt; 1e-2 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[91m&quot;</span> <span class="keywordflow">or</span> (abs(Q) &gt; 1e-5 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[93m&quot;</span> <span class="keywordflow">or</span> <span class="stringliteral">&quot;\x1b[92m&quot;</span>))
<a name="l00918"></a>00918                 logger.info(<span class="stringliteral">&quot;\r    %-8i%-20s%-20s% 13.4e% 13.4e%s% 13.4e%s% 13.4e\x1b[0m\n&quot;</span> \
<a name="l00919"></a>00919                       % (i, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.plist[i][:20], self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.plist[j][:20], Adata[i,j], Fdata[i,j], cD, D, cQ, Q))
<a name="l00920"></a>00920 
<a name="l00921"></a>00921     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a05ee5fe985b3e2ec71071ca061e42d66" title="Read the checkpoint file for the main optimizer.">readchk</a>(self):
<a name="l00922"></a>00922         <span class="stringliteral">&quot;&quot;&quot; Read the checkpoint file for the main optimizer. &quot;&quot;&quot;</span>
<a name="l00923"></a>00923         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a> = {}
<a name="l00924"></a>00924         <span class="keywordflow">if</span> self.rchk_fnm != <span class="keywordtype">None</span>:
<a name="l00925"></a>00925             absfnm = os.path.join(self.root,self.rchk_fnm)
<a name="l00926"></a>00926             <span class="keywordflow">if</span> os.path.exists(absfnm):
<a name="l00927"></a>00927                 self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a> = pickle.load(open(absfnm))
<a name="l00928"></a>00928             <span class="keywordflow">else</span>:
<a name="l00929"></a>00929                 logger.info(<span class="stringliteral">&quot;\x1b[40m\x1b[1;92mWARNING:\x1b[0m read_chk is set to True, but checkpoint file not loaded (wrong filename or doesn&#39;t exist?)\n&quot;</span>)
<a name="l00930"></a>00930         <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>
<a name="l00931"></a>00931 
<a name="l00932"></a>00932     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aa7ac7cda43b70ac58ccbd6c8445e88ef" title="Write the checkpoint file for the main optimizer.">writechk</a>(self):
<a name="l00933"></a>00933         <span class="stringliteral">&quot;&quot;&quot; Write the checkpoint file for the main optimizer. &quot;&quot;&quot;</span>
<a name="l00934"></a>00934         <span class="keywordflow">if</span> self.wchk_fnm != <span class="keywordtype">None</span>:
<a name="l00935"></a>00935             logger.info(<span class="stringliteral">&quot;Writing the checkpoint file %s\n&quot;</span> % self.wchk_fnm)
<a name="l00936"></a>00936             with open(os.path.join(self.root,self.wchk_fnm),<span class="stringliteral">&#39;w&#39;</span>) <span class="keyword">as</span> f: pickle.dump(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>,f)
<a name="l00937"></a>00937         
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Fri Aug 23 2013 15:02:15 for ForceBalance API by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
