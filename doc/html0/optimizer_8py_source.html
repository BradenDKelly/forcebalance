<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ForceBalance: forcebalance/forcebalance/optimizer.py Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="ForceBalanceLogo_sm.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ForceBalance
   &#160;<span id="projectnumber">0.11.0</span>
   </div>
   <div id="projectbrief">Automated optimization of force fields and empirical potentials</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/namespaces.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">forcebalance/forcebalance/optimizer.py</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">##</span>
<a name="l00002"></a>00002 <span class="comment">#  @package optimizer Optimization algorithms.</span>
<a name="l00003"></a>00003 <span class="comment"># </span>
<a name="l00004"></a>00004 <span class="comment"># My current implementation is to have a single optimizer class with several methods</span>
<a name="l00005"></a>00005 <span class="comment"># contained inside.</span>
<a name="l00006"></a>00006 <span class="comment"># </span>
<a name="l00007"></a>00007 <span class="comment"># @author Lee-Ping Wang</span>
<a name="l00008"></a>00008 <span class="comment"># @date 12/2011</span>
<a name="l00009"></a>00009 <span class="comment"># </span>
<a name="l00010"></a>00010 <span class="comment"># </span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="keyword">import</span> os, pickle, re, sys
<a name="l00013"></a>00013 <span class="keyword">from</span> numpy <span class="keyword">import</span> append, array, delete, exp, eye, insert, linspace, mat, ones, sort, std, zeros
<a name="l00014"></a>00014 <span class="keyword">from</span> numpy.linalg <span class="keyword">import</span> eig, norm, solve
<a name="l00015"></a>00015 <span class="keyword">from</span> nifty <span class="keyword">import</span> col, flat, row, printcool, printcool_dictionary
<a name="l00016"></a>00016 <span class="keyword">from</span> finite_difference <span class="keyword">import</span> f1d7p, f1d5p, fdwrap
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="comment">##</span>
<a name="l00019"></a>00019 <span class="comment">#  Optimizer class.  Contains several methods for numerical optimization.</span>
<a name="l00020"></a>00020 <span class="comment"># </span>
<a name="l00021"></a>00021 <span class="comment">#     For various reasons, the optimizer depends on the force field and fitting</span>
<a name="l00022"></a>00022 <span class="comment">#     simulations (i.e. we cannot treat it as a fully independent numerical optimizer).</span>
<a name="l00023"></a>00023 <span class="comment">#     The dependency is rather weak which suggests that I can remove it someday.</span>
<a name="l00024"></a>00024 <span class="comment">#     </span>
<a name="l00025"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html">00025</a> <span class="keyword">class </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html" title="Optimizer class.">Optimizer</a>(object):
<a name="l00026"></a>00026     
<a name="l00027"></a>00027     <span class="comment">##</span>
<a name="l00028"></a>00028     <span class="comment">#  Instantiation of the optimizer.</span>
<a name="l00029"></a>00029     <span class="comment"># </span>
<a name="l00030"></a>00030     <span class="comment">#         The optimizer depends on both the FF and the fitting simulations so there</span>
<a name="l00031"></a>00031     <span class="comment">#         is a chain of dependencies: FF --&gt; FitSim --&gt; Optimizer, and FF --&gt; Optimizer</span>
<a name="l00032"></a>00032     <span class="comment"># </span>
<a name="l00033"></a>00033     <span class="comment">#         Here&#39;s what we do:</span>
<a name="l00034"></a>00034     <span class="comment">#         - Take options from the parser</span>
<a name="l00035"></a>00035     <span class="comment">#         - Pass in the objective function, force field, all fitting simulations</span>
<a name="l00036"></a>00036     <span class="comment"># </span>
<a name="l00037"></a>00037     <span class="comment">#         </span>
<a name="l00038"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a674f1c17cbfaffa7955fb5d833d33e0b">00038</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a674f1c17cbfaffa7955fb5d833d33e0b" title="Instantiation of the optimizer.">__init__</a>(self,options,Objective,FF,Simulations):
<a name="l00039"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#acd9866c0bb48a8f49f2dca1d83441bde">00039</a>         
<a name="l00040"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b9231f6a0f9ac108a1d8565d1f19851">00040</a>         <span class="comment">## A list of all the things we can ask the optimizer to do.</span>
<a name="l00041"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a019d0884b09f8c3c1d8fe66dca47ca8b">00041</a>         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#acd9866c0bb48a8f49f2dca1d83441bde" title="A list of all the things we can ask the optimizer to do.">OptTab</a>    = {<span class="stringliteral">&#39;NEWTONRAPHSON&#39;</span>     : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a5b6e95f9f49b7d970ac8441d68a0023f" title="Optimize the force field parameters using the Newton-Raphson method (.">NewtonRaphson</a>, 
<a name="l00042"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#af1648435abf6f0bbf297004144a4b0bc">00042</a>                           <span class="stringliteral">&#39;BFGS&#39;</span>              : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a58b957fe289822934711c29dfeb8d203" title="Optimize the force field parameters using the BFGS method; currently the recommended choice (...">BFGS</a>,
<a name="l00043"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ae29645c2e8e62813bb039f691209a90a">00043</a>                           <span class="stringliteral">&#39;POWELL&#39;</span>            : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a0745b2e3607ef308ba48bb1d34e5be79" title="Use SciPy&#39;s built-in Powell direction-set algorithm to optimize the parameters.">Powell</a>,
<a name="l00044"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a8b4f389d44edfa39a26c513534d42780">00044</a>                           <span class="stringliteral">&#39;SIMPLEX&#39;</span>           : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6b3af8115718f61a6a21c3297d717ead" title="Use SciPy&#39;s built-in simplex algorithm to optimize the parameters.">Simplex</a>,
<a name="l00045"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6c2063d16b3d763af6594b1ff6c28822">00045</a>                           <span class="stringliteral">&#39;ANNEAL&#39;</span>            : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a183911848e43ca0be1893b87290dc31e" title="Use SciPy&#39;s built-in simulated annealing algorithm to optimize the parameters.">Anneal</a>,
<a name="l00046"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab049f4cc1b0eb55229a8dd21c569c0f2">00046</a>                           <span class="stringliteral">&#39;CONJUGATEGRADIENT&#39;</span> : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ad1e151204a172a4e75737b2b699d1623" title="Use SciPy&#39;s built-in simulated annealing algorithm to optimize the parameters.">ConjugateGradient</a>,
<a name="l00047"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a77037a4936b453ab57a9c430ef983a39">00047</a>                           <span class="stringliteral">&#39;SCAN_MVALS&#39;</span>        : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a43ab8c6bea2b3112468922ab61163f67" title="Scan through the mathematical parameter space.">ScanMVals</a>,
<a name="l00048"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a55a71642137dd2c97824dcddfbf236de">00048</a>                           <span class="stringliteral">&#39;SCAN_PVALS&#39;</span>        : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a70bff76f2e56d87c8dee8aa92fe56d29" title="Scan through the physical parameter space.">ScanPVals</a>,
<a name="l00049"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aef6a50c754338473eedf0a991823f183">00049</a>                           <span class="stringliteral">&#39;SINGLE&#39;</span>            : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a1477d2b88faa1d4991418538133abcff" title="A single-point objective function computation.">SinglePoint</a>,
<a name="l00050"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a7d44f4096cbe63fcb8ec57d91b3e140d">00050</a>                           <span class="stringliteral">&#39;GRADIENT&#39;</span>          : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ac5adf24cf3ea3976eb67f75b6b89d101" title="A single-point gradient computation.">Gradient</a>,
<a name="l00051"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a60e3690c95072a2399eebf4a704b5ee7">00051</a>                           <span class="stringliteral">&#39;HESSIAN&#39;</span>           : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a0c16ad8678a6480e235a45d69fb077d3" title="A single-point Hessian computation.">Hessian</a>,
<a name="l00052"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aefe9b04072d00b5f17dee407d7801392">00052</a>                           <span class="stringliteral">&#39;FDCHECKG&#39;</span>          : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aacf96d137fb0e491af7e380c8bd61eb9" title="Finite-difference checker for the objective function gradient.">FDCheckG</a>,
<a name="l00053"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a31ff9e7a8a403d8a8dad6740c4decf9b">00053</a>                           <span class="stringliteral">&#39;FDCHECKH&#39;</span>          : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#adb86c1f6580bb088a23563a6103986fe" title="Finite-difference checker for the objective function Hessian.">FDCheckH</a>
<a name="l00054"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab1ad00853b56756495603b8413c1b03e">00054</a>                           }
<a name="l00055"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1">00055</a>         
<a name="l00056"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4a9bf85f3c44a173211de3bf3770bdb4">00056</a>         <span class="comment">#======================================#</span>
<a name="l00057"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb">00057</a>         <span class="comment"># Options that are given by the parser #</span>
<a name="l00058"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd">00058</a>         <span class="comment">#======================================#</span>
<a name="l00059"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a482102f9a8fc0fa5120db5078684fb53">00059</a>         <span class="comment">## The root directory</span>
<a name="l00060"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75">00060</a>         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b9231f6a0f9ac108a1d8565d1f19851" title="The root directory.">root</a>      = options[<span class="stringliteral">&#39;root&#39;</span>]
<a name="l00061"></a>00061         <span class="comment">## The job type</span>
<a name="l00062"></a>00062         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a019d0884b09f8c3c1d8fe66dca47ca8b" title="The job type.">jobtype</a>   = options[<span class="stringliteral">&#39;jobtype&#39;</span>]
<a name="l00063"></a>00063         <span class="comment">## Initial step size trust radius</span>
<a name="l00064"></a>00064         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#af1648435abf6f0bbf297004144a4b0bc" title="Initial step size trust radius.">trust0</a>    = options[<span class="stringliteral">&#39;trust0&#39;</span>]
<a name="l00065"></a>00065         <span class="comment">## Lower bound on Hessian eigenvalue (below this, we add in steepest descent)</span>
<a name="l00066"></a>00066         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ae29645c2e8e62813bb039f691209a90a" title="Lower bound on Hessian eigenvalue (below this, we add in steepest descent)">eps</a>       = options[<span class="stringliteral">&#39;eig_lowerbound&#39;</span>]
<a name="l00067"></a>00067         <span class="comment">## Step size for numerical finite difference</span>
<a name="l00068"></a>00068         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a8b4f389d44edfa39a26c513534d42780" title="Step size for numerical finite difference.">h</a>         = options[<span class="stringliteral">&#39;finite_difference_h&#39;</span>]
<a name="l00069"></a>00069         <span class="comment">## Function value convergence threshold</span>
<a name="l00070"></a>00070         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6c2063d16b3d763af6594b1ff6c28822" title="Function value convergence threshold.">conv_obj</a>  = options[<span class="stringliteral">&#39;convergence_objective&#39;</span>]
<a name="l00071"></a>00071         <span class="comment">## Step size convergence threshold</span>
<a name="l00072"></a>00072         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab049f4cc1b0eb55229a8dd21c569c0f2" title="Step size convergence threshold.">conv_stp</a>  = options[<span class="stringliteral">&#39;convergence_step&#39;</span>]
<a name="l00073"></a>00073         <span class="comment">## Gradient convergence threshold</span>
<a name="l00074"></a>00074         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a77037a4936b453ab57a9c430ef983a39" title="Gradient convergence threshold.">conv_grd</a>  = options[<span class="stringliteral">&#39;convergence_gradient&#39;</span>]
<a name="l00075"></a>00075         <span class="comment">## Maximum number of optimization steps</span>
<a name="l00076"></a>00076         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a55a71642137dd2c97824dcddfbf236de" title="Maximum number of optimization steps.">maxstep</a>   = options[<span class="stringliteral">&#39;maxstep&#39;</span>]
<a name="l00077"></a>00077         <span class="comment">## For scan[mp]vals: The parameter index to scan over</span>
<a name="l00078"></a>00078         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aef6a50c754338473eedf0a991823f183" title="For scan[mp]vals: The parameter index to scan over.">idxnum</a>    = options[<span class="stringliteral">&#39;scanindex_num&#39;</span>]
<a name="l00079"></a>00079         <span class="comment">## For scan[mp]vals: The parameter name to scan over, it just looks up an index</span>
<a name="l00080"></a>00080         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a7d44f4096cbe63fcb8ec57d91b3e140d" title="For scan[mp]vals: The parameter name to scan over, it just looks up an index.">idxname</a>   = options[<span class="stringliteral">&#39;scanindex_name&#39;</span>]
<a name="l00081"></a>00081         <span class="comment">## For scan[mp]vals: The values that are fed into the scanner</span>
<a name="l00082"></a>00082         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a60e3690c95072a2399eebf4a704b5ee7" title="For scan[mp]vals: The values that are fed into the scanner.">scan_vals</a> = options[<span class="stringliteral">&#39;scan_vals&#39;</span>]
<a name="l00083"></a>00083         <span class="comment">## Name of the checkpoint file that we&#39;re reading in</span>
<a name="l00084"></a>00084         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aefe9b04072d00b5f17dee407d7801392" title="Name of the checkpoint file that we&#39;re reading in.">rchk_fnm</a>  = options[<span class="stringliteral">&#39;readchk&#39;</span>]
<a name="l00085"></a>00085         <span class="comment">## Name of the checkpoint file that we&#39;re writing out</span>
<a name="l00086"></a>00086         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a31ff9e7a8a403d8a8dad6740c4decf9b" title="Name of the checkpoint file that we&#39;re writing out.">wchk_fnm</a>  = options[<span class="stringliteral">&#39;writechk&#39;</span>]
<a name="l00087"></a>00087         <span class="comment">## Whether to write the checkpoint file at every step</span>
<a name="l00088"></a>00088         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab1ad00853b56756495603b8413c1b03e" title="Whether to write the checkpoint file at every step.">wchk_step</a> = options[<span class="stringliteral">&#39;writechk_step&#39;</span>]
<a name="l00089"></a>00089         
<a name="l00090"></a>00090         <span class="comment">#======================================#</span>
<a name="l00091"></a>00091         <span class="comment">#     Variables which are set here     #</span>
<a name="l00092"></a>00092         <span class="comment">#======================================#</span>
<a name="l00093"></a>00093         <span class="comment">## The objective function (needs to pass in when I instantiate)</span>
<a name="l00094"></a>00094         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The objective function (needs to pass in when I instantiate)">Objective</a> = Objective
<a name="l00095"></a>00095         <span class="comment">## The fitting simulations</span>
<a name="l00096"></a>00096         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4a9bf85f3c44a173211de3bf3770bdb4" title="The fitting simulations.">Sims</a>      = Simulations
<a name="l00097"></a>00097         <span class="comment">## The force field itself</span>
<a name="l00098"></a>00098         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>        = FF
<a name="l00099"></a>00099         
<a name="l00100"></a>00100         <span class="comment">#======================================#</span>
<a name="l00101"></a>00101         <span class="comment">#    Variables from the force field    #</span>
<a name="l00102"></a>00102         <span class="comment">#======================================#</span>
<a name="l00103"></a>00103         <span class="comment">## The indices to be excluded from the Hessian update</span>
<a name="l00104"></a>00104         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>  = list(FF.excision)
<a name="l00105"></a>00105         <span class="comment">## Number of parameters</span>
<a name="l00106"></a>00106         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a482102f9a8fc0fa5120db5078684fb53" title="Number of parameters.">np</a>        = FF.np
<a name="l00107"></a>00107         <span class="comment">## The original parameter values</span>
<a name="l00108"></a>00108         <span class="keywordflow">if</span> options[<span class="stringliteral">&#39;read_mvals&#39;</span>] != <span class="keywordtype">None</span>:
<a name="l00109"></a>00109             self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>    = array(options[<span class="stringliteral">&#39;read_mvals&#39;</span>])
<a name="l00110"></a>00110         <span class="keywordflow">elif</span> options[<span class="stringliteral">&#39;read_pvals&#39;</span>] != <span class="keywordtype">None</span>:
<a name="l00111"></a>00111             self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>    = FF.create_mvals(options[<span class="stringliteral">&#39;read_pvals&#39;</span>])
<a name="l00112"></a>00112         <span class="keywordflow">else</span>:
<a name="l00113"></a>00113             self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>    = zeros(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a482102f9a8fc0fa5120db5078684fb53" title="Number of parameters.">np</a>)
<a name="l00114"></a>00114 
<a name="l00115"></a>00115         <span class="comment">## Print the optimizer options.</span>
<a name="l00116"></a>00116         printcool_dictionary(options, title=<span class="stringliteral">&quot;Setup for optimizer&quot;</span>)
<a name="l00117"></a>00117         <span class="comment">## Load the checkpoint file.</span>
<a name="l00118"></a>00118         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a05ee5fe985b3e2ec71071ca061e42d66">readchk</a>()
<a name="l00119"></a>00119         <span class="comment">## A list of all the things we can ask the optimizer to do.</span>
<a name="l00120"></a>00120         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#acd9866c0bb48a8f49f2dca1d83441bde" title="A list of all the things we can ask the optimizer to do.">OptTab</a>    = {<span class="stringliteral">&#39;NEWTONRAPHSON&#39;</span>     : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a5b6e95f9f49b7d970ac8441d68a0023f" title="Optimize the force field parameters using the Newton-Raphson method (.">NewtonRaphson</a>, 
<a name="l00121"></a>00121                           <span class="stringliteral">&#39;BFGS&#39;</span>              : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a58b957fe289822934711c29dfeb8d203" title="Optimize the force field parameters using the BFGS method; currently the recommended choice (...">BFGS</a>,
<a name="l00122"></a>00122                           <span class="stringliteral">&#39;POWELL&#39;</span>            : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a0745b2e3607ef308ba48bb1d34e5be79" title="Use SciPy&#39;s built-in Powell direction-set algorithm to optimize the parameters.">Powell</a>,
<a name="l00123"></a>00123                           <span class="stringliteral">&#39;SIMPLEX&#39;</span>           : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6b3af8115718f61a6a21c3297d717ead" title="Use SciPy&#39;s built-in simplex algorithm to optimize the parameters.">Simplex</a>,
<a name="l00124"></a>00124                           <span class="stringliteral">&#39;ANNEAL&#39;</span>            : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a183911848e43ca0be1893b87290dc31e" title="Use SciPy&#39;s built-in simulated annealing algorithm to optimize the parameters.">Anneal</a>,
<a name="l00125"></a>00125                           <span class="stringliteral">&#39;CONJUGATEGRADIENT&#39;</span> : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ad1e151204a172a4e75737b2b699d1623" title="Use SciPy&#39;s built-in simulated annealing algorithm to optimize the parameters.">ConjugateGradient</a>,
<a name="l00126"></a>00126                           <span class="stringliteral">&#39;SCAN_MVALS&#39;</span>        : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a43ab8c6bea2b3112468922ab61163f67" title="Scan through the mathematical parameter space.">ScanMVals</a>,
<a name="l00127"></a>00127                           <span class="stringliteral">&#39;SCAN_PVALS&#39;</span>        : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a70bff76f2e56d87c8dee8aa92fe56d29" title="Scan through the physical parameter space.">ScanPVals</a>,
<a name="l00128"></a>00128                           <span class="stringliteral">&#39;SINGLE&#39;</span>            : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a1477d2b88faa1d4991418538133abcff" title="A single-point objective function computation.">SinglePoint</a>,
<a name="l00129"></a>00129                           <span class="stringliteral">&#39;GRADIENT&#39;</span>          : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ac5adf24cf3ea3976eb67f75b6b89d101" title="A single-point gradient computation.">Gradient</a>,
<a name="l00130"></a>00130                           <span class="stringliteral">&#39;HESSIAN&#39;</span>           : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a0c16ad8678a6480e235a45d69fb077d3" title="A single-point Hessian computation.">Hessian</a>,
<a name="l00131"></a>00131                           <span class="stringliteral">&#39;FDCHECKG&#39;</span>          : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aacf96d137fb0e491af7e380c8bd61eb9" title="Finite-difference checker for the objective function gradient.">FDCheckG</a>,
<a name="l00132"></a>00132                           <span class="stringliteral">&#39;FDCHECKH&#39;</span>          : self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#adb86c1f6580bb088a23563a6103986fe" title="Finite-difference checker for the objective function Hessian.">FDCheckH</a>
<a name="l00133"></a>00133                           }
<a name="l00134"></a>00134         
<a name="l00135"></a>00135     <span class="comment">##</span>
<a name="l00136"></a>00136     <span class="comment">#  Call the appropriate optimizer.  This is the method we might want to call from an executable. </span>
<a name="l00137"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a85688c895ce936fa4368d9e2f7fcb4b5">00137</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a85688c895ce936fa4368d9e2f7fcb4b5" title="Call the appropriate optimizer.">Run</a>(self):
<a name="l00138"></a>00138 
<a name="l00139"></a>00139         xk = self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#acd9866c0bb48a8f49f2dca1d83441bde" title="A list of all the things we can ask the optimizer to do.">OptTab</a>[self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a019d0884b09f8c3c1d8fe66dca47ca8b" title="The job type.">jobtype</a>]()
<a name="l00140"></a>00140         
<a name="l00141"></a>00141         <span class="comment">## Sometimes the optimizer doesn&#39;t return anything (i.e. in the case of a single point calculation)</span>
<a name="l00142"></a>00142         <span class="comment">## In these situations, don&#39;t do anything</span>
<a name="l00143"></a>00143         <span class="keywordflow">if</span> xk == <span class="keywordtype">None</span>: <span class="keywordflow">return</span>
<a name="l00144"></a>00144 
<a name="l00145"></a>00145         <span class="comment">## Check derivatives by finite difference after the optimization is over (for good measure)</span>
<a name="l00146"></a>00146         check_after = <span class="keyword">False</span>
<a name="l00147"></a>00147         <span class="keywordflow">if</span> check_after:
<a name="l00148"></a>00148             self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a> = xk.copy()
<a name="l00149"></a>00149             self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aacf96d137fb0e491af7e380c8bd61eb9" title="Finite-difference checker for the objective function gradient.">FDCheckG</a>()
<a name="l00150"></a>00150             
<a name="l00151"></a>00151         <span class="comment">## Print out final answer</span>
<a name="l00152"></a>00152         final_print = <span class="keyword">True</span>
<a name="l00153"></a>00153         <span class="keywordflow">if</span> final_print:
<a name="l00154"></a>00154             bar = printcool(<span class="stringliteral">&quot;Final parameter values\n Paste to input file to restart\n Choose pvals or mvals&quot;</span>,bold=<span class="keyword">True</span>,color=4)
<a name="l00155"></a>00155             <span class="keywordflow">print</span> <span class="stringliteral">&quot;read_pvals&quot;</span>
<a name="l00156"></a>00156             self.FF.print_map(self.FF.create_pvals(xk))
<a name="l00157"></a>00157             <span class="keywordflow">print</span> <span class="stringliteral">&quot;/read_pvals&quot;</span>
<a name="l00158"></a>00158             <span class="keywordflow">print</span> <span class="stringliteral">&quot;read_mvals&quot;</span>
<a name="l00159"></a>00159             self.FF.print_map(xk)
<a name="l00160"></a>00160             <span class="keywordflow">print</span> <span class="stringliteral">&quot;/read_mvals&quot;</span>
<a name="l00161"></a>00161             <span class="keywordflow">print</span> bar
<a name="l00162"></a>00162             self.FF.make(<span class="stringliteral">&#39;result&#39;</span>,xk,<span class="keyword">False</span>)
<a name="l00163"></a>00163 
<a name="l00164"></a>00164         <span class="comment">## Write out stuff to checkpoint file</span>
<a name="l00165"></a>00165         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aa7ac7cda43b70ac58ccbd6c8445e88ef">writechk</a>()
<a name="l00166"></a>00166             
<a name="l00167"></a>00167     <span class="comment">##</span>
<a name="l00168"></a>00168     <span class="comment">#  The main ForceBalance trust-radius optimizer.</span>
<a name="l00169"></a>00169     <span class="comment"># </span>
<a name="l00170"></a>00170     <span class="comment">#         Usually this function is called with the BFGS or NewtonRaphson</span>
<a name="l00171"></a>00171     <span class="comment">#         method.  I&#39;ve found the BFGS method to be most efficient,</span>
<a name="l00172"></a>00172     <span class="comment">#         especially when we don&#39;t have access to the expensive analytic</span>
<a name="l00173"></a>00173     <span class="comment">#         second derivatives of the objective function.  If we are computing</span>
<a name="l00174"></a>00174     <span class="comment">#         derivatives by finite difference (which we often do), then the</span>
<a name="l00175"></a>00175     <span class="comment">#         diagonal elements of the second derivative can also be obtained</span>
<a name="l00176"></a>00176     <span class="comment">#         by taking a central difference.</span>
<a name="l00177"></a>00177     <span class="comment"># </span>
<a name="l00178"></a>00178     <span class="comment">#         BFGS is a pseudo-Newton method in the sense that it builds an</span>
<a name="l00179"></a>00179     <span class="comment">#         approximate Hessian matrix from the gradient information in previous</span>
<a name="l00180"></a>00180     <span class="comment">#         steps; true Newton-Raphson needs all of the second derivatives.</span>
<a name="l00181"></a>00181     <span class="comment">#         However, the algorithms are similar in that they both compute the</span>
<a name="l00182"></a>00182     <span class="comment">#         step by inverting the Hessian and multiplying by the gradient.</span>
<a name="l00183"></a>00183     <span class="comment"># </span>
<a name="l00184"></a>00184     <span class="comment">#         As this method iterates toward convergence, it computes BFGS updates</span>
<a name="l00185"></a>00185     <span class="comment">#         of the Hessian matrix and adjusts the step size.  If the step</span>
<a name="l00186"></a>00186     <span class="comment">#         is good (i.e. the objective function goes down), then the step</span>
<a name="l00187"></a>00187     <span class="comment">#         size is increased; if the step is bad, then it steps back to the</span>
<a name="l00188"></a>00188     <span class="comment">#         original point and tries again with a smaller step size.</span>
<a name="l00189"></a>00189     <span class="comment"># </span>
<a name="l00190"></a>00190     <span class="comment">#         The optimization is terminated after either a function value or</span>
<a name="l00191"></a>00191     <span class="comment">#         step size tolerance is reached.</span>
<a name="l00192"></a>00192     <span class="comment"># </span>
<a name="l00193"></a>00193     <span class="comment">#         @param[in] b_BFGS Switch to use BFGS (True) or Newton-Raphson (False)</span>
<a name="l00194"></a>00194     <span class="comment"># </span>
<a name="l00195"></a>00195     <span class="comment">#         </span>
<a name="l00196"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a1d222f82239075ea0d6b9294b2f50e12">00196</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a1d222f82239075ea0d6b9294b2f50e12" title="The main ForceBalance trust-radius optimizer.">MainOptimizer</a>(self,b_BFGS=0):
<a name="l00197"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a">00197</a>         printcool( <span class="stringliteral">&quot;Main Optimizer\n%s Mode&quot;</span> % (<span class="stringliteral">&quot;BFGS&quot;</span> <span class="keywordflow">if</span> b_BFGS <span class="keywordflow">else</span> <span class="stringliteral">&quot;Newton-Raphson&quot;</span>), color=7, bold=1)
<a name="l00198"></a>00198         <span class="comment"># First, set a bunch of starting values</span>
<a name="l00199"></a>00199         Ord         = 1 <span class="keywordflow">if</span> b_BFGS <span class="keywordflow">else</span> 2
<a name="l00200"></a>00200         <span class="keywordflow">if</span> all(i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a> <span class="keywordflow">for</span> i <span class="keywordflow">in</span> [<span class="stringliteral">&#39;xk&#39;</span>,<span class="stringliteral">&#39;X&#39;</span>,<span class="stringliteral">&#39;G&#39;</span>,<span class="stringliteral">&#39;H&#39;</span>,<span class="stringliteral">&#39;ehist&#39;</span>,<span class="stringliteral">&#39;x_best&#39;</span>,<span class="stringliteral">&#39;xk_prev&#39;</span>,<span class="stringliteral">&#39;trust&#39;</span>]):
<a name="l00201"></a>00201             <span class="keywordflow">print</span> <span class="stringliteral">&quot;Reading initial objective, gradient, Hessian from checkpoint file&quot;</span>
<a name="l00202"></a>00202             xk, X, G, H, ehist     = self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>[<span class="stringliteral">&#39;xk&#39;</span>], self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>[<span class="stringliteral">&#39;X&#39;</span>], self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>[<span class="stringliteral">&#39;G&#39;</span>], self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>[<span class="stringliteral">&#39;H&#39;</span>], self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>[<span class="stringliteral">&#39;ehist&#39;</span>]
<a name="l00203"></a>00203             X_best, xk_prev, trust = self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>[<span class="stringliteral">&#39;x_best&#39;</span>], self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>[<span class="stringliteral">&#39;xk_prev&#39;</span>], self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>[<span class="stringliteral">&#39;trust&#39;</span>]
<a name="l00204"></a>00204         <span class="keywordflow">else</span>:
<a name="l00205"></a>00205             xk       = self.mvals0.copy()
<a name="l00206"></a>00206             <span class="keywordflow">print</span>
<a name="l00207"></a>00207             data     = self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The objective function (needs to pass in when I instantiate)">Objective</a>(xk,Ord,verbose=<span class="keyword">True</span>)
<a name="l00208"></a>00208             X, G, H  = data[<span class="stringliteral">&#39;X&#39;</span>], data[<span class="stringliteral">&#39;G&#39;</span>], data[<span class="stringliteral">&#39;H&#39;</span>]
<a name="l00209"></a>00209             ehist    = array([X])
<a name="l00210"></a>00210             xk_prev  = xk.copy()
<a name="l00211"></a>00211             trust    = self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#af1648435abf6f0bbf297004144a4b0bc" title="Initial step size trust radius.">trust0</a>
<a name="l00212"></a>00212             X_best   = X
<a name="l00213"></a>00213 
<a name="l00214"></a>00214         G_prev   = G.copy()
<a name="l00215"></a>00215         H_stor   = H.copy()
<a name="l00216"></a>00216         stepn  = 0
<a name="l00217"></a>00217         ndx    = 0.0
<a name="l00218"></a>00218         color  = <span class="stringliteral">&quot;\x1b[97m&quot;</span>
<a name="l00219"></a>00219         <span class="keywordflow">while</span> 1: <span class="comment"># Loop until convergence is reached.</span>
<a name="l00220"></a>00220             <span class="comment">## Put data into the checkpoint file</span>
<a name="l00221"></a>00221             self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a> = {<span class="stringliteral">&#39;xk&#39;</span>: xk, <span class="stringliteral">&#39;X&#39;</span> : X, <span class="stringliteral">&#39;G&#39;</span> : G, <span class="stringliteral">&#39;H&#39;</span>: H, <span class="stringliteral">&#39;ehist&#39;</span>: ehist,
<a name="l00222"></a>00222                         <span class="stringliteral">&#39;x_best&#39;</span>: X_best,<span class="stringliteral">&#39;xk_prev&#39;</span>: xk_prev, <span class="stringliteral">&#39;trust&#39;</span>: trust}
<a name="l00223"></a>00223             <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab1ad00853b56756495603b8413c1b03e" title="Whether to write the checkpoint file at every step.">wchk_step</a>:
<a name="l00224"></a>00224                 self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aa7ac7cda43b70ac58ccbd6c8445e88ef">writechk</a>()
<a name="l00225"></a>00225             nxk = norm(xk)
<a name="l00226"></a>00226             ngr = norm(G)
<a name="l00227"></a>00227             stdfront = len(ehist) &gt; 10 <span class="keywordflow">and</span> std(sort(ehist)[:10]) <span class="keywordflow">or</span> (len(ehist) &gt; 0 <span class="keywordflow">and</span> std(ehist) <span class="keywordflow">or</span> 0.0)
<a name="l00228"></a>00228             <span class="keywordflow">print</span> <span class="stringliteral">&quot;\n%6s%12s%12s%12s%14s%12s&quot;</span> % (<span class="stringliteral">&quot;Step&quot;</span>, <span class="stringliteral">&quot;  |k|  &quot;</span>,<span class="stringliteral">&quot;  |dk|  &quot;</span>,<span class="stringliteral">&quot; |grad| &quot;</span>,<span class="stringliteral">&quot;    -=X2=-  &quot;</span>,<span class="stringliteral">&quot;Stdev(X2)&quot;</span>)
<a name="l00229"></a>00229             <span class="keywordflow">print</span> <span class="stringliteral">&quot;%6i%12.3e%12.3e%12.3e%s%14.5e\x1b[0m%12.3e&quot;</span> % (stepn, nxk, ndx, ngr, color, X, stdfront)
<a name="l00230"></a>00230             <span class="comment"># Check the convergence criteria</span>
<a name="l00231"></a>00231             <span class="keywordflow">if</span> ngr &lt; self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a77037a4936b453ab57a9c430ef983a39" title="Gradient convergence threshold.">conv_grd</a>:
<a name="l00232"></a>00232                 <span class="keywordflow">print</span> <span class="stringliteral">&quot;Convergence criterion reached for gradient norm (%.2e)&quot;</span> % self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a77037a4936b453ab57a9c430ef983a39" title="Gradient convergence threshold.">conv_grd</a>
<a name="l00233"></a>00233                 <span class="keywordflow">break</span>
<a name="l00234"></a>00234             <span class="keywordflow">if</span> stepn == self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a55a71642137dd2c97824dcddfbf236de" title="Maximum number of optimization steps.">maxstep</a>:
<a name="l00235"></a>00235                 <span class="keywordflow">print</span> <span class="stringliteral">&quot;Maximum number of optimization steps reached (%i)&quot;</span> % stepn
<a name="l00236"></a>00236                 <span class="keywordflow">break</span>
<a name="l00237"></a>00237             <span class="keywordflow">if</span> ndx &lt; self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab049f4cc1b0eb55229a8dd21c569c0f2" title="Step size convergence threshold.">conv_stp</a> <span class="keywordflow">and</span> stepn &gt; 0:
<a name="l00238"></a>00238                 <span class="keywordflow">print</span> <span class="stringliteral">&quot;Convergence criterion reached in step size (%.2e)&quot;</span> % self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab049f4cc1b0eb55229a8dd21c569c0f2" title="Step size convergence threshold.">conv_stp</a>
<a name="l00239"></a>00239                 <span class="keywordflow">break</span>
<a name="l00240"></a>00240             <span class="keywordflow">if</span> stdfront &lt; self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6c2063d16b3d763af6594b1ff6c28822" title="Function value convergence threshold.">conv_obj</a> <span class="keywordflow">and</span> len(ehist) &gt; 10:
<a name="l00241"></a>00241                 <span class="keywordflow">print</span> <span class="stringliteral">&quot;Convergence criterion reached for objective function (%.2e)&quot;</span> % self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6c2063d16b3d763af6594b1ff6c28822" title="Function value convergence threshold.">conv_obj</a>
<a name="l00242"></a>00242                 <span class="keywordflow">break</span>
<a name="l00243"></a>00243             <span class="comment"># Take a step in the parameter space.</span>
<a name="l00244"></a>00244             dx, over = self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aacc231ff56f5d87597a95f4e543360a2" title="Computes the Newton-Raphson or BFGS step.">step</a>(G, H, trust)
<a name="l00245"></a>00245             xk += dx
<a name="l00246"></a>00246             <span class="comment"># Evaluate the objective function and its derivatives.</span>
<a name="l00247"></a>00247             <span class="keywordflow">print</span>
<a name="l00248"></a>00248             data        = self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The objective function (needs to pass in when I instantiate)">Objective</a>(xk,Ord,verbose=<span class="keyword">True</span>)
<a name="l00249"></a>00249             X, G, H = data[<span class="stringliteral">&#39;X&#39;</span>], data[<span class="stringliteral">&#39;G&#39;</span>], data[<span class="stringliteral">&#39;H&#39;</span>]
<a name="l00250"></a>00250             <span class="comment"># if pkg.efweight &gt; 0.99:</span>
<a name="l00251"></a>00251             <span class="comment">#     dFc, patomax = cartesian_dforce(pkg)</span>
<a name="l00252"></a>00252             ndx = norm(dx)
<a name="l00253"></a>00253             <span class="keywordflow">if</span> X &gt; X_best:
<a name="l00254"></a>00254                 goodstep = <span class="keyword">False</span>
<a name="l00255"></a>00255                 color = <span class="stringliteral">&quot;\x1b[91m&quot;</span>
<a name="l00256"></a>00256                 <span class="comment"># Decrease the trust radius and take a step back, if the step was bad.</span>
<a name="l00257"></a>00257                 trust = ndx*0.667
<a name="l00258"></a>00258                 xk = xk_prev.copy()
<a name="l00259"></a>00259                 <span class="comment"># Hmm, we don&#39;t want to take a step at the &quot;old&quot; xk but with the &quot;new&quot; G and H, now do we?</span>
<a name="l00260"></a>00260                 G = G_prev.copy()
<a name="l00261"></a>00261                 H = H_stor.copy()
<a name="l00262"></a>00262             <span class="keywordflow">else</span>:
<a name="l00263"></a>00263                 goodstep = <span class="keyword">True</span>
<a name="l00264"></a>00264                 color = <span class="stringliteral">&quot;\x1b[92m&quot;</span>
<a name="l00265"></a>00265                 <span class="comment"># Adjust the trust radius using this funky formula</span>
<a name="l00266"></a>00266                 <span class="comment"># Very conservative.  Multiplier is 1.5 and decreases to 1.1 when trust=4trust0</span>
<a name="l00267"></a>00267                 trust += over <span class="keywordflow">and</span> 0.5*trust*exp(-0.5*(trust/self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#af1648435abf6f0bbf297004144a4b0bc" title="Initial step size trust radius.">trust0</a> - 1)) <span class="keywordflow">or</span> 0
<a name="l00268"></a>00268                 X_best = X
<a name="l00269"></a>00269                 <span class="comment"># So here&#39;s the deal.  I&#39;m getting steepest-descent badness in some of the parameters (e.g. virtual site positions)</span>
<a name="l00270"></a>00270                 <span class="comment"># The solution would be to build up a BFGS quasi-Hessian but only in that parameter block, since we have exact second</span>
<a name="l00271"></a>00271                 <span class="comment"># derivatives for everything else.  I will leave the cross-terms alone.</span>
<a name="l00272"></a>00272                 Hnew = mat(H.copy())
<a name="l00273"></a>00273                 <span class="keywordflow">if</span> b_BFGS:
<a name="l00274"></a>00274                     Hnew = H_stor.copy()
<a name="l00275"></a>00275                 <span class="comment"># for i in range(xk.shape[0]):</span>
<a name="l00276"></a>00276                 <span class="comment">#     for j in range(xk.shape[0]):</span>
<a name="l00277"></a>00277                 <span class="comment">#         if b_BFGS:</span>
<a name="l00278"></a>00278                 <span class="comment">#             Hnew[i,j] = H_stor[i,j]</span>
<a name="l00279"></a>00279                 Dx   = col(xk - xk_prev)
<a name="l00280"></a>00280                 Dy   = col(G  - G_prev)
<a name="l00281"></a>00281                 Mat1 = (Dy*Dy.T)/(Dy.T*Dx)[0,0]
<a name="l00282"></a>00282                 Mat2 = ((Hnew*Dx)*(Hnew*Dx).T)/(Dx.T*Hnew*Dx)[0,0]
<a name="l00283"></a>00283                 Hnew += Mat1-Mat2
<a name="l00284"></a>00284                 <span class="comment"># After that bit of trickery, Hnew is now updated with BFGS stuff.</span>
<a name="l00285"></a>00285                 <span class="comment"># We now want to put the BFGS-gradients into the Hessian that will be used to take the step.</span>
<a name="l00286"></a>00286                 <span class="keywordflow">if</span> b_BFGS:
<a name="l00287"></a>00287                     H = Hnew.copy()
<a name="l00288"></a>00288                 <span class="comment"># for i in range(xk.shape[0]):</span>
<a name="l00289"></a>00289                 <span class="comment">#     for j in range(xk.shape[0]):</span>
<a name="l00290"></a>00290                 <span class="comment">#         if b_BFGS:</span>
<a name="l00291"></a>00291                 <span class="comment">#             H[i,j] = Hnew[i,j]</span>
<a name="l00292"></a>00292                 G_prev = G.copy()
<a name="l00293"></a>00293                 H_stor = H.copy()
<a name="l00294"></a>00294                 <span class="comment"># End BFGS stuff</span>
<a name="l00295"></a>00295                 xk_prev = xk.copy()
<a name="l00296"></a>00296                 ehist = append(ehist, X)
<a name="l00297"></a>00297             drc = abs(flat(dx)).argmax()
<a name="l00298"></a>00298             stepn += 1
<a name="l00299"></a>00299             
<a name="l00300"></a>00300         <span class="keywordflow">return</span> xk
<a name="l00301"></a>00301 
<a name="l00302"></a>00302     <span class="comment">##</span>
<a name="l00303"></a>00303     <span class="comment">#  Computes the Newton-Raphson or BFGS step.</span>
<a name="l00304"></a>00304     <span class="comment"># </span>
<a name="l00305"></a>00305     <span class="comment">#         The step is given by the inverse of the Hessian times the gradient.</span>
<a name="l00306"></a>00306     <span class="comment">#         There are some extra considerations here:</span>
<a name="l00307"></a>00307     <span class="comment"># </span>
<a name="l00308"></a>00308     <span class="comment">#         First, certain eigenvalues of the Hessian may be negative.  Then the</span>
<a name="l00309"></a>00309     <span class="comment">#         NR optimization will take us to a saddle point and not a true minimum.</span>
<a name="l00310"></a>00310     <span class="comment">#         In these instances, we mix in some steepest descent by adding a multiple</span>
<a name="l00311"></a>00311     <span class="comment">#         of the identity matrix to the Hessian.</span>
<a name="l00312"></a>00312     <span class="comment"># </span>
<a name="l00313"></a>00313     <span class="comment">#         Second, certain eigenvalues may be very small.  If the Hessian is close to</span>
<a name="l00314"></a>00314     <span class="comment">#         being singular, then we also add in some steepest descent.</span>
<a name="l00315"></a>00315     <span class="comment"># </span>
<a name="l00316"></a>00316     <span class="comment">#         Third, certain components of the gradient / Hessian are strictly zero, or they</span>
<a name="l00317"></a>00317     <span class="comment">#         are excluded from our optimization.  These components are explicitly deleted</span>
<a name="l00318"></a>00318     <span class="comment">#         when we do the Hessian inversion, and reinserted as a zero in the step.</span>
<a name="l00319"></a>00319     <span class="comment"># </span>
<a name="l00320"></a>00320     <span class="comment">#         Fourth, we rescale the step size back to the trust radius.</span>
<a name="l00321"></a>00321     <span class="comment"># </span>
<a name="l00322"></a>00322     <span class="comment">#         @param[in] G The gradient</span>
<a name="l00323"></a>00323     <span class="comment">#         @param[in] H The Hessian</span>
<a name="l00324"></a>00324     <span class="comment">#         @param[in] trust The trust radius</span>
<a name="l00325"></a>00325     <span class="comment">#         </span>
<a name="l00326"></a>00326     <span class="comment">#         </span>
<a name="l00327"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aacc231ff56f5d87597a95f4e543360a2">00327</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aacc231ff56f5d87597a95f4e543360a2" title="Computes the Newton-Raphson or BFGS step.">step</a>(self, G, H, trust):
<a name="l00328"></a>00328         G = delete(G, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>)
<a name="l00329"></a>00329         H = delete(H, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>, axis=0)
<a name="l00330"></a>00330         H = delete(H, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>, axis=1)
<a name="l00331"></a>00331         Eig = eig(H)[0]            <span class="comment"># Diagonalize Hessian</span>
<a name="l00332"></a>00332         Emin = min(Eig)
<a name="l00333"></a>00333         <span class="keywordflow">if</span> Emin &lt; self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ae29645c2e8e62813bb039f691209a90a" title="Lower bound on Hessian eigenvalue (below this, we add in steepest descent)">eps</a>:        <span class="comment"># Mix in SD step if Hessian minimum eigenvalue is negative</span>
<a name="l00334"></a>00334             H += (self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ae29645c2e8e62813bb039f691209a90a" title="Lower bound on Hessian eigenvalue (below this, we add in steepest descent)">eps</a> - Emin)*eye(H.shape[0])
<a name="l00335"></a>00335         dx = -solve(H, G)          <span class="comment"># Take Newton Raphson Step ; use -1*G if want steepest descent.</span>
<a name="l00336"></a>00336         dx = flat(dx)
<a name="l00337"></a>00337         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aed81fe7ecd916992d1c545ed80c065dd" title="The indices to be excluded from the Hessian update.">excision</a>:    <span class="comment"># Reinsert deleted coordinates - don&#39;t take a step in those directions</span>
<a name="l00338"></a>00338             dx = insert(dx, i, 0)
<a name="l00339"></a>00339         dxnorm = norm(dx)          <span class="comment"># Length of step</span>
<a name="l00340"></a>00340         over = <span class="keyword">False</span>
<a name="l00341"></a>00341         <span class="keywordflow">if</span> dxnorm &gt; trust:
<a name="l00342"></a>00342             over = <span class="keyword">True</span>
<a name="l00343"></a>00343             dx *= trust / dxnorm   <span class="comment"># Normalize step length (Trust region)</span>
<a name="l00344"></a>00344         <span class="keywordflow">return</span> dx, over
<a name="l00345"></a>00345 
<a name="l00346"></a>00346     <span class="comment">##</span>
<a name="l00347"></a>00347     <span class="comment">#  Optimize the force field parameters using the Newton-Raphson method (@see MainOptimizer) </span>
<a name="l00348"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a5b6e95f9f49b7d970ac8441d68a0023f">00348</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a5b6e95f9f49b7d970ac8441d68a0023f" title="Optimize the force field parameters using the Newton-Raphson method (.">NewtonRaphson</a>(self):
<a name="l00349"></a>00349         <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a1d222f82239075ea0d6b9294b2f50e12" title="The main ForceBalance trust-radius optimizer.">MainOptimizer</a>(b_BFGS=0)
<a name="l00350"></a>00350 
<a name="l00351"></a>00351     <span class="comment">##</span>
<a name="l00352"></a>00352     <span class="comment">#  Optimize the force field parameters using the BFGS method; currently the recommended choice (@see MainOptimizer) </span>
<a name="l00353"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a58b957fe289822934711c29dfeb8d203">00353</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a58b957fe289822934711c29dfeb8d203" title="Optimize the force field parameters using the BFGS method; currently the recommended choice (...">BFGS</a>(self):
<a name="l00354"></a>00354         <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a1d222f82239075ea0d6b9294b2f50e12" title="The main ForceBalance trust-radius optimizer.">MainOptimizer</a>(b_BFGS=1)
<a name="l00355"></a>00355 
<a name="l00356"></a>00356     <span class="comment">##</span>
<a name="l00357"></a>00357     <span class="comment">#  Driver for SciPy optimizations.</span>
<a name="l00358"></a>00358     <span class="comment"># </span>
<a name="l00359"></a>00359     <span class="comment">#         Using any of the SciPy optimizers requires that SciPy is installed.</span>
<a name="l00360"></a>00360     <span class="comment">#         This method first defines several wrappers around the objective function that the SciPy</span>
<a name="l00361"></a>00361     <span class="comment">#         optimizers can use.  Then it calls the algorith mitself.</span>
<a name="l00362"></a>00362     <span class="comment"># </span>
<a name="l00363"></a>00363     <span class="comment">#         @param[in] Algorithm The optimization algorithm to use, for example &#39;powell&#39;, &#39;simplex&#39; or &#39;anneal&#39;</span>
<a name="l00364"></a>00364     <span class="comment"># </span>
<a name="l00365"></a>00365     <span class="comment">#         </span>
<a name="l00366"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a503e87533bd9c257cb9c4b505af9c1de">00366</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a503e87533bd9c257cb9c4b505af9c1de" title="Driver for SciPy optimizations.">ScipyOptimizer</a>(self,Algorithm=&quot;None&quot;):
<a name="l00367"></a>00367         <span class="keyword">from</span> scipy <span class="keyword">import</span> optimize
<a name="l00368"></a>00368         <span class="keyword">def </span>xwrap(func,verbose=True):
<a name="l00369"></a>00369             <span class="keyword">def </span>my_func(mvals):
<a name="l00370"></a>00370                 <span class="keywordflow">if</span> verbose: <span class="keywordflow">print</span>
<a name="l00371"></a>00371                 Answer = func(mvals,Order=0,verbose=verbose)[<span class="stringliteral">&#39;X&#39;</span>]
<a name="l00372"></a>00372                 dx = (my_func.x_best - Answer) <span class="keywordflow">if</span> my_func.x_best != <span class="keywordtype">None</span> <span class="keywordflow">else</span> 0.0
<a name="l00373"></a>00373                 <span class="keywordflow">if</span> Answer &lt; my_func.x_best <span class="keywordflow">or</span> my_func.x_best == <span class="keywordtype">None</span>:
<a name="l00374"></a>00374                     color = <span class="stringliteral">&quot;\x1b[92m&quot;</span>
<a name="l00375"></a>00375                     my_func.x_best = Answer
<a name="l00376"></a>00376                 <span class="keywordflow">else</span>:
<a name="l00377"></a>00377                     color = <span class="stringliteral">&quot;\x1b[91m&quot;</span>
<a name="l00378"></a>00378                 <span class="keywordflow">if</span> verbose:
<a name="l00379"></a>00379                     <span class="keywordflow">print</span> <span class="stringliteral">&quot;k=&quot;</span>, <span class="stringliteral">&#39; &#39;</span>.join([<span class="stringliteral">&quot;% .4f&quot;</span> % i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> mvals])
<a name="l00380"></a>00380                     <span class="keywordflow">print</span> <span class="stringliteral">&quot;X2= %s%12.3e\x1b[0m d(X2)= %12.3e&quot;</span> % (color,Answer,dx)
<a name="l00381"></a>00381                 <span class="keywordflow">return</span> Answer
<a name="l00382"></a>00382             my_func.x_best = <span class="keywordtype">None</span>
<a name="l00383"></a>00383             <span class="keywordflow">return</span> my_func
<a name="l00384"></a>00384         <span class="keyword">def </span>gwrap(func,verbose=True):
<a name="l00385"></a>00385             <span class="keyword">def </span>my_gfunc(mvals):
<a name="l00386"></a>00386                 <span class="keywordflow">if</span> verbose: <span class="keywordflow">print</span>
<a name="l00387"></a>00387                 Output = func(mvals,Order=1,verbose=verbose)
<a name="l00388"></a>00388                 Answer = Output[<span class="stringliteral">&#39;G&#39;</span>]
<a name="l00389"></a>00389                 Objective = Output[<span class="stringliteral">&#39;X&#39;</span>]
<a name="l00390"></a>00390                 dx = (my_gfunc.x_best - Objective) <span class="keywordflow">if</span> my_gfunc.x_best != <span class="keywordtype">None</span> <span class="keywordflow">else</span> 0.0
<a name="l00391"></a>00391                 <span class="keywordflow">if</span> Objective &lt; my_gfunc.x_best <span class="keywordflow">or</span> my_gfunc.x_best == <span class="keywordtype">None</span>:
<a name="l00392"></a>00392                     color = <span class="stringliteral">&quot;\x1b[92m&quot;</span>
<a name="l00393"></a>00393                     my_gfunc.x_best = Objective
<a name="l00394"></a>00394                 <span class="keywordflow">else</span>:
<a name="l00395"></a>00395                     color = <span class="stringliteral">&quot;\x1b[91m&quot;</span>
<a name="l00396"></a>00396                 <span class="keywordflow">if</span> verbose:
<a name="l00397"></a>00397                     <span class="keywordflow">print</span> <span class="stringliteral">&quot;k=&quot;</span>, <span class="stringliteral">&#39; &#39;</span>.join([<span class="stringliteral">&quot;% .4f&quot;</span> % i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> mvals])
<a name="l00398"></a>00398                     <span class="keywordflow">print</span> <span class="stringliteral">&quot;|Grad|= %12.3e X2= %s%12.3e\x1b[0m d(X2)= %12.3e&quot;</span> % (norm(Answer),color,Objective,dx)
<a name="l00399"></a>00399                     <span class="keywordflow">print</span>
<a name="l00400"></a>00400                 <span class="keywordflow">return</span> Answer
<a name="l00401"></a>00401             my_gfunc.x_best = <span class="keywordtype">None</span>
<a name="l00402"></a>00402             <span class="keywordflow">return</span> my_gfunc
<a name="l00403"></a>00403         <span class="keywordflow">if</span> Algorithm == <span class="stringliteral">&quot;powell&quot;</span>:
<a name="l00404"></a>00404             printcool(<span class="stringliteral">&quot;Minimizing Objective Function using Powell&#39;s Method&quot;</span> , color=7, bold=1)
<a name="l00405"></a>00405             <span class="keywordflow">return</span> optimize.fmin_powell(xwrap(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The objective function (needs to pass in when I instantiate)">Objective</a>),self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,ftol=self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6c2063d16b3d763af6594b1ff6c28822" title="Function value convergence threshold.">conv_obj</a>,xtol=self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab049f4cc1b0eb55229a8dd21c569c0f2" title="Step size convergence threshold.">conv_stp</a>,maxiter=self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a55a71642137dd2c97824dcddfbf236de" title="Maximum number of optimization steps.">maxstep</a>)
<a name="l00406"></a>00406         <span class="keywordflow">elif</span> Algorithm == <span class="stringliteral">&quot;simplex&quot;</span>:
<a name="l00407"></a>00407             printcool(<span class="stringliteral">&quot;Minimizing Objective Function using Simplex Method&quot;</span> , color=7, bold=1)
<a name="l00408"></a>00408             <span class="keywordflow">return</span> optimize.fmin(xwrap(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The objective function (needs to pass in when I instantiate)">Objective</a>),self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,ftol=self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6c2063d16b3d763af6594b1ff6c28822" title="Function value convergence threshold.">conv_obj</a>,xtol=self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab049f4cc1b0eb55229a8dd21c569c0f2" title="Step size convergence threshold.">conv_stp</a>,maxiter=self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a55a71642137dd2c97824dcddfbf236de" title="Maximum number of optimization steps.">maxstep</a>,maxfun=self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a55a71642137dd2c97824dcddfbf236de" title="Maximum number of optimization steps.">maxstep</a>*10)
<a name="l00409"></a>00409         <span class="keywordflow">elif</span> Algorithm == <span class="stringliteral">&quot;anneal&quot;</span>:
<a name="l00410"></a>00410             printcool(<span class="stringliteral">&quot;Minimizing Objective Function using Simulated Annealing&quot;</span> , color=7, bold=1)
<a name="l00411"></a>00411             <span class="keywordflow">return</span> optimize.anneal(xwrap(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The objective function (needs to pass in when I instantiate)">Objective</a>),self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,lower=-1*ones(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a482102f9a8fc0fa5120db5078684fb53" title="Number of parameters.">np</a>),upper=1*ones(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a482102f9a8fc0fa5120db5078684fb53" title="Number of parameters.">np</a>),schedule=<span class="stringliteral">&#39;boltzmann&#39;</span>)
<a name="l00412"></a>00412         <span class="keywordflow">elif</span> Algorithm == <span class="stringliteral">&quot;cg&quot;</span>:
<a name="l00413"></a>00413             printcool(<span class="stringliteral">&quot;Minimizing Objective Function using Conjugate Gradient&quot;</span> , color=7, bold=1)
<a name="l00414"></a>00414             <span class="keywordflow">return</span> optimize.fmin_cg(xwrap(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The objective function (needs to pass in when I instantiate)">Objective</a>,verbose=<span class="keyword">False</span>),self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,fprime=gwrap(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The objective function (needs to pass in when I instantiate)">Objective</a>),gtol=self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a77037a4936b453ab57a9c430ef983a39" title="Gradient convergence threshold.">conv_grd</a>)
<a name="l00415"></a>00415 
<a name="l00416"></a>00416     <span class="comment">##</span>
<a name="l00417"></a>00417     <span class="comment">#  Use SciPy&#39;s built-in simplex algorithm to optimize the parameters. @see Optimizer::ScipyOptimizer </span>
<a name="l00418"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6b3af8115718f61a6a21c3297d717ead">00418</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6b3af8115718f61a6a21c3297d717ead" title="Use SciPy&#39;s built-in simplex algorithm to optimize the parameters.">Simplex</a>(self):
<a name="l00419"></a>00419         <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a503e87533bd9c257cb9c4b505af9c1de" title="Driver for SciPy optimizations.">ScipyOptimizer</a>(Algorithm=<span class="stringliteral">&quot;simplex&quot;</span>)
<a name="l00420"></a>00420 
<a name="l00421"></a>00421     <span class="comment">##</span>
<a name="l00422"></a>00422     <span class="comment">#  Use SciPy&#39;s built-in Powell direction-set algorithm to optimize the parameters. @see Optimizer::ScipyOptimizer </span>
<a name="l00423"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a0745b2e3607ef308ba48bb1d34e5be79">00423</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a0745b2e3607ef308ba48bb1d34e5be79" title="Use SciPy&#39;s built-in Powell direction-set algorithm to optimize the parameters.">Powell</a>(self):
<a name="l00424"></a>00424         <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a503e87533bd9c257cb9c4b505af9c1de" title="Driver for SciPy optimizations.">ScipyOptimizer</a>(Algorithm=<span class="stringliteral">&quot;powell&quot;</span>)
<a name="l00425"></a>00425 
<a name="l00426"></a>00426     <span class="comment">##</span>
<a name="l00427"></a>00427     <span class="comment">#  Use SciPy&#39;s built-in simulated annealing algorithm to optimize the parameters. @see Optimizer::ScipyOptimizer </span>
<a name="l00428"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a183911848e43ca0be1893b87290dc31e">00428</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a183911848e43ca0be1893b87290dc31e" title="Use SciPy&#39;s built-in simulated annealing algorithm to optimize the parameters.">Anneal</a>(self):
<a name="l00429"></a>00429         <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a503e87533bd9c257cb9c4b505af9c1de" title="Driver for SciPy optimizations.">ScipyOptimizer</a>(Algorithm=<span class="stringliteral">&quot;anneal&quot;</span>)
<a name="l00430"></a>00430 
<a name="l00431"></a>00431     <span class="comment">##</span>
<a name="l00432"></a>00432     <span class="comment">#  Use SciPy&#39;s built-in simulated annealing algorithm to optimize the parameters. @see Optimizer::ScipyOptimizer </span>
<a name="l00433"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ad1e151204a172a4e75737b2b699d1623">00433</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ad1e151204a172a4e75737b2b699d1623" title="Use SciPy&#39;s built-in simulated annealing algorithm to optimize the parameters.">ConjugateGradient</a>(self):
<a name="l00434"></a>00434         <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a503e87533bd9c257cb9c4b505af9c1de" title="Driver for SciPy optimizations.">ScipyOptimizer</a>(Algorithm=<span class="stringliteral">&quot;cg&quot;</span>)
<a name="l00435"></a>00435 
<a name="l00436"></a>00436     <span class="comment">##</span>
<a name="l00437"></a>00437     <span class="comment">#  Scan through parameter values.</span>
<a name="l00438"></a>00438     <span class="comment"># </span>
<a name="l00439"></a>00439     <span class="comment">#         This option is activated using the inputs:</span>
<a name="l00440"></a>00440     <span class="comment"># </span>
<a name="l00441"></a>00441     <span class="comment">#         @code</span>
<a name="l00442"></a>00442     <span class="comment">#         scan[mp]vals</span>
<a name="l00443"></a>00443     <span class="comment">#         scan_vals low:hi:nsteps</span>
<a name="l00444"></a>00444     <span class="comment">#         scan_idxnum (number) -or-</span>
<a name="l00445"></a>00445     <span class="comment">#         scan_idxname (name)</span>
<a name="l00446"></a>00446     <span class="comment">#         @endcode</span>
<a name="l00447"></a>00447     <span class="comment">#         </span>
<a name="l00448"></a>00448     <span class="comment">#         This method goes to the specified parameter indices and scans through</span>
<a name="l00449"></a>00449     <span class="comment">#         the supplied values, evaluating the objective function at every step.</span>
<a name="l00450"></a>00450     <span class="comment"># </span>
<a name="l00451"></a>00451     <span class="comment">#         I hope this method will be useful for people who just want to look at</span>
<a name="l00452"></a>00452     <span class="comment">#         changing one or two parameters and seeing how it affects the force</span>
<a name="l00453"></a>00453     <span class="comment">#         field performance.</span>
<a name="l00454"></a>00454     <span class="comment"># </span>
<a name="l00455"></a>00455     <span class="comment">#         @todo Maybe a multidimensional grid can be done.</span>
<a name="l00456"></a>00456     <span class="comment">#         @param[in] MathPhys Switch to use mathematical (True) or physical (False) parameters.</span>
<a name="l00457"></a>00457     <span class="comment">#         </span>
<a name="l00458"></a>00458     <span class="comment">#         </span>
<a name="l00459"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6c7508252398ff7e00469c4c8acb0a48">00459</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6c7508252398ff7e00469c4c8acb0a48" title="Scan through parameter values.">Scan_Values</a>(self,MathPhys=1):
<a name="l00460"></a>00460         <span class="comment"># First make sure that the user entered the correct syntax.</span>
<a name="l00461"></a>00461         <span class="keywordflow">try</span>:
<a name="l00462"></a>00462             vals_in = [float(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.scan_vals.split(<span class="stringliteral">&quot;:&quot;</span>)]
<a name="l00463"></a>00463         <span class="keywordflow">except</span>:
<a name="l00464"></a>00464             <span class="keywordflow">print</span> <span class="stringliteral">&quot;Syntax error: in the input file please use scan_vals low:hi:nsteps&quot;</span>
<a name="l00465"></a>00465             sys.exit(1)
<a name="l00466"></a>00466         <span class="keywordflow">if</span> len(vals_in) != 3:
<a name="l00467"></a>00467             <span class="keywordflow">print</span> <span class="stringliteral">&quot;Syntax error: in the input file please use scan_vals low:hi:nsteps&quot;</span>
<a name="l00468"></a>00468             sys.exit(1)
<a name="l00469"></a>00469         idx = [int(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aef6a50c754338473eedf0a991823f183" title="For scan[mp]vals: The parameter index to scan over.">idxnum</a>]
<a name="l00470"></a>00470         <span class="keywordflow">for</span> j <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a7d44f4096cbe63fcb8ec57d91b3e140d" title="For scan[mp]vals: The parameter name to scan over, it just looks up an index.">idxname</a>:
<a name="l00471"></a>00471             idx += [self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.map[i] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.map <span class="keywordflow">if</span> j <span class="keywordflow">in</span> i]
<a name="l00472"></a>00472         idx = set(idx)
<a name="l00473"></a>00473         scanvals = linspace(vals_in[0],vals_in[1],vals_in[2]+1)
<a name="l00474"></a>00474         <span class="keywordflow">for</span> pidx <span class="keywordflow">in</span> idx:
<a name="l00475"></a>00475             <span class="keywordflow">if</span> MathPhys:
<a name="l00476"></a>00476                 <span class="keywordflow">print</span> <span class="stringliteral">&quot;Scanning parameter %i (%s) in the mathematical space&quot;</span> % (pidx,self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.plist[pidx])
<a name="l00477"></a>00477                 vals = self.mvals0.copy()
<a name="l00478"></a>00478             <span class="keywordflow">else</span>:
<a name="l00479"></a>00479                 <span class="keywordflow">print</span> <span class="stringliteral">&quot;Scanning parameter %i (%s) in the physical space&quot;</span> % (pidx,self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.plist[pidx])
<a name="l00480"></a>00480                 <span class="keywordflow">for</span> Sim <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4a9bf85f3c44a173211de3bf3770bdb4" title="The fitting simulations.">Sims</a>:
<a name="l00481"></a>00481                     Sim.usepvals = <span class="keyword">True</span>
<a name="l00482"></a>00482                 vals = self.FF.pvals0.copy()
<a name="l00483"></a>00483             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> scanvals:
<a name="l00484"></a>00484                 vals[pidx] = i
<a name="l00485"></a>00485                 data        = self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The objective function (needs to pass in when I instantiate)">Objective</a>(vals,Order=0)
<a name="l00486"></a>00486                 <span class="keywordflow">print</span> <span class="stringliteral">&quot;Value = % .4e Objective = % .4e&quot;</span> % (i, data[<span class="stringliteral">&#39;X&#39;</span>])
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <span class="comment">##</span>
<a name="l00489"></a>00489     <span class="comment">#  Scan through the mathematical parameter space. @see Optimizer::ScanValues </span>
<a name="l00490"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a43ab8c6bea2b3112468922ab61163f67">00490</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a43ab8c6bea2b3112468922ab61163f67" title="Scan through the mathematical parameter space.">ScanMVals</a>(self):
<a name="l00491"></a>00491         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6c7508252398ff7e00469c4c8acb0a48" title="Scan through parameter values.">Scan_Values</a>(1)
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <span class="comment">##</span>
<a name="l00494"></a>00494     <span class="comment">#  Scan through the physical parameter space. @see Optimizer::ScanValues </span>
<a name="l00495"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a70bff76f2e56d87c8dee8aa92fe56d29">00495</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a70bff76f2e56d87c8dee8aa92fe56d29" title="Scan through the physical parameter space.">ScanPVals</a>(self):
<a name="l00496"></a>00496         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a6c7508252398ff7e00469c4c8acb0a48" title="Scan through parameter values.">Scan_Values</a>(0)
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <span class="comment">##</span>
<a name="l00499"></a>00499     <span class="comment">#  A single-point objective function computation. </span>
<a name="l00500"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a1477d2b88faa1d4991418538133abcff">00500</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a1477d2b88faa1d4991418538133abcff" title="A single-point objective function computation.">SinglePoint</a>(self):
<a name="l00501"></a>00501         data        = self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The objective function (needs to pass in when I instantiate)">Objective</a>(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,Order=0)
<a name="l00502"></a>00502         <span class="keywordflow">print</span> data[<span class="stringliteral">&#39;X&#39;</span>]
<a name="l00503"></a>00503 
<a name="l00504"></a>00504     <span class="comment">##</span>
<a name="l00505"></a>00505     <span class="comment">#  A single-point gradient computation. </span>
<a name="l00506"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ac5adf24cf3ea3976eb67f75b6b89d101">00506</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ac5adf24cf3ea3976eb67f75b6b89d101" title="A single-point gradient computation.">Gradient</a>(self):
<a name="l00507"></a>00507         data        = self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The objective function (needs to pass in when I instantiate)">Objective</a>(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,Order=1)
<a name="l00508"></a>00508         <span class="keywordflow">print</span> data[<span class="stringliteral">&#39;X&#39;</span>]
<a name="l00509"></a>00509         <span class="keywordflow">print</span> data[<span class="stringliteral">&#39;G&#39;</span>]
<a name="l00510"></a>00510         <span class="keywordflow">print</span> data[<span class="stringliteral">&#39;H&#39;</span>]
<a name="l00511"></a>00511 
<a name="l00512"></a>00512     <span class="comment">##</span>
<a name="l00513"></a>00513     <span class="comment">#  A single-point Hessian computation. </span>
<a name="l00514"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a0c16ad8678a6480e235a45d69fb077d3">00514</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a0c16ad8678a6480e235a45d69fb077d3" title="A single-point Hessian computation.">Hessian</a>(self):
<a name="l00515"></a>00515         data        = self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The objective function (needs to pass in when I instantiate)">Objective</a>(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,Order=2)
<a name="l00516"></a>00516         <span class="keywordflow">print</span> data[<span class="stringliteral">&#39;X&#39;</span>]
<a name="l00517"></a>00517         <span class="keywordflow">print</span> data[<span class="stringliteral">&#39;G&#39;</span>]
<a name="l00518"></a>00518         <span class="keywordflow">print</span> data[<span class="stringliteral">&#39;H&#39;</span>]
<a name="l00519"></a>00519 
<a name="l00520"></a>00520     <span class="comment">##</span>
<a name="l00521"></a>00521     <span class="comment">#  Finite-difference checker for the objective function gradient.</span>
<a name="l00522"></a>00522     <span class="comment"># </span>
<a name="l00523"></a>00523     <span class="comment">#         For each element in the gradient, use a five-point finite difference</span>
<a name="l00524"></a>00524     <span class="comment">#         stencil to compute a finite-difference derivative, and compare it to</span>
<a name="l00525"></a>00525     <span class="comment">#         the analytic result.</span>
<a name="l00526"></a>00526     <span class="comment"># </span>
<a name="l00527"></a>00527     <span class="comment">#         </span>
<a name="l00528"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aacf96d137fb0e491af7e380c8bd61eb9">00528</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aacf96d137fb0e491af7e380c8bd61eb9" title="Finite-difference checker for the objective function gradient.">FDCheckG</a>(self):
<a name="l00529"></a>00529 
<a name="l00530"></a>00530         Adata        = self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The objective function (needs to pass in when I instantiate)">Objective</a>(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,Order=1)[<span class="stringliteral">&#39;G&#39;</span>]
<a name="l00531"></a>00531         Fdata        = zeros(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a482102f9a8fc0fa5120db5078684fb53" title="Number of parameters.">np</a>,dtype=float)
<a name="l00532"></a>00532         printcool(<span class="stringliteral">&quot;Checking first derivatives by finite difference!\n%-8s%-20s%13s%13s%13s%13s&quot;</span> \
<a name="l00533"></a>00533                   % (<span class="stringliteral">&quot;Index&quot;</span>, <span class="stringliteral">&quot;Parameter ID&quot;</span>,<span class="stringliteral">&quot;Analytic&quot;</span>,<span class="stringliteral">&quot;Numerical&quot;</span>,<span class="stringliteral">&quot;Difference&quot;</span>,<span class="stringliteral">&quot;Fractional&quot;</span>),bold=1,color=5)
<a name="l00534"></a>00534         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a482102f9a8fc0fa5120db5078684fb53" title="Number of parameters.">np</a>):
<a name="l00535"></a>00535             Fdata[i] = f1d7p(fdwrap(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The objective function (needs to pass in when I instantiate)">Objective</a>,self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,i,<span class="stringliteral">&#39;X&#39;</span>,Order=0),self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a8b4f389d44edfa39a26c513534d42780" title="Step size for numerical finite difference.">h</a>)
<a name="l00536"></a>00536             Denom = max(abs(Adata[i]),abs(Fdata[i]))
<a name="l00537"></a>00537             Denom = Denom &gt; 1e-8 <span class="keywordflow">and</span> Denom <span class="keywordflow">or</span> 1e-8
<a name="l00538"></a>00538             D = Adata[i] - Fdata[i]
<a name="l00539"></a>00539             Q = (Adata[i] - Fdata[i])/Denom
<a name="l00540"></a>00540             cD = abs(D) &gt; 0.5 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[1;91m&quot;</span> <span class="keywordflow">or</span> (abs(D) &gt; 1e-2 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[91m&quot;</span> <span class="keywordflow">or</span> (abs(D) &gt; 1e-5 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[93m&quot;</span> <span class="keywordflow">or</span> <span class="stringliteral">&quot;\x1b[92m&quot;</span>))
<a name="l00541"></a>00541             cQ = abs(Q) &gt; 0.5 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[1;91m&quot;</span> <span class="keywordflow">or</span> (abs(Q) &gt; 1e-2 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[91m&quot;</span> <span class="keywordflow">or</span> (abs(Q) &gt; 1e-5 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[93m&quot;</span> <span class="keywordflow">or</span> <span class="stringliteral">&quot;\x1b[92m&quot;</span>))
<a name="l00542"></a>00542             <span class="keywordflow">print</span> <span class="stringliteral">&quot;    %-8i%-20s% 13.4e% 13.4e%s% 13.4e%s% 13.4e\x1b[0m&quot;</span> \
<a name="l00543"></a>00543                   % (i, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.plist[i][:20], Adata[i], Fdata[i], cD, D, cQ, Q)
<a name="l00544"></a>00544 
<a name="l00545"></a>00545     <span class="comment">##</span>
<a name="l00546"></a>00546     <span class="comment">#  Finite-difference checker for the objective function Hessian.</span>
<a name="l00547"></a>00547     <span class="comment"># </span>
<a name="l00548"></a>00548     <span class="comment">#         For each element in the Hessian, use a five-point stencil in both</span>
<a name="l00549"></a>00549     <span class="comment">#         parameter indices to compute a finite-difference derivative, and</span>
<a name="l00550"></a>00550     <span class="comment">#         compare it to the analytic result.</span>
<a name="l00551"></a>00551     <span class="comment"># </span>
<a name="l00552"></a>00552     <span class="comment">#         This is meant to be a foolproof checker, so it is pretty slow.  We</span>
<a name="l00553"></a>00553     <span class="comment">#         could write a faster checker if we assumed we had accurate first</span>
<a name="l00554"></a>00554     <span class="comment">#         derivatives, but it&#39;s better to not make that assumption.</span>
<a name="l00555"></a>00555     <span class="comment"># </span>
<a name="l00556"></a>00556     <span class="comment">#         The second derivative is computed by double-wrapping the objective</span>
<a name="l00557"></a>00557     <span class="comment">#         function via the &#39;wrap2&#39; function.</span>
<a name="l00558"></a>00558     <span class="comment"># </span>
<a name="l00559"></a>00559     <span class="comment">#         </span>
<a name="l00560"></a><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#adb86c1f6580bb088a23563a6103986fe">00560</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#adb86c1f6580bb088a23563a6103986fe" title="Finite-difference checker for the objective function Hessian.">FDCheckH</a>(self):
<a name="l00561"></a>00561         Adata        = self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The objective function (needs to pass in when I instantiate)">Objective</a>(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,Order=2)[<span class="stringliteral">&#39;H&#39;</span>]
<a name="l00562"></a>00562         Fdata        = zeros((self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a482102f9a8fc0fa5120db5078684fb53" title="Number of parameters.">np</a>,self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a482102f9a8fc0fa5120db5078684fb53" title="Number of parameters.">np</a>),dtype=float)
<a name="l00563"></a>00563         printcool(<span class="stringliteral">&quot;Checking second derivatives by finite difference!\n%-8s%-20s%-20s%13s%13s%13s%13s&quot;</span> \
<a name="l00564"></a>00564                   % (<span class="stringliteral">&quot;Index&quot;</span>, <span class="stringliteral">&quot;Parameter1 ID&quot;</span>, <span class="stringliteral">&quot;Parameter2 ID&quot;</span>, <span class="stringliteral">&quot;Analytic&quot;</span>,<span class="stringliteral">&quot;Numerical&quot;</span>,<span class="stringliteral">&quot;Difference&quot;</span>,<span class="stringliteral">&quot;Fractional&quot;</span>),bold=1,color=5)
<a name="l00565"></a>00565 
<a name="l00566"></a>00566         <span class="comment"># Whee, our double-wrapped finite difference second derivative!</span>
<a name="l00567"></a>00567         <span class="keyword">def </span>wrap2(mvals0,pidxi,pidxj):
<a name="l00568"></a>00568             <span class="keyword">def </span>func1(arg):
<a name="l00569"></a>00569                 mvals = list(mvals0)
<a name="l00570"></a>00570                 mvals[pidxj] += arg
<a name="l00571"></a>00571                 <span class="keywordflow">return</span> f1d5p(fdwrap(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#ab43692f45372b27e41046aa4a40396f1" title="The objective function (needs to pass in when I instantiate)">Objective</a>,mvals,pidxi,<span class="stringliteral">&#39;X&#39;</span>,Order=0),self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a8b4f389d44edfa39a26c513534d42780" title="Step size for numerical finite difference.">h</a>)
<a name="l00572"></a>00572             <span class="keywordflow">return</span> func1
<a name="l00573"></a>00573         
<a name="l00574"></a>00574         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a482102f9a8fc0fa5120db5078684fb53" title="Number of parameters.">np</a>):
<a name="l00575"></a>00575             <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(i,self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a482102f9a8fc0fa5120db5078684fb53" title="Number of parameters.">np</a>):
<a name="l00576"></a>00576                 Fdata[i,j] = f1d5p(wrap2(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a2b9976e6502107bc6d11868e9b6ddf75" title="The original parameter values.">mvals0</a>,i,j),self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a8b4f389d44edfa39a26c513534d42780" title="Step size for numerical finite difference.">h</a>)
<a name="l00577"></a>00577                 Denom = max(abs(Adata[i,j]),abs(Fdata[i,j]))
<a name="l00578"></a>00578                 Denom = Denom &gt; 1e-8 <span class="keywordflow">and</span> Denom <span class="keywordflow">or</span> 1e-8
<a name="l00579"></a>00579                 D = Adata[i,j] - Fdata[i,j]
<a name="l00580"></a>00580                 Q = (Adata[i,j] - Fdata[i,j])/Denom
<a name="l00581"></a>00581                 cD = abs(D) &gt; 0.5 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[1;91m&quot;</span> <span class="keywordflow">or</span> (abs(D) &gt; 1e-2 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[91m&quot;</span> <span class="keywordflow">or</span> (abs(D) &gt; 1e-5 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[93m&quot;</span> <span class="keywordflow">or</span> <span class="stringliteral">&quot;\x1b[92m&quot;</span>))
<a name="l00582"></a>00582                 cQ = abs(Q) &gt; 0.5 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[1;91m&quot;</span> <span class="keywordflow">or</span> (abs(Q) &gt; 1e-2 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[91m&quot;</span> <span class="keywordflow">or</span> (abs(Q) &gt; 1e-5 <span class="keywordflow">and</span> <span class="stringliteral">&quot;\x1b[93m&quot;</span> <span class="keywordflow">or</span> <span class="stringliteral">&quot;\x1b[92m&quot;</span>))
<a name="l00583"></a>00583                 <span class="keywordflow">print</span> <span class="stringliteral">&quot;    %-8i%-20s%-20s% 13.4e% 13.4e%s% 13.4e%s% 13.4e\x1b[0m&quot;</span> \
<a name="l00584"></a>00584                       % (i, self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.plist[i][:20], self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a309b7d86a8f67f679efe427b1c5cd0cb" title="The force field itself.">FF</a>.plist[j][:20], Adata[i,j], Fdata[i,j], cD, D, cQ, Q)
<a name="l00585"></a>00585 
<a name="l00586"></a>00586     <span class="keyword">def </span>readchk(self):
<a name="l00587"></a>00587         self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a> = {}
<a name="l00588"></a>00588         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aefe9b04072d00b5f17dee407d7801392" title="Name of the checkpoint file that we&#39;re reading in.">rchk_fnm</a> != <span class="keywordtype">None</span>:
<a name="l00589"></a>00589             absfnm = os.path.join(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b9231f6a0f9ac108a1d8565d1f19851" title="The root directory.">root</a>,self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#aefe9b04072d00b5f17dee407d7801392" title="Name of the checkpoint file that we&#39;re reading in.">rchk_fnm</a>)
<a name="l00590"></a>00590             <span class="keywordflow">if</span> os.path.exists(absfnm):
<a name="l00591"></a>00591                 self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a> = pickle.load(open(absfnm))
<a name="l00592"></a>00592             <span class="keywordflow">else</span>:
<a name="l00593"></a>00593                 <span class="keywordflow">print</span> <span class="stringliteral">&quot;\x1b[1;93mWARNING:\x1b[0m read_chk is set to True, but checkpoint file not loaded (wrong filename or doesn&#39;t exist?)&quot;</span>
<a name="l00594"></a>00594         <span class="keywordflow">return</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>
<a name="l00595"></a>00595 
<a name="l00596"></a>00596     <span class="keyword">def </span>writechk(self):
<a name="l00597"></a>00597         <span class="keywordflow">if</span> self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a31ff9e7a8a403d8a8dad6740c4decf9b" title="Name of the checkpoint file that we&#39;re writing out.">wchk_fnm</a> != <span class="keywordtype">None</span>:
<a name="l00598"></a>00598             <span class="keywordflow">print</span> <span class="stringliteral">&quot;Writing the checkpoint file %s&quot;</span> % self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a31ff9e7a8a403d8a8dad6740c4decf9b" title="Name of the checkpoint file that we&#39;re writing out.">wchk_fnm</a>
<a name="l00599"></a>00599             with open(os.path.join(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b9231f6a0f9ac108a1d8565d1f19851" title="The root directory.">root</a>,self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a31ff9e7a8a403d8a8dad6740c4decf9b" title="Name of the checkpoint file that we&#39;re writing out.">wchk_fnm</a>),<span class="stringliteral">&#39;w&#39;</span>) <span class="keyword">as</span> f: pickle.dump(self.<a class="code" href="classforcebalance_1_1optimizer_1_1Optimizer.html#a4b07916dddfdff495a61fd8fb849db3a" title="Put data into the checkpoint file.">chk</a>,f)
<a name="l00600"></a>00600         
<a name="l00601"></a>00601 
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Thu Feb 2 2012 13:21:19 for ForceBalance by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
