<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ForceBalance: forcebalance/forcebalance/forcefield.py Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="ForceBalanceLogo_sm.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">ForceBalance
   &#160;<span id="projectnumber">0.11.0</span>
   </div>
   <div id="projectbrief">Automated optimization of force fields and empirical potentials</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/roadmap.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="api/namespaces.html"><span>API</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="installation.html"><span>Installation</span></a></li>
      <li><a href="usage.html"><span>Usage</span></a></li>
      <li><a href="tutorial.html"><span>Tutorial</span></a></li>
      <li><a href="glossary.html"><span>Glossary</span></a></li>
      <li><a href="todo.html"><span>To-Do&#160;List</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">forcebalance/forcebalance/forcefield.py</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">##</span>
<a name="l00002"></a>00002 <span class="comment">#  @package forcefield</span>
<a name="l00003"></a>00003 <span class="comment"># </span>
<a name="l00004"></a>00004 <span class="comment"># Force field module.</span>
<a name="l00005"></a>00005 <span class="comment"># </span>
<a name="l00006"></a>00006 <span class="comment"># In ForceBalance a &#39;force field&#39; is built from a set of files containing</span>
<a name="l00007"></a>00007 <span class="comment"># physical parameters.  These files can be anything that enter into any</span>
<a name="l00008"></a>00008 <span class="comment"># computation - our original program was quite dependent on the GROMACS</span>
<a name="l00009"></a>00009 <span class="comment"># force field format, but this program is set up to allow very general</span>
<a name="l00010"></a>00010 <span class="comment"># input formats.</span>
<a name="l00011"></a>00011 <span class="comment"># </span>
<a name="l00012"></a>00012 <span class="comment"># We introduce several important concepts:</span>
<a name="l00013"></a>00013 <span class="comment"># </span>
<a name="l00014"></a>00014 <span class="comment"># 1) Adjustable parameters are allocated into a vector.</span>
<a name="l00015"></a>00015 <span class="comment"># </span>
<a name="l00016"></a>00016 <span class="comment"># To cast the force field optimization as a math problem, we treat all</span>
<a name="l00017"></a>00017 <span class="comment"># of the parameters on equal footing and write them as indices in a parameter vector.</span>
<a name="l00018"></a>00018 <span class="comment"># </span>
<a name="l00019"></a>00019 <span class="comment"># 2) A mapping from interaction type to parameter number.</span>
<a name="l00020"></a>00020 <span class="comment"># </span>
<a name="l00021"></a>00021 <span class="comment"># Each element in the parameter vector corresponds to one or more</span>
<a name="l00022"></a>00022 <span class="comment"># interaction types.  Whenever we change the parameter vector and</span>
<a name="l00023"></a>00023 <span class="comment"># recompute the objective function, this amounts to changing the</span>
<a name="l00024"></a>00024 <span class="comment"># physical parameters in the simulations, so we print out new</span>
<a name="l00025"></a>00025 <span class="comment"># force field files for external programs.  In addition, when</span>
<a name="l00026"></a>00026 <span class="comment"># these programs are computing the objective function we are often</span>
<a name="l00027"></a>00027 <span class="comment"># in low-level subroutines that compute terms in the energy and</span>
<a name="l00028"></a>00028 <span class="comment"># force.  If we need an analytic derivative of the objective</span>
<a name="l00029"></a>00029 <span class="comment"># function, then these subroutines need to know which index of the</span>
<a name="l00030"></a>00030 <span class="comment"># parameter vector needs to be modified.</span>
<a name="l00031"></a>00031 <span class="comment"># </span>
<a name="l00032"></a>00032 <span class="comment"># This is done by way of a hash table: for example, when we are</span>
<a name="l00033"></a>00033 <span class="comment"># computing a Coulomb interaction between atom 4 and atom 5, we</span>
<a name="l00034"></a>00034 <span class="comment"># can build the words &#39;COUL4&#39; and &#39;COUL5&#39; and look it up in the</span>
<a name="l00035"></a>00035 <span class="comment"># parameter map; this gives us two numbers (say, 10 and 11)</span>
<a name="l00036"></a>00036 <span class="comment"># corresponding to the eleventh and twelfth element of the</span>
<a name="l00037"></a>00037 <span class="comment"># parameter vector.  Then we can compute the derivatives of</span>
<a name="l00038"></a>00038 <span class="comment"># the energy w/r.t. these parameters (in this case, COUL5/rij</span>
<a name="l00039"></a>00039 <span class="comment"># and COUL4/rij) and increment these values in the objective function</span>
<a name="l00040"></a>00040 <span class="comment"># gradient.</span>
<a name="l00041"></a>00041 <span class="comment"># </span>
<a name="l00042"></a>00042 <span class="comment"># In custom-implemented force fields (see counterpoisematch.py)</span>
<a name="l00043"></a>00043 <span class="comment"># the hash table can also be used to look up parameter values for</span>
<a name="l00044"></a>00044 <span class="comment"># computation of interactions.  This is probably not the fastest way</span>
<a name="l00045"></a>00045 <span class="comment"># to do things, however.</span>
<a name="l00046"></a>00046 <span class="comment"># </span>
<a name="l00047"></a>00047 <span class="comment"># 3) Distinction between physical and mathematical parameters.</span>
<a name="l00048"></a>00048 <span class="comment"># </span>
<a name="l00049"></a>00049 <span class="comment"># The optimization algorithm works in a space that is related to, but</span>
<a name="l00050"></a>00050 <span class="comment"># not exactly the same as the physical parameter space.  The reasons</span>
<a name="l00051"></a>00051 <span class="comment"># for why we do this are:</span>
<a name="l00052"></a>00052 <span class="comment"># </span>
<a name="l00053"></a>00053 <span class="comment"># a) Each parameter has its own physical units.  On the one hand</span>
<a name="l00054"></a>00054 <span class="comment"># it&#39;s not right to treat different physical units all on the same</span>
<a name="l00055"></a>00055 <span class="comment"># footing, so nondimensionalization is desirable.  To make matters</span>
<a name="l00056"></a>00056 <span class="comment"># worse, the force field parameters can be small as 1e-8 or as</span>
<a name="l00057"></a>00057 <span class="comment"># large as 1e+6 depending on the parameter type.  This means the</span>
<a name="l00058"></a>00058 <span class="comment"># elements of the objective function gradient / Hessian have</span>
<a name="l00059"></a>00059 <span class="comment"># elements that differ from each other in size by 10+ orders of</span>
<a name="l00060"></a>00060 <span class="comment"># magnitude, leading to mathematical instabilities in the optimizer.</span>
<a name="l00061"></a>00061 <span class="comment"># </span>
<a name="l00062"></a>00062 <span class="comment"># b) The parameter space can be constrained, most notably for atomic</span>
<a name="l00063"></a>00063 <span class="comment"># partial charges where we don&#39;t want to change the overall charge</span>
<a name="l00064"></a>00064 <span class="comment"># on a molecule.  Thus we wish to project out certain movements</span>
<a name="l00065"></a>00065 <span class="comment"># in the mathematical parameters such that they don&#39;t change the physical</span>
<a name="l00066"></a>00066 <span class="comment"># parameters.</span>
<a name="l00067"></a>00067 <span class="comment"># </span>
<a name="l00068"></a>00068 <span class="comment"># c) We wish to regularize our optimization so as to avoid changing</span>
<a name="l00069"></a>00069 <span class="comment"># our parameters in very insensitive directions (linear dependencies).</span>
<a name="l00070"></a>00070 <span class="comment"># However, the sensitivity of the objective function to changes in the</span>
<a name="l00071"></a>00071 <span class="comment"># force field depends on the physical units!</span>
<a name="l00072"></a>00072 <span class="comment"># </span>
<a name="l00073"></a>00073 <span class="comment"># For all of these reasons, we introduce a &#39;transformation matrix&#39;</span>
<a name="l00074"></a>00074 <span class="comment"># which maps mathematical parameters onto physical parameters.  The</span>
<a name="l00075"></a>00075 <span class="comment"># diagonal elements in this matrix are rescaling factors; they take the</span>
<a name="l00076"></a>00076 <span class="comment"># mathematical parameter and magnify it by this constant factor.  The</span>
<a name="l00077"></a>00077 <span class="comment"># off-diagonal elements correspond to rotations and other linear</span>
<a name="l00078"></a>00078 <span class="comment"># transformations, and currently I just use them to project out the</span>
<a name="l00079"></a>00079 <span class="comment"># &#39;increase the net charge&#39; direction in the physical parameter space.</span>
<a name="l00080"></a>00080 <span class="comment"># </span>
<a name="l00081"></a>00081 <span class="comment"># Note that with regularization, these rescaling factors are equivalent</span>
<a name="l00082"></a>00082 <span class="comment"># to the widths of prior distributions in a maximum likelihood framework.</span>
<a name="l00083"></a>00083 <span class="comment"># Because there is such a correspondence between rescaling factors and</span>
<a name="l00084"></a>00084 <span class="comment"># choosing a prior, they need to be chosen carefully.  This is work in</span>
<a name="l00085"></a>00085 <span class="comment"># progress.  Another possibility is to sample the width of the priors from</span>
<a name="l00086"></a>00086 <span class="comment"># a noninformative distribution -- the hyperprior (we can choose the</span>
<a name="l00087"></a>00087 <span class="comment"># Jeffreys prior or something).  This is work in progress.</span>
<a name="l00088"></a>00088 <span class="comment"># </span>
<a name="l00089"></a>00089 <span class="comment"># Right now only GROMACS parameters are supported, but this class is extensible,</span>
<a name="l00090"></a>00090 <span class="comment"># we need more modules!</span>
<a name="l00091"></a>00091 <span class="comment"># </span>
<a name="l00092"></a>00092 <span class="comment"># @author Lee-Ping Wang</span>
<a name="l00093"></a>00093 <span class="comment"># @date 12/2011</span>
<a name="l00094"></a>00094 <span class="comment"># </span>
<a name="l00095"></a>00095 <span class="comment"># </span>
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 <span class="keyword">import</span> os
<a name="l00098"></a>00098 <span class="keyword">import</span> sys
<a name="l00099"></a>00099 <span class="keyword">from</span> re <span class="keyword">import</span> match, sub, split
<a name="l00100"></a>00100 <span class="keyword">import</span> gmxio, qchemio, tinkerio, custom_io
<a name="l00101"></a>00101 <span class="keyword">import</span> basereader
<a name="l00102"></a>00102 <span class="keyword">from</span> numpy <span class="keyword">import</span> arange, array, diag, exp, eye, log, mat, mean, ones, vstack, zeros
<a name="l00103"></a>00103 <span class="keyword">from</span> numpy.linalg <span class="keyword">import</span> norm
<a name="l00104"></a>00104 <span class="keyword">from</span> nifty <span class="keyword">import</span> col, flat, invert_svd, isint, kb, orthogonalize, pmat2d, printcool, row
<a name="l00105"></a>00105 <span class="keyword">from</span> string <span class="keyword">import</span> count
<a name="l00106"></a>00106 
<a name="l00107"></a>00107 FF_Extensions = {<span class="stringliteral">&quot;itp&quot;</span> : <span class="stringliteral">&quot;gmx&quot;</span>,
<a name="l00108"></a>00108                  <span class="stringliteral">&quot;in&quot;</span>  : <span class="stringliteral">&quot;qchem&quot;</span>,
<a name="l00109"></a>00109                  <span class="stringliteral">&quot;prm&quot;</span> : <span class="stringliteral">&quot;tinker&quot;</span>,
<a name="l00110"></a>00110                  <span class="stringliteral">&quot;gen&quot;</span> : <span class="stringliteral">&quot;custom&quot;</span>
<a name="l00111"></a>00111                  }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 <span class="stringliteral">&quot;&quot;&quot; Recognized force field formats. &quot;&quot;&quot;</span>
<a name="l00114"></a>00114 FF_IOModules = {<span class="stringliteral">&quot;gmx&quot;</span>: gmxio.ITP_Reader ,
<a name="l00115"></a>00115                 <span class="stringliteral">&quot;qchem&quot;</span>: qchemio.QCIn_Reader ,
<a name="l00116"></a>00116                 <span class="stringliteral">&quot;tinker&quot;</span>: tinkerio.Tinker_Reader ,
<a name="l00117"></a>00117                 <span class="stringliteral">&quot;custom&quot;</span>: custom_io.Gen_Reader
<a name="l00118"></a>00118                 }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 <span class="keyword">def </span>determine_fftype(ffname):
<a name="l00121"></a>00121     fsplit = ffname.split(<span class="stringliteral">&#39;/&#39;</span>)[-1].split(<span class="stringliteral">&#39;:&#39;</span>)
<a name="l00122"></a>00122     fftype = <span class="keywordtype">None</span>
<a name="l00123"></a>00123     <span class="keywordflow">print</span> <span class="stringliteral">&quot;Determining file type of %s ...&quot;</span> % fsplit[0],
<a name="l00124"></a>00124     <span class="keywordflow">if</span> len(fsplit) == 2:
<a name="l00125"></a>00125         <span class="keywordflow">if</span> fsplit[1] <span class="keywordflow">in</span> FF_IOModules:
<a name="l00126"></a>00126             <span class="keywordflow">print</span> <span class="stringliteral">&quot;We&#39;re golden! (%s)&quot;</span> % fsplit[1]
<a name="l00127"></a>00127             fftype = fsplit[1]
<a name="l00128"></a>00128         <span class="keywordflow">else</span>:
<a name="l00129"></a>00129             <span class="keywordflow">print</span> <span class="stringliteral">&quot;\x1b[91m Warning: \x1b[0m %s not in supported types (%s)!&quot;</span> % (fsplit[1],<span class="stringliteral">&#39;, &#39;</span>.join(FF_IOModules.keys()))
<a name="l00130"></a>00130     <span class="keywordflow">elif</span> len(fsplit) == 1:
<a name="l00131"></a>00131         <span class="keywordflow">print</span> <span class="stringliteral">&quot;Guessing from extension (you may specify type with filename:type) ...&quot;</span>, 
<a name="l00132"></a>00132         ffname = fsplit[0]
<a name="l00133"></a>00133         ffext = ffname.split(<span class="stringliteral">&#39;.&#39;</span>)[-1]
<a name="l00134"></a>00134         <span class="keywordflow">if</span> ffext <span class="keywordflow">in</span> FF_Extensions:
<a name="l00135"></a>00135             guesstype = FF_Extensions[ffext]
<a name="l00136"></a>00136             <span class="keywordflow">if</span> guesstype <span class="keywordflow">in</span> FF_IOModules:
<a name="l00137"></a>00137                 <span class="keywordflow">print</span> <span class="stringliteral">&quot;guessing %s -&gt; %s!&quot;</span> % (ffext, guesstype)
<a name="l00138"></a>00138                 fftype = guesstype
<a name="l00139"></a>00139             <span class="keywordflow">else</span>:
<a name="l00140"></a>00140                 <span class="keywordflow">print</span> <span class="stringliteral">&quot;\x1b[91m Warning: \x1b[0m %s not in supported types (%s)!&quot;</span> % (fsplit[0],<span class="stringliteral">&#39;, &#39;</span>.join(FF_IOModules.keys()))
<a name="l00141"></a>00141         <span class="keywordflow">else</span>:
<a name="l00142"></a>00142             <span class="keywordflow">print</span> <span class="stringliteral">&quot;\x1b[91m Warning: \x1b[0m %s not in supported extensions (%s)!&quot;</span> % (ffext,<span class="stringliteral">&#39;, &#39;</span>.join(FF_Extensions.keys()))
<a name="l00143"></a>00143     <span class="keywordflow">if</span> fftype == <span class="keywordtype">None</span>:
<a name="l00144"></a>00144         <span class="keywordflow">print</span> <span class="stringliteral">&quot;Force field type not determined!&quot;</span>
<a name="l00145"></a>00145         <span class="comment">#sys.exit(1)</span>
<a name="l00146"></a>00146     <span class="keywordflow">return</span> fftype
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 <span class="comment">##</span>
<a name="l00149"></a>00149 <span class="comment">#  Force field class.</span>
<a name="l00150"></a>00150 <span class="comment"># </span>
<a name="l00151"></a>00151 <span class="comment">#     This class contains all methods for force field manipulation.</span>
<a name="l00152"></a>00152 <span class="comment">#     To create an instance of this class, an input file is required</span>
<a name="l00153"></a>00153 <span class="comment">#     containing the list of force field file names.  Everything else</span>
<a name="l00154"></a>00154 <span class="comment">#     inside this class pertaining to force field generation is self-contained.</span>
<a name="l00155"></a>00155 <span class="comment"># </span>
<a name="l00156"></a>00156 <span class="comment">#     For details on force field parsing, see the detailed documentation for addff.</span>
<a name="l00157"></a>00157 <span class="comment">#     </span>
<a name="l00158"></a>00158 <span class="comment">#     </span>
<a name="l00159"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html">00159</a> <span class="keyword">class </span><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html" title="Force field class.">FF</a>(object):
<a name="l00160"></a>00160     <span class="comment">##</span>
<a name="l00161"></a>00161     <span class="comment"># Instantiation of force field class.</span>
<a name="l00162"></a>00162     <span class="comment"># </span>
<a name="l00163"></a>00163     <span class="comment">#         Many variables here are initialized to zero, but they are filled out by</span>
<a name="l00164"></a>00164     <span class="comment">#         methods like addff, rsmake, and mktransmat.</span>
<a name="l00165"></a>00165     <span class="comment">#         </span>
<a name="l00166"></a>00166     <span class="comment">#         </span>
<a name="l00167"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aef2e183571128eea70132c7be2a8dc5d">00167</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aef2e183571128eea70132c7be2a8dc5d" title="Instantiation of force field class.">__init__</a>(self, options):
<a name="l00168"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3212d7a016d1e1e65249cb0147ebecbb">00168</a> 
<a name="l00169"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a1534c7fcccf4d877d0288e371dcc318c">00169</a>         <span class="comment">#======================================#</span>
<a name="l00170"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aa2172f23b0d01ea15ff14a6795734f62">00170</a>         <span class="comment"># Options that are given by the parser #</span>
<a name="l00171"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#ace535d538a683e676371739fe2ec6092">00171</a>         <span class="comment">#======================================#</span>
<a name="l00172"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a0b4c59bcf7ecb19000b3a173151a7c5b">00172</a> 
<a name="l00173"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a2d12bd53577f14af5e8d4b64ebb6281f">00173</a>         <span class="comment">## The root directory of the project</span>
<a name="l00174"></a>00174         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3212d7a016d1e1e65249cb0147ebecbb" title="The root directory of the project.">root</a>        = os.getcwd()
<a name="l00175"></a>00175         <span class="comment">## File names of force fields</span>
<a name="l00176"></a>00176         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a1534c7fcccf4d877d0288e371dcc318c" title="File names of force fields.">fnms</a>        = options[<span class="stringliteral">&#39;forcefield&#39;</span>]
<a name="l00177"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aa521223f43f9629b30384491cafbd10c">00177</a>         <span class="comment">## Directory containing force fields, relative to project directory</span>
<a name="l00178"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3424d0271d9eebf1962ad87286ec9fc3">00178</a>         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aa2172f23b0d01ea15ff14a6795734f62" title="Directory containing force fields, relative to project directory.">ffdir</a>       = options[<span class="stringliteral">&#39;ffdir&#39;</span>]
<a name="l00179"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3ecc51355dbd97e0b1620007924fd2a3">00179</a>         
<a name="l00180"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a9c49407242f4e8da1c42530825c6dbda">00180</a>         <span class="comment">#======================================#</span>
<a name="l00181"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aa630b2a2142d81e30c5751ed13a7b777">00181</a>         <span class="comment">#     Variables which are set here     #</span>
<a name="l00182"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a5f04fa76bff707688a394542f893993d">00182</a>         <span class="comment">#======================================#</span>
<a name="l00183"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a681cf6c42115d8b250a2294c726fead0">00183</a>         <span class="comment"># A lot of these variables are filled out by calling the methods.</span>
<a name="l00184"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a4d6fbc589839d65aaf4dc417b05afba3">00184</a>         
<a name="l00185"></a>00185         <span class="comment">## The content of all force field files are stored in memory</span>
<a name="l00186"></a>00186         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#ace535d538a683e676371739fe2ec6092" title="The content of all force field files are stored in memory.">stuff</a>       = {}        
<a name="l00187"></a>00187         <span class="comment">## The mapping of interaction type -&gt; parameter number</span>
<a name="l00188"></a>00188         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a0b4c59bcf7ecb19000b3a173151a7c5b" title="The mapping of interaction type -&gt; parameter number.">map</a>         = {}
<a name="l00189"></a>00189         <span class="comment">## The listing of parameter number -&gt; interaction types</span>
<a name="l00190"></a>00190         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a2d12bd53577f14af5e8d4b64ebb6281f" title="The listing of parameter number -&gt; interaction types.">plist</a>       = []
<a name="l00191"></a>00191         <span class="comment">## A list where pfields[pnum] = [&#39;file&#39;,line,field,mult],</span>
<a name="l00192"></a>00192         <span class="comment">## basically a new way to modify force field files; when we modify the</span>
<a name="l00193"></a>00193         <span class="comment">## force field file, we go to the specific line/field in a given file</span>
<a name="l00194"></a>00194         <span class="comment">## and change the number.</span>
<a name="l00195"></a>00195         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aa521223f43f9629b30384491cafbd10c" title="A list where pfields[pnum] = [&#39;file&#39;,line,field,mult], basically a new way to modify force field file...">pfields</a>     = []
<a name="l00196"></a>00196         <span class="comment">## List of rescaling factors</span>
<a name="l00197"></a>00197         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3424d0271d9eebf1962ad87286ec9fc3" title="List of rescaling factors.">rs</a>          = []
<a name="l00198"></a>00198         <span class="comment">## The transformation matrix for mathematical -&gt; physical parameters</span>
<a name="l00199"></a>00199         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3ecc51355dbd97e0b1620007924fd2a3" title="The transformation matrix for mathematical -&gt; physical parameters.">tm</a>          = <span class="keywordtype">None</span>
<a name="l00200"></a>00200         <span class="comment">## The transpose of the transformation matrix</span>
<a name="l00201"></a>00201         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a9c49407242f4e8da1c42530825c6dbda" title="The transpose of the transformation matrix.">tmI</a>         = <span class="keywordtype">None</span>
<a name="l00202"></a>00202         <span class="comment">## Indices to exclude from optimization / Hessian inversion</span>
<a name="l00203"></a>00203         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aa630b2a2142d81e30c5751ed13a7b777" title="Indices to exclude from optimization / Hessian inversion.">excision</a>    = <span class="keywordtype">None</span>
<a name="l00204"></a>00204         <span class="comment">## The total number of parameters</span>
<a name="l00205"></a>00205         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a5f04fa76bff707688a394542f893993d" title="The total number of parameters.">np</a>          = 0
<a name="l00206"></a>00206         <span class="comment">## The force field content, but with parameter fields replaced with new parameters.</span>
<a name="l00207"></a>00207         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a681cf6c42115d8b250a2294c726fead0" title="The force field content, but with parameter fields replaced with new parameters.">newstuff</a>    = {}
<a name="l00208"></a>00208         <span class="comment">## Initial value of physical parameters</span>
<a name="l00209"></a>00209         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a4d6fbc589839d65aaf4dc417b05afba3" title="Initial value of physical parameters.">pvals0</a>      = []
<a name="l00210"></a>00210         
<a name="l00211"></a>00211         <span class="comment"># Read the force fields into memory.</span>
<a name="l00212"></a>00212         <span class="keywordflow">for</span> fnm <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a1534c7fcccf4d877d0288e371dcc318c" title="File names of force fields.">fnms</a>:
<a name="l00213"></a>00213             <span class="keywordflow">print</span> <span class="stringliteral">&quot;Reading force field from file: %s&quot;</span> % fnm
<a name="l00214"></a>00214             self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a142d41c86b9b0ef57f93ec6fb349357b" title="Parse a force field file and add it to the class.">addff</a>(fnm)
<a name="l00215"></a>00215 
<a name="l00216"></a>00216         <span class="comment"># Set the initial values of parameter arrays.</span>
<a name="l00217"></a>00217         <span class="comment">## Initial value of physical parameters</span>
<a name="l00218"></a>00218         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a4d6fbc589839d65aaf4dc417b05afba3" title="Initial value of physical parameters.">pvals0</a> = array(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a4d6fbc589839d65aaf4dc417b05afba3" title="Initial value of physical parameters.">pvals0</a>)
<a name="l00219"></a>00219 
<a name="l00220"></a>00220         <span class="comment"># Prepare various components of the class for first use.</span>
<a name="l00221"></a>00221         <span class="comment">## Creates plist from map.</span>
<a name="l00222"></a>00222         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#ac0046446695a65cb2489fdb560ef5929" title="Create the plist, which is like a reversed version of the parameter map.">list_map</a>()
<a name="l00223"></a>00223         <span class="comment">## Prints the plist to screen.</span>
<a name="l00224"></a>00224         bar = printcool(<span class="stringliteral">&quot;Starting parameter indices, physical values and IDs&quot;</span>)
<a name="l00225"></a>00225         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a61082e99cb3a02e35c80bbea919eaafa" title="Prints out the (physical or mathematical) parameter indices, IDs and values in a visually appealing w...">print_map</a>()                       
<a name="l00226"></a>00226         <span class="keywordflow">print</span> bar
<a name="l00227"></a>00227         <span class="comment">## Make the rescaling factors.</span>
<a name="l00228"></a>00228         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a88715f96ff8e14c3c83b4f976ad147b4" title="Create the rescaling factors for the coordinate transformation in parameter space.">rsmake</a>(printfacs=<span class="keyword">True</span>)            
<a name="l00229"></a>00229         <span class="comment">## Make the transformation matrix.</span>
<a name="l00230"></a>00230         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#acf0ce8fc4e9fbf5257f93d14d4a4f10f" title="Create the transformation matrix to rescale and rotate the mathematical parameters.">mktransmat</a>()                      
<a name="l00231"></a>00231         
<a name="l00232"></a>00232     <span class="comment">##</span>
<a name="l00233"></a>00233     <span class="comment">#  Parse a force field file and add it to the class.</span>
<a name="l00234"></a>00234     <span class="comment"># </span>
<a name="l00235"></a>00235     <span class="comment">#         First, we need to figure out the type of file file.  Currently this is done</span>
<a name="l00236"></a>00236     <span class="comment">#         using the three-letter file extension (&#39;.itp&#39; = gmx); that can be improved.</span>
<a name="l00237"></a>00237     <span class="comment">#         </span>
<a name="l00238"></a>00238     <span class="comment">#         First we open the force field file and read all of its lines.  As we loop</span>
<a name="l00239"></a>00239     <span class="comment">#         through the force field file, we look for two types of tags: (1) section</span>
<a name="l00240"></a>00240     <span class="comment">#         markers, in GMX indicated by [ section_name ], which allows us to determine</span>
<a name="l00241"></a>00241     <span class="comment">#         the section, and (2) parameter tags, indicated by the &#39;PARM&#39; or &#39;RPT&#39; keywords.</span>
<a name="l00242"></a>00242     <span class="comment"># </span>
<a name="l00243"></a>00243     <span class="comment">#         As we go through the file, we figure out the atoms involved in the interaction</span>
<a name="l00244"></a>00244     <span class="comment">#         described on each line.</span>
<a name="l00245"></a>00245     <span class="comment"># </span>
<a name="l00246"></a>00246     <span class="comment">#         When a &#39;PARM&#39; keyword is indicated, it is followed by a number which is the field</span>
<a name="l00247"></a>00247     <span class="comment">#         in the line to be modified, starting with zero.  Based on the field number and the</span>
<a name="l00248"></a>00248     <span class="comment">#         section name, we can figure out the parameter type.  With the parameter type</span>
<a name="l00249"></a>00249     <span class="comment">#         and the atoms in hand, we construct a &#39;parameter identifier&#39; or pid which uniquely</span>
<a name="l00250"></a>00250     <span class="comment">#         identifies that parameter.  We also store the physical parameter value in an array</span>
<a name="l00251"></a>00251     <span class="comment">#         called &#39;pvals0&#39; and the precise location of that parameter (by filename, line number,</span>
<a name="l00252"></a>00252     <span class="comment">#         and field number) in a list called &#39;pfields&#39;.</span>
<a name="l00253"></a>00253     <span class="comment"># </span>
<a name="l00254"></a>00254     <span class="comment">#         An example: Suppose in &#39;my_ff.itp&#39; I encounter the following on lines 146 and 147:</span>
<a name="l00255"></a>00255     <span class="comment">#         </span>
<a name="l00256"></a>00256     <span class="comment">#         @code</span>
<a name="l00257"></a>00257     <span class="comment">#         [ angletypes ]</span>
<a name="l00258"></a>00258     <span class="comment">#         CA   CB   O   1   109.47  350.00  ; PARM 4 5</span>
<a name="l00259"></a>00259     <span class="comment">#         @endcode</span>
<a name="l00260"></a>00260     <span class="comment"># </span>
<a name="l00261"></a>00261     <span class="comment">#         From reading &lt;tt&gt;[ angletypes ]&lt;/tt&gt; I know I&#39;m in the &#39;angletypes&#39; section.</span>
<a name="l00262"></a>00262     <span class="comment"># </span>
<a name="l00263"></a>00263     <span class="comment">#         On the next line, I notice two parameters on fields 4 and 5.</span>
<a name="l00264"></a>00264     <span class="comment"># </span>
<a name="l00265"></a>00265     <span class="comment">#         From the atom types, section type and field number I know the parameter IDs are &lt;tt&gt;&#39;ANGLESBCACBO&#39;&lt;/tt&gt; and &lt;tt&gt;&#39;ANGLESKCACBO&#39;&lt;/tt&gt;.</span>
<a name="l00266"></a>00266     <span class="comment">#         </span>
<a name="l00267"></a>00267     <span class="comment">#         After building &lt;tt&gt;map={&#39;ANGLESBCACBO&#39;:1,&#39;ANGLESKCACBO&#39;:2}&lt;/tt&gt;, I store the values in</span>
<a name="l00268"></a>00268     <span class="comment">#         an array: &lt;tt&gt;pvals0=array([109.47,350.00])&lt;/tt&gt;, and I put the parameter locations in</span>
<a name="l00269"></a>00269     <span class="comment">#         pfields: &lt;tt&gt;pfields=[[&#39;my_ff.itp&#39;,147,4,1.0],[&#39;my_ff.itp&#39;,146,5,1.0]]&lt;/tt&gt;.  The 1.0</span>
<a name="l00270"></a>00270     <span class="comment">#         is a &#39;multiplier&#39; and I will explain it below.</span>
<a name="l00271"></a>00271     <span class="comment">#         </span>
<a name="l00272"></a>00272     <span class="comment">#         Note that in the creation of parameter IDs, we run into the issue that the atoms</span>
<a name="l00273"></a>00273     <span class="comment">#         involved in the interaction may be labeled in reverse order (e.g. &lt;tt&gt;OCACB&lt;/tt&gt;).  Thus,</span>
<a name="l00274"></a>00274     <span class="comment">#         we store both the normal and the reversed parameter ID in the map.</span>
<a name="l00275"></a>00275     <span class="comment"># </span>
<a name="l00276"></a>00276     <span class="comment">#         Parameter repetition and multiplier:</span>
<a name="l00277"></a>00277     <span class="comment">#         </span>
<a name="l00278"></a>00278     <span class="comment">#         If &lt;tt&gt;&#39;RPT&#39;&lt;/tt&gt; is encountered in the line, it is always in the syntax:</span>
<a name="l00279"></a>00279     <span class="comment">#         &lt;tt&gt;&#39;RPT 4 ANGLESBCACAH 5 MINUS_ANGLESKCACAH /RPT&#39;&lt;/tt&gt;.  In this case, field 4 is replaced by</span>
<a name="l00280"></a>00280     <span class="comment">#         the stored parameter value corresponding to &lt;tt&gt;ANGLESBCACAH&lt;/tt&gt; and field 5 is replaced by</span>
<a name="l00281"></a>00281     <span class="comment">#         -1 times the stored value of &lt;tt&gt;ANGLESKCACAH&lt;/tt&gt;.  Now I just picked this as an example,</span>
<a name="l00282"></a>00282     <span class="comment">#         I don&#39;t think people actually want a negative angle force constant .. :) the &lt;tt&gt;MINUS&lt;/tt&gt;</span>
<a name="l00283"></a>00283     <span class="comment">#         keyword does come in handy for assigning atomic charges and virtual site positions.</span>
<a name="l00284"></a>00284     <span class="comment">#         In order to achieve this, a multiplier of -1.0 is stored into pfields instead of 1.0.</span>
<a name="l00285"></a>00285     <span class="comment"># </span>
<a name="l00286"></a>00286     <span class="comment">#         @todo Note that I can also create the opposite virtual site position by changing the atom</span>
<a name="l00287"></a>00287     <span class="comment">#         labeling, woo!</span>
<a name="l00288"></a>00288     <span class="comment"># </span>
<a name="l00289"></a>00289     <span class="comment">#         @warning My program currently assumes that we are only using one MM program per job.</span>
<a name="l00290"></a>00290     <span class="comment">#         If we use CHARMM and GROMACS to perform fitting simulations in the same job, we will</span>
<a name="l00291"></a>00291     <span class="comment">#         get f-ed up.  Maybe this needs to be fixed in the future, with program prefixes to</span>
<a name="l00292"></a>00292     <span class="comment">#         parameters like C_ , G_ .. or simply unit conversions, you get the idea.</span>
<a name="l00293"></a>00293     <span class="comment"># </span>
<a name="l00294"></a>00294     <span class="comment">#         @warning I don&#39;t think the multiplier actually works for analytic derivatives unless</span>
<a name="l00295"></a>00295     <span class="comment">#         the interaction calculator knows the multiplier as well.  I&#39;m sure I can make this</span>
<a name="l00296"></a>00296     <span class="comment">#         work in the future if necessary.</span>
<a name="l00297"></a>00297     <span class="comment"># </span>
<a name="l00298"></a>00298     <span class="comment">#         @param[in] ffname Name of the force field file</span>
<a name="l00299"></a>00299     <span class="comment"># </span>
<a name="l00300"></a>00300     <span class="comment">#         </span>
<a name="l00301"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a142d41c86b9b0ef57f93ec6fb349357b">00301</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a142d41c86b9b0ef57f93ec6fb349357b" title="Parse a force field file and add it to the class.">addff</a>(self,ffname):
<a name="l00302"></a>00302         fftype = determine_fftype(ffname)
<a name="l00303"></a>00303         ffname = ffname.split(<span class="stringliteral">&#39;:&#39;</span>)[0]
<a name="l00304"></a>00304 
<a name="l00305"></a>00305         <span class="comment"># Determine the appropriate parser from the FF_IOModules dictionary.</span>
<a name="l00306"></a>00306         <span class="comment"># If we can&#39;t figure it out, then use the base reader, it ain&#39;t so bad. :)</span>
<a name="l00307"></a>00307         Reader = FF_IOModules.get(fftype,basereader.BaseReader)
<a name="l00308"></a>00308 
<a name="l00309"></a>00309         <span class="comment"># Open the force field using an absolute path and read its contents into memory.</span>
<a name="l00310"></a>00310         absff = os.path.join(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3212d7a016d1e1e65249cb0147ebecbb" title="The root directory of the project.">root</a>,self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aa2172f23b0d01ea15ff14a6795734f62" title="Directory containing force fields, relative to project directory.">ffdir</a>,ffname)
<a name="l00311"></a>00311         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#ace535d538a683e676371739fe2ec6092" title="The content of all force field files are stored in memory.">stuff</a>[ffname] = open(absff).readlines()
<a name="l00312"></a>00312         
<a name="l00313"></a>00313         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a849ac9d6e43c32f7cacba27af3af70e8">R</a> = Reader(ffname)
<a name="l00314"></a>00314         <span class="keywordflow">for</span> ln, line <span class="keywordflow">in</span> enumerate(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#ace535d538a683e676371739fe2ec6092" title="The content of all force field files are stored in memory.">stuff</a>[ffname]):
<a name="l00315"></a>00315             self.R.feed(line)
<a name="l00316"></a>00316             sline = line.split()
<a name="l00317"></a>00317             <span class="keywordflow">if</span> <span class="stringliteral">&#39;PARM&#39;</span> <span class="keywordflow">in</span> sline:
<a name="l00318"></a>00318                 pmark = (array(sline) == <span class="stringliteral">&#39;PARM&#39;</span>).argmax() <span class="comment"># The position of the &#39;PARM&#39; word</span>
<a name="l00319"></a>00319                 pflds = [int(i) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> sline[pmark+1:]] <span class="comment"># The integers that specify the parameter word positions</span>
<a name="l00320"></a>00320                 <span class="keywordflow">for</span> pfld <span class="keywordflow">in</span> pflds:
<a name="l00321"></a>00321                     <span class="comment"># For each of the fields that are to be parameterized (indicated by PARM #),</span>
<a name="l00322"></a>00322                     <span class="comment"># assign a parameter type to it according to the Interaction Type -&gt; Parameter Dictionary.</span>
<a name="l00323"></a>00323                     pid = self.R.build_pid(pfld)
<a name="l00324"></a>00324                     <span class="comment"># Add pid into the dictionary.</span>
<a name="l00325"></a>00325                     self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a0b4c59bcf7ecb19000b3a173151a7c5b" title="The mapping of interaction type -&gt; parameter number.">map</a>[pid] = self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a5f04fa76bff707688a394542f893993d" title="The total number of parameters.">np</a>
<a name="l00326"></a>00326                     <span class="comment"># Also append pid to the parameter list</span>
<a name="l00327"></a>00327                     self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3af07734a2378364ed533e2853ee6b82" title="Assign physical parameter values to the &#39;pvals0&#39; array.">assign_p0</a>(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a5f04fa76bff707688a394542f893993d" title="The total number of parameters.">np</a>,float(sline[pfld]))
<a name="l00328"></a>00328                     self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a2c9cda9adb5a6446fbccfa7b35f8dff5" title="Record the locations of a parameter in a file; [[file name, line number, field number, and multiplier]].">assign_field</a>(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a5f04fa76bff707688a394542f893993d" title="The total number of parameters.">np</a>,ffname,ln,pfld,1)
<a name="l00329"></a>00329                     self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a5f04fa76bff707688a394542f893993d" title="The total number of parameters.">np</a> += 1
<a name="l00330"></a>00330             <span class="keywordflow">if</span> <span class="stringliteral">&quot;RPT&quot;</span> <span class="keywordflow">in</span> sline:
<a name="l00331"></a>00331                 parse = (array(sline)==<span class="stringliteral">&#39;RPT&#39;</span>).argmax()+1 <span class="comment"># The position of the &#39;RPT&#39; word</span>
<a name="l00332"></a>00332                 <span class="keywordflow">while</span> parse &lt; (array(sline)==<span class="stringliteral">&#39;/RPT&#39;</span>).argmax():
<a name="l00333"></a>00333                     <span class="comment"># Between RPT and /RPT, the words occur in pairs.</span>
<a name="l00334"></a>00334                     <span class="comment"># First is a number corresponding to the field that contains the dependent parameter.</span>
<a name="l00335"></a>00335                     <span class="comment"># Second is a string corresponding to the &#39;pid&#39; that this parameter depends on.</span>
<a name="l00336"></a>00336                     pfld = int(sline[parse])
<a name="l00337"></a>00337                     prep = self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a0b4c59bcf7ecb19000b3a173151a7c5b" title="The mapping of interaction type -&gt; parameter number.">map</a>[sline[parse+1].replace(<span class="stringliteral">&#39;MINUS_&#39;</span>,<span class="stringliteral">&#39;&#39;</span>)]
<a name="l00338"></a>00338                     pid = self.R.build_pid(pfld)
<a name="l00339"></a>00339                     self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a0b4c59bcf7ecb19000b3a173151a7c5b" title="The mapping of interaction type -&gt; parameter number.">map</a>[pid] = prep
<a name="l00340"></a>00340                     self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a2c9cda9adb5a6446fbccfa7b35f8dff5" title="Record the locations of a parameter in a file; [[file name, line number, field number, and multiplier]].">assign_field</a>(prep,ffname,ln,pfld,<span class="stringliteral">&quot;MINUS_&quot;</span> <span class="keywordflow">in</span> sline[parse+1] <span class="keywordflow">and</span> -1 <span class="keywordflow">or</span> 1)
<a name="l00341"></a>00341                     parse += 2
<a name="l00342"></a>00342         
<a name="l00343"></a>00343     <span class="comment">##</span>
<a name="l00344"></a>00344     <span class="comment">#  Create a new force field using provided parameter values.</span>
<a name="l00345"></a>00345     <span class="comment">#         </span>
<a name="l00346"></a>00346     <span class="comment">#         This big kahuna does a number of things:</span>
<a name="l00347"></a>00347     <span class="comment">#         1) Creates the physical parameters from the mathematical parameters</span>
<a name="l00348"></a>00348     <span class="comment">#         2) Creates force fields with physical parameters substituted in</span>
<a name="l00349"></a>00349     <span class="comment">#         3) Prints the force fields to the specified file.</span>
<a name="l00350"></a>00350     <span class="comment"># </span>
<a name="l00351"></a>00351     <span class="comment">#         It does NOT store the mathematical parameters in the class state</span>
<a name="l00352"></a>00352     <span class="comment">#         (since we can only hold one set of parameters).</span>
<a name="l00353"></a>00353     <span class="comment"># </span>
<a name="l00354"></a>00354     <span class="comment">#         @param[in] printdir The directory that the force fields are printed to; as usual</span>
<a name="l00355"></a>00355     <span class="comment">#         this is relative to the project root directory.</span>
<a name="l00356"></a>00356     <span class="comment">#         @param[in] vals Input parameters.  I previously had an option where it uses</span>
<a name="l00357"></a>00357     <span class="comment">#         stored values in the class state, but I don&#39;t think that&#39;s a good idea anymore.</span>
<a name="l00358"></a>00358     <span class="comment">#         @param[in] usepvals Switch for whether to bypass the coordinate transformation</span>
<a name="l00359"></a>00359     <span class="comment">#         and use physical parameters directly.</span>
<a name="l00360"></a>00360     <span class="comment">#         </span>
<a name="l00361"></a>00361     <span class="comment">#         </span>
<a name="l00362"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aecd595ddb369aedd7009e6756276ffc5">00362</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aecd595ddb369aedd7009e6756276ffc5" title="Create a new force field using provided parameter values.">make</a>(self,printdir,vals,usepvals):
<a name="l00363"></a>00363         <span class="keywordflow">if</span> usepvals:
<a name="l00364"></a>00364             pvals = vals.copy()
<a name="l00365"></a>00365         <span class="keywordflow">else</span>:
<a name="l00366"></a>00366             pvals = self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a260031479e0429e497f56987de541930" title="Converts mathematical to physical parameters.">create_pvals</a>(vals)
<a name="l00367"></a>00367         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3965b1b353e0e72d3001906aee31a7ef" title="Replaces numerical fields in stored force field files with the stored physical parameter values...">replace_pvals</a>(pvals)
<a name="l00368"></a>00368         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#adf766c97d811fe9501557b66c33eb084" title="Prints out the new content of force fields to files in &#39;printdir&#39;.">print_newstuff</a>(printdir)
<a name="l00369"></a>00369         <span class="keywordflow">return</span> pvals
<a name="l00370"></a>00370         
<a name="l00371"></a>00371     <span class="comment">##</span>
<a name="l00372"></a>00372     <span class="comment"># Converts mathematical to physical parameters.</span>
<a name="l00373"></a>00373     <span class="comment"># </span>
<a name="l00374"></a>00374     <span class="comment">#         First, mathematical parameters are rescaled and rotated by</span>
<a name="l00375"></a>00375     <span class="comment">#         multiplying by the transformation matrix, followed by adding</span>
<a name="l00376"></a>00376     <span class="comment">#         the original physical parameters.</span>
<a name="l00377"></a>00377     <span class="comment"># </span>
<a name="l00378"></a>00378     <span class="comment">#         @param[in] mvals The mathematical parameters</span>
<a name="l00379"></a>00379     <span class="comment">#         @return pvals The physical parameters</span>
<a name="l00380"></a>00380     <span class="comment">#         </span>
<a name="l00381"></a>00381     <span class="comment">#         </span>
<a name="l00382"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a260031479e0429e497f56987de541930">00382</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a260031479e0429e497f56987de541930" title="Converts mathematical to physical parameters.">create_pvals</a>(self,mvals):
<a name="l00383"></a>00383         pvals = flat(mat(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a9c49407242f4e8da1c42530825c6dbda" title="The transpose of the transformation matrix.">tmI</a>)*col(mvals)) + self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a4d6fbc589839d65aaf4dc417b05afba3" title="Initial value of physical parameters.">pvals0</a>
<a name="l00384"></a>00384         <span class="keywordflow">return</span> pvals
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     <span class="comment">##</span>
<a name="l00387"></a>00387     <span class="comment"># Converts physical to mathematical parameters.</span>
<a name="l00388"></a>00388     <span class="comment"># </span>
<a name="l00389"></a>00389     <span class="comment">#         We create the inverse transformation matrix using SVD.</span>
<a name="l00390"></a>00390     <span class="comment"># </span>
<a name="l00391"></a>00391     <span class="comment">#         @param[in] pvals The physical parameters</span>
<a name="l00392"></a>00392     <span class="comment">#         @return mvals The mathematical parameters</span>
<a name="l00393"></a>00393     <span class="comment">#         </span>
<a name="l00394"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#ae5fba4d3e22f210632ead3653e6e12dd">00394</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#ae5fba4d3e22f210632ead3653e6e12dd" title="Converts physical to mathematical parameters.">create_mvals</a>(self,pvals):
<a name="l00395"></a>00395         mvals = flat(invert_svd(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a9c49407242f4e8da1c42530825c6dbda" title="The transpose of the transformation matrix.">tmI</a>) * col(pvals - self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a4d6fbc589839d65aaf4dc417b05afba3" title="Initial value of physical parameters.">pvals0</a>))
<a name="l00396"></a>00396         <span class="keywordflow">return</span> mvals
<a name="l00397"></a>00397         
<a name="l00398"></a>00398     <span class="comment">##</span>
<a name="l00399"></a>00399     <span class="comment"># Replaces numerical fields in stored force field files with the stored physical parameter values.</span>
<a name="l00400"></a>00400     <span class="comment">#         </span>
<a name="l00401"></a>00401     <span class="comment">#         Unless you really know what you&#39;re doing, you probably shouldn&#39;t be calling this directly.</span>
<a name="l00402"></a>00402     <span class="comment"># </span>
<a name="l00403"></a>00403     <span class="comment">#         </span>
<a name="l00404"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3965b1b353e0e72d3001906aee31a7ef">00404</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3965b1b353e0e72d3001906aee31a7ef" title="Replaces numerical fields in stored force field files with the stored physical parameter values...">replace_pvals</a>(self,pvals):
<a name="l00405"></a>00405         vals = list(pvals)
<a name="l00406"></a>00406         <span class="keywordflow">for</span> fnm <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#ace535d538a683e676371739fe2ec6092" title="The content of all force field files are stored in memory.">stuff</a>:
<a name="l00407"></a>00407             self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a681cf6c42115d8b250a2294c726fead0" title="The force field content, but with parameter fields replaced with new parameters.">newstuff</a>[fnm] = list(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#ace535d538a683e676371739fe2ec6092" title="The content of all force field files are stored in memory.">stuff</a>[fnm])
<a name="l00408"></a>00408         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aa521223f43f9629b30384491cafbd10c" title="A list where pfields[pnum] = [&#39;file&#39;,line,field,mult], basically a new way to modify force field file...">pfields</a>)):
<a name="l00409"></a>00409             pfld_list = self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aa521223f43f9629b30384491cafbd10c" title="A list where pfields[pnum] = [&#39;file&#39;,line,field,mult], basically a new way to modify force field file...">pfields</a>[i]
<a name="l00410"></a>00410             <span class="keywordflow">for</span> pfield <span class="keywordflow">in</span> pfld_list:
<a name="l00411"></a>00411                 fnm,ln,fld,mult = pfield
<a name="l00412"></a>00412                 sline       = self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a681cf6c42115d8b250a2294c726fead0" title="The force field content, but with parameter fields replaced with new parameters.">newstuff</a>[fnm][ln].split()
<a name="l00413"></a>00413                 whites      = split(<span class="stringliteral">&#39;[^ ]+&#39;</span>,self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a681cf6c42115d8b250a2294c726fead0" title="The force field content, but with parameter fields replaced with new parameters.">newstuff</a>[fnm][ln])
<a name="l00414"></a>00414                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> match(<span class="stringliteral">&#39;^-&#39;</span>,sline[fld]) <span class="keywordflow">and</span> len(whites[fld]) &gt; 1:
<a name="l00415"></a>00415                     whites[fld] = whites[fld][:-1]
<a name="l00416"></a>00416                 sline[fld]  = <span class="stringliteral">&quot;% .12e&quot;</span> % (mult*vals[i])
<a name="l00417"></a>00417                 self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a681cf6c42115d8b250a2294c726fead0" title="The force field content, but with parameter fields replaced with new parameters.">newstuff</a>[fnm][ln] = <span class="stringliteral">&#39;&#39;</span>.join([whites[j]+sline[j] <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(len(sline))])+<span class="stringliteral">&#39;\n&#39;</span>
<a name="l00418"></a>00418                 
<a name="l00419"></a>00419     <span class="comment">##</span>
<a name="l00420"></a>00420     <span class="comment"># Prints out the new content of force fields to files in &#39;printdir&#39;.</span>
<a name="l00421"></a>00421     <span class="comment"># </span>
<a name="l00422"></a>00422     <span class="comment">#         @param[in] printdir The directory to which new force fields are printed.</span>
<a name="l00423"></a>00423     <span class="comment"># </span>
<a name="l00424"></a>00424     <span class="comment">#         </span>
<a name="l00425"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#adf766c97d811fe9501557b66c33eb084">00425</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#adf766c97d811fe9501557b66c33eb084" title="Prints out the new content of force fields to files in &#39;printdir&#39;.">print_newstuff</a>(self,printdir):
<a name="l00426"></a>00426         <span class="keywordflow">if</span> <span class="keywordflow">not</span> os.path.exists(os.path.join(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3212d7a016d1e1e65249cb0147ebecbb" title="The root directory of the project.">root</a>,printdir)):
<a name="l00427"></a>00427             os.makedirs(os.path.join(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3212d7a016d1e1e65249cb0147ebecbb" title="The root directory of the project.">root</a>,printdir))
<a name="l00428"></a>00428         <span class="keywordflow">for</span> fnm <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a681cf6c42115d8b250a2294c726fead0" title="The force field content, but with parameter fields replaced with new parameters.">newstuff</a>:
<a name="l00429"></a>00429             with open(os.path.join(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3212d7a016d1e1e65249cb0147ebecbb" title="The root directory of the project.">root</a>,printdir,fnm),<span class="stringliteral">&#39;w&#39;</span>) <span class="keyword">as</span> f: f.writelines(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a681cf6c42115d8b250a2294c726fead0" title="The force field content, but with parameter fields replaced with new parameters.">newstuff</a>[fnm])
<a name="l00430"></a>00430             
<a name="l00431"></a>00431     <span class="comment">##</span>
<a name="l00432"></a>00432     <span class="comment"># Create the rescaling factors for the coordinate transformation in parameter space.</span>
<a name="l00433"></a>00433     <span class="comment"># </span>
<a name="l00434"></a>00434     <span class="comment">#         The proper choice of rescaling factors (read: prior widths in maximum likelihood analysis)</span>
<a name="l00435"></a>00435     <span class="comment">#         is still a black art.  This is a topic of current research.</span>
<a name="l00436"></a>00436     <span class="comment"># </span>
<a name="l00437"></a>00437     <span class="comment">#         @todo Pass in rsfactors through the input file</span>
<a name="l00438"></a>00438     <span class="comment"># </span>
<a name="l00439"></a>00439     <span class="comment">#         @param[in] printfacs List for printing out the resecaling factors</span>
<a name="l00440"></a>00440     <span class="comment"># </span>
<a name="l00441"></a>00441     <span class="comment">#         </span>
<a name="l00442"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a88715f96ff8e14c3c83b4f976ad147b4">00442</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a88715f96ff8e14c3c83b4f976ad147b4" title="Create the rescaling factors for the coordinate transformation in parameter space.">rsmake</a>(self,printfacs=True):
<a name="l00443"></a>00443         typevals = {}
<a name="l00444"></a>00444         tvgeomean = {}
<a name="l00445"></a>00445         <span class="comment">## Takes the dictionary &#39;BONDS&#39;:{3:&#39;B&#39;, 4:&#39;K&#39;}, &#39;VDW&#39;:{4:&#39;S&#39;, 5:&#39;T&#39;},</span>
<a name="l00446"></a>00446         <span class="comment">## and turns it into a list of term types [&#39;BONDSB&#39;,&#39;BONDSK&#39;,&#39;VDWS&#39;,&#39;VDWT&#39;]</span>
<a name="l00447"></a>00447         termtypelist = sum([[i+self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a849ac9d6e43c32f7cacba27af3af70e8">R</a>.pdict[i][j] <span class="keywordflow">for</span> j <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a849ac9d6e43c32f7cacba27af3af70e8">R</a>.pdict[i] <span class="keywordflow">if</span> isint(str(j))] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a849ac9d6e43c32f7cacba27af3af70e8">R</a>.pdict],[])
<a name="l00448"></a>00448         <span class="keywordflow">for</span> termtype <span class="keywordflow">in</span> termtypelist:
<a name="l00449"></a>00449             <span class="keywordflow">for</span> pid <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a0b4c59bcf7ecb19000b3a173151a7c5b" title="The mapping of interaction type -&gt; parameter number.">map</a>:
<a name="l00450"></a>00450                 <span class="keywordflow">if</span> termtype <span class="keywordflow">in</span> pid:
<a name="l00451"></a>00451                     typevals.setdefault(termtype, []).append(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a4d6fbc589839d65aaf4dc417b05afba3" title="Initial value of physical parameters.">pvals0</a>[self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a0b4c59bcf7ecb19000b3a173151a7c5b" title="The mapping of interaction type -&gt; parameter number.">map</a>[pid]])
<a name="l00452"></a>00452         <span class="keywordflow">for</span> termtype <span class="keywordflow">in</span> typevals:
<a name="l00453"></a>00453             <span class="comment"># The old, horrendously complicated rule</span>
<a name="l00454"></a>00454             <span class="comment"># tvgeomean[termtype] = exp(mean(log(abs(array(typevals[termtype]))+(abs(array(typevals[termtype]))==0))))</span>
<a name="l00455"></a>00455             <span class="comment"># The newer, maximum rule (thanks Baba)</span>
<a name="l00456"></a>00456             tvgeomean[termtype] = max(abs(array(typevals[termtype])))
<a name="l00457"></a>00457             <span class="comment"># Physically motivated overrides</span>
<a name="l00458"></a>00458             rs_override(tvgeomean,termtype)
<a name="l00459"></a>00459         <span class="comment"># for line in os.popen(&quot;awk &#39;/rsfactor/ {print $2,$3}&#39; %s&quot; % pkg.options).readlines():</span>
<a name="l00460"></a>00460         <span class="comment">#     tvgeomean[line.split()[0]] = float(line.split()[1])</span>
<a name="l00461"></a>00461         <span class="keywordflow">if</span> printfacs:
<a name="l00462"></a>00462             bar = printcool(<span class="stringliteral">&quot;Rescaling Factors for Different Parameter Types:&quot;</span>,color=1)
<a name="l00463"></a>00463             <span class="keywordflow">print</span> <span class="stringliteral">&#39;\n&#39;</span>.join(sorted([<span class="stringliteral">&quot;   %-15s  : %.5e&quot;</span> % (i, tvgeomean[i]) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> tvgeomean]))
<a name="l00464"></a>00464             <span class="keywordflow">print</span> bar
<a name="l00465"></a>00465         <span class="comment">## The array of rescaling factors</span>
<a name="l00466"></a>00466         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3424d0271d9eebf1962ad87286ec9fc3" title="List of rescaling factors.">rs</a> = ones(len(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a4d6fbc589839d65aaf4dc417b05afba3" title="Initial value of physical parameters.">pvals0</a>))
<a name="l00467"></a>00467         <span class="keywordflow">for</span> pnum <span class="keywordflow">in</span> range(len(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a4d6fbc589839d65aaf4dc417b05afba3" title="Initial value of physical parameters.">pvals0</a>)):
<a name="l00468"></a>00468             <span class="keywordflow">for</span> termtype <span class="keywordflow">in</span> tvgeomean:
<a name="l00469"></a>00469                 <span class="keywordflow">if</span> termtype <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a2d12bd53577f14af5e8d4b64ebb6281f" title="The listing of parameter number -&gt; interaction types.">plist</a>[pnum]:
<a name="l00470"></a>00470                     self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3424d0271d9eebf1962ad87286ec9fc3" title="List of rescaling factors.">rs</a>[pnum] = tvgeomean[termtype]
<a name="l00471"></a>00471                     
<a name="l00472"></a>00472     <span class="comment">##</span>
<a name="l00473"></a>00473     <span class="comment">#  Create the transformation matrix to rescale and rotate the mathematical parameters.</span>
<a name="l00474"></a>00474     <span class="comment"># </span>
<a name="l00475"></a>00475     <span class="comment">#         For point charge parameters, project out perturbations that</span>
<a name="l00476"></a>00476     <span class="comment">#         change the total charge.</span>
<a name="l00477"></a>00477     <span class="comment">#         </span>
<a name="l00478"></a>00478     <span class="comment">#         First build these:</span>
<a name="l00479"></a>00479     <span class="comment">#         </span>
<a name="l00480"></a>00480     <span class="comment">#         &#39;qmap&#39;    : Just a list of parameter indices that point to charges.</span>
<a name="l00481"></a>00481     <span class="comment">#         </span>
<a name="l00482"></a>00482     <span class="comment">#         &#39;qid&#39;     : For each parameter in the qmap, a list of the affected atoms :)</span>
<a name="l00483"></a>00483     <span class="comment">#                     A potential target for the molecule-specific thang.</span>
<a name="l00484"></a>00484     <span class="comment">#                     </span>
<a name="l00485"></a>00485     <span class="comment">#         Then make this:</span>
<a name="l00486"></a>00486     <span class="comment">#         </span>
<a name="l00487"></a>00487     <span class="comment">#         &#39;qtrans2&#39; : A transformation matrix that rotates the charge parameters.</span>
<a name="l00488"></a>00488     <span class="comment">#                     The first row is all zeros (because it corresponds to increasing the charge on all atoms)</span>
<a name="l00489"></a>00489     <span class="comment">#                     The other rows correspond to changing one of the parameters and decreasing all of the others</span>
<a name="l00490"></a>00490     <span class="comment">#                     equally such that the overall charge is preserved.</span>
<a name="l00491"></a>00491     <span class="comment">#                     </span>
<a name="l00492"></a>00492     <span class="comment">#         &#39;qmat2&#39;   : An identity matrix with &#39;qtrans2&#39; pasted into the right place</span>
<a name="l00493"></a>00493     <span class="comment">#         </span>
<a name="l00494"></a>00494     <span class="comment">#         &#39;transmat&#39;: &#39;qmat2&#39; with rows and columns scaled using self.rs</span>
<a name="l00495"></a>00495     <span class="comment">#         </span>
<a name="l00496"></a>00496     <span class="comment">#         &#39;excision&#39;: Parameter indices that need to be &#39;cut out&#39; because they are irrelevant and</span>
<a name="l00497"></a>00497     <span class="comment">#                     mess with the matrix diagonalization</span>
<a name="l00498"></a>00498     <span class="comment">#         </span>
<a name="l00499"></a>00499     <span class="comment">#         @todo Only project out changes in total charge of a molecule, and perhaps generalize to</span>
<a name="l00500"></a>00500     <span class="comment">#         fragments of molecules or other types of parameters.</span>
<a name="l00501"></a>00501     <span class="comment">#         </span>
<a name="l00502"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#acf0ce8fc4e9fbf5257f93d14d4a4f10f">00502</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#acf0ce8fc4e9fbf5257f93d14d4a4f10f" title="Create the transformation matrix to rescale and rotate the mathematical parameters.">mktransmat</a>(self):
<a name="l00503"></a>00503         qmap   = []
<a name="l00504"></a>00504         qid    = []
<a name="l00505"></a>00505         qnr    = 1
<a name="l00506"></a>00506         concern= [<span class="stringliteral">&#39;COUL&#39;</span>]
<a name="l00507"></a>00507         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a5f04fa76bff707688a394542f893993d" title="The total number of parameters.">np</a>):
<a name="l00508"></a>00508             <span class="keywordflow">if</span> any([j <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a2d12bd53577f14af5e8d4b64ebb6281f" title="The listing of parameter number -&gt; interaction types.">plist</a>[i] <span class="keywordflow">for</span> j <span class="keywordflow">in</span> concern]):
<a name="l00509"></a>00509                 qmap.append(i)
<a name="l00510"></a>00510                 nq = sum(array([count(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a2d12bd53577f14af5e8d4b64ebb6281f" title="The listing of parameter number -&gt; interaction types.">plist</a>[i], j) <span class="keywordflow">for</span> j <span class="keywordflow">in</span> concern]))
<a name="l00511"></a>00511                 qid.append(qnr+arange(nq))
<a name="l00512"></a>00512                 qnr += nq
<a name="l00513"></a>00513         tq = qnr - 1
<a name="l00514"></a>00514         cons0 = ones((1,tq))
<a name="l00515"></a>00515         <span class="comment">#print qmap</span>
<a name="l00516"></a>00516         <span class="comment">#print qid</span>
<a name="l00517"></a>00517         <span class="comment">#chargegrp = []</span>
<a name="l00518"></a>00518         <span class="comment"># LPW Charge groups aren&#39;t implemented at this time</span>
<a name="l00519"></a>00519         <span class="comment">## chargegrp = [[1,3],[4,5],[6,7]]</span>
<a name="l00520"></a>00520         <span class="comment">## for group in chargegrp:</span>
<a name="l00521"></a>00521         <span class="comment">##     a = min(group[0]-1, group[1])</span>
<a name="l00522"></a>00522         <span class="comment">##     b = max(group[0]-1, group[1])</span>
<a name="l00523"></a>00523         <span class="comment">##     constemp = zeros(tq, dtype=float)</span>
<a name="l00524"></a>00524         <span class="comment">##     for i in range(constemp.shape[0]):</span>
<a name="l00525"></a>00525         <span class="comment">##         if i &gt;= a and i &lt; b:</span>
<a name="l00526"></a>00526         <span class="comment">##             constemp[i] += 1</span>
<a name="l00527"></a>00527         <span class="comment">##         else:</span>
<a name="l00528"></a>00528         <span class="comment">##             constemp[i] -= 1</span>
<a name="l00529"></a>00529         <span class="comment">##     cons0 = vstack((cons0, constemp))</span>
<a name="l00530"></a>00530         <span class="comment">## print cons0</span>
<a name="l00531"></a>00531         <span class="comment">#Here is where we build the qtrans2 matrix.</span>
<a name="l00532"></a>00532         
<a name="l00533"></a>00533         nq = len(qmap)
<a name="l00534"></a>00534         <span class="keywordflow">if</span> nq &gt; 0:
<a name="l00535"></a>00535             cons = zeros((cons0.shape[0], nq), dtype=float)
<a name="l00536"></a>00536             qtrans2 = eye(nq, dtype=float)
<a name="l00537"></a>00537             <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(cons.shape[0]):
<a name="l00538"></a>00538                 <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(cons.shape[1]):
<a name="l00539"></a>00539                     cons[i][j] = sum([cons0[i][k-1] <span class="keywordflow">for</span> k <span class="keywordflow">in</span> qid[j]])
<a name="l00540"></a>00540                 cons[i] /= norm(cons[i])
<a name="l00541"></a>00541                 <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(i):
<a name="l00542"></a>00542                     cons[i] = orthogonalize(cons[i], cons[j])
<a name="l00543"></a>00543                 qtrans2[i,:] = 0
<a name="l00544"></a>00544                 <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(nq-i-1):
<a name="l00545"></a>00545                     qtrans2[i+j+1, :] = orthogonalize(qtrans2[i+j+1, :], cons[i])
<a name="l00546"></a>00546             <span class="comment">#print qtrans2</span>
<a name="l00547"></a>00547         qmat2 = eye(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a5f04fa76bff707688a394542f893993d" title="The total number of parameters.">np</a>,dtype=float)
<a name="l00548"></a>00548         x = 0
<a name="l00549"></a>00549         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a5f04fa76bff707688a394542f893993d" title="The total number of parameters.">np</a>):
<a name="l00550"></a>00550             <span class="keywordflow">if</span> i <span class="keywordflow">in</span> qmap:
<a name="l00551"></a>00551                 y = 0
<a name="l00552"></a>00552                 <span class="keywordflow">for</span> j <span class="keywordflow">in</span> qmap:
<a name="l00553"></a>00553                     qmat2[i, j] = qtrans2[x, y]
<a name="l00554"></a>00554                     y += 1
<a name="l00555"></a>00555                 x += 1
<a name="l00556"></a>00556         transmat = mat(qmat2) * diag(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3424d0271d9eebf1962ad87286ec9fc3" title="List of rescaling factors.">rs</a>)
<a name="l00557"></a>00557         transmatNS = array(transmat,copy=<span class="keyword">True</span>)
<a name="l00558"></a>00558         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aa630b2a2142d81e30c5751ed13a7b777" title="Indices to exclude from optimization / Hessian inversion.">excision</a> = []
<a name="l00559"></a>00559         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a5f04fa76bff707688a394542f893993d" title="The total number of parameters.">np</a>):
<a name="l00560"></a>00560             <span class="keywordflow">if</span> abs(transmatNS[i, i]) &lt; 1e-8:
<a name="l00561"></a>00561                 self.excision.append(i)
<a name="l00562"></a>00562                 transmatNS[i, i] += 1
<a name="l00563"></a>00563         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aa630b2a2142d81e30c5751ed13a7b777" title="Indices to exclude from optimization / Hessian inversion.">excision</a> = list(set(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aa630b2a2142d81e30c5751ed13a7b777" title="Indices to exclude from optimization / Hessian inversion.">excision</a>))
<a name="l00564"></a>00564         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aa630b2a2142d81e30c5751ed13a7b777" title="Indices to exclude from optimization / Hessian inversion.">excision</a>:
<a name="l00565"></a>00565             transmat[i, :] = zeros(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a5f04fa76bff707688a394542f893993d" title="The total number of parameters.">np</a>, dtype=float)
<a name="l00566"></a>00566         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3ecc51355dbd97e0b1620007924fd2a3" title="The transformation matrix for mathematical -&gt; physical parameters.">tm</a> = transmat
<a name="l00567"></a>00567         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a9c49407242f4e8da1c42530825c6dbda" title="The transpose of the transformation matrix.">tmI</a> = transmat.T
<a name="l00568"></a>00568         
<a name="l00569"></a>00569     <span class="comment">##</span>
<a name="l00570"></a>00570     <span class="comment">#  Create the plist, which is like a reversed version of the parameter map.  More convenient for printing. </span>
<a name="l00571"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#ac0046446695a65cb2489fdb560ef5929">00571</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#ac0046446695a65cb2489fdb560ef5929" title="Create the plist, which is like a reversed version of the parameter map.">list_map</a>(self):
<a name="l00572"></a>00572         self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a2d12bd53577f14af5e8d4b64ebb6281f" title="The listing of parameter number -&gt; interaction types.">plist</a> = [[] <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(max([self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a0b4c59bcf7ecb19000b3a173151a7c5b" title="The mapping of interaction type -&gt; parameter number.">map</a>[i] <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a0b4c59bcf7ecb19000b3a173151a7c5b" title="The mapping of interaction type -&gt; parameter number.">map</a>])+1)]
<a name="l00573"></a>00573         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a0b4c59bcf7ecb19000b3a173151a7c5b" title="The mapping of interaction type -&gt; parameter number.">map</a>:
<a name="l00574"></a>00574             self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a2d12bd53577f14af5e8d4b64ebb6281f" title="The listing of parameter number -&gt; interaction types.">plist</a>[self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a0b4c59bcf7ecb19000b3a173151a7c5b" title="The mapping of interaction type -&gt; parameter number.">map</a>[i]].append(i)
<a name="l00575"></a>00575         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a5f04fa76bff707688a394542f893993d" title="The total number of parameters.">np</a>):
<a name="l00576"></a>00576             self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a2d12bd53577f14af5e8d4b64ebb6281f" title="The listing of parameter number -&gt; interaction types.">plist</a>[i] = <span class="stringliteral">&#39; &#39;</span>.join(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a2d12bd53577f14af5e8d4b64ebb6281f" title="The listing of parameter number -&gt; interaction types.">plist</a>[i])
<a name="l00577"></a>00577             
<a name="l00578"></a>00578     <span class="comment">##</span>
<a name="l00579"></a>00579     <span class="comment"># Prints out the (physical or mathematical) parameter indices, IDs and values in a visually appealing way.</span>
<a name="l00580"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a61082e99cb3a02e35c80bbea919eaafa">00580</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a61082e99cb3a02e35c80bbea919eaafa" title="Prints out the (physical or mathematical) parameter indices, IDs and values in a visually appealing w...">print_map</a>(self,vals = None):
<a name="l00581"></a>00581         <span class="keywordflow">if</span> vals == <span class="keywordtype">None</span>:
<a name="l00582"></a>00582             vals = self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a4d6fbc589839d65aaf4dc417b05afba3" title="Initial value of physical parameters.">pvals0</a>
<a name="l00583"></a>00583         <span class="keywordflow">print</span> <span class="stringliteral">&#39;\n&#39;</span>.join([<span class="stringliteral">&quot;%4i [ % .4e ]&quot;</span> % (self.plist.index(i),vals[self.plist.index(i)]) + <span class="stringliteral">&quot; : &quot;</span> + <span class="stringliteral">&quot;%s&quot;</span> % i <span class="keywordflow">for</span> i <span class="keywordflow">in</span> self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a2d12bd53577f14af5e8d4b64ebb6281f" title="The listing of parameter number -&gt; interaction types.">plist</a>])
<a name="l00584"></a>00584         
<a name="l00585"></a>00585     <span class="comment">##</span>
<a name="l00586"></a>00586     <span class="comment">#  Assign physical parameter values to the &#39;pvals0&#39; array.</span>
<a name="l00587"></a>00587     <span class="comment"># </span>
<a name="l00588"></a>00588     <span class="comment">#         @param[in] idx The index to which we assign the parameter value.</span>
<a name="l00589"></a>00589     <span class="comment">#         @param[in] val The parameter value to be inserted.</span>
<a name="l00590"></a>00590     <span class="comment">#         </span>
<a name="l00591"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3af07734a2378364ed533e2853ee6b82">00591</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a3af07734a2378364ed533e2853ee6b82" title="Assign physical parameter values to the &#39;pvals0&#39; array.">assign_p0</a>(self,idx,val):
<a name="l00592"></a>00592         <span class="keywordflow">if</span> idx == len(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a4d6fbc589839d65aaf4dc417b05afba3" title="Initial value of physical parameters.">pvals0</a>):
<a name="l00593"></a>00593             self.pvals0.append(val)
<a name="l00594"></a>00594         <span class="keywordflow">else</span>:
<a name="l00595"></a>00595             self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a4d6fbc589839d65aaf4dc417b05afba3" title="Initial value of physical parameters.">pvals0</a>[idx] = val
<a name="l00596"></a>00596             
<a name="l00597"></a>00597     <span class="comment">##</span>
<a name="l00598"></a>00598     <span class="comment">#  Record the locations of a parameter in a file; [[file name, line number, field number, and multiplier]].</span>
<a name="l00599"></a>00599     <span class="comment"># </span>
<a name="l00600"></a>00600     <span class="comment">#         Note that parameters can have multiple locations because of the repetition functionality.</span>
<a name="l00601"></a>00601     <span class="comment"># </span>
<a name="l00602"></a>00602     <span class="comment">#         @param[in] idx  The index of the parameter.</span>
<a name="l00603"></a>00603     <span class="comment">#         @param[in] fnm  The file name of the parameter field.</span>
<a name="l00604"></a>00604     <span class="comment">#         @param[in] ln   The line number within the file.</span>
<a name="l00605"></a>00605     <span class="comment">#         @param[in] pfld The field within the line.</span>
<a name="l00606"></a>00606     <span class="comment">#         @param[in] mult The multiplier (this is usually 1.0)</span>
<a name="l00607"></a>00607     <span class="comment">#         </span>
<a name="l00608"></a>00608     <span class="comment">#         </span>
<a name="l00609"></a><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a2c9cda9adb5a6446fbccfa7b35f8dff5">00609</a>     <span class="keyword">def </span><a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#a2c9cda9adb5a6446fbccfa7b35f8dff5" title="Record the locations of a parameter in a file; [[file name, line number, field number, and multiplier]].">assign_field</a>(self,idx,fnm,ln,pfld,mult):
<a name="l00610"></a>00610         <span class="keywordflow">if</span> idx == len(self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aa521223f43f9629b30384491cafbd10c" title="A list where pfields[pnum] = [&#39;file&#39;,line,field,mult], basically a new way to modify force field file...">pfields</a>):
<a name="l00611"></a>00611             self.pfields.append([[fnm,ln,pfld,mult]])
<a name="l00612"></a>00612         <span class="keywordflow">else</span>:
<a name="l00613"></a>00613             self.<a class="code" href="classforcebalance_1_1forcefield_1_1FF.html#aa521223f43f9629b30384491cafbd10c" title="A list where pfields[pnum] = [&#39;file&#39;,line,field,mult], basically a new way to modify force field file...">pfields</a>[idx].append([fnm,ln,pfld,mult])
<a name="l00614"></a>00614 
<a name="l00615"></a>00615 <span class="comment">##</span>
<a name="l00616"></a>00616 <span class="comment">#  This function takes in a dictionary (tvgeomean) and a string (termtype).</span>
<a name="l00617"></a>00617 <span class="comment">#     </span>
<a name="l00618"></a>00618 <span class="comment">#     If termtype matches any of the strings below, tvgeomean[termtype] is assigned</span>
<a name="l00619"></a>00619 <span class="comment">#     to one of the numbers below.</span>
<a name="l00620"></a>00620 <span class="comment"># </span>
<a name="l00621"></a>00621 <span class="comment">#     This is LPW&#39;s attempt to simplify the rescaling factors.</span>
<a name="l00622"></a>00622 <span class="comment"># </span>
<a name="l00623"></a>00623 <span class="comment">#     @param[out] tvgeomean The computed rescaling factor.</span>
<a name="l00624"></a>00624 <span class="comment">#     @param[in] termtype The interaction type (corresponding to a physical unit)</span>
<a name="l00625"></a>00625 <span class="comment">#     @param[in] Temperature The temperature for computing the kT energy scale</span>
<a name="l00626"></a>00626 <span class="comment">#     </span>
<a name="l00627"></a>00627 <span class="comment">#     </span>
<a name="l00628"></a>00628 <span class="keyword">def </span>rs_override(tvgeomean,termtype,Temperature=298.15):
<a name="l00629"></a>00629     <span class="keywordflow">if</span> match(<span class="stringliteral">&#39;PDIHS[1-6]K|RBDIHSK[1-5]|MORSEC&#39;</span>,termtype):
<a name="l00630"></a>00630         <span class="comment"># eV or eV rad^-2</span>
<a name="l00631"></a>00631         tvgeomean[termtype] = 96.4853
<a name="l00632"></a>00632     <span class="keywordflow">elif</span> match(<span class="stringliteral">&#39;UREY_BRADLEYK1|ANGLESK&#39;</span>,termtype):
<a name="l00633"></a>00633         tvgeomean[termtype] = 96.4853 * 6.28
<a name="l00634"></a>00634     <span class="keywordflow">elif</span> match(<span class="stringliteral">&#39;COUL|VPAIR_BHAMC|QTPIEA&#39;</span>,termtype):
<a name="l00635"></a>00635         <span class="comment"># elementary charge, or unitless, or already in atomic unit</span>
<a name="l00636"></a>00636         tvgeomean[termtype] = 1.0
<a name="l00637"></a>00637     <span class="keywordflow">elif</span> match(<span class="stringliteral">&#39;QTPIEC|QTPIEH&#39;</span>,termtype):
<a name="l00638"></a>00638         <span class="comment"># eV to atomic unit</span>
<a name="l00639"></a>00639         tvgeomean[termtype] = 27.2114
<a name="l00640"></a>00640     <span class="keywordflow">elif</span> match(<span class="stringliteral">&#39;BONDSB|UREY_BRADLEYB|MORSEB|VDWS|VPAIRS|VSITE|VDW_BHAMA|VPAIR_BHAMA&#39;</span>,termtype):
<a name="l00641"></a>00641         <span class="comment"># nm to atomic unit</span>
<a name="l00642"></a>00642         tvgeomean[termtype] = 0.05291772
<a name="l00643"></a>00643     <span class="keywordflow">elif</span> match(<span class="stringliteral">&#39;BONDSK|UREY_BRADLEYK2&#39;</span>,termtype):
<a name="l00644"></a>00644         <span class="comment"># au bohr^-2</span>
<a name="l00645"></a>00645         tvgeomean[termtype] = 34455.5275 * 27.2114
<a name="l00646"></a>00646     <span class="keywordflow">elif</span> match(<span class="stringliteral">&#39;PDIHS[1-6]B|ANGLESB|UREY_BRADLEYB&#39;</span>,termtype):
<a name="l00647"></a>00647         <span class="comment"># radian</span>
<a name="l00648"></a>00648         tvgeomean[termtype] = 57.295779513
<a name="l00649"></a>00649     <span class="keywordflow">elif</span> match(<span class="stringliteral">&#39;VDWT|VDW_BHAMB|VPAIR_BHAMB&#39;</span>,termtype):
<a name="l00650"></a>00650         <span class="comment"># VdW well depth; using kT.  This was a tough one because the energy scale is so darn small.</span>
<a name="l00651"></a>00651         tvgeomean[termtype] = kb*Temperature
<a name="l00652"></a>00652     <span class="keywordflow">elif</span> match(<span class="stringliteral">&#39;MORSEE&#39;</span>,termtype):
<a name="l00653"></a>00653         tvgeomean[termtype] = 18.897261
<a name="l00654"></a>00654 
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Thu Feb 2 2012 13:21:19 for ForceBalance by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
