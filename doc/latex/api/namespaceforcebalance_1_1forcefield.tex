\hypertarget{namespaceforcebalance_1_1forcefield}{\subsection{forcebalance\-:\-:forcefield \-Namespace \-Reference}
\label{namespaceforcebalance_1_1forcefield}\index{forcebalance\-::forcefield@{forcebalance\-::forcefield}}
}


\-Force field module.  


\subsubsection*{\-Classes}
\begin{DoxyCompactItemize}
\item 
class \hyperlink{classforcebalance_1_1forcefield_1_1BackedUpDict}{\-Backed\-Up\-Dict}
\item 
class \hyperlink{classforcebalance_1_1forcefield_1_1FF}{\-F\-F}
\begin{DoxyCompactList}\small\item\em \-Force field class. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsubsection*{\-Functions}
\begin{DoxyCompactItemize}
\item 
def \hyperlink{namespaceforcebalance_1_1forcefield_a99c9997d5158a04be089f291bd6f99bd}{determine\-\_\-fftype}
\begin{DoxyCompactList}\small\item\em \-Determine the type of a force field file. \end{DoxyCompactList}\item 
def \hyperlink{namespaceforcebalance_1_1forcefield_ab1a855bace20dd5e45928467e2a133f1}{rs\-\_\-override}
\begin{DoxyCompactList}\small\item\em \-This function takes in a dictionary (rsfactors) and a string (termtype). \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsubsection*{\-Variables}
\begin{DoxyCompactItemize}
\item 
tuple \hyperlink{namespaceforcebalance_1_1forcefield_acc6d19b93081a5db0b60419be8a27471}{logger} = get\-Logger(\-\_\-\-\_\-name\-\_\-\-\_\-)
\item 
dictionary \hyperlink{namespaceforcebalance_1_1forcefield_a877cd53359cedaee26cad7323cbdd60c}{\-F\-F\-\_\-\-Extensions}
\item 
dictionary \hyperlink{namespaceforcebalance_1_1forcefield_a7e159bd71671c11d9327e46f2ac01483}{\-F\-F\-\_\-\-I\-O\-Modules}
\end{DoxyCompactItemize}


\subsubsection{\-Detailed \-Description}
\-Force field module. \-In \-Force\-Balance a 'force field' is built from a set of files containing physical parameters. \-These files can be anything that enter into any computation -\/ our original program was quite dependent on the \-G\-R\-O\-M\-A\-C\-S force field format, but this program is set up to allow very general input formats.

\-We introduce several important concepts\-:

1) \-Adjustable parameters are allocated into a vector.

\-To cast the force field optimization as a math problem, we treat all of the parameters on equal footing and write them as indices in a parameter vector.

2) \-A mapping from interaction type to parameter number.

\-Each element in the parameter vector corresponds to one or more interaction types. \-Whenever we change the parameter vector and recompute the objective function, this amounts to changing the physical parameters in the simulations, so we print out new force field files for external programs. \-In addition, when these programs are computing the objective function we are often in low-\/level subroutines that compute terms in the energy and force. \-If we need an analytic derivative of the objective function, then these subroutines need to know which index of the parameter vector needs to be modified.

\-This is done by way of a hash table\-: for example, when we are computing a \-Coulomb interaction between atom 4 and atom 5, we can build the words '\-C\-O\-U\-L4' and '\-C\-O\-U\-L5' and look it up in the parameter map; this gives us two numbers (say, 10 and 11) corresponding to the eleventh and twelfth element of the parameter vector. \-Then we can compute the derivatives of the energy w/r.\-t. these parameters (in this case, \-C\-O\-U\-L5/rij and \-C\-O\-U\-L4/rij) and increment these values in the objective function gradient.

\-In custom-\/implemented force fields (see counterpoisematch.\-py) the hash table can also be used to look up parameter values for computation of interactions. \-This is probably not the fastest way to do things, however.

3) \-Distinction between physical and mathematical parameters.

\-The optimization algorithm works in a space that is related to, but not exactly the same as the physical parameter space. \-The reasons for why we do this are\-:

a) \-Each parameter has its own physical units. \-On the one hand it's not right to treat different physical units all on the same footing, so nondimensionalization is desirable. \-To make matters worse, the force field parameters can be small as 1e-\/8 or as large as 1e+6 depending on the parameter type. \-This means the elements of the objective function gradient / \-Hessian have elements that differ from each other in size by 10+ orders of magnitude, leading to mathematical instabilities in the optimizer.

b) \-The parameter space can be constrained, most notably for atomic partial charges where we don't want to change the overall charge on a molecule. \-Thus we wish to project out certain movements in the mathematical parameters such that they don't change the physical parameters.

c) \-We wish to regularize our optimization so as to avoid changing our parameters in very insensitive directions (linear dependencies). \-However, the sensitivity of the objective function to changes in the force field depends on the physical units!

\-For all of these reasons, we introduce a 'transformation matrix' which maps mathematical parameters onto physical parameters. \-The diagonal elements in this matrix are rescaling factors; they take the mathematical parameter and magnify it by this constant factor. \-The off-\/diagonal elements correspond to rotations and other linear transformations, and currently \-I just use them to project out the 'increase the net charge' direction in the physical parameter space.

\-Note that with regularization, these rescaling factors are equivalent to the widths of prior distributions in a maximum likelihood framework. \-Because there is such a correspondence between rescaling factors and choosing a prior, they need to be chosen carefully. \-This is work in progress. \-Another possibility is to sample the width of the priors from a noninformative distribution -\/-\/ the hyperprior (we can choose the \-Jeffreys prior or something). \-This is work in progress.

\-Right now only \-G\-R\-O\-M\-A\-C\-S parameters are supported, but this class is extensible, we need more modules!

\begin{DoxyAuthor}{\-Author}
\-Lee-\/\-Ping \-Wang 
\end{DoxyAuthor}
\begin{DoxyDate}{\-Date}
04/2012 
\end{DoxyDate}


\subsubsection{\-Function \-Documentation}
\hypertarget{namespaceforcebalance_1_1forcefield_a99c9997d5158a04be089f291bd6f99bd}{\index{forcebalance\-::forcefield@{forcebalance\-::forcefield}!determine\-\_\-fftype@{determine\-\_\-fftype}}
\index{determine\-\_\-fftype@{determine\-\_\-fftype}!forcebalance::forcefield@{forcebalance\-::forcefield}}
\paragraph[{determine\-\_\-fftype}]{\setlength{\rightskip}{0pt plus 5cm}def {\bf forcebalance.\-forcefield.\-determine\-\_\-fftype} (
\begin{DoxyParamCaption}
\item[{}]{ffname, }
\item[{}]{verbose = {\ttfamily \-False}}
\end{DoxyParamCaption}
)}}\label{namespaceforcebalance_1_1forcefield_a99c9997d5158a04be089f291bd6f99bd}


\-Determine the type of a force field file. 

\-It is possible to specify the file type explicitly in the input file using the syntax 'force\-\_\-field.\-ext\-:type'. \-Otherwise this function will try to determine the force field type by extension. 

\-Definition at line 145 of file forcefield.\-py.

\hypertarget{namespaceforcebalance_1_1forcefield_ab1a855bace20dd5e45928467e2a133f1}{\index{forcebalance\-::forcefield@{forcebalance\-::forcefield}!rs\-\_\-override@{rs\-\_\-override}}
\index{rs\-\_\-override@{rs\-\_\-override}!forcebalance::forcefield@{forcebalance\-::forcefield}}
\paragraph[{rs\-\_\-override}]{\setlength{\rightskip}{0pt plus 5cm}def {\bf forcebalance.\-forcefield.\-rs\-\_\-override} (
\begin{DoxyParamCaption}
\item[{}]{rsfactors, }
\item[{}]{termtype, }
\item[{}]{\-Temperature = {\ttfamily 298.15}}
\end{DoxyParamCaption}
)}}\label{namespaceforcebalance_1_1forcefield_ab1a855bace20dd5e45928467e2a133f1}


\-This function takes in a dictionary (rsfactors) and a string (termtype). 

\-If termtype matches any of the strings below, rsfactors\mbox{[}termtype\mbox{]} is assigned to one of the numbers below.

\-This is \-L\-P\-W's attempt to simplify the rescaling factors.


\begin{DoxyParams}[1]{\-Parameters}
\mbox{\tt out}  & {\em rsfactors} & \-The computed rescaling factor. \\
\hline
\mbox{\tt in}  & {\em termtype} & \-The interaction type (corresponding to a physical unit) \\
\hline
\mbox{\tt in}  & {\em \-Temperature} & \-The temperature for computing the k\-T energy scale \\
\hline
\end{DoxyParams}


\-Definition at line 1172 of file forcefield.\-py.



\subsubsection{\-Variable \-Documentation}
\hypertarget{namespaceforcebalance_1_1forcefield_a877cd53359cedaee26cad7323cbdd60c}{\index{forcebalance\-::forcefield@{forcebalance\-::forcefield}!\-F\-F\-\_\-\-Extensions@{\-F\-F\-\_\-\-Extensions}}
\index{\-F\-F\-\_\-\-Extensions@{\-F\-F\-\_\-\-Extensions}!forcebalance::forcefield@{forcebalance\-::forcefield}}
\paragraph[{\-F\-F\-\_\-\-Extensions}]{\setlength{\rightskip}{0pt plus 5cm}dictionary {\bf forcebalance\-::forcefield\-::\-F\-F\-\_\-\-Extensions}}}\label{namespaceforcebalance_1_1forcefield_a877cd53359cedaee26cad7323cbdd60c}
{\bfseries \-Initial value\-:}
\begin{DoxyCode}
1 {"itp" : "gmx",
2                  "in"  : "qchem",
3                  "prm" : "tinker",
4                  "gen" : "custom",
5                  "xml" : "openmm",
6                  "frcmod" : "frcmod",
7                  "mol2" : "mol2",
8                  "gbs"  : "gbs",
9                  "grid" : "grid"
10                  }
\end{DoxyCode}


\-Definition at line 117 of file forcefield.\-py.

\hypertarget{namespaceforcebalance_1_1forcefield_a7e159bd71671c11d9327e46f2ac01483}{\index{forcebalance\-::forcefield@{forcebalance\-::forcefield}!\-F\-F\-\_\-\-I\-O\-Modules@{\-F\-F\-\_\-\-I\-O\-Modules}}
\index{\-F\-F\-\_\-\-I\-O\-Modules@{\-F\-F\-\_\-\-I\-O\-Modules}!forcebalance::forcefield@{forcebalance\-::forcefield}}
\paragraph[{\-F\-F\-\_\-\-I\-O\-Modules}]{\setlength{\rightskip}{0pt plus 5cm}dictionary {\bf forcebalance\-::forcefield\-::\-F\-F\-\_\-\-I\-O\-Modules}}}\label{namespaceforcebalance_1_1forcefield_a7e159bd71671c11d9327e46f2ac01483}
{\bfseries \-Initial value\-:}
\begin{DoxyCode}
1 {"gmx": gmxio.ITP_Reader ,
2                 "qchem": qchemio.QCIn_Reader ,
3                 "tinker": tinkerio.Tinker_Reader ,
4                 "custom": custom_io.Gen_Reader , 
5                 "openmm" : openmmio.OpenMM_Reader,
6                 "frcmod" : amberio.FrcMod_Reader,
7                 "mol2" : amberio.Mol2_Reader,
8                 "gbs" : psi4io.GBS_Reader,
9                 "grid" : psi4io.Grid_Reader
10                 }
\end{DoxyCode}


\-Definition at line 129 of file forcefield.\-py.

\hypertarget{namespaceforcebalance_1_1forcefield_acc6d19b93081a5db0b60419be8a27471}{\index{forcebalance\-::forcefield@{forcebalance\-::forcefield}!logger@{logger}}
\index{logger@{logger}!forcebalance::forcefield@{forcebalance\-::forcefield}}
\paragraph[{logger}]{\setlength{\rightskip}{0pt plus 5cm}tuple {\bf forcebalance\-::forcefield\-::logger} = get\-Logger(\-\_\-\-\_\-name\-\_\-\-\_\-)}}\label{namespaceforcebalance_1_1forcefield_acc6d19b93081a5db0b60419be8a27471}


\-Definition at line 115 of file forcefield.\-py.

